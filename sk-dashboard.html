<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BIMS - SK Official Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Cropper.js CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- BIMS Configuration -->
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>

    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>


    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#2f6e4e",
              secondary: "#3d8b64",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      /* Enhanced Icon System */
      .icon-wrapper {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .icon-wrapper:hover {
        transform: translateY(-2px);
      }
      .nav-link svg {
        transition: all 0.3s ease;
      }
      .nav-link:hover svg {
        transform: scale(1.1);
      }
      .icon-badge {
        box-shadow: 0 2px 8px rgba(47, 110, 78, 0.15);
      }
      .notification-icon {
        position: relative;
      }
      .notification-icon:hover {
        transform: rotate(15deg) scale(1.1);
        transition: transform 0.3s ease;
      }
      .status-icon-pending {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }
      .status-icon-approved {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      .status-icon-rejected {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }
      .icon-primary {
        filter: drop-shadow(0 2px 4px rgba(47, 110, 78, 0.1));
      }
      .icon-glow {
        filter: drop-shadow(0 0 8px rgba(47, 110, 78, 0.3));
      }

      /* Toast Notification Styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #10b981;
      }

      .toast.error {
        border-left: 4px solid #ef4444;
      }

      .toast.warning {
        border-left: 4px solid #f59e0b;
      }

      .toast.info {
        border-left: 4px solid #3b82f6;
      }

      /* Input validation states */
      .input-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }

      .input-success {
        border-color: #10b981 !important;
      }

      /* Loading spinner */
      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Character counter */
      .char-counter {
        font-size: 0.75rem;
        color: #6b7280;
        text-align: right;
        margin-top: 0.25rem;
      }

      .char-counter.warning {
        color: #f59e0b;
      }

      .char-counter.error {
        color: #ef4444;
      }

      /* Pagination dots - consistent across all screen sizes */
      #announcementPaginationDots button {
        flex-shrink: 0;
        display: inline-block;
        cursor: pointer;
        border: none;
        padding: 0;
        outline: none;
      }

      #announcementPaginationDots button:focus {
        outline: 2px solid rgba(47, 110, 78, 0.3);
        outline-offset: 2px;
      }

      /* Limit announcement description to 5 lines with ellipsis */
      .announcement-description {
        display: -webkit-box;
        -webkit-line-clamp: 5;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.5;
        height: calc(
          1.5em * 5
        ); /* Fixed height for 5 lines - keeps cards consistent */
        min-height: calc(
          1.5em * 5
        ); /* Ensure minimum height even with short text */
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside
        class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col"
      >
        <div class="p-6 flex-1 flex flex-col">
          <!-- Logo -->
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg icon-badge overflow-hidden"
            >
              <img
                src="asset/logo.svg"
                alt="BIMS Logo"
                class="w-full h-full object-contain p-1"
              />
            </div>
            <div>
              <h1 class="text-xl font-black text-gray-800">BIMS</h1>
              <p class="text-sm text-gray-600 font-medium">SK Malanday</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a
              href="sk-dashboard.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 bg-[#2f6e4e]/10 text-[#2f6e4e] rounded-lg font-medium group"
            >
              <div
                class="w-9 h-9 bg-[#2f6e4e]/20 rounded-lg flex items-center justify-center group-hover:bg-[#2f6e4e]/30 transition"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                  ></path>
                </svg>
              </div>
              <span>Dashboard</span>
            </a>
            <a
              href="sk-files.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div
                class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-blue-50 transition"
              >
                <svg
                  class="w-5 h-5 group-hover:text-blue-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
              </div>
              <span>Manage Files</span>
            </a>
            <a
              href="sk-projects.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div
                class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-purple-50 transition"
              >
                <svg
                  class="w-5 h-5 group-hover:text-purple-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  ></path>
                </svg>
              </div>
              <span>Project Monitoring</span>
            </a>
            <a
              href="sk-calendar.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div
                class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-orange-50 transition"
              >
                <svg
                  class="w-5 h-5 group-hover:text-orange-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <span>Calendar</span>
            </a>
            <a
              href="sk-testimonies.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div
                class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-50 transition"
              >
                <svg
                  class="w-5 h-5 group-hover:text-indigo-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                  ></path>
                </svg>
              </div>
              <span>Testimonies</span>
            </a>
            <a
              href="sk-archive.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div
                class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition"
              >
                <svg
                  class="w-5 h-5 group-hover:text-gray-700 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                  ></path>
                </svg>
              </div>
              <span>Archives</span>
            </a>
          </nav>

          <div class="flex-1"></div>

          <!-- Logout -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <button
              onclick="handleLogout()"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition w-full group"
            >
              <div
                class="w-9 h-9 bg-red-50 rounded-lg flex items-center justify-center group-hover:bg-red-100 transition"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
              </div>
              <span class="font-medium">Logout</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Confirmation Modal -->
      <div
        id="confirmModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4"
      >
        <div
          class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all"
        >
          <div
            class="flex items-center justify-center w-12 h-12 mx-auto bg-yellow-100 rounded-full mb-4"
          >
            <svg
              class="w-6 h-6 text-yellow-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
          <h3
            id="confirmTitle"
            class="text-lg font-bold text-gray-900 text-center mb-2"
          >
            Confirm Action
          </h3>
          <p id="confirmMessage" class="text-sm text-gray-600 text-center mb-6">
            Are you sure you want to proceed?
          </p>
          <div class="flex gap-3">
            <button
              id="confirmCancel"
              class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700"
            >
              Cancel
            </button>
            <button
              id="confirmOk"
              class="flex-1 px-4 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium"
            >
              Confirm
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 overflow-auto">
        <!-- Top Bar -->
        <header
          class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200"
        >
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p
                  class="text-sm text-[#2f6e4e] font-semibold mb-1"
                  id="currentDate"
                >
                  Sunday, December 14, 2025
                </p>
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <p class="text-sm text-gray-600 mt-1">
                  Overview of barangay activities, projects, and volunteer
                  engagement
                </p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button
                    onclick="window.notificationModal.toggle()"
                    class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                    title="Notifications"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                      ></path>
                    </svg>
                    <span
                      id="notificationBadge"
                      class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse"
                      >5</span
                    >
                  </button>
                </div>
                <div
                  class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 rounded-xl px-3 py-2 transition-all duration-300 group"
                  onclick="window.profileModal.open()"
                >
                  <div class="text-right">
                    <p
                      class="text-sm font-medium text-gray-700 group-hover:text-[#2f6e4e] transition"
                    >
                      Andrea Pelias
                    </p>
                    <p class="text-xs text-gray-500">SK Chairman</p>
                  </div>
                  <div
                    class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20 group-hover:ring-[#2f6e4e]/40 transition"
                  >
                    AP
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Stats Cards -->
        <div class="px-6 py-6">
          <div class="max-w-7xl mx-auto">
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <!-- Total Files -->
              <div
                class="group bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow-md hover:shadow-xl p-6 border-l-4 border-blue-500 transition-all duration-300 hover:-translate-y-1 cursor-pointer"
              >
                <div class="flex items-start justify-between mb-3">
                  <div
                    class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      ></path>
                    </svg>
                  </div>
                </div>
                <p
                  class="text-sm text-gray-600 font-semibold uppercase tracking-wide mb-1"
                >
                  Total Files
                </p>
                <p
                  id="totalFiles"
                  class="text-4xl font-extrabold text-gray-900 mb-1"
                >
                  <span
                    class="inline-block w-16 h-10 bg-gray-200 animate-pulse rounded"
                  ></span>
                </p>
                <p class="text-xs text-gray-500">Uploaded documents</p>
              </div>

              <!-- Total Announcements -->
              <div
                class="group bg-gradient-to-br from-amber-50 to-white rounded-2xl shadow-md hover:shadow-xl p-6 border-l-4 border-amber-500 transition-all duration-300 hover:-translate-y-1 cursor-pointer"
              >
                <div class="flex items-start justify-between mb-3">
                  <div
                    class="w-14 h-14 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
                      ></path>
                    </svg>
                  </div>
                </div>
                <p
                  class="text-sm text-gray-600 font-semibold uppercase tracking-wide mb-1"
                >
                  Announcements
                </p>
                <p
                  id="totalAnnouncements"
                  class="text-4xl font-extrabold text-gray-900 mb-1"
                >
                  <span
                    class="inline-block w-16 h-10 bg-gray-200 animate-pulse rounded"
                  ></span>
                </p>
                <p class="text-xs text-gray-500">Active posts</p>
              </div>

              <!-- Active Projects -->
              <div
                class="group bg-gradient-to-br from-green-50 to-white rounded-2xl shadow-md hover:shadow-xl p-6 border-l-4 border-[#2f6e4e] transition-all duration-300 hover:-translate-y-1 cursor-pointer"
              >
                <div class="flex items-start justify-between mb-3">
                  <div
                    class="w-14 h-14 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                      ></path>
                    </svg>
                  </div>
                </div>
                <p
                  class="text-sm text-gray-600 font-semibold uppercase tracking-wide mb-1"
                >
                  Active Projects
                </p>
                <p
                  id="activeProjects"
                  class="text-4xl font-extrabold text-gray-900 mb-1"
                >
                  <span
                    class="inline-block w-16 h-10 bg-gray-200 animate-pulse rounded"
                  ></span>
                </p>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                  <svg
                    class="w-3 h-3 text-green-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Ongoing initiatives
                </p>
              </div>

              <!-- Youth Volunteers -->
              <div
                class="group bg-gradient-to-br from-purple-50 to-white rounded-2xl shadow-md hover:shadow-xl p-6 border-l-4 border-purple-500 transition-all duration-300 hover:-translate-y-1 cursor-pointer"
              >
                <div class="flex items-start justify-between mb-3">
                  <div
                    class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300"
                  >
                    <svg
                      class="w-7 h-7 text-white"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="2.5"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                      ></path>
                    </svg>
                  </div>
                </div>
                <p
                  class="text-sm text-gray-600 font-semibold uppercase tracking-wide mb-1"
                >
                  Youth Volunteers
                </p>
                <p
                  id="totalVolunteers"
                  class="text-4xl font-extrabold text-gray-900 mb-1"
                >
                  <span
                    class="inline-block w-16 h-10 bg-gray-200 animate-pulse rounded"
                  ></span>
                </p>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                  <svg
                    class="w-3 h-3 text-purple-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  Registered members
                </p>
              </div>
            </div>

            <!-- Latest Announcements Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
              <div
                class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6"
              >
                <h3 class="text-xl font-bold text-gray-800">
                  Manage Announcements
                </h3>
                <button
                  onclick="openCreateModal()"
                  class="w-full md:w-auto bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 md:min-w-[180px] justify-center"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                  <span>Create New Announcement</span>
                </button>
              </div>

              <div
                id="announcementsGrid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              >
                <!-- Announcements will be dynamically loaded from database -->
              </div>

              <!-- Pagination Dots (Center) -->
              <div
                id="announcementPaginationDots"
                class="flex justify-center gap-2 mt-6 hidden"
              >
                <!-- Dots will be inserted here -->
              </div>

              <!-- Pagination Controls (Bottom Right) -->
              <div class="mt-6 flex justify-end">
                <nav
                  id="announcementPaginationNav"
                  class="hidden inline-flex rounded-md shadow-sm"
                  role="navigation"
                  aria-label="Pagination"
                >
                  <button
                    id="prevAnnouncementPage"
                    onclick="navigateAnnouncements(-1)"
                    class="px-3 py-2 border border-gray-200 rounded-l-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Prev
                  </button>
                  <button
                    id="nextAnnouncementPage"
                    onclick="navigateAnnouncements(1)"
                    class="px-3 py-2 border-t border-b border-r border-gray-200 rounded-r-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Next
                  </button>
                </nav>
              </div>
            </div>

            <!-- Transparency & Budget Reports Section -->
            <div class="mt-8">
              <h2 class="text-2xl font-bold text-gray-800 mb-2">
                Transparency & Budget Reports
              </h2>
              <p class="text-gray-600 mb-6">
                Full transparency on how your barangay funds are utilized
              </p>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 2025 Budget Allocation -->
                <div
                  class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-sm p-6 border border-blue-100"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3
                      class="text-lg font-bold text-gray-800"
                      id="budgetYearTitle"
                    >
                      2025 Budget Allocation
                    </h3>
                    <div class="flex space-x-2">
                      <button
                        onclick="editBudgetAllocation()"
                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                        title="Edit Budget"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                          ></path>
                        </svg>
                      </button>
                      <button
                        onclick="viewBudgetHistory()"
                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"
                        title="View History"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                          ></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div class="space-y-4">
                    <!-- Youth Development Programs -->
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 font-medium"
                          >Youth Development Programs</span
                        >
                        <span
                          class="text-gray-900 font-semibold"
                          id="youthBudget"
                          >₱450,000</span
                        >
                      </div>
                      <div class="w-full bg-blue-100 rounded-full h-2">
                        <div
                          id="youthBudgetBar"
                          class="bg-blue-600 h-2 rounded-full"
                          style="width: 45%"
                        ></div>
                      </div>
                    </div>

                    <!-- Community Events -->
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 font-medium"
                          >Community Events</span
                        >
                        <span
                          class="text-gray-900 font-semibold"
                          id="eventsBudget"
                          >₱300,000</span
                        >
                      </div>
                      <div class="w-full bg-blue-100 rounded-full h-2">
                        <div
                          id="eventsBudgetBar"
                          class="bg-blue-600 h-2 rounded-full"
                          style="width: 30%"
                        ></div>
                      </div>
                    </div>

                    <!-- Infrastructure Projects -->
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 font-medium"
                          >Infrastructure Projects</span
                        >
                        <span
                          class="text-gray-900 font-semibold"
                          id="infraBudget"
                          >₱250,000</span
                        >
                      </div>
                      <div class="w-full bg-blue-100 rounded-full h-2">
                        <div
                          id="infraBudgetBar"
                          class="bg-blue-600 h-2 rounded-full"
                          style="width: 25%"
                        ></div>
                      </div>
                    </div>

                    <!-- Total Budget -->
                    <div
                      class="pt-4 border-t border-blue-200 flex justify-between"
                    >
                      <span class="text-gray-800 font-bold">Total Budget</span>
                      <span
                        class="text-2xl font-bold text-blue-600"
                        id="totalBudget"
                        >₱1,000,000</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Project Success Metrics -->
                <div
                  class="bg-gradient-to-br from-[#2f6e4e]/10 to-white rounded-xl shadow-sm p-6 border border-[#2f6e4e]/20"
                >
                  <div class="flex items-center justify-between mb-4">
                    <div>
                      <h3 class="text-lg font-bold text-gray-800">
                        Project Success Metrics
                      </h3>
                      <p class="text-sm text-gray-600">
                        Based on 5-factor evaluation system
                      </p>
                    </div>
                    <div class="p-3 bg-[#2f6e4e]/20 rounded-lg">
                      <svg
                        class="w-6 h-6 text-[#2f6e4e]"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                        ></path>
                      </svg>
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <div
                      class="text-center p-4 bg-white rounded-lg border border-[#2f6e4e]/20"
                    >
                      <p
                        class="text-3xl font-bold text-[#2f6e4e]"
                        id="totalProjects"
                      >
                        42
                      </p>
                      <p class="text-sm text-gray-600 mt-1">Total Projects</p>
                      <p class="text-xs text-gray-400 mt-1" id="projectsYear">
                        2025
                      </p>
                    </div>
                    <div
                      class="text-center p-4 bg-white rounded-lg border border-[#2f6e4e]/20"
                    >
                      <p
                        class="text-3xl font-bold text-[#2f6e4e]"
                        id="completedProjects"
                      >
                        38
                      </p>
                      <p class="text-sm text-gray-600 mt-1">Completed</p>
                    </div>
                    <div
                      class="text-center p-4 bg-white rounded-lg border border-[#2f6e4e]/20"
                    >
                      <p
                        class="text-3xl font-bold text-yellow-600"
                        id="ongoingProjects"
                      >
                        4
                      </p>
                      <p class="text-sm text-gray-600 mt-1">Ongoing</p>
                    </div>
                    <div
                      class="text-center p-4 bg-white rounded-lg border border-[#2f6e4e]/20"
                    >
                      <p
                        class="text-3xl font-bold text-[#2f6e4e]"
                        id="successRate"
                      >
                        89%
                      </p>
                      <p class="text-sm text-gray-600 mt-1">Avg Success Rate</p>
                    </div>
                  </div>

                  <div
                    class="bg-white rounded-lg border border-[#2f6e4e]/20 p-4"
                  >
                    <p class="text-xs font-semibold text-gray-700 mb-2">
                      Success Rate Calculation:
                    </p>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                      <div>• Budget Efficiency (25%)</div>
                      <div>• Timeline Adherence (20%)</div>
                      <div>• Volunteer Participation (20%)</div>
                      <div>• Volunteer Feedback (15%)</div>
                      <div>• Community Impact (20%)</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Announcement Modal -->
    <div
      id="createModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-gray-800">
              Create New Announcement
            </h3>
            <button
              onclick="closeCreateModal()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Title *</label
            >
            <input
              type="text"
              id="createTitle"
              placeholder="Enter announcement title"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Category *</label
            >
            <select
              id="createCategory"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
            >
              <option value="">Select category</option>
              <option value="urgent">Urgent</option>
              <option value="general">General</option>
              <option value="update">Update</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Description *</label
            >
            <textarea
              id="createDescription"
              rows="5"
              maxlength="500"
              placeholder="Enter announcement description"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
              oninput="updateCharCount('createDescription', 'createDescCharCount', 500)"
            ></textarea>
            <div id="createDescCharCount" class="char-counter">
              0/500 characters
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Image (Optional, Max 5MB)</label
            >
            <input
              type="file"
              id="createImage"
              accept="image/*"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
              onchange="openCropperModal(event, 'create')"
            />
            <p class="text-xs text-gray-500 mt-1">
              Accepted formats: JPG, PNG, GIF
            </p>
          </div>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
          <button
            onclick="closeCreateModal()"
            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
          >
            Cancel
          </button>
          <button
            onclick="postAnnouncement()"
            class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition font-medium"
          >
            Post Announcement
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Announcement Modal -->
    <div
      id="editModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-gray-800">Edit Announcement</h3>
            <button
              onclick="closeEditModal()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Title *</label
            >
            <input
              type="text"
              id="editTitle"
              placeholder="Enter announcement title"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
            />
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Category *</label
            >
            <select
              id="editCategory"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
            >
              <option value="">Select category</option>
              <option value="urgent">Urgent</option>
              <option value="general">General</option>
              <option value="update">Update</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Description *</label
            >
            <textarea
              id="editDescription"
              rows="5"
              maxlength="500"
              placeholder="Enter announcement description"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
              oninput="updateCharCount('editDescription', 'editDescCharCount', 500)"
            ></textarea>
            <div id="editDescCharCount" class="char-counter">
              0/500 characters
            </div>
          </div>
          <!-- Current Image Preview - Clickable to change -->
          <div>
            <label id="editImageLabel" class="block text-sm font-semibold text-gray-700 mb-2">Image (Click to change)</label>
            <div
              id="editCurrentImageContainer"
              class="relative w-full h-48 bg-gray-100 rounded-lg overflow-hidden cursor-pointer group border-2 border-dashed border-gray-300 hover:border-[#2f6e4e] transition-colors"
              onclick="document.getElementById('editImage').click()"
            >
              <!-- Image preview -->
              <img id="editCurrentImage" src="" alt="Current announcement image" class="w-full h-full object-cover hidden" />

              <!-- Placeholder when no image -->
              <div id="editImagePlaceholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-sm font-medium">Click to add image</span>
              </div>

              <!-- Hover overlay -->
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                <div class="bg-white rounded-full p-3 shadow-lg">
                  <svg class="w-6 h-6 text-[#2f6e4e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
              </div>
            </div>
            <!-- Hidden file input -->
            <input
              type="file"
              id="editImage"
              accept="image/*"
              class="hidden"
              onchange="openCropperModal(event, 'edit')"
            />
            <p class="text-xs text-gray-500 mt-2">Click the image area to select a new image (Max 5MB)</p>
          </div>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
          <button
            onclick="closeEditModal()"
            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
          >
            Cancel
          </button>
          <button
            onclick="saveEdit()"
            class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition font-medium"
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- View Announcement Modal -->
    <div
      id="viewModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between mb-3">
            <span
              id="viewCategory"
              class="px-3 py-1 bg-red-100 text-red-700 text-xs font-medium rounded-full"
              >urgent</span
            >
            <button
              onclick="closeViewModal()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <h3 class="text-2xl font-bold text-gray-800" id="viewTitle">
            Announcement Details
          </h3>
        </div>
        <div class="p-6 space-y-4">
          <div
            id="viewImage"
            class="h-64 bg-gradient-to-br from-orange-400 to-orange-500 rounded-lg flex items-center justify-center"
          >
            <svg
              class="w-24 h-24 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Date Posted</label
            >
            <p id="viewDate" class="text-gray-600">November 18, 2025</p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Description</label
            >
            <p id="viewDescription" class="text-gray-600">
              Full announcement description will appear here...
            </p>
          </div>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end">
          <button
            onclick="closeViewModal()"
            class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      id="deleteModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6">
          <div
            class="flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4"
          >
            <svg
              class="w-6 h-6 text-red-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-800 text-center mb-2">
            Delete Announcement?
          </h3>
          <p class="text-gray-600 text-center mb-6">
            This action cannot be undone. Are you sure you want to permanently
            delete this announcement?
          </p>
          <div class="flex space-x-3">
            <button
              onclick="closeDeleteModal()"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
            >
              Cancel
            </button>
            <button
              onclick="deleteAnnouncement()"
              class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Modal - Injected by NotificationModal.js component -->

    <!-- Budget Edit Modal -->
    <div
      id="budgetEditModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-gray-800">
              Edit Budget Allocation
            </h3>
            <button
              onclick="closeBudgetEditModal()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="p-6">
          <!-- Instructions -->
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-start">
              <svg
                class="w-5 h-5 text-blue-600 mt-0.5 mr-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <div>
                <p class="text-sm font-semibold text-blue-900 mb-1">
                  Important Information
                </p>
                <p class="text-xs text-blue-800">
                  This budget allocation will be displayed on the
                  <strong>Dashboard homepage</strong> in the "Transparency &
                  Budget Reports" section. You can add or remove budget
                  categories, and the breakdown will be shown to all visitors
                  for full transparency on how barangay funds are utilized
                  throughout the year.
                </p>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <!-- Year Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Budget Year</label
              >
              <input
                type="number"
                id="editBudgetYear"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
                min="2020"
                max="2030"
              />
            </div>

            <!-- Budget Categories Container -->
            <div>
              <div class="flex items-center justify-between mb-3">
                <label class="block text-sm font-medium text-gray-700"
                  >Budget Categories</label
                >
                <button
                  onclick="addBudgetCategory()"
                  type="button"
                  class="text-sm text-[#2f6e4e] hover:text-[#2f6e4e] font-medium flex items-center"
                >
                  <svg
                    class="w-4 h-4 mr-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    ></path>
                  </svg>
                  Add Category
                </button>
              </div>

              <div id="budgetCategoriesContainer" class="space-y-3">
                <!-- Categories will be dynamically rendered here -->
              </div>
            </div>

            <!-- Total Budget Display -->
            <div
              class="pt-4 border-t border-gray-200 flex justify-between items-center"
            >
              <span class="text-lg font-bold text-gray-800">Total Budget</span>
              <span
                class="text-2xl font-bold text-blue-600"
                id="editTotalBudget"
                >₱0</span
              >
            </div>
          </div>
        </div>

        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
          <button
            onclick="closeBudgetEditModal()"
            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
          >
            Cancel
          </button>
          <button
            onclick="saveBudgetAllocation()"
            class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition font-medium"
          >
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- ProfileModal component will be dynamically rendered here -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10001] flex items-center justify-center">
      <div class="bg-white rounded-xl shadow-2xl p-6 flex items-center gap-4">
        <div class="spinner" style="border-top-color: #2f6e4e; width: 24px; height: 24px;"></div>
        <span class="text-gray-800 font-medium">Uploading image...</span>
      </div>
    </div>

    <!-- Image Cropper Modal -->
    <div id="cropperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-2xl font-bold text-gray-800">Crop Image</h3>
        </div>
        <div class="p-6">
          <div class="img-container max-h-[50vh]">
            <img id="imageToCrop" src="" alt="Image to crop" />
          </div>
        </div>
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
          <button onclick="closeCropperModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">
            Cancel
          </button>
          <button onclick="cropAndUploadImage()" class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition font-medium">
            Crop & Upload
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      // Import components
      import { NotificationModal } from "./js/components/NotificationModal.js";
      import { ProfileModal } from "./js/components/ProfileModal.js";

      console.log("[SK DASHBOARD] Script loaded - starting execution");
      console.log(
        "[SK DASHBOARD] SessionManager available:",
        typeof SessionManager !== "undefined"
      );

      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;
      console.log("[SK DASHBOARD] NotificationModal component initialized");

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;
      console.log("[SK DASHBOARD] ProfileModal component initialized");

      // Global variables
      let currentAnnouncementId = null;
      let currentUser = null;
      let currentUserData = null;
      let cropper = null;
      let currentFile = null;
      let currentModal = '';
      let pendingEditImageBlob = null; // Store cropped image for edit modal

      /**
       * Initialize session and authentication
       * Load all dashboard data in parallel for efficiency
       *
       * @async
       * @returns {Promise<void>}
       */
      async function initializeDashboard() {
        console.log("[SK DASHBOARD] initializeDashboard() function called");
        try {
          console.log("[SK DASHBOARD] Inside try block - Initializing...");

          // Require authentication - only SK_OFFICIAL allowed
          console.log("[SK DASHBOARD] Checking authentication...");
          const sessionResult = await SessionManager.requireAuth([
            "SK_OFFICIAL",
          ]);

          console.log("[SK DASHBOARD] Session result:", sessionResult);

          if (!sessionResult.success) {
            console.error(
              "[SK DASHBOARD ERROR] Authentication failed:",
              sessionResult.error
            );
            return; // Session manager handles redirect
          }

          console.log("[SK DASHBOARD] Authentication successful!");
          console.log("[SK DASHBOARD] User role:", sessionResult.role);
          console.log("[SK DASHBOARD] User data:", sessionResult.userData);

          currentUser = sessionResult.user;
          currentUserData = sessionResult.userData;

          // Update user profile in header
          updateUserProfile();

          // Load user profile data into ProfileModal component
          await profileModal.loadUserData(currentUser, currentUserData);

          // EFFICIENCY: Load dashboard data in parallel
          await Promise.all([loadAnnouncements(), loadDashboardStatistics()]);

          // TODO: Load notifications after authentication completes
          // loadSKNotifications();
          // updateNotificationCount();

          console.log("[SK DASHBOARD] Initialized successfully!");
        } catch (error) {
          console.error("[SK DASHBOARD ERROR] Initialization error:", error);
          console.error(
            "[SK DASHBOARD ERROR] Error details:",
            error.message,
            error.stack
          );
          SessionManager.redirectToLogin("Failed to initialize dashboard");
        }
      }
      
      // Cropper Modal Functions
      function openCropperModal(event, modalType) {
        currentFile = event.target.files[0];
        if (!currentFile) return;

        const validation = validateImageFile(currentFile);
        if (!validation.valid) {
          showToast(validation.error, "error");
          event.target.value = ''; // Reset file input
          return;
        }

        currentModal = modalType;
        const reader = new FileReader();
        reader.onload = (e) => {
          const image = document.getElementById('imageToCrop');
          image.src = e.target.result;
          document.getElementById('cropperModal').classList.remove('hidden');
          
          if (cropper) {
            cropper.destroy();
          }
          cropper = new Cropper(image, {
            aspectRatio: 16 / 9,
            viewMode: 1,
          });
        };
        reader.readAsDataURL(currentFile);
      }

      function closeCropperModal() {
        document.getElementById('cropperModal').classList.add('hidden');
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        // Reset file input
        const createImageInput = document.getElementById('createImage');
        if (createImageInput) createImageInput.value = '';
        const editImageInput = document.getElementById('editImage');
        if (editImageInput) editImageInput.value = '';
      }

      function cropAndUploadImage() {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
          width: 1280,
          height: 720,
        });

        canvas.toBlob((blob) => {
          if (currentModal === 'create') {
            postAnnouncement(blob);
          } else if (currentModal === 'edit') {
            // Store the blob for later and show preview in edit modal
            pendingEditImageBlob = blob;

            // Create a temporary URL to show the cropped image preview
            const previewUrl = URL.createObjectURL(blob);
            const currentImage = document.getElementById("editCurrentImage");
            const placeholder = document.getElementById("editImagePlaceholder");
            const imageLabel = document.getElementById("editImageLabel");

            if (currentImage) {
              currentImage.src = previewUrl;
              currentImage.classList.remove("hidden");
            }
            if (placeholder) {
              placeholder.classList.add("hidden");
            }
            if (imageLabel) {
              imageLabel.textContent = "New Image (Cropped)";
              imageLabel.classList.add("text-green-600");
            }

            showToast("Image cropped! Click 'Save Changes' to update.", "success");
          }
          closeCropperModal();
        }, 'image/jpeg', 0.9);
      }


      // Update user profile in header
      function updateUserProfile() {
        if (!currentUserData) return;

        const nameElement = document.querySelector(
          "header p.text-sm.font-medium"
        );
        const roleElement = document.querySelector(
          "header p.text-xs.text-gray-500"
        );
        const avatarElement = document.querySelector("header .w-10.h-10");

        if (nameElement) {
          const fullName = `${currentUserData.firstName} ${
            currentUserData.middleName || ""
          } ${currentUserData.lastName}`
            .trim()
            .replace(/\s+/g, " ");
          nameElement.textContent = fullName;
        }

        if (roleElement) {
          roleElement.textContent = "SK Official";
        }

        if (avatarElement) {
          // SECURITY: Sanitize profile picture URL
          const safeProfileUrl = sanitizeImageURL(currentUserData.imagePathURL);
          if (safeProfileUrl) {
            // Display profile picture with sanitized URL
            avatarElement.innerHTML = `<img src="${safeProfileUrl}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='<span class=\\'text-white font-semibold\\'>${escapeHTML(currentUserData.firstName?.charAt(0) || '')}${escapeHTML(currentUserData.lastName?.charAt(0) || '')}</span>'.toUpperCase();" />`;
          } else {
            // Display initials
            const initials = `${currentUserData.firstName?.charAt(0) || ''}${currentUserData.lastName?.charAt(0) || ''}`.toUpperCase();
            avatarElement.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Listen for profile updates from ProfileModal
      window.addEventListener('profileUpdated', (event) => {
        const profile = event.detail;

        // Update currentUserData with new values
        if (currentUserData) {
          currentUserData.firstName = profile.firstName;
          currentUserData.middleName = profile.middleName || '';
          currentUserData.lastName = profile.lastName;
          currentUserData.address = profile.address;
          currentUserData.contactNumber = profile.contact;
          currentUserData.birthday = profile.birthday;
          currentUserData.gender = profile.gender;
          if (profile.profilePicture) {
            currentUserData.imagePathURL = profile.profilePicture;
          }
        }

        // Update header UI
        updateUserProfile();
      });

      // Call init on page load - wrapped in DOMContentLoaded to ensure DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          console.log("[SK DASHBOARD] DOM loaded, calling initializeDashboard()");
          initializeDashboard();
        });
      } else {
        // DOM already loaded
        console.log("[SK DASHBOARD] DOM already loaded, calling initializeDashboard()");
        initializeDashboard();
      }

      // ============================================
      // DEBUG: Production-safe logging utility
      // Set DEBUG_MODE to false in production
      // ============================================
      const DEBUG_MODE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

      const debug = {
        log: (...args) => DEBUG_MODE && console.log('[SK-DASHBOARD]', ...args),
        warn: (...args) => DEBUG_MODE && console.warn('[SK-DASHBOARD]', ...args),
        error: (...args) => console.error('[SK-DASHBOARD]', ...args), // Always log errors
      };

      // ============================================
      // SECURITY: XSS Prevention Helper
      // ============================================
      /**
       * Escape HTML to prevent XSS attacks
       * @param {string} unsafe - Unsafe string from user input or database
       * @returns {string} - Safe HTML string
       */
      function escapeHTML(unsafe) {
        if (typeof unsafe !== "string") return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      /**
       * SECURITY: Validate and sanitize image URLs
       * Only allows https URLs and Supabase storage URLs
       * @param {string} url - URL to validate
       * @returns {string} - Safe URL or empty string
       */
      function sanitizeImageURL(url) {
        if (!url || typeof url !== "string") return "";

        // Trim and check for empty
        const trimmedUrl = url.trim();
        if (!trimmedUrl) return "";

        // Only allow https:// URLs (block javascript:, data:, etc.)
        if (!trimmedUrl.startsWith("https://")) {
          console.warn("⚠️ Blocked non-HTTPS image URL:", trimmedUrl.substring(0, 50));
          return "";
        }

        // Validate URL format
        try {
          const parsedUrl = new URL(trimmedUrl);
          // Only allow specific trusted domains
          const allowedDomains = [
            "supabase.co",
            "supabase.com",
            // Add other trusted image hosts if needed
          ];

          const isAllowedDomain = allowedDomains.some(domain =>
            parsedUrl.hostname.endsWith(domain)
          );

          if (!isAllowedDomain) {
            console.warn("⚠️ Image URL from untrusted domain:", parsedUrl.hostname);
            // Still allow but log - remove this return to block untrusted domains
          }

          return trimmedUrl;
        } catch (e) {
          console.warn("⚠️ Invalid image URL format:", trimmedUrl.substring(0, 50));
          return "";
        }
      }

      // ============================================
      // SECURITY: File Upload Validation
      // ============================================
      /**
       * Validate and sanitize image uploads
       * Checks MIME type (not just extension), file size, and type matching
       *
       * @param {File} file - File object to validate
       * @returns {Object} - {valid: boolean, error: string}
       */
      function validateImageFile(file) {
        // Allowed MIME types (more reliable than file extension)
        const allowedTypes = [
          "image/jpeg",
          "image/jpg",
          "image/png",
          "image/gif",
          "image/webp",
        ];
        const maxSize = 5 * 1024 * 1024; // 5MB

        // Debug logging
        console.log("📎 Validating file:", {
          name: file.name,
          type: file.type,
          size: `${(file.size / 1024 / 1024).toFixed(2)} MB`,
          extension: file.name.split(".").pop().toLowerCase(),
        });

        // Check MIME type
        if (!allowedTypes.includes(file.type)) {
          const error = `Invalid file type: ${file.type}. Only JPG, PNG, GIF, and WebP images are allowed`;
          console.error("❌", error);
          return { valid: false, error: error };
        }

        // Check file size
        if (file.size > maxSize) {
          const error = `Image size (${(file.size / 1024 / 1024).toFixed(
            2
          )} MB) exceeds 5MB limit`;
          console.error("❌", error);
          return { valid: false, error: error };
        }

        // Check file extension matches MIME type (prevent spoofing)
        const extension = file.name.split(".").pop().toLowerCase();
        const mimeExtension = file.type.split("/")[1].replace("jpeg", "jpg");

        if (
          extension !== mimeExtension &&
          !(extension === "jpg" && mimeExtension === "jpeg")
        ) {
          const error = `File extension (.${extension}) does not match MIME type (${file.type})`;
          console.error("❌", error);
          return { valid: false, error: error };
        }

        console.log("✅ File validation passed");
        return { valid: true };
      }

      // Announcement data - loaded from Supabase
      let announcementsArray = [];
      let announcements = {};

      // EFFICIENCY: Maximum announcements to load (prevents loading too many records)
      const MAX_ANNOUNCEMENTS = 100;

      /**
       * Load announcements from Supabase database
       * Filters for ACTIVE content and orders by published date
       * Uses DB-level limit to prevent loading excessive records
       *
       * @async
       * @returns {Promise<void>}
       */
      async function loadAnnouncements() {
        try {
          // EFFICIENCY: Use .limit() to prevent loading too many records
          const { data, error } = await supabaseClient
            .from("Announcement_Tbl")
            .select("*")
            .order("publishedDate", { ascending: false })
            .limit(MAX_ANNOUNCEMENTS);

          if (error) throw error;

          if (data && data.length > 0) {
            console.log("📥 Raw data from database:", data);

            // Convert to the format expected by the UI
            announcementsArray = data.map((announcement) => ({
              id: announcement.announcementID,
              title: announcement.title,
              date: formatRelativeDate(announcement.publishedDate),
              category: announcement.category.toLowerCase(),
              description:
                announcement.description || "No description available",
              image: announcement.imagePathURL || "",
              rawDate: announcement.publishedDate,
            }));

            // Create object format for viewAnnouncement function
            announcements = {};
            announcementsArray.forEach((ann) => {
              announcements[ann.id] = ann;
            });

            console.log("📦 Processed announcements object:", announcements);
            console.log("📋 Announcements array:", announcementsArray);

            // Render announcements after loading
            renderAnnouncements();
            updateAnnouncementPagination();

            console.log(`✅ Loaded ${announcementsArray.length} announcements`);
          } else {
            console.log("No announcements found");
            announcementsArray = [];
            renderAnnouncements();
          }
        } catch (error) {
          console.error("Error loading announcements:", error);
          showToast(
            "Failed to load announcements. Please refresh the page.",
            "error"
          );
          announcementsArray = [];
          renderAnnouncements();
        }
      }

      /**
       * Load dashboard statistics from Supabase
       * Uses count queries for efficiency (doesn't load full data)
       * Loads all stats in parallel for performance
       *
       * @async
       * @returns {Promise<void>}
       */
      async function loadDashboardStatistics() {
        try {
          console.log("📊 Loading dashboard statistics...");

          // EFFICIENCY: Load all counts in parallel using Promise.all
          const [
            filesResult,
            announcementsResult,
            projectsResult,
            volunteersResult,
          ] = await Promise.all([
            // Total active files
            supabaseClient
              .from("File_Tbl")
              .select("*", { count: "exact", head: true })
              .eq("fileStatus", "ACTIVE"),

            // Total announcements
            supabaseClient
              .from("Announcement_Tbl")
              .select("*", { count: "exact", head: true }),

            // Active/ongoing projects
            supabaseClient
              .from("Pre_Project_Tbl")
              .select("*", { count: "exact", head: true })
              .eq("status", "ONGOING"),

            // Active youth volunteers
            supabaseClient
              .from("User_Tbl")
              .select("*", { count: "exact", head: true })
              .eq("role", "YOUTH_VOLUNTEER")
              .eq("accountStatus", "ACTIVE"),
          ]);

          // Check for errors
          if (filesResult.error) throw new Error("Failed to load files count");
          if (announcementsResult.error)
            throw new Error("Failed to load announcements count");
          if (projectsResult.error)
            throw new Error("Failed to load projects count");
          if (volunteersResult.error)
            throw new Error("Failed to load volunteers count");

          // Update DOM with counts (fallback to 0 if null)
          const totalFiles = filesResult.count ?? 0;
          const totalAnnouncements = announcementsResult.count ?? 0;
          const activeProjects = projectsResult.count ?? 0;
          const totalVolunteers = volunteersResult.count ?? 0;

          // RELIABLE: Safe DOM updates with null checks
          const filesElement = document.getElementById("totalFiles");
          const announcementsElement =
            document.getElementById("totalAnnouncements");
          const projectsElement = document.getElementById("activeProjects");
          const volunteersElement = document.getElementById("totalVolunteers");

          if (filesElement) filesElement.textContent = totalFiles;
          if (announcementsElement)
            announcementsElement.textContent = totalAnnouncements;
          if (projectsElement) projectsElement.textContent = activeProjects;
          if (volunteersElement)
            volunteersElement.textContent = totalVolunteers;

          console.log(" Statistics loaded:", {
            files: totalFiles,
            announcements: totalAnnouncements,
            projects: activeProjects,
            volunteers: totalVolunteers,
          });
        } catch (error) {
          console.error("Error loading dashboard statistics:", error);

          // RELIABLE: Show 0 instead of leaving loading animation on error
          const defaultElements = [
            "totalFiles",
            "totalAnnouncements",
            "activeProjects",
            "totalVolunteers",
          ];
          defaultElements.forEach((id) => {
            const element = document.getElementById(id);
            if (element) element.textContent = "0";
          });

          // Don't show error toast for statistics (non-critical feature)
          console.warn("⚠️ Statistics unavailable, showing default values");
        }
      }

      // Format date to relative format (e.g., "2 days ago")
      function formatRelativeDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        // Less than 1 minute
        if (diffSec < 60) {
          return "Just now";
        }
        // Less than 1 hour
        else if (diffMin < 60) {
          return `${diffMin} ${diffMin === 1 ? "minute" : "minutes"} ago`;
        }
        // Less than 24 hours
        else if (diffHour < 24) {
          return `${diffHour} ${diffHour === 1 ? "hour" : "hours"} ago`;
        }
        // Less than 7 days
        else if (diffDay < 7) {
          return diffDay === 1 ? "Yesterday" : `${diffDay} days ago`;
        }
        // Less than 30 days
        else if (diffDay < 30) {
          const weeks = Math.floor(diffDay / 7);
          return `${weeks} ${weeks === 1 ? "week" : "weeks"} ago`;
        }
        // Less than 365 days
        else if (diffDay < 365) {
          const months = Math.floor(diffDay / 30);
          return `${months} ${months === 1 ? "month" : "months"} ago`;
        }
        // 365+ days
        else {
          const years = Math.floor(diffDay / 365);
          return `${years} ${years === 1 ? "year" : "years"} ago`;
        }
      }

      // Pagination variables
      let currentAnnouncementPage = 0;
      const announcementsPerPage = 3;

      // Add activity log entry
      function addActivityLog(action, itemName) {
        // In a real application, this would send to the backend
        console.log(`Activity Log: SK Official ${action} - "${itemName}"`);
      }

      // Render announcements with pagination
      function renderAnnouncements() {
        const grid = document.getElementById("announcementsGrid");
        grid.innerHTML = "";

        const startIndex = currentAnnouncementPage * announcementsPerPage;
        const endIndex = startIndex + announcementsPerPage;
        const announcementsToShow = announcementsArray.slice(
          startIndex,
          endIndex
        );

        announcementsToShow.forEach((announcement) => {
          const categoryColors = {
            urgent: {
              badge: "bg-red-100 text-red-700",
              gradient: "from-orange-400 to-orange-500",
              icon: `<svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            },
            general: {
              badge: "bg-blue-100 text-blue-700",
              gradient: "from-blue-400 to-blue-500",
              icon: `<svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`,
            },
            update: {
              badge: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
              gradient: "from-green-400 to-green-500",
              icon: `<svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            },
          };

          const colors =
            categoryColors[announcement.category] || categoryColors.general;

          const card = document.createElement("div");
          card.className =
            "border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition flex flex-col";

          // SECURITY: Validate and sanitize image URL
          const safeImageUrl = sanitizeImageURL(announcement.image);
          const hasImage = safeImageUrl !== '';

          const imageHtml = hasImage
            ? `<img src="${safeImageUrl}" alt="${escapeHTML(announcement.title)}" class="w-full h-32 object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
               <div class="h-32 bg-gradient-to-br ${colors.gradient} flex items-center justify-center" style="display: none;">
                 ${colors.icon}
               </div>`
            : `<div class="h-32 bg-gradient-to-br ${colors.gradient} flex items-center justify-center">
                 ${colors.icon}
               </div>`;

          // SECURITY: Use escapeHTML() to prevent XSS attacks
          card.innerHTML = `
            ${imageHtml}
            <div class="p-5 flex flex-col flex-1">
              <div class="flex items-center justify-between mb-3">
                <span class="px-3 py-1 ${
                  colors.badge
                } text-xs font-medium rounded-full">${escapeHTML(
            announcement.category
          )}</span>
                <span class="text-xs text-gray-500">${escapeHTML(
                  announcement.date
                )}</span>
              </div>
              <h4 class="text-lg font-bold text-gray-800 mb-2">${escapeHTML(
                announcement.title
              )}</h4>
              <p class="announcement-description text-sm text-gray-600 mb-4">${escapeHTML(
                announcement.description
              )}</p>
              <div class="flex justify-end mt-auto">
                <div class="flex space-x-2">
                  <button onclick="viewAnnouncement(${
                    announcement.id
                  })" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="View">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                  </button>
                  <button onclick="openEditModal(${
                    announcement.id
                  })" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Edit">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  </button>
                  <button onclick="confirmDelete(${
                    announcement.id
                  })" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });

        updateAnnouncementPagination();
      }

      // Update announcement pagination controls
      function updateAnnouncementPagination() {
        const totalPages = Math.ceil(
          announcementsArray.length / announcementsPerPage
        );
        const dotsContainer = document.getElementById(
          "announcementPaginationDots"
        );
        const navContainer = document.getElementById(
          "announcementPaginationNav"
        );

        if (totalPages <= 1) {
          dotsContainer.classList.add("hidden");
          navContainer.classList.add("hidden");
          return;
        }

        dotsContainer.classList.remove("hidden");
        navContainer.classList.remove("hidden");

        // Create pagination dots
        dotsContainer.innerHTML = Array.from(
          { length: totalPages },
          (_, i) => `
          <button
            onclick="goToAnnouncementPage(${i})"
            class="h-2 rounded-full transition-all duration-300 ${
              i === currentAnnouncementPage
                ? "bg-[#2f6e4e] w-8"
                : "bg-gray-300 hover:bg-gray-400 w-2"
            }"
            style="min-height: 8px;"
          ></button>
        `
        ).join("");
      }

      // Navigate announcements
      function navigateAnnouncements(direction) {
        const totalPages = Math.ceil(
          announcementsArray.length / announcementsPerPage
        );
        currentAnnouncementPage += direction;

        // Wrap around
        if (currentAnnouncementPage < 0)
          currentAnnouncementPage = totalPages - 1;
        if (currentAnnouncementPage >= totalPages) currentAnnouncementPage = 0;

        renderAnnouncements();
      }

      // Go to specific announcement page
      function goToAnnouncementPage(pageIndex) {
        currentAnnouncementPage = pageIndex;
        renderAnnouncements();
      }

      // Create Announcement Modal
      function openCreateModal() {
        document.getElementById("createModal").classList.remove("hidden");
      }

      function closeCreateModal() {
        document.getElementById("createModal").classList.add("hidden");
        document.getElementById("createTitle").value = "";
        document.getElementById("createCategory").value = "";
        document.getElementById("createDescription").value = "";
        document.getElementById("createImage").value = "";
      }

      async function postAnnouncement(imageBlob = null) {
        const titleInput = document.getElementById("createTitle");
        const categoryInput = document.getElementById("createCategory");
        const descriptionInput = document.getElementById("createDescription");

        const title = titleInput.value.trim();
        const category = categoryInput.value;
        const description = descriptionInput.value.trim();

        // Validate required fields
        if (!title) {
          showToast("Please enter a title", "error");
          return;
        }
        if (!category) {
          showToast("Please select a category", "error");
          return;
        }
        if (!description) {
          showToast("Please enter a description", "error");
          return;
        }

        document.getElementById('loadingOverlay').classList.remove('hidden');
        const button = document.querySelector('#createModal button[onclick="postAnnouncement()"]');
        const originalButtonText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          let imagePath = null;

          // Only upload image if provided
          if (imageBlob) {
            const fileExt = 'jpeg';
            const fileName = `announcement_${Date.now()}.${fileExt}`;

            console.log("📤 Uploading cropped image to announcement-images bucket:", fileName);

            const { data: uploadData, error: uploadError } =
              await supabaseClient.storage
                .from("announcement-images")
                .upload(fileName, imageBlob, {
                  cacheControl: "3600",
                  upsert: false,
                  contentType: 'image/jpeg',
                });

            if (uploadError) {
              console.error("❌ Upload error:", uploadError);
              throw new Error(`Image upload failed: ${uploadError.message}`);
            }

            console.log("✅ Upload successful:", uploadData);

            const { data: urlData } = supabaseClient.storage
              .from("announcement-images")
              .getPublicUrl(fileName);

            console.log("🔗 Public URL:", urlData.publicUrl);

            imagePath = urlData.publicUrl;
          }

          const { data, error } = await supabaseClient
            .from("Announcement_Tbl")
            .insert({
              userID: currentUser.id,
              title: title,
              category: category.toUpperCase(),
              description: description,
              imagePathURL: imagePath,
              publishedDate: new Date().toISOString(),
            })
            .select();

          if (error) throw error;

          showToast("Announcement posted successfully!", "success");
          closeCreateModal();
          await Promise.all([loadAnnouncements(), loadDashboardStatistics()]);

        } catch (error) {
          console.error("Error posting announcement:", error);
          showToast(error.message, "error");
        } finally {
          document.getElementById('loadingOverlay').classList.add('hidden');
          button.disabled = false;
          button.innerHTML = originalButtonText;
        }
      }

      // Edit Announcement Modal
      function openEditModal(id) {
        currentAnnouncementId = id;
        const announcement = announcements[id];

        console.log("🔍 Opening edit modal for ID:", id);
        console.log("📋 Announcement data:", announcement);
        console.log("📦 All announcements:", announcements);

        if (!announcement) {
          showToast(
            "Announcement not found. Please refresh the page.",
            "error"
          );
          return;
        }

        const titleInput = document.getElementById("editTitle");
        const categoryInput = document.getElementById("editCategory");
        const descriptionInput = document.getElementById("editDescription");

        titleInput.value = announcement.title;
        categoryInput.value = announcement.category || "";
        descriptionInput.value = announcement.description;

        // Update character count
        updateCharCount("editDescription", "editDescCharCount", 500);

        // Clear any previous validation states
        setInputState(titleInput, null);
        setInputState(categoryInput, null);
        setInputState(descriptionInput, null);

        // Reset pending image blob
        pendingEditImageBlob = null;

        // Show current image preview if exists
        const currentImage = document.getElementById("editCurrentImage");
        const placeholder = document.getElementById("editImagePlaceholder");
        const imageLabel = document.getElementById("editImageLabel");

        // Reset label text and style
        if (imageLabel) {
          imageLabel.textContent = "Image (Click to change)";
          imageLabel.classList.remove("text-green-600");
        }

        if (announcement.image) {
          currentImage.src = announcement.image;
          currentImage.classList.remove("hidden");
          placeholder.classList.add("hidden");
        } else {
          currentImage.classList.add("hidden");
          placeholder.classList.remove("hidden");
        }

        // Clear file input
        document.getElementById("editImage").value = "";

        document.getElementById("editModal").classList.remove("hidden");
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.add("hidden");
        currentAnnouncementId = null;
        pendingEditImageBlob = null; // Clear pending image
      }

      /**
       * Save edited announcement to Supabase
       * Updates existing announcement with new data and optionally new image
       *
       * @async
       * @returns {Promise<void>}
       */
      async function saveEdit() {
        const titleInput = document.getElementById("editTitle");
        const categoryInput = document.getElementById("editCategory");
        const descriptionInput = document.getElementById("editDescription");

        const title = titleInput.value.trim();
        const category = categoryInput.value;
        const description = descriptionInput.value.trim();

        // Validate required fields
        if (!title) {
          showToast("Please enter a title", "error");
          return;
        }
        if (!category) {
          showToast("Please select a category", "error");
          return;
        }
        if (!description) {
          showToast("Please enter a description", "error");
          return;
        }

        document.getElementById('loadingOverlay').classList.remove('hidden');
        const button = document.querySelector('#editModal button[onclick="saveEdit()"]');
        const originalButtonText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          let imagePath = announcements[currentAnnouncementId].image; // Keep existing image by default

          // Use pending cropped image if available
          const imageBlob = pendingEditImageBlob;

          if (imageBlob) {
            const fileExt = 'jpeg';
            const fileName = `announcement_${Date.now()}.${fileExt}`;

            console.log("📤 Uploading cropped image to announcement-images bucket:", fileName);

            const { data: uploadData, error: uploadError } =
              await supabaseClient.storage
                .from("announcement-images")
                .upload(fileName, imageBlob, {
                  cacheControl: "3600",
                  upsert: false,
                  contentType: 'image/jpeg',
                });

            if (uploadError) {
              console.error("❌ Upload error:", uploadError);
              throw new Error(`Image upload failed: ${uploadError.message}`);
            }

            console.log("✅ Upload successful:", uploadData);

            const { data: urlData } = supabaseClient.storage
              .from("announcement-images")
              .getPublicUrl(fileName);

            console.log("🔗 Public URL:", urlData.publicUrl);

            imagePath = urlData.publicUrl;
          }

          const { data, error } = await supabaseClient
            .from("Announcement_Tbl")
            .update({
              title: title,
              category: category.toUpperCase(),
              description: description,
              imagePathURL: imagePath,
              updatedAt: new Date().toISOString(),
            })
            .eq("announcementID", currentAnnouncementId);

          if (error) throw error;

          showToast("Announcement updated successfully!", "success");
          closeEditModal();
          await Promise.all([loadAnnouncements(), loadDashboardStatistics()]);

        } catch (error) {
          console.error("Error updating announcement:", error);
          showToast(error.message, "error");
        } finally {
          document.getElementById('loadingOverlay').classList.add('hidden');
          button.disabled = false;
          button.innerHTML = originalButtonText;
        }
      }

      /**
       * View announcement details in modal
       * Uses textContent for XSS protection
       *
       * @param {number} id - Announcement ID
       * @returns {void}
       */
      function viewAnnouncement(id) {
        const announcement = announcements[id];

        // SECURITY: Using textContent (not innerHTML) to prevent XSS
        document.getElementById("viewTitle").textContent = announcement.title;
        document.getElementById("viewDescription").textContent =
          announcement.description;
        document.getElementById("viewDate").textContent = announcement.date;

        // Update category badge with proper styling
        const categoryBadge = document.getElementById("viewCategory");
        categoryBadge.textContent = announcement.category;

        // Remove all category classes
        categoryBadge.className = "px-3 py-1 text-xs font-medium rounded-full";

        // Add category-specific classes
        if (announcement.category === "urgent") {
          categoryBadge.classList.add("bg-red-100", "text-red-700");
        } else if (announcement.category === "general") {
          categoryBadge.classList.add("bg-blue-100", "text-blue-700");
        } else if (announcement.category === "update") {
          categoryBadge.classList.add("bg-[#2f6e4e]/20", "text-[#2f6e4e]");
        }

        // Update image display
        const viewImageDiv = document.getElementById("viewImage");
        // SECURITY: Sanitize image URL to prevent XSS
        const safeImageUrl = sanitizeImageURL(announcement.image);
        const hasImage = safeImageUrl !== '';

        if (hasImage) {
          // Show actual image with sanitized URL
          viewImageDiv.innerHTML = `<img src="${safeImageUrl}" alt="${escapeHTML(announcement.title)}" class="w-full h-64 object-cover rounded-lg" onerror="this.style.display='none';" />`;
        } else {
          // Show placeholder icon
          const gradientColors = {
            urgent: "from-orange-400 to-orange-500",
            general: "from-blue-400 to-blue-500",
            update: "from-green-400 to-green-500"
          };
          const gradient = gradientColors[announcement.category] || gradientColors.general;

          viewImageDiv.innerHTML = `
            <div class="h-64 bg-gradient-to-br ${gradient} rounded-lg flex items-center justify-center">
              <svg class="w-24 h-24 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
          `;
        }

        document.getElementById("viewModal").classList.remove("hidden");
      }

      function closeViewModal() {
        document.getElementById("viewModal").classList.add("hidden");
      }

      // Delete Announcement
      function confirmDelete(id) {
        currentAnnouncementId = id;
        console.log("🗑️ Confirming delete for ID:", id);
        console.log("📋 Announcement to delete:", announcements[id]);

        if (!announcements[id]) {
          showToast(
            "Announcement not found. Please refresh the page.",
            "error"
          );
          return;
        }

        document.getElementById("deleteModal").classList.remove("hidden");
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
        currentAnnouncementId = null;
      }

      /**
       * Delete announcement from Supabase
       * Sets contentstatus to 'ARCHIVED' (soft delete) instead of hard delete
       *
       * @async
       * @returns {Promise<void>}
       */
      async function deleteAnnouncement() {
        const announcement = announcements[currentAnnouncementId];

        console.log("🗑️ Deleting announcement with ID:", currentAnnouncementId);
        console.log("📋 Announcement details:", announcement);

        // Show loading state on delete button
        const deleteButton = document.querySelector(
          '#deleteModal button[onclick="deleteAnnouncement()"]'
        );
        const originalText = deleteButton ? deleteButton.innerHTML : 'Delete';

        if (deleteButton) {
          deleteButton.disabled = true;
          deleteButton.innerHTML = '<div class="spinner mx-auto"></div>';
        }

        try {
          // HARD DELETE: Permanently remove announcement from database
          console.log(
            "📤 Sending delete request to database for announcementID:",
            currentAnnouncementId
          );
          const { data, error } = await supabaseClient
            .from("Announcement_Tbl")
            .delete()
            .eq("announcementID", currentAnnouncementId);

          if (error) throw error;

          console.log("✅ Announcement deleted successfully");
          showToast("Announcement deleted successfully!", "success");

          // RELIABILITY: Reload announcements to reflect changes immediately
          await loadAnnouncements();

          // Also reload statistics since announcement count changed
          await loadDashboardStatistics();

          closeDeleteModal();
        } catch (error) {
          // SECURITY: Log full error for debugging (console only)
          console.error("Error deleting announcement:", error);

          // Show generic message to user
          showToast(
            "Failed to delete announcement. Please try again.",
            "error"
          );
        } finally {
          // Always reset button state
          if (deleteButton) {
            deleteButton.disabled = false;
            deleteButton.innerHTML = originalText;
          }
        }
      }

      // Toast notification
      // Toast Notification System
      function showToast(message, type = "success") {
        const existingToast = document.querySelector(".toast");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        let icon = "";
        if (type === "success") {
          icon =
            '<svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        } else if (type === "error") {
          icon =
            '<svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        } else if (type === "warning") {
          icon =
            '<svg class="w-6 h-6 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
        } else {
          icon =
            '<svg class="w-6 h-6 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        toast.innerHTML = `
          ${icon}
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-800">${message}</p>
          </div>
          <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        `;

        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add("show"), 10);
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Confirmation modal system
      function showConfirm(
        title,
        message,
        onConfirm,
        confirmButtonText = "Confirm",
        confirmButtonColor = "yellow"
      ) {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const messageEl = document.getElementById("confirmMessage");
        const confirmBtn = document.getElementById("confirmOk");
        const cancelBtn = document.getElementById("confirmCancel");

        titleEl.textContent = title;
        messageEl.textContent = message;
        confirmBtn.textContent = confirmButtonText;

        // Update button colors
        if (confirmButtonColor === "green") {
          confirmBtn.className =
            "flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition font-medium";
        } else if (confirmButtonColor === "red") {
          confirmBtn.className =
            "flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium";
        } else {
          confirmBtn.className =
            "flex-1 px-4 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium";
        }

        modal.classList.remove("hidden");

        const handleConfirm = () => {
          modal.classList.add("hidden");
          onConfirm();
          cleanup();
        };

        const handleCancel = () => {
          modal.classList.add("hidden");
          cleanup();
        };

        const cleanup = () => {
          confirmBtn.removeEventListener("click", handleConfirm);
          cancelBtn.removeEventListener("click", handleCancel);
        };

        confirmBtn.addEventListener("click", handleConfirm);
        cancelBtn.addEventListener("click", handleCancel);

        // Close on click outside
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        });
      }

      // Character counter for textareas
      function updateCharCount(inputId, counterId, maxLength) {
        const input = document.getElementById(inputId);
        const counter = document.getElementById(counterId);
        const currentLength = input.value.length;

        counter.textContent = `${currentLength}/${maxLength} characters`;

        counter.classList.remove("warning", "error");
        if (currentLength >= maxLength) {
          counter.classList.add("error");
        } else if (currentLength >= maxLength * 0.9) {
          counter.classList.add("warning");
        }
      }

      // Input validation helper
      function setInputState(inputElement, isValid) {
        inputElement.classList.remove("input-error", "input-success");
        if (isValid === true) {
          inputElement.classList.add("input-success");
        } else if (isValid === false) {
          inputElement.classList.add("input-error");
        }
      }

      // Old demo notification system removed - now using NotificationModal.js component with Supabase

      // Notification modal functions removed - now handled by NotificationModal.js component

      // Update current date
      function updateCurrentDate() {
        const options = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        const currentDate = new Date().toLocaleDateString("en-US", options);
        const dateElement = document.getElementById("currentDate");
        if (dateElement) {
          dateElement.textContent = currentDate;
        }
      }
      updateCurrentDate();

      // ===========================
      // BUDGET & METRICS MANAGEMENT
      // ===========================

      // Budget data structure (now with dynamic categories)
      let budgetData = {
        year: 2025,
        categories: [
          { id: 1, name: "Youth Development Programs", amount: 450000 },
          { id: 2, name: "Community Events", amount: 300000 },
          { id: 3, name: "Infrastructure Projects", amount: 250000 },
        ],
        history: [],
      };

      // Project metrics data
      let projectMetrics = {
        year: 2025,
        total: 42,
        completed: 38,
        ongoing: 4,
        successRate: 89,
      };

      // Load budget data from localStorage
      function loadBudgetData() {
        const saved = localStorage.getItem("budgetData");
        if (saved) {
          budgetData = JSON.parse(saved);
          updateBudgetDisplay();
        }
      }

      // Load project metrics from localStorage
      function loadProjectMetrics() {
        const saved = localStorage.getItem("projectMetrics");
        if (saved) {
          projectMetrics = JSON.parse(saved);
          updateMetricsDisplay();
        }
      }

      // Update budget display
      function updateBudgetDisplay() {
        const budgetContainer = document.querySelector(
          ".bg-gradient-to-br.from-blue-50 .space-y-4"
        );
        if (!budgetContainer) return;

        const total = budgetData.categories.reduce(
          (sum, cat) => sum + cat.amount,
          0
        );

        document.getElementById(
          "budgetYearTitle"
        ).textContent = `${budgetData.year} Budget Allocation`;
        document.getElementById(
          "totalBudget"
        ).textContent = `₱${total.toLocaleString()}`;

        // Clear existing category displays
        const categoriesHTML = budgetData.categories
          .map((category) => {
            const percent =
              total > 0 ? ((category.amount / total) * 100).toFixed(0) : 0;
            return `
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-700 font-medium">${category.name}</span>
                <span class="text-gray-900 font-semibold">₱${category.amount.toLocaleString()}</span>
              </div>
              <div class="w-full bg-blue-100 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full" style="width: ${percent}%"></div>
              </div>
            </div>
          `;
          })
          .join("");

        // Find the container and update it (preserve the total budget section)
        const totalSection = budgetContainer.querySelector(".pt-4.border-t");
        budgetContainer.innerHTML = categoriesHTML;
        if (totalSection) {
          budgetContainer.appendChild(totalSection);
        }
      }

      // Update metrics display
      function updateMetricsDisplay() {
        document.getElementById("totalProjects").textContent =
          projectMetrics.total;
        document.getElementById("completedProjects").textContent =
          projectMetrics.completed;
        document.getElementById("ongoingProjects").textContent =
          projectMetrics.ongoing;
        document.getElementById(
          "successRate"
        ).textContent = `${projectMetrics.successRate}%`;
        document.getElementById("projectsYear").textContent =
          projectMetrics.year;
      }

      // Render budget categories in edit modal
      function renderBudgetCategoriesEdit() {
        const container = document.getElementById("budgetCategoriesContainer");
        container.innerHTML = "";

        budgetData.categories.forEach((category, index) => {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "flex gap-2";
          categoryDiv.innerHTML = `
            <div class="flex-1">
              <input
                type="text"
                value="${category.name}"
                onchange="updateCategoryName(${category.id}, this.value)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent text-sm"
                placeholder="Category name"
              />
            </div>
            <div class="flex-1">
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">₱</span>
                <input
                  type="number"
                  value="${category.amount}"
                  onchange="updateCategoryAmount(${category.id}, this.value)"
                  oninput="updateEditBudgetTotal()"
                  class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent text-sm"
                  min="0"
                  step="1000"
                  placeholder="Amount"
                />
              </div>
            </div>
            <button
              onclick="removeBudgetCategory(${category.id})"
              class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition"
              title="Remove category"
              ${
                budgetData.categories.length <= 1
                  ? 'disabled style="opacity: 0.5; cursor: not-allowed;"'
                  : ""
              }
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          `;
          container.appendChild(categoryDiv);
        });

        updateEditBudgetTotal();
      }

      // Add new budget category
      function addBudgetCategory() {
        const newId =
          Math.max(...budgetData.categories.map((c) => c.id), 0) + 1;
        budgetData.categories.push({
          id: newId,
          name: "",
          amount: 0,
        });
        renderBudgetCategoriesEdit();
      }

      // Remove budget category
      function removeBudgetCategory(id) {
        if (budgetData.categories.length <= 1) {
          showToast("You must have at least one budget category.", "warning");
          return;
        }
        budgetData.categories = budgetData.categories.filter(
          (c) => c.id !== id
        );
        renderBudgetCategoriesEdit();
      }

      // Update category name
      function updateCategoryName(id, name) {
        const category = budgetData.categories.find((c) => c.id === id);
        if (category) {
          category.name = name;
        }
      }

      // Update category amount
      function updateCategoryAmount(id, amount) {
        const category = budgetData.categories.find((c) => c.id === id);
        if (category) {
          category.amount = parseInt(amount) || 0;
        }
        updateEditBudgetTotal();
      }

      // Edit budget allocation
      function editBudgetAllocation() {
        const modal = document.getElementById("budgetEditModal");
        document.getElementById("editBudgetYear").value = budgetData.year;
        renderBudgetCategoriesEdit();
        modal.classList.remove("hidden");
      }

      function closeBudgetEditModal() {
        document.getElementById("budgetEditModal").classList.add("hidden");
      }

      function updateEditBudgetTotal() {
        const total = budgetData.categories.reduce(
          (sum, cat) => sum + cat.amount,
          0
        );
        document.getElementById(
          "editTotalBudget"
        ).textContent = `₱${total.toLocaleString()}`;
      }

      function saveBudgetAllocation() {
        // Validate that all categories have names
        const emptyNames = budgetData.categories.filter((c) => !c.name.trim());
        if (emptyNames.length > 0) {
          showToast("Please provide names for all budget categories.", "error");
          return;
        }

        budgetData.year = parseInt(
          document.getElementById("editBudgetYear").value
        );

        localStorage.setItem("budgetData", JSON.stringify(budgetData));
        updateBudgetDisplay();
        closeBudgetEditModal();

        // Show success message
        showToast("Budget allocation updated successfully!", "success");
      }

      function viewBudgetHistory() {
        showToast("Budget history feature coming soon!", "info");
      }

      // Logout function
      async function handleLogout() {
        try {
          await SessionManager.logout();
        } catch (error) {
          console.error("Logout error:", error);
          // Force logout even if there's an error
          window.location.href = "login.html";
        }
      }

      // Expose functions to global scope for onclick handlers
      // Profile functions - handled by ProfileModal component (window.profileModal)

      // Announcement functions
      window.viewAnnouncement = viewAnnouncement;
      window.openCreateModal = openCreateModal;
      window.closeCreateModal = closeCreateModal;
      window.openEditModal = openEditModal;
      window.closeEditModal = closeEditModal;
      window.confirmDelete = confirmDelete;
      window.closeDeleteModal = closeDeleteModal;
      window.deleteAnnouncement = deleteAnnouncement;
      window.postAnnouncement = postAnnouncement;
      window.saveEdit = saveEdit;
      window.closeViewModal = closeViewModal;
      window.navigateAnnouncements = navigateAnnouncements;
      window.goToAnnouncementPage = goToAnnouncementPage;
      window.updateCharCount = updateCharCount;

      // Cropper functions
      window.openCropperModal = openCropperModal;
      window.closeCropperModal = closeCropperModal;
      window.cropAndUploadImage = cropAndUploadImage;

      // Budget functions
      window.editBudgetAllocation = editBudgetAllocation;
      window.closeBudgetEditModal = closeBudgetEditModal;
      window.saveBudgetAllocation = saveBudgetAllocation;
      window.viewBudgetHistory = viewBudgetHistory;
      window.addBudgetCategory = addBudgetCategory;
      window.removeBudgetCategory = removeBudgetCategory;

      // Logout function
      window.handleLogout = handleLogout;

      // Initialize other page components on load (budget and project metrics are loaded separately from auth)
      loadBudgetData();
      loadProjectMetrics();
    </script>
    <script src="js/mobile-nav.js"></script>
  </body>
</html>
