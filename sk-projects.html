<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BIMS - SK Project Monitoring</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#2f6e4e",
              secondary: "#3d8b64",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      /* Text truncation */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Card layout */
      .project-card {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Custom scrollbar */
      .custom-scrollbar {
        -webkit-overflow-scrolling: touch;
      }

      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      /* Tab styles */
      .tab-btn {
        position: relative;
        padding: 1rem 0.5rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
      }

      .tab-btn.active {
        color: #059669;
        border-bottom-color: #059669;
      }

      .tab-btn:hover {
        color: #047857;
      }

      /* Badge animations */
      @keyframes pulse-slow {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .badge-pulse {
        animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Icon enhancements */
      .icon-wrapper { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .icon-wrapper:hover { transform: translateY(-2px); }
      .nav-link svg { transition: all 0.3s ease; }
      .nav-link:hover svg { transform: scale(1.1); }
      .icon-badge { box-shadow: 0 2px 8px rgba(47, 110, 78, 0.15); }
      .notification-icon { position: relative; }
      .notification-icon:hover { transform: rotate(15deg) scale(1.1); transition: transform 0.3s ease; }
      .status-icon-pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
      .status-icon-approved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
      .status-icon-rejected { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
      .icon-primary { filter: drop-shadow(0 2px 4px rgba(47, 110, 78, 0.1)); }
      .icon-glow { filter: drop-shadow(0 0 8px rgba(47, 110, 78, 0.3)); }

      /* Toast Notification Styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #10b981;
      }

      .toast.error {
        border-left: 4px solid #ef4444;
      }

      .toast.warning {
        border-left: 4px solid #f59e0b;
      }

      .toast.info {
        border-left: 4px solid #3b82f6;
      }

      /* Input validation states */
      .input-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }

      .input-success {
        border-color: #10b981 !important;
      }

      /* Loading spinner */
      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Pagination dots - consistent across all screen sizes */
      #paginationDots button {
        flex-shrink: 0;
        display: inline-block;
        cursor: pointer;
        border: none;
        padding: 0;
        outline: none;
      }

      #paginationDots button:focus {
        outline: 2px solid rgba(47, 110, 78, 0.3);
        outline-offset: 2px;
      }

      /* Enhanced Attendance Checkbox Styles */
      input[type="checkbox"]:checked {
        background-color: #2f6e4e;
        border-color: #2f6e4e;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      }

      input[type="checkbox"]:focus {
        outline: none;
        border-color: #2f6e4e;
      }

      /* Smooth checkbox transitions */
      input[type="checkbox"] {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      input[type="checkbox"]:hover {
        border-color: #2f6e4e;
        transform: scale(1.05);
      }

      input[type="checkbox"]:active {
        transform: scale(0.95);
      }

      /* Mobile-specific touch feedback */
      @media (max-width: 640px) {
        input[type="checkbox"] {
          width: 1.375rem;
          height: 1.375rem;
        }

        input[type="checkbox"]:active {
          transform: scale(0.9);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 overflow-x-hidden">
    <div class="flex h-screen overflow-hidden">
      <!-- SIDEBAR -->
      <aside
        class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col"
      >
        <div class="p-6 flex-1 flex flex-col">
          <!-- Logo -->
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg icon-badge overflow-hidden"
            >
              <img src="asset/logo.svg" alt="BIMS Logo" class="w-full h-full object-contain p-1">
            </div>
            <div>
              <h1 class="text-xl font-black text-gray-800">BIMS</h1>
              <p class="text-sm text-gray-600 font-medium">SK Malanday</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a
              href="sk-dashboard.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-green-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-green-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                  ></path>
                </svg>
              </div>
              <span>Dashboard</span>
            </a>
            <a
              href="sk-files.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-blue-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-blue-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
              </div>
              <span>Manage Files</span>
            </a>
            <a
              href="sk-projects.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 bg-[#2f6e4e]/10 text-[#2f6e4e] rounded-lg font-medium group"
            >
              <div class="w-9 h-9 bg-[#2f6e4e]/20 rounded-lg flex items-center justify-center group-hover:bg-[#2f6e4e]/30 transition">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  ></path>
                </svg>
              </div>
              <span>Project Monitoring</span>
            </a>
            <a
              href="sk-calendar.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-orange-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-orange-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <span>Calendar</span>
            </a>
            <a
              href="sk-testimonies.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-indigo-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                  ></path>
                </svg>
              </div>
              <span>Testimonies</span>
            </a>
            <a
              href="sk-archive.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition">
                <svg
                  class="w-5 h-5 group-hover:text-gray-700 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                  ></path>
                </svg>
              </div>
              <span>Archives</span>
            </a>
          </nav>

          <div class="flex-1"></div>

          <!-- Logout -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <button
              onclick="handleLogout()"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition w-full group"
            >
              <div class="w-9 h-9 bg-red-50 rounded-lg flex items-center justify-center group-hover:bg-red-100 transition">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
              </div>
              <span class="font-medium">Logout</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Confirmation Modal -->
      <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
          <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h3 id="confirmTitle" class="text-lg font-bold text-gray-900 text-center mb-2">Confirm Action</h3>
          <p id="confirmMessage" class="text-sm text-gray-600 text-center mb-6">Are you sure you want to proceed?</p>
          <div class="flex gap-3">
            <button id="confirmCancel" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Cancel</button>
            <button id="confirmOk" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium">Delete</button>
          </div>
        </div>
      </div>

      <!-- Cancel Approval Confirmation Modal -->
      <div id="cancelApprovalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
          <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Cancel Approval Request?</h3>
          <p id="cancelApprovalProjectName" class="text-sm text-gray-600 text-center mb-6">Are you sure you want to cancel this project's approval request? The project will be deleted.</p>
          <div class="flex gap-3">
            <button onclick="closeCancelApprovalModal()" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Keep Project</button>
            <button id="confirmCancelApprovalBtn" onclick="confirmCancelApproval()" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium">Cancel Approval</button>
          </div>
        </div>
      </div>

      <!-- MAIN CONTENT -->
      <div class="flex-1 overflow-auto">
        <!-- Header -->
        <header class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-[#2f6e4e] font-semibold mb-1" id="currentDate">Sunday, December 14, 2025</p>
                <h1 class="text-2xl font-bold text-gray-800">Project Monitoring</h1>
                <p class="text-sm text-gray-600 mt-1">Track and manage all SK projects</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="window.notificationModal.toggle()" class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Notifications">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse">5</span>
                  </button>
                </div>
                <button onclick="window.profileModal.open()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-[#2f6e4e] transition">Loading...</p>
                    <p class="text-xs text-gray-500">SK Official</p>
                  </div>
                  <div class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20 group-hover:ring-[#2f6e4e]/40 transition">
                    --
                  </div>
                </button>
              </div>
          </div>
        </header>

        <!-- Main Content Section -->
        <div class="px-6 py-6">
          <div class="max-w-7xl mx-auto">
            <!-- Action Button -->
            <div class="flex items-center justify-end mb-6">
              <button
                id="createProjectBtn"
                class="px-4 py-2 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg font-medium transition flex items-center space-x-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                <span>Create Project</span>
              </button>
            </div>

            <!-- Projects Container with White Background -->
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
              <!-- Search and Filters Section -->
              <div class="px-6 py-4 border-b border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3">
                  <input
                    id="projectSearch"
                    type="text"
                    placeholder="Search projects by name, category, or location..."
                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
                  />
                  <select
                    id="categoryFilter"
                    class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white md:min-w-[180px]"
                  >
                    <option value="">All types</option>
                    <option>Community</option>
                    <option>Sports</option>
                    <option>Education</option>
                    <option>Environment</option>
                    <option>Health</option>
                  </select>
                </div>
              </div>

              <!-- Projects Grid -->
              <div class="p-6">
                <div
                  id="projectsGrid"
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                >
                  <!-- Project cards will be dynamically inserted here -->
                </div>

                <!-- Pagination Dots (Center) -->
                <div id="paginationDots" class="flex justify-center gap-2 mt-6 hidden">
                  <!-- Dots will be inserted here -->
                </div>

                <!-- Pagination Controls (Bottom Right) -->
                <div class="mt-6 flex justify-end">
                  <nav
                    id="paginationNav"
                    class="hidden inline-flex rounded-md shadow-sm"
                    role="navigation"
                    aria-label="Pagination"
                  >
                    <button
                      id="prevBtn"
                      onclick="navigateProjects(-1)"
                      class="px-3 py-2 border border-gray-200 rounded-l-md hover:bg-gray-50 transition text-gray-700 font-medium"
                    >
                      Prev
                    </button>
                    <button
                      id="nextBtn"
                      onclick="navigateProjects(1)"
                      class="px-3 py-2 border-t border-b border-r border-gray-200 rounded-r-md hover:bg-gray-50 transition text-gray-700 font-medium"
                    >
                      Next
                    </button>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT DETAILS VIEW MODAL -->
    <div
      id="projectViewModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-2 sm:p-4"
      onclick="if(event.target === this) closeProjectView()"
    >
        <div
          class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[95vh] sm:max-h-[90vh] flex flex-col overflow-hidden"
        >
          <!-- Header with gradient -->
          <div
            class="sticky top-0 bg-gradient-to-r from-[#3d8b64] to-[#3d8b64] text-white px-4 py-3 sm:px-6 sm:py-4 z-50 shadow-lg flex-shrink-0"
          >
            <div class="flex justify-between items-start">
              <div>
                <h2 id="viewProjectTitle" class="text-lg sm:text-xl font-bold mb-2"></h2>
                <div class="flex items-center gap-4 text-white/70">
                  <span id="viewProjectHeadsCount" class="text-xs sm:text-sm"></span>
                  <span>•</span>
                  <span id="viewProjectCategory" class="text-xs sm:text-sm"></span>
                </div>
              </div>
              <button
                onclick="closeProjectView()"
                class="text-white/80 hover:text-white flex-shrink-0 ml-4"
              >
                <svg
                  class="w-5 h-5 sm:w-6 sm:h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="sticky top-[72px] sm:top-[88px] border-b border-gray-200 bg-white px-4 sm:px-6 z-40 shadow-sm flex-shrink-0">
            <nav class="flex space-x-4 sm:space-x-8 overflow-x-auto">
              <button
                onclick="switchTab('details')"
                id="tabDetails"
                class="tab-btn active whitespace-nowrap"
              >
                Project Details
              </button>
              <button
                onclick="switchTab('applicants')"
                id="tabApplicants"
                class="tab-btn whitespace-nowrap"
              >
                Applicants (<span id="applicantCount">0</span>)
              </button>
              <button
                onclick="switchTab('inquiries')"
                id="tabInquiries"
                class="tab-btn whitespace-nowrap"
              >
                Inquiries (<span id="inquiryCount">0</span>)
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="flex-1 overflow-y-auto custom-scrollbar" style="min-height: 0;">
            <!-- Project Details Tab -->
            <div id="tabContentDetails" class="p-4 sm:p-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Category
                  </h3>
                  <p id="detailsCategory" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Status
                  </h3>
                  <span
                    id="detailsStatus"
                    class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                  ></span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Project Duration
                  </h3>
                  <p id="detailsDuration" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Location
                  </h3>
                  <p id="detailsLocation" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Project Heads
                  </h3>
                  <p id="detailsHeads" class="text-gray-900"></p>
                </div>
              </div>

              <div>
                <h3 class="text-sm font-semibold text-gray-600 mb-2">
                  Description
                </h3>
                <div
                  id="detailsDescription"
                  class="text-gray-900 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg"
                ></div>
              </div>

              <!-- Captain's Decision Section -->
              <div id="captainDecisionSection" class="hidden mt-6">
                <div class="border-t border-gray-200 pt-6">
                  <h3 class="text-sm font-semibold text-gray-600 mb-3">
                    Barangay Captain's Decision
                  </h3>
                  <div id="decisionContent" class="bg-gray-50 rounded-lg p-5 border-l-4">
                    <div class="flex items-center gap-3 mb-3">
                      <div id="decisionIcon" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold"></div>
                      <div>
                        <p id="decisionStatus" class="font-bold text-lg"></p>
                        <p id="decisionDate" class="text-sm text-gray-600"></p>
                      </div>
                    </div>
                    <div class="mt-4">
                      <p class="text-xs font-semibold text-gray-600 mb-2">Comments:</p>
                      <p id="decisionComments" class="text-gray-800 whitespace-pre-wrap"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Applicants Tab -->
            <div id="tabContentApplicants" class="hidden p-4 sm:p-6">
              <div class="mb-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <select
                    id="applicantStatusFilter"
                    onchange="filterApplicants()"
                    class="px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">All Status</option>
                    <option value="pending">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                  </select>
                </div>
                <div class="flex gap-2">
                  <span
                    class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium"
                  >
                    <span id="pendingCount">0</span> pending review
                  </span>
                  <span
                    class="px-3 py-1 bg-[#2f6e4e]/20 text-[#2f6e4e] rounded-full text-xs font-medium"
                  >
                    <span id="approvedCount">0</span> Approved
                  </span>
                </div>
              </div>

              <div id="applicantsList" class="space-y-3">
                <!-- Applicant cards will be inserted here -->
              </div>

              <!-- Attendance Generator Section -->
              <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">Generate Attendance Sheet</h3>
                    <p class="text-sm text-gray-600 mt-1">Download PDF attendance sheet for approved volunteers</p>
                  </div>
                  <button
                    onclick="generateAttendancePDF()"
                    class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg font-medium transition flex items-center gap-2"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Download PDF</span>
                  </button>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div class="flex gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                      <p class="font-semibold mb-1">Attendance Sheet Info:</p>
                      <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Only <strong>approved applicants</strong> will be included</li>
                        <li>Sheet includes columns for: Name, Role, Signature, Time In, Time Out</li>
                        <li>PDF will be formatted for easy printing</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Inquiries Tab -->
            <div id="tabContentInquiries" class="hidden p-4 sm:p-6">
              <div id="inquiriesList" class="space-y-4">
                <!-- Inquiries will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE/EDIT PROJECT MODAL -->
    <div id="projectModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 opacity-75"
          onclick="closeProjectModal()"
        ></div>

        <div
          class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
        >
          <div class="p-6 border-b">
            <div class="flex items-center justify-between">
              <h3
                id="projectModalTitle"
                class="text-2xl font-bold text-gray-800"
              >
                Create Project
              </h3>
              <button
                onclick="closeProjectModal()"
                class="text-gray-400 hover:text-gray-600"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Title</label
              >
              <input
                id="projTitle"
                type="text"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Category</label
                >
                <input
                  id="projCategory"
                  type="text"
                  placeholder="e.g., Community, Sports, Education"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Status</label
                >
                <select
                  id="projStatus"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  disabled
                >
                  <option>Pending Approval</option>
                  <option>Ongoing</option>
                  <option>Upcoming</option>
                  <option>Pending for Revision</option>
                  <option>Rejected</option>
                  <option>Completed</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-info-circle mr-1"></i>
                  Status will be "Pending Approval" until Barangay Captain approves
                </p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Proposed Budget (₱)</label
                >
                <input
                  id="projBudget"
                  type="number"
                  placeholder="e.g., 50000"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
                  min="0"
                  step="100"
                  oninput="updateBudgetRemaining()"
                />
                <p class="text-xs text-gray-500 mt-1" id="budgetHelpText">
                  <i class="fas fa-info-circle mr-1"></i>
                  Enter the total budget needed for this project
                </p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Expected Volunteers</label
                >
                <input
                  id="projVolunteers"
                  type="number"
                  placeholder="e.g., 50"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
                  min="1"
                />
              </div>
            </div>

            <!-- Budget Breakdown Section -->
            <div class="bg-[#2f6e4e]/10 border border-[#2f6e4e]/30 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-bold text-gray-800">Budget Breakdown</h4>
                <div class="text-right">
                  <p class="text-xs text-gray-600">Remaining Budget</p>
                  <p id="remainingBudget" class="text-lg font-bold text-[#2f6e4e]">₱0.00</p>
                </div>
              </div>

              <div class="bg-white rounded-lg p-3 mb-3">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="border-b border-gray-300">
                        <th class="text-left py-2 px-2 font-semibold text-gray-700 w-12">#</th>
                        <th class="text-left py-2 px-2 font-semibold text-gray-700">Expense Item</th>
                        <th class="text-left py-2 px-2 font-semibold text-gray-700 w-32">Cost (₱)</th>
                        <th class="text-center py-2 px-2 font-semibold text-gray-700 w-16">Action</th>
                      </tr>
                    </thead>
                    <tbody id="budgetBreakdownTable">
                      <!-- Budget breakdown rows will be added here -->
                    </tbody>
                    <tfoot>
                      <tr class="border-t-2 border-gray-300">
                        <td colspan="2" class="py-2 px-2 text-right font-bold text-gray-800">Total:</td>
                        <td class="py-2 px-2 font-bold text-[#2f6e4e]" id="budgetTotal">₱0.00</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <button
                type="button"
                onclick="addBudgetRow()"
                class="w-full px-3 py-2 bg-white border border-[#3d8b64]/50 text-[#2f6e4e] rounded-lg hover:bg-[#2f6e4e]/10 flex items-center justify-center gap-2 text-sm font-medium"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Expense Item
              </button>

              <p class="text-xs text-gray-600 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                List all planned expenses. Total must not exceed the proposed budget.
              </p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Start Date</label
                >
                <input
                  type="date"
                  id="projStartDate"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Start Time</label
                >
                <input
                  type="time"
                  id="projStartTime"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >End Date</label
                >
                <input
                  type="date"
                  id="projEndDate"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >End Time</label
                >
                <input
                  type="time"
                  id="projEndTime"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Location</label
              >
              <input
                id="projLocation"
                type="text"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                placeholder="Barangay Hall, Covered Court, etc."
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Project Heads</label
              >
              <div id="headsSelect" class="relative">
                <div
                  id="selectedPills"
                  class="flex items-center gap-2 flex-wrap p-2 border border-gray-300 rounded-lg min-h-[48px] cursor-text"
                  onclick="openHeadsDropdown()"
                >
                  <input
                    id="headsSearch"
                    placeholder="Search & add project heads..."
                    class="flex-1 min-w-[120px] px-2 py-1 outline-none"
                  />
                </div>
                <div
                  id="headsDropdown"
                  class="hidden absolute mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-20 max-h-48 overflow-auto"
                ></div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Banner image (optional)</label
              >
              <input
                id="projBanner"
                type="file"
                accept="image/*"
                class="w-full"
              />
              <p class="text-xs text-gray-500 mt-1">
                You can upload a banner image to display on the card.
              </p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Target Beneficiaries</label
              >
              <input
                id="projBeneficiaries"
                type="text"
                placeholder="e.g., 200 Youth ages 15-30, 150 Families"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
              />
              <p class="text-xs text-gray-500 mt-1">
                Who and how many people will benefit from this project? (Include count and description)
              </p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Project Description</label
              >
              <textarea
                id="projDesc"
                rows="6"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64]"
                placeholder="Include:&#10;• Brief project overview&#10;• Objectives (What you aim to achieve)&#10;• Expected outcomes (What results you expect)&#10;&#10;Example: A community festival to celebrate New Year with cultural performances, games, and food stalls.&#10;&#10;Objectives:&#10;• Promote community unity&#10;• Showcase local talents&#10;• Provide entertainment for all ages&#10;&#10;Expected Outcomes:&#10;• 500+ attendees expected&#10;• 15+ performers lined up&#10;• Strengthen barangay relationships"
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                Please include project overview, objectives, and expected outcomes in your description for Barangay Captain review.
              </p>
            </div>
          </div>

          <div class="p-6 border-t flex justify-end gap-3">
            <button
              onclick="closeProjectModal()"
              class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"
            >
              Close
            </button>
            <button
              id="cancelApprovalBtn"
              onclick="cancelProjectApproval()"
              class="hidden px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              Cancel Approval
            </button>
            <button
              id="saveProjectBtn"
              class="px-4 py-2 bg-[#2f6e4e] text-white rounded-lg hover:bg-[#2f6e4e] flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
              Submit for Approval
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- APPLICANT DETAILS MODAL -->
    <div
      id="applicantModal"
      class="hidden fixed inset-0 z-[10000] overflow-y-auto"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 opacity-75"
          onclick="closeApplicantModal()"
        ></div>

        <div
          class="relative bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto"
        >
          <!-- Header -->
          <div class="bg-gradient-to-r from-[#3d8b64] to-[#3d8b64] p-6">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-xl font-bold text-white">
                  Volunteer Application Details
                </h2>
                <p
                  id="appProjectName"
                  class="text-[#2f6e4e]/20 text-sm mt-1"
                ></p>
              </div>
              <button
                onclick="closeApplicantModal()"
                class="text-white/80 hover:text-white"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <!-- Personal Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4">Personal Information</h3>
              <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <div class="grid grid-cols-4 gap-4">
                  <div class="col-span-2">
                    <label class="text-xs text-gray-600">Last Name</label>
                    <p id="appLastName" class="font-medium"></p>
                  </div>
                  <div class="col-span-1">
                    <label class="text-xs text-gray-600">First Name</label>
                    <p id="appFirstName" class="font-medium"></p>
                  </div>
                  <div class="col-span-1">
                    <label class="text-xs text-gray-600">MI</label>
                    <p id="appMiddleName" class="font-medium"></p>
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="text-xs text-gray-600">Birthday</label>
                    <p id="appBirthday" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Age</label>
                    <p id="appAge" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Contact</label>
                    <p id="appContact" class="font-medium"></p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs text-gray-600">Email</label>
                    <p id="appEmail" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Address</label>
                    <p id="appAddress" class="font-medium"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Application Details -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4">Application Details</h3>
              <div class="space-y-3">
                <div>
                  <label class="text-xs text-gray-600">Preferred Role</label>
                  <p id="appRole" class="font-medium"></p>
                </div>
                <div id="appParentalConsentSection" class="hidden">
                  <label class="text-xs text-gray-600"
                    >Parental Consent (Minor Applicant)</label
                  >
                  <div class="p-3 bg-gray-50 rounded-lg text-sm">
                    <a
                      id="appParentalConsent"
                      href="#"
                      download
                      class="text-blue-600 hover:underline inline-flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        ></path>
                      </svg>
                      <span id="appParentalConsentText"></span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status Management -->
            <div class="border-t pt-4">
              <h3 class="text-lg font-semibold mb-4">Application Status</h3>
              <div class="flex items-center justify-between mb-4">
                <div>
                  <label class="text-xs text-gray-600">Current Status</label>
                  <p id="appCurrentStatus" class="font-medium"></p>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Applied Date</label>
                  <p id="appDate" class="font-medium"></p>
                </div>
              </div>

              <div class="flex gap-2">
                <button
                  onclick="updateStatus('approved')"
                  class="px-4 py-2 bg-[#2f6e4e] text-white rounded-lg hover:bg-[#2f6e4e]"
                >
                  Approve
                </button>
                <button
                  onclick="updateStatus('rejected')"
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                >
                  Reject
                </button>
                <button
                  onclick="updateStatus('pending')"
                  class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                >
                  Pending
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT EVALUATION MODAL (Mark as Complete) -->
    <div id="evaluationModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeEvaluationModal()"></div>

        <div class="relative bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <!-- Header -->
          <div class="sticky top-0 z-20 bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-t-xl">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">Project Evaluation</h2>
                <p id="evalProjectTitle" class="text-purple-100"></p>
              </div>
              <button onclick="closeEvaluationModal()" class="text-white/80 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Form Content -->
          <div class="p-6 space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
              <p class="text-sm text-blue-800">
                <strong>Complete this evaluation to calculate the project's success rate.</strong><br>
                The success rate is based on 5 weighted metrics: Budget Efficiency (25%), Volunteer Participation (20%), Timeline Adherence (20%), Community Impact (20%), and Volunteer Feedback (15%).
              </p>
            </div>

            <!-- Budget Efficiency (25%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                1. Budget Efficiency (25%)
              </h3>
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Planned Budget (₱)</label>
                  <input type="number" id="budgetPlanned" placeholder="e.g. 50000"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Spent (₱)</label>
                  <input type="number" id="budgetActual" placeholder="e.g. 48000"
                         oninput="calculateSuccessRate(); updateActualTotalFromBreakdown()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-calculator mr-1"></i>
                    Auto-calculated from breakdown below
                  </p>
                </div>
              </div>

              <!-- Budget Breakdown with Receipts -->
              <div class="border-t pt-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-md font-bold text-gray-800">Budget Breakdown & Receipts</h4>
                  <button type="button" onclick="addActualBreakdownRow()" class="text-sm px-3 py-1.5 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg transition">
                    <i class="fas fa-plus mr-1"></i> Add Item
                  </button>
                </div>

                <div class="overflow-x-auto overflow-y-auto max-h-[400px]">
                  <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-gray-50 border-b-2 border-gray-200 z-10">
                      <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Description</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-32">Planned (₱)</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-32">Actual (₱)</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-48">Receipt</th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-700 w-20">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="actualBudgetBreakdownTable">
                      <!-- Rows will be populated here -->
                    </tbody>
                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                      <tr class="font-bold">
                        <td class="px-3 py-3 text-gray-800">TOTAL</td>
                        <td class="px-3 py-3 text-gray-800" id="plannedBreakdownTotal">₱0</td>
                        <td class="px-3 py-3 text-[#2f6e4e]" id="actualBreakdownTotal">₱0</td>
                        <td colspan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>

            <!-- Volunteer Participation (20%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                2. Volunteer Participation (20%)
              </h3>

              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Target Volunteers</label>
                  <input type="number" id="volunteersTarget" placeholder="e.g. 50"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Volunteers</label>
                  <input type="number" id="volunteersActual" placeholder="e.g. 62"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                  <p class="text-xs text-gray-500 mt-1">
                    Enter the actual number of volunteers who participated
                  </p>
                </div>
              </div>

              <!-- Upload Attendance PDF -->
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-file-pdf mr-1"></i>
                  Upload Attendance Sheet (PDF)
                </label>
                <div class="flex items-center gap-3">
                  <label class="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition text-sm font-medium flex items-center gap-2">
                    <i class="fas fa-upload"></i>
                    <span>Choose PDF</span>
                    <input type="file" id="attendancePdfUpload" accept=".pdf" onchange="uploadAttendancePDF(event)" class="hidden" />
                  </label>
                  <span id="attendancePdfName" class="text-sm text-gray-600 italic">No file selected</span>
                </div>
                <p class="text-xs text-gray-600 mt-2">
                  <i class="fas fa-info-circle mr-1"></i>
                  Upload the attendance PDF for documentation
                </p>
              </div>
            </div>

            <!-- Timeline Adherence (20%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                3. Timeline Adherence (20%)
              </h3>
              <select id="timelineStatus" onchange="calculateSuccessRate()"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="">Select timeline status</option>
                <option value="on-time">Completed On Time (100 points)</option>
                <option value="slightly-delayed">Slightly Delayed (70 points)</option>
                <option value="delayed">Delayed (40 points)</option>
                <option value="significantly-delayed">Significantly Delayed (10 points)</option>
              </select>
            </div>

            <!-- Community Impact (20%) - Beneficiaries Reached -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                4. Community Impact (20%) - Beneficiaries Reached
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Target Beneficiaries</label>
                  <input type="number" id="beneficiariesTarget" placeholder="e.g. 200"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Beneficiaries</label>
                  <input type="number" id="beneficiariesActual" placeholder="e.g. 250"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                  <p class="text-xs text-gray-500 mt-1">Actual people reached</p>
                </div>
              </div>
            </div>

            <!-- Volunteer Feedback (15%) - Auto-calculated from surveys -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                5. Volunteer Feedback (15%)
              </h3>
              <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm text-blue-800 font-semibold mb-1">Automatic Calculation</p>
                    <p class="text-sm text-blue-700 mb-3">
                      This metric is automatically calculated from volunteer satisfaction surveys. Volunteers must complete a satisfaction survey before receiving their Certificate of Participation.
                    </p>
                    <div class="p-3 bg-white rounded border border-blue-200">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-700">Average Satisfaction Score:</span>
                        <span id="autoFeedbackScore" class="text-2xl font-bold text-purple-600">-</span>
                      </div>
                      <p class="text-xs text-gray-500">
                        <span id="surveyCount">0</span> out of <span id="totalVolunteers">0</span> volunteers submitted feedback
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Project Achievements -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                6. Project Achievements
              </h3>
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Achievement #<span id="achievementNumber">1</span>
                </label>
                <div class="relative">
                  <textarea id="achievementInput" rows="2"
                            placeholder="Type to see suggestions or enter your own achievement..."
                            oninput="showAchievementSuggestions(this.value)"
                            onfocus="showAchievementSuggestions(this.value)"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none"></textarea>

                  <!-- Auto-suggest dropdown -->
                  <div id="achievementSuggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                    <!-- Suggestions will be populated here -->
                  </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Click suggestions below or type your own achievement</p>
              </div>

              <!-- Quick Suggestions -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Quick Suggestions:</label>
                <div class="flex flex-wrap gap-2">
                  <button type="button" onclick="addQuickAchievement('environmental')"
                          class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition">
                    🌱 Environmental
                  </button>
                  <button type="button" onclick="addQuickAchievement('community')"
                          class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition">
                    🤝 Community
                  </button>
                  <button type="button" onclick="addQuickAchievement('volunteer')"
                          class="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition">
                    👥 Volunteer
                  </button>
                  <button type="button" onclick="addQuickAchievement('educational')"
                          class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200 transition">
                    📚 Educational
                  </button>
                  <button type="button" onclick="addQuickAchievement('impact')"
                          class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-full hover:bg-red-200 transition">
                    ⭐ Impact
                  </button>
                </div>
              </div>

              <!-- Add Achievement Button -->
              <button type="button" onclick="addAchievement()"
                      class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add Achievement
              </button>

              <!-- Achievements List -->
              <div id="achievementsList" class="mt-4 space-y-2">
                <!-- Added achievements will appear here -->
              </div>
            </div>

            <!-- Success Rate Preview -->
            <div class="bg-gradient-to-r from-[#2f6e4e]/10 to-[#2f6e4e]/20 border-2 border-[#3d8b64]/50 rounded-lg p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-[#0f2418]">Calculated Success Rate</h3>
                <span id="successRateValue" class="text-4xl font-black text-[#2f6e4e]">0%</span>
              </div>
              <div class="h-4 bg-[#2f6e4e]/30 rounded-full overflow-hidden mb-4">
                <div id="successRateBar" class="h-full bg-[#2f6e4e] rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>

              <!-- Score Breakdown -->
              <div class="grid grid-cols-5 gap-2 text-center text-sm">
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-[#1a3d2a]" id="budgetScoreValue">0</div>
                  <div class="text-xs text-[#2f6e4e]">Budget</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-[#1a3d2a]" id="participationScoreValue">0</div>
                  <div class="text-xs text-[#2f6e4e]">Volunteers</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-[#1a3d2a]" id="timelineScoreValue">0</div>
                  <div class="text-xs text-[#2f6e4e]">Timeline</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-[#1a3d2a]" id="impactScoreValue">0</div>
                  <div class="text-xs text-[#2f6e4e]">Impact</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-[#1a3d2a]" id="feedbackScoreValue">0</div>
                  <div class="text-xs text-[#2f6e4e]">Feedback</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Actions -->
          <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
            <button onclick="closeEvaluationModal()"
                    class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
              Cancel
            </button>
            <button onclick="submitEvaluation()"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Mark as Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- DOWNLOAD REPORT MODAL -->
    <div id="downloadReportModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeDownloadReportModal()"></div>

        <div class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full">
          <!-- Header -->
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">Download Project Report</h2>
                <p id="downloadProjectTitle" class="text-blue-100"></p>
              </div>
              <button onclick="closeDownloadReportModal()" class="text-white/80 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <p class="text-gray-600 mb-6">
              Choose a format to download the complete project report including success rate breakdown, volunteer list, and budget details.
            </p>

            <div class="grid grid-cols-2 gap-4">
              <!-- PDF Option -->
              <button onclick="downloadReport('pdf')"
                      class="group p-6 border-2 border-gray-300 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition">
                <div class="flex flex-col items-center">
                  <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-red-200 transition">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-gray-800 mb-2">PDF Report</h3>
                  <p class="text-sm text-gray-600 text-center">Formatted document with charts</p>
                </div>
              </button>

              <!-- Excel Option -->
              <button onclick="downloadReport('excel')"
                      class="group p-6 border-2 border-gray-300 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
                <div class="flex flex-col items-center">
                  <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-green-200 transition">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-gray-800 mb-2">Excel Report</h3>
                  <p class="text-sm text-gray-600 text-center">Spreadsheet with detailed data</p>
                </div>
              </button>
            </div>

            <div class="mt-6 bg-gray-50 rounded-lg p-4">
              <h4 class="font-semibold text-gray-800 mb-2">Report Includes:</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Success rate breakdown with all 5 metrics
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Complete volunteer list
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Budget transparency (allocated vs spent)
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Timeline summary and dates
                </li>
              </ul>
            </div>
          </div>

          <!-- Footer -->
          <div class="p-6 border-t border-gray-200 flex justify-end">
            <button onclick="closeDownloadReportModal()"
                    class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="hidden fixed top-6 right-6 z-[70] bg-[#2f6e4e] text-white px-5 py-3 rounded-lg shadow-lg"
    >
      <span id="toastMessage"></span>
    </div>

    <!-- NotificationModal and ProfileModal components will be dynamically rendered -->

    <script type="module">
      // =========================================
      // BIMS SK PROJECT MONITORING - SUPABASE BACKEND
      // Cache bust: 2026-01-24-v2
      // =========================================

      // Import components
      import { NotificationModal } from './js/components/NotificationModal.js';
      import { ProfileModal } from './js/components/ProfileModal.js';

      // Security: XSS Prevention helpers
      function escapeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // Security: Sanitize image URL (only allow Supabase storage URLs)
      function sanitizeImageURL(url) {
        if (!url) return null;
        try {
          const parsed = new URL(url);
          const allowedHosts = ['supabase.co', 'supabase.com'];
          if (allowedHosts.some(host => parsed.hostname.endsWith(host))) {
            return url;
          }
        } catch (e) {
          console.warn('Invalid URL:', url);
        }
        return null;
      }

      // State
      let projects = [];
      let currentUser = null;
      let currentUserData = null;
      let currentUserSKData = null;
      let isLoading = false;

      // Update current date
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const currentDate = new Date().toLocaleDateString('en-US', options);
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
          dateElement.textContent = currentDate;
        }
      }

      // =========================================
      // COMPONENT INITIALIZATION
      // =========================================

      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;
      window.toggleNotificationModal = () => notificationModal.toggle();

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;
      window.openProfileModal = () => profileModal.open();

      // =========================================
      // SESSION & INITIALIZATION
      // =========================================
      async function initializePage() {
        try {
          // Initialize session for SK Officials only
          const sessionResult = await SessionManager.init(['SK_OFFICIAL', 'SUPERADMIN']);

          if (!sessionResult.success) {
            return; // SessionManager handles redirect
          }

          currentUser = sessionResult.user;
          currentUserData = sessionResult.userData;

          // Get SK data for the current user
          await loadCurrentUserSKData();

          // Update header with user info
          updateHeaderUserInfo(sessionResult);

          // Load profile modal data
          await profileModal.loadUserData(currentUser, sessionResult.userData);

          // Load notifications for badge count
          await notificationModal.loadNotifications();

          // Load projects from Supabase
          await loadProjects();

          // Load SK Officials list
          await loadSKOfficials();

          // Update current date
          updateCurrentDate();

          // Handle URL parameters (e.g., from captain approval)
          handleURLParameters();

        } catch (error) {
          console.error('Page initialization error:', error);
          showToast('Failed to initialize page. Please refresh.', 'error');
        }
      }

      async function loadSKOfficials() {
        try {
          const { data, error } = await supabaseClient
            .from('SK_Tbl')
            .select(`
              skID,
              position,
              User_Tbl (
                firstName,
                lastName
              )
            `);

          if (!error && data) {
            skOfficials = data.map(sk => {
              const user = sk.User_Tbl;
              return user ? `${user.firstName} ${user.lastName}`.trim() : 'Unknown';
            }).filter(name => name !== 'Unknown');
          }
        } catch (err) {
          console.warn('Could not load SK officials:', err);
        }
      }

      async function loadCurrentUserSKData() {
        try {
          const { data, error } = await supabaseClient
            .from('SK_Tbl')
            .select('*')
            .eq('userID', currentUser.id)
            .single();

          if (!error && data) {
            currentUserSKData = data;
          }
        } catch (err) {
          console.warn('Could not load SK data:', err);
        }
      }

      function updateHeaderUserInfo(sessionResult) {
        const nameEl = document.querySelector('header .text-sm.font-medium');
        const roleEl = document.querySelector('header .text-xs.text-gray-500');
        const avatarEl = document.querySelector('header .w-10.h-10');

        if (nameEl && sessionResult.userData) {
          const firstName = sessionResult.userData.firstName || '';
          const lastName = sessionResult.userData.lastName || '';
          nameEl.textContent = `${firstName} ${lastName}`.trim() || 'SK Official';
        }

        if (roleEl) {
          const roleDisplay = {
            'SK_OFFICIAL': 'SK Official',
            'SUPERADMIN': 'Administrator'
          };
          roleEl.textContent = roleDisplay[sessionResult.role] || sessionResult.role;
        }

        // Update avatar with profile image
        if (avatarEl && sessionResult.userData) {
          const imageUrl = sessionResult.userData.imagePathURL;
          const firstName = sessionResult.userData.firstName || '';
          const lastName = sessionResult.userData.lastName || '';
          const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();

          if (imageUrl && typeof imageUrl === 'string' && imageUrl.startsWith('https://')) {
            avatarEl.innerHTML = `<img src="${escapeHTML(imageUrl)}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='<span class=\\'text-white font-semibold\\'>${escapeHTML(initials)}</span>';" />`;
          } else {
            avatarEl.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Listen for profile updates from ProfileModal
      window.addEventListener('profileUpdated', (event) => {
        const profile = event.detail;
        const nameEl = document.querySelector('header .text-sm.font-medium');
        const avatarEl = document.querySelector('header .w-10.h-10');

        if (nameEl) {
          nameEl.textContent = `${profile.firstName} ${profile.lastName}`.trim();
        }

        if (avatarEl) {
          const initials = `${profile.firstName?.charAt(0) || ''}${profile.lastName?.charAt(0) || ''}`.toUpperCase();
          if (profile.profilePicture && profile.profilePicture.startsWith('https://')) {
            avatarEl.innerHTML = `<img src="${escapeHTML(profile.profilePicture)}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='<span class=\\'text-white font-semibold\\'>${escapeHTML(initials)}</span>';" />`;
          } else {
            avatarEl.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }

        // Update currentUserData
        if (currentUserData) {
          currentUserData.firstName = profile.firstName;
          currentUserData.lastName = profile.lastName;
          currentUserData.imagePathURL = profile.profilePicture;
        }
      });

      // =========================================
      // PROJECT LOADING FROM SUPABASE
      // =========================================
      async function loadProjects() {
        showLoadingSkeleton(true);

        try {
          // Query Pre_Project_Tbl for all projects (SK Officials can see all)
          const { data: projectsData, error } = await supabaseClient
            .from('Pre_Project_Tbl')
            .select(`
              *,
              SK_Tbl (
                User_Tbl (
                  firstName,
                  lastName
                )
              )
            `)
            .in('approvalStatus', ['APPROVED', 'PENDING', 'REVISION'])
            .neq('status', 'CANCELLED')
            .order('createdAt', { ascending: false });

          if (error) {
            console.error('Error loading projects:', error);
            showToast('Failed to load projects. Please try again.', 'error');
            projects = [];
          } else {
            // Transform data to match our frontend structure
            projects = await Promise.all((projectsData || []).map(async (project) => {
              // Load applications for this project
              const applications = await loadProjectApplications(project.preProjectID);

              // Load inquiries for this project
              const inquiries = await loadProjectInquiries(project.preProjectID);

              // Load budget breakdown
              const budgetBreakdown = await loadProjectBudgetBreakdown(project.preProjectID);

              // Get project head name
              const headName = project.SK_Tbl?.User_Tbl
                ? `${project.SK_Tbl.User_Tbl.firstName} ${project.SK_Tbl.User_Tbl.lastName}`.trim()
                : 'Unknown';

              // Map status for display
              const statusMap = {
                'ONGOING': 'Ongoing',
                'COMPLETED': 'Completed',
                'CANCELLED': 'Cancelled'
              };

              const approvalStatusMap = {
                'PENDING': 'Pending Approval',
                'APPROVED': project.status === 'COMPLETED' ? 'Completed' : (new Date(project.startDateTime) > new Date() ? 'Upcoming' : 'Ongoing'),
                'REJECTED': 'Rejected',
                'REVISION': 'Pending for Revision'
              };

              // Determine display status
              let displayStatus = approvalStatusMap[project.approvalStatus] || project.status;
              if (project.approvalStatus === 'APPROVED') {
                if (project.status === 'COMPLETED') {
                  displayStatus = 'Completed';
                } else if (new Date(project.startDateTime) > new Date()) {
                  displayStatus = 'Upcoming';
                } else {
                  displayStatus = 'Ongoing';
                }
              }

              return {
                id: project.preProjectID,
                title: project.title,
                category: project.category,
                status: displayStatus,
                dbStatus: project.status,
                approvalStatus: project.approvalStatus,
                heads: [headName],
                skID: project.skID,
                startDate: project.startDateTime ? new Date(project.startDateTime).toISOString().split('T')[0] : '',
                endDate: project.endDateTime ? new Date(project.endDateTime).toISOString().split('T')[0] : '',
                startTime: project.startDateTime ? new Date(project.startDateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) : '',
                endTime: project.endDateTime ? new Date(project.endDateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }) : '',
                location: project.location,
                description: project.description,
                budget: project.budget,
                expectedVolunteers: project.volunteers,
                beneficiaries: project.beneficiaries,
                budgetBreakdown: budgetBreakdown,
                applications: applications,
                inquiries: inquiries,
                approvalNotes: project.approvalNotes,
                approvalDate: project.approvalDate ? new Date(project.approvalDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : null,
                imagePathURL: project.imagePathURL,
                userID: project.userID
              };
            }));
          }

          showLoadingSkeleton(false);
          renderProjects(projects);

        } catch (err) {
          console.error('Load projects exception:', err);
          showToast('An error occurred while loading projects.', 'error');
          showLoadingSkeleton(false);
          projects = [];
          renderProjects([]);
        }
      }

      async function loadProjectApplications(preProjectID) {
        try {
          const { data, error } = await supabaseClient
            .from('Application_Tbl')
            .select(`
              *,
              User_Tbl (
                firstName,
                lastName,
                middleName,
                birthday,
                contactNumber,
                address,
                email
              )
            `)
            .eq('preProjectID', preProjectID);

          if (error) {
            console.error('Error loading applications:', error);
            return [];
          }

          return (data || []).map(app => {
            const user = app.User_Tbl || {};
            const birthday = user.birthday ? new Date(user.birthday) : null;
            const age = birthday ? Math.floor((new Date() - birthday) / (365.25 * 24 * 60 * 60 * 1000)) : null;

            return {
              id: app.applicationID,
              projectId: app.preProjectID,
              firstName: user.firstName || '',
              middleName: user.middleName || '',
              lastName: user.lastName || '',
              fullName: `${user.lastName || ''}, ${user.firstName || ''} ${user.middleName ? user.middleName.charAt(0) + '.' : ''}`.trim(),
              birthday: user.birthday || '',
              age: age,
              contact: user.contactNumber || '',
              email: user.email || '',
              address: user.address || '',
              preferredRole: app.preferredRole,
              parentalConsent: app.parentConsentFile,
              status: (app.applicationStatus || 'pending').toLowerCase(),
              appliedDate: app.appliedDate ? new Date(app.appliedDate).toLocaleDateString() : '',
              userID: app.userID
            };
          });
        } catch (err) {
          console.error('Load applications exception:', err);
          return [];
        }
      }

      async function loadProjectInquiries(preProjectID) {
        try {
          const { data, error } = await supabaseClient
            .from('Inquiry_Tbl')
            .select(`
              *,
              User_Tbl (
                firstName,
                lastName
              ),
              Reply_Tbl (
                replyID,
                message,
                timeStamp,
                User_Tbl (
                  firstName,
                  lastName
                )
              )
            `)
            .eq('preProjectID', preProjectID)
            .order('timeStamp', { ascending: false });

          if (error) {
            console.error('Error loading inquiries:', error);
            return [];
          }

          return (data || []).map(inq => ({
            id: inq.inquiryID,
            from: inq.User_Tbl ? `${inq.User_Tbl.firstName} ${inq.User_Tbl.lastName}`.trim() : 'Anonymous',
            message: inq.message,
            time: formatTimeAgo(inq.timeStamp),
            isReplied: inq.isReplied,
            replies: (inq.Reply_Tbl || []).map(reply => ({
              id: reply.replyID,
              text: reply.message,
              repliedBy: reply.User_Tbl ? `${reply.User_Tbl.firstName} ${reply.User_Tbl.lastName}`.trim() : 'SK Official',
              repliedAt: formatTimeAgo(reply.timeStamp)
            }))
          }));
        } catch (err) {
          console.error('Load inquiries exception:', err);
          return [];
        }
      }

      async function loadProjectBudgetBreakdown(preProjectID) {
        try {
          const { data, error } = await supabaseClient
            .from('BudgetBreakdown_Tbl')
            .select('*')
            .eq('preProjectID', preProjectID);

          if (error) {
            console.error('Error loading budget breakdown:', error);
            return [];
          }

          return (data || []).map(item => ({
            id: item.breakdownID,
            description: item.description,
            cost: item.cost
          }));
        } catch (err) {
          console.error('Load budget breakdown exception:', err);
          return [];
        }
      }

      function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        const now = new Date();
        const date = new Date(timestamp);
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
        return date.toLocaleDateString();
      }

      function showLoadingSkeleton(show) {
        const grid = document.getElementById('projectsGrid');
        if (show) {
          grid.innerHTML = `
            <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse">
              <div class="h-40 bg-gray-200 rounded-lg mb-4"></div>
              <div class="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
              <div class="flex gap-2 mb-4">
                <div class="h-6 bg-gray-200 rounded w-20"></div>
                <div class="h-6 bg-gray-200 rounded w-24"></div>
              </div>
              <div class="h-16 bg-gray-200 rounded mb-4"></div>
              <div class="h-10 bg-gray-200 rounded"></div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse">
              <div class="h-40 bg-gray-200 rounded-lg mb-4"></div>
              <div class="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
              <div class="flex gap-2 mb-4">
                <div class="h-6 bg-gray-200 rounded w-20"></div>
                <div class="h-6 bg-gray-200 rounded w-24"></div>
              </div>
              <div class="h-16 bg-gray-200 rounded mb-4"></div>
              <div class="h-10 bg-gray-200 rounded"></div>
            </div>
            <div class="bg-white border border-gray-200 rounded-xl p-5 animate-pulse">
              <div class="h-40 bg-gray-200 rounded-lg mb-4"></div>
              <div class="h-6 bg-gray-200 rounded w-3/4 mb-3"></div>
              <div class="flex gap-2 mb-4">
                <div class="h-6 bg-gray-200 rounded w-20"></div>
                <div class="h-6 bg-gray-200 rounded w-24"></div>
              </div>
              <div class="h-16 bg-gray-200 rounded mb-4"></div>
              <div class="h-10 bg-gray-200 rounded"></div>
            </div>
          `;
        }
      }

      // Helper to check if current user is project head
      function isCurrentUserProjectHead(project) {
        if (!currentUserData || !project) return false;
        const currentUserName = `${currentUserData.firstName} ${currentUserData.lastName}`.trim();
        return project.heads.includes(currentUserName) || project.userID === currentUser?.id;
      }

      // Generate Attendance PDF
      function generateAttendancePDF() {
        if (!currentProjectId) {
          showToast('No project selected', 'warning');
          return;
        }

        // Get the current project
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) {
          showToast('Project not found', 'error');
          return;
        }

        // Get approved applicants for the current project
        const approvedApplicants = applications.filter(app =>
          app.projectId === currentProjectId && app.status === 'approved'
        );

        if (approvedApplicants.length === 0) {
          showToast('No approved applicants found for this project. Please approve applicants first.', 'warning');
          return;
        }

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Page settings
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let yPosition = margin;

        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('BARANGAY INFORMATION MANAGEMENT SYSTEM', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 7;

        doc.setFontSize(14);
        doc.text('SK Malanday - Volunteer Attendance Sheet', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 10;

        // Project Information
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Project: ${project.title}`, margin, yPosition);
        yPosition += 6;
        doc.text(`Date: ${project.startDate}`, margin, yPosition);
        yPosition += 10;

        // Table Header
        doc.setFillColor(5, 150, 105); // Emerald color
        doc.rect(margin, yPosition, pageWidth - 2 * margin, 8, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.setFontSize(9);

        const colWidths = {
          no: 15,
          name: 80,
          time: 40,
          signature: 45
        };

        let xPos = margin + 2;
        doc.text('No.', xPos, yPosition + 5);
        xPos += colWidths.no;
        doc.text('Name', xPos, yPosition + 5);
        xPos += colWidths.name;
        doc.text('Time', xPos, yPosition + 5);
        xPos += colWidths.time;
        doc.text('Signature', xPos, yPosition + 5);

        yPosition += 8;
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');

        // Table Rows
        approvedApplicants.forEach((applicant, index) => {
          // Check if we need a new page
          if (yPosition > pageHeight - 30) {
            doc.addPage();
            yPosition = margin;
          }

          // Alternating row colors
          if (index % 2 === 0) {
            doc.setFillColor(249, 250, 251);
            doc.rect(margin, yPosition, pageWidth - 2 * margin, 10, 'F');
          }

          xPos = margin + 2;

          // Number
          doc.text(String(index + 1), xPos, yPosition + 6);
          xPos += colWidths.no;

          // Name
          doc.text(applicant.fullName, xPos, yPosition + 6);
          xPos += colWidths.name;

          // Time line
          doc.setDrawColor(200, 200, 200);
          doc.line(xPos, yPosition + 7, xPos + colWidths.time - 5, yPosition + 7);
          xPos += colWidths.time;

          // Signature line
          doc.line(xPos, yPosition + 7, xPos + colWidths.signature - 5, yPosition + 7);

          yPosition += 10;
        });

        // Footer
        yPosition += 10;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Total Approved Volunteers: ${approvedApplicants.length}`, margin, yPosition);
        yPosition += 5;
        doc.text(`Generated on: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, margin, yPosition);

        // Save the PDF
        const fileName = `Attendance_${project.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);

        showToast('Attendance sheet generated successfully!');
      }

      // Store current project ID for modal operations
      let currentProjectId = null;

      // Pagination variables
      let currentPage = 0;
      const projectsPerPage = 3;
      let currentFilteredProjects = [];

      // SK Officials list (loaded from database)
      let skOfficials = [];

      // Navigate through project pages
      function navigateProjects(direction) {
        const totalPages = Math.ceil(currentFilteredProjects.length / projectsPerPage);
        currentPage += direction;

        // Wrap around
        if (currentPage < 0) currentPage = totalPages - 1;
        if (currentPage >= totalPages) currentPage = 0;

        renderProjects(currentFilteredProjects);
        updatePaginationDots();
      }

      // Update pagination dots
      function updatePaginationDots() {
        const totalPages = Math.ceil(currentFilteredProjects.length / projectsPerPage);
        const dotsContainer = document.getElementById('paginationDots');
        const navContainer = document.getElementById('paginationNav');

        if (totalPages <= 1) {
          dotsContainer.classList.add('hidden');
          navContainer.classList.add('hidden');
          return;
        }

        dotsContainer.classList.remove('hidden');
        navContainer.classList.remove('hidden');

        dotsContainer.innerHTML = Array.from({ length: totalPages }, (_, i) => `
          <button
            onclick="goToPage(${i})"
            class="h-2 rounded-full transition-all duration-300 ${i === currentPage ? 'bg-[#2f6e4e] w-8' : 'bg-gray-300 hover:bg-gray-400 w-2'}"
            style="min-height: 8px;"
          ></button>
        `).join('');
      }

      // Go to specific page
      function goToPage(pageIndex) {
        currentPage = pageIndex;
        renderProjects(currentFilteredProjects);
        updatePaginationDots();
      }

      // Render projects grid
      function renderProjects(list) {
        currentFilteredProjects = list;
        const grid = document.getElementById("projectsGrid");
        grid.innerHTML = "";

        if (list.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-12 text-gray-500">No projects found</div>';
          document.getElementById('paginationDots').classList.add('hidden');
          document.getElementById('paginationNav').classList.add('hidden');
          return;
        }

        // Calculate pagination
        const startIndex = currentPage * projectsPerPage;
        const endIndex = startIndex + projectsPerPage;
        const projectsToShow = list.slice(startIndex, endIndex);

        // Update navigation buttons
        updatePaginationDots();

        projectsToShow.forEach((project) => {
          const isHead = isCurrentUserProjectHead(project);
          const pendingCount = project.applications.filter(
            (a) => a.status === "pending"
          ).length;
          const totalApplicants = project.applications.length;

          const card = document.createElement("div");
          card.className =
            "bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-all project-card";

          const statusColors = {
            "Pending Approval": "bg-orange-100 text-orange-700",
            Ongoing: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
            Upcoming: "bg-blue-100 text-blue-700",
            "Pending for Revision": "bg-yellow-100 text-yellow-700",
            Rejected: "bg-red-100 text-red-700",
            Completed: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
          };

          card.innerHTML = `
          <!-- Banner Image Area -->
          <div class="h-40 bg-gradient-to-br from-[#2f6e4e]/20 to-[#2f6e4e]/10"></div>

          <!-- Card Body -->
          <div class="p-5 flex flex-col h-full">
            <!-- Title -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 line-clamp-2 min-h-[56px]">${
              project.title
            }</h3>
            
            <!-- Status and Category badges -->
            <div class="flex items-center gap-2 mb-4">
              <span class="px-2.5 py-1 ${
                statusColors[project.status] || "bg-gray-100 text-gray-700"
              } text-xs rounded-md font-medium">
                ${project.status}
              </span>
              <span class="px-2.5 py-1 bg-gray-100 text-gray-700 text-xs rounded-md font-medium">
                ${project.category}
              </span>
            </div>

            <!-- Description -->
            <p class="text-sm text-gray-600 line-clamp-3 mb-4 flex-1">
              ${project.description}
            </p>

            <!-- Statistics Section -->
            <div class="space-y-3 mb-4">
              <!-- Applicants -->
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-2xl font-bold text-gray-800">${totalApplicants}</span>
                  <span class="ml-2 text-sm text-gray-600">Total Applicants</span>
                </div>
                ${
                  pendingCount > 0
                    ? `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-medium">
                    ${pendingCount} pending review
                  </span>`
                    : ""
                }
              </div>

              <!-- Inquiries -->
              <div class="flex items-center text-sm text-gray-600">
                <span class="font-semibold text-gray-800">${
                  project.inquiries.length
                }</span>
                <span class="ml-2">Inquiries</span>
              </div>
            </div>

            <!-- Success Rate Badge (for completed projects) -->
            ${
              project.status === "Completed" && project.successRate !== undefined
                ? `
              <div class="mb-3 p-3 bg-gradient-to-r from-[#2f6e4e]/10 to-[#2f6e4e]/20 rounded-lg border border-[#2f6e4e]/30">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold text-[#1a3d2a]">Success Rate</span>
                  <span class="text-2xl font-bold text-[#2f6e4e]">${project.successRate}%</span>
                </div>
                <div class="mt-2 h-2 bg-[#2f6e4e]/30 rounded-full overflow-hidden">
                  <div class="h-full bg-[#2f6e4e] rounded-full" style="width: ${project.successRate}%"></div>
                </div>
              </div>
            `
                : ""
            }

            <!-- Main Action Button -->
            <button onclick="viewProject(${project.id})"
                    class="w-full px-4 py-2.5 bg-[#2f6e4e] text-white rounded-lg hover:bg-[#2f6e4e] font-medium mb-3 transition">
              View Details & Applications
            </button>

            <!-- Archive Button (for completed, rejected, or revision-needed projects) -->
            ${
              project.status === "Completed" || project.status === "Rejected" || project.status === "Pending for Revision"
                ? `
              <button onclick="archiveProject(${project.id})"
                      class="w-full px-4 py-2.5 text-yellow-600 border border-yellow-300 rounded-lg hover:bg-yellow-50 font-medium mb-3 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                </svg>
                Archive Project
              </button>
            `
                : ""
            }

            <!-- Mark as Complete Button (for active/ongoing projects) -->
            ${
              isHead && (project.status === "Ongoing" || project.status === "Upcoming")
                ? `
              <button onclick="openEvaluationModal(${project.id})"
                      class="w-full px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium mb-3 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Mark as Complete
              </button>
            `
                : ""
            }

            <!-- Edit Button -->
            ${
              isHead
                ? `
              <div class="flex gap-2">
                <button onclick="editProject(${project.id})"
                        class="w-full px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium">
                  Edit
                </button>
              </div>
            `
                : ""
            }
          </div>
        `;

          grid.appendChild(card);
        });
      }

      // View project details
      function viewProject(id) {
        currentProjectId = id;
        const project = projects.find((p) => p.id === id);
        if (!project) return;

        // Populate header
        document.getElementById("viewProjectTitle").textContent = project.title;
        document.getElementById(
          "viewProjectHeadsCount"
        ).textContent = `${project.heads.length} Project Head(s)`;
        document.getElementById("viewProjectCategory").textContent =
          project.category;

        // Populate details tab
        document.getElementById("detailsCategory").textContent =
          project.category;

        const statusEl = document.getElementById("detailsStatus");
        const statusColors = {
          "Pending Approval": "bg-orange-100 text-orange-700",
          Ongoing: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
          Upcoming: "bg-blue-100 text-blue-700",
          "Pending for Revision": "bg-yellow-100 text-yellow-700",
          Rejected: "bg-red-100 text-red-700",
          Completed: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
        };
        statusEl.textContent = project.status;
        statusEl.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${
          statusColors[project.status]
        }`;

        const startDateTime = project.startTime
          ? `${new Date(project.startDate).toLocaleDateString()} ${
              project.startTime
            }`
          : new Date(project.startDate).toLocaleDateString();
        const endDateTime = project.endTime
          ? `${new Date(project.endDate).toLocaleDateString()} ${
              project.endTime
            }`
          : new Date(project.endDate).toLocaleDateString();
        document.getElementById(
          "detailsDuration"
        ).textContent = `${startDateTime} - ${endDateTime}`;
        document.getElementById("detailsLocation").textContent =
          project.location;

        // Display captain's decision if available
        displayCaptainDecision(project);
        document.getElementById("detailsHeads").textContent =
          project.heads.join(", ");
        document.getElementById("detailsDescription").textContent =
          project.description;

        // Update counts
        document.getElementById("applicantCount").textContent =
          project.applications.length;
        document.getElementById("inquiryCount").textContent =
          project.inquiries.length;

        const pending = project.applications.filter(
          (a) => a.status === "pending"
        ).length;
        const approved = project.applications.filter(
          (a) => a.status === "approved"
        ).length;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;

        // Load applicants
        loadApplicants(project);

        // Load inquiries
        loadInquiries(project);

        // Show modal
        document.getElementById("projectViewModal").classList.remove("hidden");
        switchTab("details");
      }

      function closeProjectView() {
        document.getElementById("projectViewModal").classList.add("hidden");
        currentProjectId = null;
      }

      // Tab switching
      function switchTab(tab) {
        // Update tab buttons
        ["details", "applicants", "inquiries"].forEach((t) => {
          const tabBtn = document.getElementById(
            `tab${t.charAt(0).toUpperCase() + t.slice(1)}`
          );
          const tabContent = document.getElementById(
            `tabContent${t.charAt(0).toUpperCase() + t.slice(1)}`
          );

          if (t === tab) {
            tabBtn.classList.add("active");
            tabContent.classList.remove("hidden");
          } else {
            tabBtn.classList.remove("active");
            tabContent.classList.add("hidden");
          }
        });
      }

      // Load applicants
      function loadApplicants(project) {
        const container = document.getElementById("applicantsList");
        container.innerHTML = "";

        if (project.applications.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">No applications yet</p>';
          return;
        }

        const filteredApps = getFilteredApplicants(project);

        filteredApps.forEach((app) => {
          const statusColors = {
            pending: "bg-yellow-100 text-yellow-700",
            approved: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
            rejected: "bg-red-100 text-red-700",
          };

          const card = document.createElement("div");
          card.className =
            "bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition";
          card.onclick = () => viewApplicant(app, project);

          card.innerHTML = `
          <div class="flex flex-col gap-2.5">
            <!-- Row 1: Checkbox + Name & Role -->
            <div class="flex items-start gap-3">
              ${project.status === 'Completed' && app.status === 'approved' ? `
                <div class="pt-0.5" onclick="event.stopPropagation()">
                  <input type="checkbox" ${app.attended ? 'checked' : ''}
                         onchange="toggleAttendance(${project.id}, ${app.id}, this.checked)"
                         class="w-5 h-5 text-[#2f6e4e] border-2 border-gray-300 rounded transition-all duration-200 focus:ring-2 focus:ring-[#2f6e4e]/30 focus:ring-offset-1 cursor-pointer flex-shrink-0" />
                </div>
              ` : ''}
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-900 mb-0.5">${app.fullName}</h4>
                <p class="text-sm text-gray-600">${app.preferredRole} • Age ${app.age}</p>
              </div>
            </div>

            <!-- Row 2: Mark Attended Label + Status Badge -->
            <div class="flex items-center justify-between gap-3 ${project.status === 'Completed' && app.status === 'approved' ? 'pl-8' : ''}">
              ${project.status === 'Completed' && app.status === 'approved' ? `
                <span class="text-sm font-semibold ${app.attended ? 'text-[#2f6e4e]' : 'text-gray-600'}" style="white-space: nowrap;">
                  Mark Attended
                </span>
              ` : '<div></div>'}
              <span class="inline-block px-3 py-1 ${statusColors[app.status]} text-xs rounded-full font-semibold uppercase tracking-wide shadow-sm flex-shrink-0" style="white-space: nowrap;">
                ${app.status}
              </span>
            </div>
          </div>
        `;

          container.appendChild(card);
        });
      }

      function getFilteredApplicants(project) {
        const filter = document.getElementById("applicantStatusFilter").value;
        return filter
          ? project.applications.filter((a) => a.status === filter)
          : project.applications;
      }

      function filterApplicants() {
        const project = projects.find((p) => p.id === currentProjectId);
        if (project) loadApplicants(project);
      }

      // Toggle attendance for approved volunteers
      function toggleAttendance(projectId, applicantId, attended) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        const applicant = project.applications.find(a => a.id === applicantId);
        if (!applicant) return;

        applicant.attended = attended;

        // Reload the applicants list to reflect the change
        loadApplicants(project);

        showToast(attended ?
          `${applicant.fullName} marked as attended` :
          `${applicant.fullName} attendance removed`
        );
      }

      // Load inquiries
      function loadInquiries(project) {
        const container = document.getElementById("inquiriesList");
        container.innerHTML = "";

        if (project.inquiries.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">No inquiries yet</p>';
          return;
        }

        project.inquiries.forEach((inquiry) => {
          const initials = inquiry.from
            .split(" ")
            .map((n) => n[0])
            .join("")
            .substring(0, 2);
          const hasReplies = inquiry.replies && inquiry.replies.length > 0;

          const card = document.createElement("div");
          card.className = "bg-white border border-gray-200 rounded-lg p-4";

          // Build all replies HTML
          let repliesSection = "";
          if (hasReplies) {
            inquiry.replies.forEach((reply) => {
              const replyInitials = reply.repliedBy
                .split(" ")
                .map((n) => n[0])
                .join("")
                .substring(0, 2);
              repliesSection += `
              <div class="mt-4 ml-16 pl-4 border-l-2 border-[#3d8b64]">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 bg-[#2f6e4e] rounded-full flex items-center justify-center font-semibold text-white flex-shrink-0 text-sm">
                    ${replyInitials}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <h5 class="font-semibold text-gray-900 text-sm">${reply.repliedBy}</h5>
                      <span class="text-xs text-gray-500">${reply.repliedAt}</span>
                    </div>
                    <p class="text-sm text-gray-700">${reply.text}</p>
                  </div>
                </div>
              </div>
            `;
            });
          }

          card.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center font-semibold text-gray-700 flex-shrink-0">
              ${initials}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900">${inquiry.from}</h4>
                  <p class="text-sm text-gray-700 mt-1">${inquiry.message}</p>
                </div>
                <span class="text-xs text-gray-500 ml-4">${inquiry.time}</span>
              </div>
              
              <div class="mt-2">
                ${
                  hasReplies
                    ? `<span class="text-xs text-[#2f6e4e] font-medium">✓ ${
                        inquiry.replies.length
                      } ${
                        inquiry.replies.length === 1 ? "Reply" : "Replies"
                      }</span>`
                    : '<span class="text-xs text-orange-600 font-medium">No replies yet</span>'
                }
              </div>
            </div>
          </div>
          
          ${repliesSection}
          
          <div class="mt-4 ml-16 pl-4 border-l-2 border-gray-200">
            <textarea id="replyText_${inquiry.id}" rows="2" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none" 
                      placeholder="Type your reply..."></textarea>
            <button onclick="sendInquiryReply(${inquiry.id})" 
                    class="mt-2 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
              Send Reply
            </button>
          </div>
        `;

          container.appendChild(card);
        });
      }

      // View applicant details
      let currentApp = null;
      function viewApplicant(app, project) {
        currentApp = app;
        document.getElementById("appProjectName").textContent = project.title;
        document.getElementById("appFirstName").textContent =
          app.firstName || "";
        document.getElementById("appMiddleName").textContent =
          app.middleName || "";
        document.getElementById("appLastName").textContent = app.lastName || "";
        document.getElementById("appBirthday").textContent = new Date(
          app.birthday
        ).toLocaleDateString();
        document.getElementById("appAge").textContent = `${app.age} years old`;
        document.getElementById("appContact").textContent = app.contact;
        document.getElementById("appEmail").textContent = app.email || "";
        document.getElementById("appAddress").textContent = app.address;
        document.getElementById("appRole").textContent = app.preferredRole;

        // Show parental consent section if applicant is under 18
        const consentSection = document.getElementById(
          "appParentalConsentSection"
        );
        if (app.age < 18) {
          consentSection.classList.remove("hidden");
          const consentLink = document.getElementById("appParentalConsent");
          const consentText = document.getElementById("appParentalConsentText");

          if (app.parentalConsent) {
            consentLink.href = "#"; // In a real app, this would be the actual file URL
            consentLink.download = app.parentalConsent;
            consentText.textContent = app.parentalConsent;
          } else {
            consentText.textContent = "Not uploaded";
            consentLink.removeAttribute("href");
            consentLink.classList.remove("text-blue-600", "hover:underline");
            consentLink.classList.add("text-gray-500");
          }
        } else {
          consentSection.classList.add("hidden");
        }

        const statusColors = {
          pending: "text-yellow-600",
          approved: "text-[#2f6e4e]",
          rejected: "text-red-600",
        };

        document.getElementById("appCurrentStatus").innerHTML = `<span class="${
          statusColors[app.status]
        } font-semibold">${app.status.toUpperCase()}</span>`;
        document.getElementById("appDate").textContent = new Date(
          app.appliedDate
        ).toLocaleDateString();

        document.getElementById("applicantModal").classList.remove("hidden");
      }

      function closeApplicantModal() {
        document.getElementById("applicantModal").classList.add("hidden");
        currentApp = null;
      }

      async function updateStatus(newStatus) {
        if (!currentApp) return;

        try {
          // Map status to database format
          const dbStatus = newStatus.toUpperCase();

          // Update application status in database
          const { error } = await supabaseClient
            .from('Application_Tbl')
            .update({
              applicationStatus: dbStatus
            })
            .eq('applicationID', currentApp.id);

          if (error) {
            console.error('Error updating application status:', error);
            showToast('Failed to update status. Please try again.', 'error');
            return;
          }

          // Update local state
          currentApp.status = newStatus;
          showToast(`Application status updated to ${newStatus}`);
          closeApplicantModal();

          // Refresh the view
          const project = projects.find((p) =>
            p.applications.some((a) => a.id === currentApp.id)
          );
          if (project) {
            // Reload applications from database
            project.applications = await loadProjectApplications(project.id);
            loadApplicants(project);

            // Update counts
            const pending = project.applications.filter(
              (a) => a.status === "pending"
            ).length;
            const approved = project.applications.filter(
              (a) => a.status === "approved"
            ).length;
            document.getElementById("pendingCount").textContent = pending;
            document.getElementById("approvedCount").textContent = approved;
          }

          renderProjects(projects);
        } catch (err) {
          console.error('Update status exception:', err);
          showToast('An error occurred. Please try again.', 'error');
        }
      }

      // Edit project
      let editingProjectId = null;
      let selectedHeads = [];

      async function editProject(id) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;

        if (!isCurrentUserProjectHead(project)) {
          showToast("Only project heads can edit this project.", "warning");
          return;
        }

        editingProjectId = id;
        document.getElementById("projectModalTitle").textContent =
          "Edit Project";
        document.getElementById("projTitle").value = project.title;
        document.getElementById("projCategory").value = project.category;
        document.getElementById("projStatus").value = project.status;
        document.getElementById("projBudget").value = project.budget || 0;
        document.getElementById("projVolunteers").value = project.expectedVolunteers || 0;
        document.getElementById("projStartDate").value = project.startDate;
        document.getElementById("projStartTime").value =
          project.startTime || "08:00";
        document.getElementById("projEndDate").value = project.endDate;
        document.getElementById("projEndTime").value =
          project.endTime || "17:00";
        document.getElementById("projLocation").value = project.location;
        document.getElementById("projDesc").value = project.description;
        document.getElementById("projBeneficiaries").value = project.beneficiaries || "";

        selectedHeads = [...(project.heads || [])];
        renderHeadsPills();

        // Load budget breakdown items from database
        await loadBudgetBreakdownForEdit(project.id);

        // Show/hide cancel approval button based on status
        const cancelApprovalBtn = document.getElementById("cancelApprovalBtn");
        if (project.status === "Pending Approval") {
          cancelApprovalBtn.classList.remove("hidden");
          cancelApprovalBtn.classList.add("flex");
        } else {
          cancelApprovalBtn.classList.add("hidden");
          cancelApprovalBtn.classList.remove("flex");
        }

        document.getElementById("projectModal").classList.remove("hidden");
      }

      async function loadBudgetBreakdownForEdit(preProjectID) {
        try {
          const { data, error } = await supabaseClient
            .from('BudgetBreakdown_Tbl')
            .select('*')
            .eq('preProjectID', preProjectID)
            .order('breakdownID', { ascending: true });

          if (error) {
            console.error('Error loading budget breakdown:', error);
            budgetBreakdownItems = [];
          } else {
            // Transform database items to local format
            budgetBreakdownItems = (data || []).map(item => ({
              id: item.breakdownID,
              description: item.description,
              cost: item.cost || 0
            }));
          }
          renderBudgetBreakdown();
          updateBudgetTotal();
        } catch (err) {
          console.error('Error loading budget breakdown:', err);
          budgetBreakdownItems = [];
          renderBudgetBreakdown();
        }
      }

      // Create new project
      document
        .getElementById("createProjectBtn")
        .addEventListener("click", () => {
          editingProjectId = null;
          selectedHeads = [];
          document.getElementById("projectModalTitle").textContent =
            "Create Project";
          document.getElementById("projTitle").value = "";
          document.getElementById("projCategory").value = "";
          document.getElementById("projStatus").value = "Ongoing";
          document.getElementById("projBudget").value = "";
          document.getElementById("projVolunteers").value = "";
          document.getElementById("projStartDate").value = "";
          document.getElementById("projEndDate").value = "";
          document.getElementById("projLocation").value = "";
          document.getElementById("projDesc").value = "";
          document.getElementById("projBeneficiaries").value = "";
          document.getElementById("projBanner").value = "";

          clearBudgetBreakdown();
          renderHeadsPills();

          // Hide cancel approval button when creating new project
          const cancelApprovalBtn = document.getElementById("cancelApprovalBtn");
          cancelApprovalBtn.classList.add("hidden");
          cancelApprovalBtn.classList.remove("flex");

          document.getElementById("projectModal").classList.remove("hidden");

          // Check if there's a budget in URL params (from captain approval)
          const urlParams = new URLSearchParams(window.location.search);
          const approvedBudget = urlParams.get('budget');
          if (approvedBudget) {
            autoFillBudgetFromCaptain(parseFloat(approvedBudget));
            // Clear the URL param after using it
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        });

      function closeProjectModal() {
        document.getElementById("projectModal").classList.add("hidden");
        editingProjectId = null;
        selectedHeads = [];
        clearBudgetBreakdown();
      }

      function cancelProjectApproval() {
        if (!editingProjectId) return;

        const project = projects.find((p) => p.id === editingProjectId);
        if (!project) return;

        // Show the styled confirmation modal
        document.getElementById("cancelApprovalProjectName").textContent =
          `Are you sure you want to cancel the approval request for "${project.title}"? The project will be permanently deleted.`;
        document.getElementById("cancelApprovalModal").classList.remove("hidden");
      }

      function closeCancelApprovalModal() {
        document.getElementById("cancelApprovalModal").classList.add("hidden");
      }

      async function confirmCancelApproval() {
        if (!editingProjectId) return;

        const project = projects.find((p) => p.id === editingProjectId);
        if (!project) return;

        const btn = document.getElementById("confirmCancelApprovalBtn");
        btn.disabled = true;
        btn.textContent = "Canceling...";

        try {
          // Delete budget breakdown items first
          const { error: breakdownError } = await supabaseClient
            .from("BudgetBreakdown_Tbl")
            .delete()
            .eq("preProjectID", project.id);

          if (breakdownError) {
            console.error("Error deleting budget breakdown:", breakdownError);
          }

          // Delete the project
          const { error } = await supabaseClient
            .from("Pre_Project_Tbl")
            .delete()
            .eq("preProjectID", project.id);

          if (error) {
            showToast("Error canceling project approval: " + error.message, "error");
            return;
          }

          showToast("Project approval request has been canceled.", "success");
          closeCancelApprovalModal();
          closeProjectModal();
          await loadProjects();
        } catch (err) {
          console.error("Error canceling project approval:", err);
          showToast("An error occurred while canceling the project.", "error");
        } finally {
          btn.disabled = false;
          btn.textContent = "Cancel Approval";
        }
      }

      // Budget Breakdown Functions
      let budgetBreakdownItems = [];

      function addBudgetRow() {
        const item = {
          id: Date.now(),
          description: '',
          cost: 0
        };
        budgetBreakdownItems.push(item);
        renderBudgetBreakdown();
        // Focus on the newly added description input
        setTimeout(() => {
          const newRow = document.querySelector(`#budgetItem_${item.id}_desc`);
          if (newRow) newRow.focus();
        }, 100);
      }

      function removeBudgetRow(id) {
        budgetBreakdownItems = budgetBreakdownItems.filter(item => item.id !== id);
        renderBudgetBreakdown();
        updateBudgetTotal();
      }

      function updateBudgetItem(id, field, value) {
        const item = budgetBreakdownItems.find(item => item.id === id);
        if (item) {
          if (field === 'cost') {
            item[field] = parseFloat(value) || 0;
          } else {
            item[field] = value;
          }
          updateBudgetTotal();
        }
      }

      function renderBudgetBreakdown() {
        const tbody = document.getElementById('budgetBreakdownTable');
        tbody.innerHTML = budgetBreakdownItems.map((item, index) => `
          <tr class="border-b border-gray-200">
            <td class="py-2 px-2 text-gray-700">${index + 1}</td>
            <td class="py-2 px-2">
              <input
                type="text"
                id="budgetItem_${item.id}_desc"
                value="${item.description}"
                placeholder="e.g., Food and beverages"
                oninput="updateBudgetItem(${item.id}, 'description', this.value)"
                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-[#3d8b64] text-sm"
              />
            </td>
            <td class="py-2 px-2">
              <input
                type="number"
                id="budgetItem_${item.id}_cost"
                value="${item.cost || ''}"
                placeholder="0"
                min="0"
                step="0.01"
                oninput="updateBudgetItem(${item.id}, 'cost', this.value)"
                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-[#3d8b64] text-sm"
              />
            </td>
            <td class="py-2 px-2 text-center">
              <button
                type="button"
                onclick="removeBudgetRow(${item.id})"
                class="text-red-600 hover:text-red-800"
                title="Remove item"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </td>
          </tr>
        `).join('');
      }

      function updateBudgetTotal() {
        const total = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
        document.getElementById('budgetTotal').textContent = `₱${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        updateBudgetRemaining();
      }

      function updateBudgetRemaining() {
        const proposedBudget = parseFloat(document.getElementById('projBudget').value) || 0;
        const total = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
        const remaining = proposedBudget - total;

        const remainingEl = document.getElementById('remainingBudget');
        remainingEl.textContent = `₱${remaining.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        // Change color based on remaining budget
        if (remaining < 0) {
          remainingEl.className = 'text-lg font-bold text-red-600';
        } else if (remaining === 0) {
          remainingEl.className = 'text-lg font-bold text-gray-600';
        } else {
          remainingEl.className = 'text-lg font-bold text-[#2f6e4e]';
        }
      }

      function clearBudgetBreakdown() {
        budgetBreakdownItems = [];
        renderBudgetBreakdown();
        updateBudgetTotal();
      }

      // Auto-fill budget from captain's approval
      function autoFillBudgetFromCaptain(approvedBudget) {
        if (approvedBudget) {
          document.getElementById('projBudget').value = approvedBudget;
          updateBudgetRemaining();
        }
      }

      // Initialize budget when opening create project modal
      // This will be called from captain-dashboard when creating project from approved proposal
      window.initializeProjectWithBudget = function(budget) {
        autoFillBudgetFromCaptain(budget);
      };

      // Project heads multi-select
      function renderHeadsPills() {
        const container = document.getElementById("selectedPills");
        container.querySelectorAll(".pill").forEach((el) => el.remove());

        selectedHeads.forEach((name) => {
          const pill = document.createElement("span");
          pill.className =
            "pill flex items-center gap-1 bg-[#2f6e4e]/10 text-[#2f6e4e] px-2 py-1 rounded-full text-sm";
          pill.innerHTML = `
          ${name}
          <button onclick="removeHead('${name}')" class="ml-1">✕</button>
        `;
          container.insertBefore(pill, document.getElementById("headsSearch"));
        });
      }

      function removeHead(name) {
        selectedHeads = selectedHeads.filter((h) => h !== name);
        renderHeadsPills();
      }

      function openHeadsDropdown() {
        const dropdown = document.getElementById("headsDropdown");
        dropdown.classList.remove("hidden");
        renderHeadsDropdown();
      }

      document.getElementById("headsSearch").addEventListener("input", (e) => {
        renderHeadsDropdown(e.target.value);
      });

      function renderHeadsDropdown(filter = "") {
        const dropdown = document.getElementById("headsDropdown");
        dropdown.innerHTML = "";

        const available = skOfficials.filter(
          (name) =>
            name.toLowerCase().includes(filter.toLowerCase()) &&
            !selectedHeads.includes(name)
        );

        available.forEach((name) => {
          const option = document.createElement("div");
          option.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
          option.textContent = name;
          option.onclick = () => {
            selectedHeads.push(name);
            renderHeadsPills();
            document.getElementById("headsSearch").value = "";
            renderHeadsDropdown();
          };
          dropdown.appendChild(option);
        });
      }

      // Save project
      document
        .getElementById("saveProjectBtn")
        .addEventListener("click", async () => {
          const saveBtn = document.getElementById("saveProjectBtn");
          if (saveBtn.disabled) return;
          saveBtn.disabled = true;
          saveBtn.classList.add("opacity-50", "pointer-events-none");

          const title = document.getElementById("projTitle").value.trim();
          const category = document.getElementById("projCategory").value.trim();
          const status = document.getElementById("projStatus").value;
          const startDate = document.getElementById("projStartDate").value;
          const startTime = document.getElementById("projStartTime").value;
          const endDate = document.getElementById("projEndDate").value;
          const endTime = document.getElementById("projEndTime").value;
          const location = document.getElementById("projLocation").value.trim();
          const description = document.getElementById("projDesc").value.trim();
          const budget = parseFloat(document.getElementById("projBudget").value) || 0;
          const volunteers = parseInt(document.getElementById("projVolunteers").value) || 0;
          const beneficiaries = document.getElementById("projBeneficiaries").value.trim();

          function reenableBtn() {
            saveBtn.disabled = false;
            saveBtn.classList.remove("opacity-50", "pointer-events-none");
          }

          if (
            !title ||
            !category ||
            !startDate ||
            !startTime ||
            !endDate ||
            !endTime ||
            !location ||
            !description
          ) {
            showToast("Please provide all required fields.", "error");
            reenableBtn();
            return;
          }

          // Validate budget breakdown
          if (budgetBreakdownItems.length > 0) {
            const totalBudgetBreakdown = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
            if (totalBudgetBreakdown > budget) {
              showToast(`Budget breakdown total (₱${totalBudgetBreakdown.toLocaleString()}) exceeds the proposed budget (₱${budget.toLocaleString()}). Please adjust the breakdown.`, "error");
              reenableBtn();
              return;
            }
            // Check if all items have descriptions
            const hasEmptyDescriptions = budgetBreakdownItems.some(item => !item.description.trim());
            if (hasEmptyDescriptions) {
              showToast("Please provide descriptions for all budget breakdown items.", "error");
              reenableBtn();
              return;
            }
          }

          // Combine date and time into ISO format
          const startDateTime = new Date(`${startDate}T${startTime}`).toISOString();
          const endDateTime = new Date(`${endDate}T${endTime}`).toISOString();

          try {
            if (editingProjectId) {
              // Update existing project
              const { data, error } = await supabaseClient
                .from('Pre_Project_Tbl')
                .update({
                  title,
                  category,
                  description,
                  budget: Math.round(budget),
                  volunteers,
                  beneficiaries: parseInt(beneficiaries) || 0,
                  startDateTime,
                  endDateTime,
                  location,
                  updatedAt: new Date().toISOString()
                })
                .eq('preProjectID', editingProjectId)
                .select();

              if (error) {
                console.error('Error updating project:', error);
                showToast('Failed to update project. Please try again.', 'error');
                reenableBtn();
                return;
              }

              // Update budget breakdown items
              await updateBudgetBreakdownItems(editingProjectId);

              showToast("Project updated successfully");
            } else {
              // Create new project
              const { data: newProject, error } = await supabaseClient
                .from('Pre_Project_Tbl')
                .insert({
                  userID: currentUser.id,
                  skID: currentUserSKData?.skID || null,
                  title,
                  category,
                  description,
                  budget: Math.round(budget),
                  volunteers,
                  beneficiaries: parseInt(beneficiaries) || 0,
                  status: 'ONGOING',
                  startDateTime,
                  endDateTime,
                  location,
                  approvalStatus: 'PENDING',
                  submittedDate: new Date().toISOString()
                })
                .select()
                .single();

              if (error) {
                console.error('Error creating project:', error);
                showToast('Failed to create project. Please try again.', 'error');
                reenableBtn();
                return;
              }

              // Save budget breakdown items
              if (budgetBreakdownItems.length > 0 && newProject) {
                await saveBudgetBreakdownItems(newProject.preProjectID);
              }

              // Create notification for captain
              await createCaptainNotification(newProject.preProjectID, title);

              showToast("Project submitted for Barangay Captain approval!");
            }

            closeProjectModal();
            reenableBtn();
            await loadProjects(); // Reload projects from database
          } catch (err) {
            console.error('Save project exception:', err);
            showToast('An error occurred. Please try again.', 'error');
            reenableBtn();
          }
        });

      async function saveBudgetBreakdownItems(preProjectID) {
        for (const item of budgetBreakdownItems) {
          if (item.description && item.cost > 0) {
            await supabaseClient
              .from('BudgetBreakdown_Tbl')
              .insert({
                preProjectID,
                description: item.description,
                cost: Math.round(item.cost)
              });
          }
        }
      }

      async function updateBudgetBreakdownItems(preProjectID) {
        // Delete existing breakdown items
        await supabaseClient
          .from('BudgetBreakdown_Tbl')
          .delete()
          .eq('preProjectID', preProjectID);

        // Insert new items
        await saveBudgetBreakdownItems(preProjectID);
      }

      async function createCaptainNotification(preProjectID, projectTitle) {
        try {
          // Find captain user
          const { data: captainData } = await supabaseClient
            .from('User_Tbl')
            .select('userID')
            .eq('role', 'CAPTAIN')
            .eq('accountStatus', 'ACTIVE')
            .single();

          if (captainData) {
            await supabaseClient
              .from('Notification_Tbl')
              .insert({
                userID: captainData.userID,
                notificationType: 'project_awaiting_approval',
                title: `New project awaiting approval: ${projectTitle}`,
                isRead: false
              });
          }
        } catch (err) {
          console.warn('Could not create captain notification:', err);
        }
      }

      // Send reply to inquiry
      async function sendInquiryReply(inquiryId) {
        const replyText = document
          .getElementById(`replyText_${inquiryId}`)
          .value.trim();

        if (!replyText) {
          showToast("Please type a reply message.", "error");
          return;
        }

        try {
          // Insert reply into Reply_Tbl
          const { data, error } = await supabaseClient
            .from('Reply_Tbl')
            .insert({
              inquiryID: inquiryId,
              userID: currentUser.id,
              message: replyText,
              timeStamp: new Date().toISOString()
            })
            .select();

          if (error) {
            console.error('Error sending reply:', error);
            showToast('Failed to send reply. Please try again.', 'error');
            return;
          }

          // Update inquiry isReplied status
          await supabaseClient
            .from('Inquiry_Tbl')
            .update({ isReplied: true })
            .eq('inquiryID', inquiryId);

          // Clear input
          document.getElementById(`replyText_${inquiryId}`).value = '';

          showToast("Reply sent successfully");

          // Reload project data to show new reply
          const project = projects.find((p) => p.id === currentProjectId);
          if (project) {
            project.inquiries = await loadProjectInquiries(currentProjectId);
            loadInquiries(project);
          }

        } catch (err) {
          console.error('Send reply exception:', err);
          showToast('An error occurred. Please try again.', 'error');
        }
      }

      // Search and filter
      document
        .getElementById("projectSearch")
        .addEventListener("input", applyFilters);
      document
        .getElementById("categoryFilter")
        .addEventListener("change", applyFilters);

      function applyFilters() {
        const search = document
          .getElementById("projectSearch")
          .value.toLowerCase();
        const category = document.getElementById("categoryFilter").value;

        const filtered = projects.filter((p) => {
          const matchSearch =
            !search ||
            p.title.toLowerCase().includes(search) ||
            p.description.toLowerCase().includes(search) ||
            p.category.toLowerCase().includes(search) ||
            p.heads.join(" ").toLowerCase().includes(search);
          const matchCategory = !category || p.category === category;
          return matchSearch && matchCategory;
        });

        currentPage = 0; // Reset to first page when filters change
        renderProjects(filtered);
      }

      // Toast notification system
      function showToast(message, type = 'success') {
        // Remove any existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        // Icon based on type
        let icon = '';
        if (type === 'success') {
          icon = '<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        } else if (type === 'error') {
          icon = '<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        } else if (type === 'warning') {
          icon = '<svg class="w-5 h-5 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
        } else {
          icon = '<svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        toast.innerHTML = `
          ${icon}
          <span class="text-sm text-gray-800 flex-1">${message}</span>
          <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        `;

        document.body.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);

        // Auto remove after 4 seconds
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Confirmation modal system
      function showConfirm(title, message, onConfirm, confirmButtonText = 'Delete', confirmButtonColor = 'red') {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        titleEl.textContent = title;
        messageEl.textContent = message;
        confirmBtn.textContent = confirmButtonText;

        // Update button colors
        if (confirmButtonColor === 'green') {
          confirmBtn.className = 'flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition font-medium';
        } else if (confirmButtonColor === 'yellow') {
          confirmBtn.className = 'flex-1 px-4 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium';
        } else {
          confirmBtn.className = 'flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium';
        }

        modal.classList.remove('hidden');

        const handleConfirm = () => {
          modal.classList.add('hidden');
          onConfirm();
          cleanup();
        };

        const handleCancel = () => {
          modal.classList.add('hidden');
          cleanup();
        };

        const cleanup = () => {
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);

        // Close on click outside
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        });
      }

      // Display captain's decision in project details
      function displayCaptainDecision(project) {
        const section = document.getElementById('captainDecisionSection');
        const content = document.getElementById('decisionContent');
        const icon = document.getElementById('decisionIcon');
        const statusEl = document.getElementById('decisionStatus');
        const dateEl = document.getElementById('decisionDate');
        const commentsEl = document.getElementById('decisionComments');

        // Check if project has approval status and notes from captain
        if (project.approvalStatus && project.notes) {
          section.classList.remove('hidden');

          let iconText = '';
          let iconBg = '';
          let borderColor = '';
          let statusText = '';
          let dateText = '';

          if (project.approvalStatus === 'approved') {
            iconText = '✓';
            iconBg = 'bg-green-100 text-green-600';
            borderColor = 'border-green-500';
            statusText = 'Project Approved';
            dateText = project.approvalDate ? `Approved on ${project.approvalDate}` : 'Recently approved';
          } else if (project.approvalStatus === 'rejected') {
            iconText = '✗';
            iconBg = 'bg-red-100 text-red-600';
            borderColor = 'border-red-500';
            statusText = 'Project Rejected';
            dateText = project.rejectionDate ? `Rejected on ${project.rejectionDate}` : 'Recently rejected';
          } else if (project.approvalStatus === 'revision-requested') {
            iconText = '✎';
            iconBg = 'bg-yellow-100 text-yellow-600';
            borderColor = 'border-yellow-500';
            statusText = 'Revision Requested';
            dateText = project.revisionRequestDate ? `Requested on ${project.revisionRequestDate}` : 'Recently requested';
          }

          icon.className = `w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold ${iconBg}`;
          icon.textContent = iconText;

          statusEl.textContent = statusText;
          dateEl.textContent = dateText;
          commentsEl.textContent = project.notes || 'No comments provided.';

          content.className = `bg-gray-50 rounded-lg p-5 border-l-4 ${borderColor}`;
        } else {
          section.classList.add('hidden');
        }
      }

      // Close dropdowns on outside click
      document.addEventListener("click", (e) => {
        if (!document.getElementById("headsSelect").contains(e.target)) {
          document.getElementById("headsDropdown").classList.add("hidden");
        }
      });

      // Initialize
      renderProjects(projects);

      // =========================================
      // LOGOUT HANDLER
      // =========================================
      async function handleLogout() {
        try {
          await SessionManager.logout();
          // SessionManager handles redirect to login page
        } catch (error) {
          console.error('Logout error:', error);
          showToast('Failed to logout. Please try again.', 'error');
        }
      }

      // Make functions globally accessible
      window.handleLogout = handleLogout;
      window.viewProject = viewProject;
      window.closeProjectView = closeProjectView;
      window.switchTab = switchTab;
      window.editProject = editProject;
      window.closeProjectModal = closeProjectModal;
      window.cancelProjectApproval = cancelProjectApproval;
      window.closeCancelApprovalModal = closeCancelApprovalModal;
      window.confirmCancelApproval = confirmCancelApproval;
      window.closeApplicantModal = closeApplicantModal;
      window.viewApplicant = viewApplicant;
      window.updateStatus = updateStatus;
      window.removeHead = removeHead;
      window.openHeadsDropdown = openHeadsDropdown;
      window.filterApplicants = filterApplicants;
      window.applyFilters = applyFilters;
      window.sendInquiryReply = sendInquiryReply;
      window.openEvaluationModal = openEvaluationModal;
      window.closeEvaluationModal = closeEvaluationModal;
      window.submitEvaluation = submitEvaluation;
      window.calculateSuccessRate = calculateSuccessRate;
      window.openDownloadReportModal = openDownloadReportModal;
      window.closeDownloadReportModal = closeDownloadReportModal;
      window.downloadReport = downloadReport;
      window.archiveProject = archiveProject;
      window.goToPage = goToPage;
      window.addQuickAchievement = addQuickAchievement;
      window.addAchievement = addAchievement;
      window.selectAchievementSuggestion = selectAchievementSuggestion;
      window.removeAchievement = removeAchievement;
      window.showAchievementSuggestions = showAchievementSuggestions;
      window.generateAttendancePDF = generateAttendancePDF;
      window.uploadAttendancePDF = uploadAttendancePDF;
      window.viewReceiptImage = viewReceiptImage;
      window.navigateProjects = navigateProjects;
      window.addBudgetRow = addBudgetRow;
      window.removeBudgetRow = removeBudgetRow;
      window.updateBudgetItem = updateBudgetItem;
      window.updateBudgetRemaining = updateBudgetRemaining;
      window.addActualBreakdownRow = addActualBreakdownRow;
      window.deleteActualBreakdownRow = deleteActualBreakdownRow;
      window.removeReceipt = removeReceipt;
      // Handle URL parameters for deep linking to inquiries
      function handleURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get("projectId");
        const tab = urlParams.get("tab");
        const applicantId = urlParams.get("applicantId");

        if (projectId) {
          const id = parseInt(projectId);
          const project = projects.find((p) => p.id === id);

          if (project) {
            viewProject(id);

            if (tab === "inquiries") {
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  switchTab("inquiries");
                });
              });
            } else if (tab === "applications") {
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  switchTab("applicants");
                  // If applicantId is provided, open that applicant's details modal
                  if (applicantId) {
                    requestAnimationFrame(() => {
                      const applicant = applications.find(
                        (a) => a.id === parseInt(applicantId)
                      );
                      if (applicant) {
                        viewApplicant(applicant, project);
                      }
                    });
                  }
                });
              });
            }
          }
        }
      }

      // ========== SUCCESS RATE EVALUATION MODAL FUNCTIONS ==========

      function openEvaluationModal(projectId) {
        currentProjectId = projectId;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        document.getElementById('evalProjectTitle').textContent = project.title;
        document.getElementById('evaluationModal').classList.remove('hidden');

        // Auto-fill from project proposal data
        document.getElementById('budgetPlanned').value = project.budget || '';
        document.getElementById('volunteersTarget').value = project.expectedVolunteers || '';
        document.getElementById('beneficiariesTarget').value = project.targetBeneficiaries || '';

        // Load actual budget breakdown (auto-fills from planned, user can edit)
        loadActualBreakdownFromPlanned(projectId);

        // Reset actual values
        document.getElementById('budgetActual').value = '';
        document.getElementById('volunteersActual').value = '';
        document.getElementById('timelineStatus').value = '';
        document.getElementById('beneficiariesActual').value = '';

        // Load volunteer feedback data from project
        const approvedVolunteers = project.applications.filter(a => a.status === 'approved');
        const volunteersWithFeedback = approvedVolunteers.filter(v => v.satisfactionScore);
        const avgSatisfaction = volunteersWithFeedback.length > 0
          ? (volunteersWithFeedback.reduce((sum, v) => sum + v.satisfactionScore, 0) / volunteersWithFeedback.length).toFixed(1)
          : '-';

        document.getElementById('autoFeedbackScore').textContent = avgSatisfaction !== '-' ? `${avgSatisfaction}/4` : '-';
        document.getElementById('surveyCount').textContent = volunteersWithFeedback.length;
        document.getElementById('totalVolunteers').textContent = approvedVolunteers.length;

        calculateSuccessRate();
      }

      function closeEvaluationModal() {
        document.getElementById('evaluationModal').classList.add('hidden');
        currentProjectId = null;
        // Clear achievements
        projectAchievements = [];
        document.getElementById('achievementsList').innerHTML = '';
        document.getElementById('achievementInput').value = '';
        document.getElementById('achievementNumber').textContent = '1';
      }

      // ========== ACHIEVEMENTS FUNCTIONS ==========

      let projectAchievements = [];

      const achievementTemplates = {
        environmental: [
          "Successfully collected and properly disposed of {X} kg of waste materials from the community",
          "Planted {X} native trees across {Y} hectares of degraded land, contributing to reforestation efforts",
          "Reduced plastic waste by {X}% through community education and eco-friendly alternatives",
          "Established {X} community compost bins serving {Y} households in the barangay",
          "Cleaned and rehabilitated {X} meters of coastal/riverbank areas, removing debris and pollutants",
          "Organized {X} environmental awareness workshops reaching {Y} community members"
        ],
        community: [
          "Engaged {X} community members in active participation throughout the project duration",
          "Strengthened partnerships with {X} local organizations and {Y} barangay officials",
          "Distributed essential resources to {X} families in need within the community",
          "Facilitated {X} community dialogues fostering collaboration among {Y} stakeholders",
          "Established {X} sustainable community programs benefiting {Y} residents long-term",
          "Built strong relationships with {X} local leaders enhancing future project collaboration"
        ],
        volunteer: [
          "Mobilized {X} dedicated volunteers who contributed a total of {Y} service hours",
          "Achieved {X}% volunteer retention rate with {Y} volunteers participating in multiple activities",
          "Trained {X} volunteers in leadership and project management skills for future initiatives",
          "Developed teamwork and collaboration among {X} volunteers from diverse backgrounds",
          "Recognized {X} outstanding volunteers for exceptional dedication and community service",
          "Created a volunteer network of {X} individuals committed to ongoing community development"
        ],
        educational: [
          "Conducted {X} educational sessions on environmental conservation reaching {Y} participants",
          "Distributed {X} informational materials educating community members on sustainable practices",
          "Trained {X} community leaders as environmental advocates and change agents",
          "Organized {X} skills workshops equipping {Y} residents with practical knowledge",
          "Developed {X} learning modules adopted by {Y} barangays for community education",
          "Achieved {X}% increase in community awareness on environmental issues through targeted campaigns"
        ],
        impact: [
          "Exceeded target beneficiaries by {X}%, reaching {Y} individuals instead of the projected goal",
          "Achieved {X}% satisfaction rating from community members based on post-project surveys",
          "Generated {X}% cost savings by completing the project under budget while maintaining quality",
          "Completed all project milestones {X} days ahead of schedule demonstrating efficient execution",
          "Created lasting impact with {X}% of participants committing to continued environmental action",
          "Secured {X} commitments from local businesses and organizations for ongoing support of initiatives"
        ]
      };

      function showAchievementSuggestions(inputValue) {
        const suggestionsDiv = document.getElementById('achievementSuggestions');

        if (!inputValue || inputValue.trim().length < 2) {
          suggestionsDiv.classList.add('hidden');
          return;
        }

        const allTemplates = Object.values(achievementTemplates).flat();
        const matches = allTemplates.filter(template =>
          template.toLowerCase().includes(inputValue.toLowerCase())
        );

        if (matches.length === 0) {
          suggestionsDiv.classList.add('hidden');
          return;
        }

        suggestionsDiv.innerHTML = matches.slice(0, 8).map(template => `
          <div class="px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0"
               onclick="selectAchievementSuggestion('${template.replace(/'/g, "\\'")}')">
            <p class="text-sm text-gray-700">${template}</p>
          </div>
        `).join('');

        suggestionsDiv.classList.remove('hidden');
      }

      function selectAchievementSuggestion(template) {
        document.getElementById('achievementInput').value = template;
        document.getElementById('achievementSuggestions').classList.add('hidden');
      }

      function addQuickAchievement(category) {
        const templates = achievementTemplates[category];
        if (!templates || templates.length === 0) return;

        // Get a random template from the category
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
        document.getElementById('achievementInput').value = randomTemplate;
        document.getElementById('achievementSuggestions').classList.add('hidden');

        // Auto-focus on the input
        document.getElementById('achievementInput').focus();
      }

      function addAchievement() {
        const input = document.getElementById('achievementInput');
        const achievementText = input.value.trim();

        if (!achievementText) {
          showToast('Please enter an achievement description', 'error');
          return;
        }

        projectAchievements.push(achievementText);
        renderAchievementsList();

        // Clear input and update number
        input.value = '';
        document.getElementById('achievementNumber').textContent = projectAchievements.length + 1;
        document.getElementById('achievementSuggestions').classList.add('hidden');
      }

      function removeAchievement(index) {
        projectAchievements.splice(index, 1);
        renderAchievementsList();
        document.getElementById('achievementNumber').textContent = projectAchievements.length + 1;
      }

      function renderAchievementsList() {
        const listDiv = document.getElementById('achievementsList');

        if (projectAchievements.length === 0) {
          listDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No achievements added yet</p>';
          return;
        }

        listDiv.innerHTML = projectAchievements.map((achievement, index) => `
          <div class="flex items-start gap-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
            <div class="flex-shrink-0 w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-xs font-bold">
              ${index + 1}
            </div>
            <p class="flex-1 text-sm text-gray-700 leading-relaxed">${achievement}</p>
            <button onclick="removeAchievement(${index})"
                    class="flex-shrink-0 text-red-600 hover:text-red-800 transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        `).join('');
      }

      // Close suggestions when clicking outside
      document.addEventListener('click', function(event) {
        const input = document.getElementById('achievementInput');
        const suggestions = document.getElementById('achievementSuggestions');

        if (input && suggestions && !input.contains(event.target) && !suggestions.contains(event.target)) {
          suggestions.classList.add('hidden');
        }
      });

      // ========== ACTUAL BUDGET BREAKDOWN WITH RECEIPTS ==========

      let actualBreakdownItems = [];

      function loadActualBreakdownFromPlanned(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project || !project.budgetBreakdown) {
          actualBreakdownItems = [];
          return;
        }

        // Auto-fill from planned budget breakdown
        actualBreakdownItems = project.budgetBreakdown.map(item => ({
          id: item.id,
          description: item.description,
          plannedCost: item.cost,
          actualCost: item.cost, // Pre-fill with planned cost (user can edit)
          receipt: null,
          receiptPreview: null
        }));

        // Load saved actual breakdown if exists
        if (project.actualBreakdown) {
          project.actualBreakdown.forEach(savedItem => {
            const item = actualBreakdownItems.find(i => i.id === savedItem.id);
            if (item) {
              item.actualCost = savedItem.actualCost;
              item.receipt = savedItem.receipt;
              item.receiptPreview = savedItem.receiptPreview;
            }
          });
        }

        renderActualBreakdownTable();
      }

      function renderActualBreakdownTable() {
        const tableBody = document.getElementById('actualBudgetBreakdownTable');
        tableBody.innerHTML = '';

        actualBreakdownItems.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-200 hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-3 py-3">
              <input type="text" value="${item.description}" onchange="updateActualBreakdownDescription(${index}, this.value)"
                     class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-[#3d8b64] text-sm" />
            </td>
            <td class="px-3 py-3 text-gray-600">₱${item.plannedCost.toLocaleString()}</td>
            <td class="px-3 py-3">
              <input type="number" value="${item.actualCost}" onchange="updateActualBreakdownCost(${index}, this.value)"
                     class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-[#3d8b64] text-sm" min="0" />
            </td>
            <td class="px-3 py-3">
              <div class="flex items-center gap-2">
                ${item.receiptPreview ? `
                  <img src="${item.receiptPreview}" class="w-10 h-10 object-cover rounded border cursor-pointer" onclick="viewReceiptImage(${index})" title="Click to view" />
                  <button onclick="removeReceipt(${index})" class="text-red-600 hover:text-red-800 text-xs">
                    <i class="fas fa-times"></i>
                  </button>
                ` : `
                  <label class="cursor-pointer text-[#2f6e4e] hover:text-[#2f6e4e] text-xs flex items-center gap-1">
                    <i class="fas fa-upload"></i>
                    <span>Upload</span>
                    <input type="file" accept="image/*" onchange="uploadReceipt(${index}, event)" class="hidden" />
                  </label>
                `}
              </div>
            </td>
            <td class="px-3 py-3 text-center">
              <button onclick="deleteActualBreakdownRow(${index})" class="text-red-600 hover:text-red-800" title="Remove item">
                <i class="fas fa-times text-sm"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });

        updateActualBreakdownTotals();
      }

      function addActualBreakdownRow() {
        const newItem = {
          id: Date.now(),
          description: '',
          plannedCost: 0,
          actualCost: 0,
          receipt: null,
          receiptPreview: null
        };
        actualBreakdownItems.push(newItem);
        renderActualBreakdownTable();
      }

      function updateActualBreakdownDescription(index, value) {
        actualBreakdownItems[index].description = value;
      }

      function updateActualBreakdownCost(index, value) {
        actualBreakdownItems[index].actualCost = parseFloat(value) || 0;
        updateActualBreakdownTotals();
      }

      function deleteActualBreakdownRow(index) {
        showConfirm(
          'Remove Budget Item',
          'Remove this budget item?',
          () => {
            actualBreakdownItems.splice(index, 1);
            renderActualBreakdownTable();
          },
          'Remove',
          'red'
        );
      }

      function uploadReceipt(index, event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          showToast('Please upload an image file', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          actualBreakdownItems[index].receipt = file.name;
          actualBreakdownItems[index].receiptPreview = e.target.result;
          renderActualBreakdownTable();
        };
        reader.readAsDataURL(file);
      }

      function removeReceipt(index) {
        actualBreakdownItems[index].receipt = null;
        actualBreakdownItems[index].receiptPreview = null;
        renderActualBreakdownTable();
      }

      function viewReceiptImage(index) {
        const receipt = actualBreakdownItems[index];
        if (!receipt.receiptPreview) return;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
        modal.onclick = () => modal.remove();
        modal.innerHTML = `
          <div class="max-w-4xl max-h-[90vh] relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-gray-100">
              <i class="fas fa-times"></i>
            </button>
            <img src="${receipt.receiptPreview}" class="max-w-full max-h-[90vh] rounded shadow-2xl" />
          </div>
        `;
        document.body.appendChild(modal);
      }

      function updateActualBreakdownTotals() {
        const plannedTotal = actualBreakdownItems.reduce((sum, item) => sum + item.plannedCost, 0);
        const actualTotal = actualBreakdownItems.reduce((sum, item) => sum + item.actualCost, 0);

        document.getElementById('plannedBreakdownTotal').textContent = '₱' + plannedTotal.toLocaleString();
        document.getElementById('actualBreakdownTotal').textContent = '₱' + actualTotal.toLocaleString();

        // Auto-update the main Actual Spent field
        document.getElementById('budgetActual').value = actualTotal;
        calculateSuccessRate();
      }

      function updateActualTotalFromBreakdown() {
        // This is called when manual edit is attempted - ignore it since we auto-calculate
        return;
      }

      // ========== SUCCESS RATE CALCULATION ==========

      function calculateSuccessRate() {
        const budgetPlanned = parseFloat(document.getElementById('budgetPlanned').value) || 0;
        const budgetActual = parseFloat(document.getElementById('budgetActual').value) || 0;
        const volunteersTarget = parseFloat(document.getElementById('volunteersTarget').value) || 0;
        const volunteersActual = parseFloat(document.getElementById('volunteersActual').value) || 0;
        const timelineStatus = document.getElementById('timelineStatus').value;
        const beneficiariesTarget = parseFloat(document.getElementById('beneficiariesTarget').value) || 0;
        const beneficiariesActual = parseFloat(document.getElementById('beneficiariesActual').value) || 0;

        // Calculate Budget Efficiency (25%) - closer to planned is better
        let budgetScore = 0;
        if (budgetPlanned > 0) {
          const budgetEfficiency = Math.min((budgetPlanned / budgetActual) * 100, 100);
          budgetScore = budgetEfficiency;
        }

        // Calculate Volunteer Participation (20%)
        let participationScore = 0;
        if (volunteersTarget > 0) {
          participationScore = Math.min((volunteersActual / volunteersTarget) * 100, 100);
        }

        // Calculate Timeline Adherence (20%)
        const timelineScores = {
          'on-time': 100,
          'slightly-delayed': 70,
          'delayed': 40,
          'significantly-delayed': 10
        };
        const timelineScore = timelineScores[timelineStatus] || 0;

        // Calculate Community Impact (20%) - Based on beneficiaries reached
        let impactScore = 0;
        if (beneficiariesTarget > 0) {
          impactScore = Math.min((beneficiariesActual / beneficiariesTarget) * 100, 100);
        }

        // Calculate Volunteer Feedback (15%) - Auto-calculated from volunteer surveys
        const feedbackText = document.getElementById('autoFeedbackScore').textContent;
        const feedbackRating = feedbackText !== '-' ? parseFloat(feedbackText.split('/')[0]) : 0;
        const feedbackScore = (feedbackRating / 4) * 100;

        // Weighted calculation
        const successRate = Math.round(
          (budgetScore * 0.25) +
          (participationScore * 0.20) +
          (timelineScore * 0.20) +
          (impactScore * 0.20) +
          (feedbackScore * 0.15)
        );

        // Update display
        document.getElementById('successRateValue').textContent = successRate + '%';
        document.getElementById('successRateBar').style.width = successRate + '%';

        // Update breakdown
        document.getElementById('budgetScoreValue').textContent = Math.round(budgetScore * 0.25);
        document.getElementById('participationScoreValue').textContent = Math.round(participationScore * 0.20);
        document.getElementById('timelineScoreValue').textContent = Math.round(timelineScore * 0.20);
        document.getElementById('impactScoreValue').textContent = Math.round(impactScore * 0.20);
        document.getElementById('feedbackScoreValue').textContent = Math.round(feedbackScore * 0.15);

        return successRate;
      }

      async function submitEvaluation() {
        const budgetPlanned = parseFloat(document.getElementById('budgetPlanned').value);
        const budgetActual = parseFloat(document.getElementById('budgetActual').value);
        const volunteersTarget = parseFloat(document.getElementById('volunteersTarget').value);
        const volunteersActual = parseFloat(document.getElementById('volunteersActual').value);
        const timelineStatus = document.getElementById('timelineStatus').value;
        const beneficiariesTarget = parseFloat(document.getElementById('beneficiariesTarget').value);
        const beneficiariesActual = parseFloat(document.getElementById('beneficiariesActual').value);

        if (!budgetPlanned || !budgetActual || !volunteersTarget || !volunteersActual || !timelineStatus || !beneficiariesTarget || !beneficiariesActual) {
          showToast('Please fill in all required fields', 'error');
          return;
        }

        const feedbackText = document.getElementById('autoFeedbackScore').textContent;
        const feedbackRating = feedbackText !== '-' ? parseFloat(feedbackText.split('/')[0]) : 0;

        const successRate = calculateSuccessRate();

        try {
          // Update project status to COMPLETED
          const { error: projectError } = await supabaseClient
            .from('Pre_Project_Tbl')
            .update({
              status: 'COMPLETED',
              updatedAt: new Date().toISOString()
            })
            .eq('preProjectID', currentProjectId);

          if (projectError) {
            console.error('Error updating project status:', projectError);
            showToast('Failed to mark project as complete. Please try again.', 'error');
            return;
          }

          // Create Post_Project_Tbl entry
          const { data: postProject, error: postError } = await supabaseClient
            .from('Post_Project_Tbl')
            .insert({
              preProjectID: currentProjectId,
              actualVolunteer: Math.round(volunteersActual),
              timelineAdherence: timelineStatus,
              beneficiariesReached: Math.round(beneficiariesActual),
              projectAchievement: projectAchievements.join('\n')
            })
            .select()
            .single();

          if (postError) {
            console.error('Error creating post-project record:', postError);
            // Continue anyway - the project status is updated
          }

          // Save actual expense data
          if (actualBreakdownItems.length > 0 && postProject) {
            for (const item of actualBreakdownItems) {
              if (item.actualCost > 0) {
                await supabaseClient
                  .from('Expenses_Tbl')
                  .insert({
                    breakdownID: item.id,
                    actualCost: item.actualCost,
                    receiptURL: item.receipt || null
                  });
              }
            }
          }

          showToast(`Project marked as complete with ${successRate}% success rate!`);
          closeEvaluationModal();
          await loadProjects(); // Reload projects to reflect changes

        } catch (err) {
          console.error('Submit evaluation exception:', err);
          showToast('An error occurred. Please try again.', 'error');
        }
      }

      // ========== ARCHIVE PROJECT FUNCTIONS ==========

      function archiveProject(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        const archivableStatuses = ['Completed', 'Rejected', 'Pending for Revision'];
        if (!archivableStatuses.includes(project.status)) {
          showToast('Only completed, rejected, or projects pending revision can be archived.', 'warning');
          return;
        }

        showConfirm(
          'Archive Project',
          `Are you sure you want to archive "${escapeHTML(project.title)}"?\n\nStatus: ${project.status}\nThis will move the project to the Archive section.`,
          async () => {
            try {
              // Update project status to CANCELLED (archived)
              const { error } = await supabaseClient
                .from('Pre_Project_Tbl')
                .update({
                  status: 'CANCELLED',
                  updatedAt: new Date().toISOString()
                })
                .eq('preProjectID', projectId);

              if (error) {
                console.error('Error archiving project:', error);
                showToast('Failed to archive project. Please try again.', 'error');
                return;
              }

              showToast('Project archived successfully', 'success');
              await loadProjects(); // Reload projects
            } catch (err) {
              console.error('Archive project exception:', err);
              showToast('An error occurred. Please try again.', 'error');
            }
          },
          'Archive',
          'yellow'
        );
      }

      // Auto-archive completed projects after 3 months
      function checkAutoArchive() {
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

        projects.forEach(project => {
          if (project.status === 'Completed' && project.evaluation && project.evaluation.completedDate) {
            const completedDate = new Date(project.evaluation.completedDate);

            // If completed more than 3 months ago, auto-archive
            if (completedDate < threeMonthsAgo) {
              console.log(`Auto-archiving project: ${project.title}`);
              projects = projects.filter(p => p.id !== project.id);
              showToast(`"${project.title}" was automatically archived (completed >3 months ago)`);
            }
          }
        });

        renderProjects(projects);
      }

      // Run auto-archive check on page load and every hour
      checkAutoArchive();
      setInterval(checkAutoArchive, 3600000); // Check every hour

      // ========== DOWNLOAD REPORT MODAL FUNCTIONS ==========

      function openDownloadReportModal(projectId) {
        currentProjectId = projectId;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        document.getElementById('downloadProjectTitle').textContent = project.title;
        document.getElementById('downloadReportModal').classList.remove('hidden');
      }

      function closeDownloadReportModal() {
        document.getElementById('downloadReportModal').classList.add('hidden');
        currentProjectId = null;
      }

      function downloadReport(format) {
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) return;

        if (format === 'pdf') {
          showToast('Generating PDF report...');
          const volunteers = project.applications.filter(a => a.status === 'approved');

          // Build HTML content as array and join
          const htmlParts = [];
          htmlParts.push('<html><head><title>' + project.title + ' Report<\/title><\/head>');
          htmlParts.push('<body style="font-family: Arial; padding: 20px;">');
          htmlParts.push('<h1>' + project.title + '<\/h1>');
          htmlParts.push('<p><strong>Success Rate:<\/strong> ' + (project.successRate || 'N/A') + '%<\/p>');
          htmlParts.push('<p><strong>Category:<\/strong> ' + project.category + '<\/p>');
          htmlParts.push('<p><strong>Status:<\/strong> ' + project.status + '<\/p>');
          if (project.evaluation) {
            htmlParts.push('<h2>Evaluation Metrics<\/h2>');
            htmlParts.push('<p><strong>Budget:<\/strong> ₱' + project.evaluation.budgetActual.toLocaleString() + ' / ₱' + project.evaluation.budgetPlanned.toLocaleString() + '<\/p>');
            htmlParts.push('<p><strong>Volunteers:<\/strong> ' + project.evaluation.volunteersActual + ' / ' + project.evaluation.volunteersTarget + '<\/p>');
            htmlParts.push('<p><strong>Beneficiaries:<\/strong> ' + project.evaluation.beneficiariesActual + ' / ' + project.evaluation.beneficiariesTarget + '<\/p>');
          }
          htmlParts.push('<h2>Volunteers (' + volunteers.length + ')<\/h2>');
          htmlParts.push('<table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Name<\/th><th>Age<\/th><th>Contact<\/th><\/tr>');
          volunteers.forEach(v => {
            htmlParts.push('<tr><td>' + (v.fullName || v.firstName + ' ' + v.lastName) + '<\/td><td>' + v.age + '<\/td><td>' + (v.contact || 'N/A') + '<\/td><\/tr>');
          });
          htmlParts.push('<\/table>');
          htmlParts.push('<\/body><\/html>');

          const reportWindow = window.open('', '_blank');
          reportWindow.document.write(htmlParts.join(''));
          reportWindow.document.close();
          setTimeout(function() { reportWindow.print(); }, 500);

          showToast('PDF report opened. Use Print to save as PDF.');
          closeDownloadReportModal();
        } else if (format === 'excel') {
          showToast('Generating Excel report...');
          setTimeout(() => {
            console.log('Excel Report Data:', {
              project: project.title,
              successRate: project.successRate,
              evaluation: project.evaluation,
              volunteers: project.applications.filter(a => a.status === 'approved')
            });
            showToast('Excel report downloaded successfully!');
            closeDownloadReportModal();
          }, 1000);
        }
      }

      // ========== ATTENDANCE PDF UPLOAD ==========

      let uploadedAttendancePDF = null;

      function uploadAttendancePDF(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type !== 'application/pdf') {
          showToast('Please upload a PDF file', 'error');
          return;
        }

        uploadedAttendancePDF = file;
        document.getElementById('attendancePdfName').textContent = file.name;
        document.getElementById('attendancePdfName').classList.remove('italic', 'text-gray-600');
        document.getElementById('attendancePdfName').classList.add('text-[#2f6e4e]', 'font-medium');
      }

      // =========================================
      // INITIALIZE ON PAGE LOAD
      // =========================================
      document.addEventListener('DOMContentLoaded', () => {
        initializePage();
      });
    </script>
    <script src="js/mobile-nav.js"></script>
  </body>
</html>
