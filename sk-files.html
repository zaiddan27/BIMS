<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="SK File Management - Upload and manage barangay documents">
    <title>BIMS - SK Manage Files</title>

    <!-- Tailwind CSS CDN -->
    <link href="css/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link href="css/toast.css" rel="stylesheet">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.97.0" integrity="sha384-1+ItoWbWcmVSm+Y+dJaUt4SEWNA21/jxef+Z0TSHHVy/dEUxEUEnZ1bHn6GT5hj+" crossorigin="anonymous"></script>
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>
    <script src="js/utils/sanitize.js"></script>
    <script src="js/utils/toast.js"></script>
    <script src="js/utils/focus-trap.js"></script>

    <!-- PDF.js for PDF Preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha384-/1qUCSGwTur9vjf/z9lmu/eCUYbpOTgSjmpbMQZ1/CtX2v/WcAIKqRv+U1DUCG6e" crossorigin="anonymous" defer></script>
    <style>
      .icon-wrapper { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .icon-wrapper:hover { transform: translateY(-2px); }
      .nav-link svg { transition: all 0.3s ease; }
      .nav-link:hover svg { transform: scale(1.1); }
      .icon-badge { box-shadow: 0 2px 8px rgba(47, 110, 78, 0.15); }
      .notification-icon { position: relative; }
      .notification-icon:hover { transform: rotate(15deg) scale(1.1); transition: transform 0.3s ease; }
      .status-icon-pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
      .status-icon-approved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
      .status-icon-rejected { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
      .icon-primary { filter: drop-shadow(0 2px 4px rgba(47, 110, 78, 0.1)); }
      .icon-glow { filter: drop-shadow(0 0 8px rgba(47, 110, 78, 0.3)); }

      /* Input validation states */
      .input-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }

      .input-success {
        border-color: #10b981 !important;
      }

      /* Loading spinner */
      .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.6s linear infinite;
      }

      .spinner-lg {
        border: 3px solid rgba(47, 110, 78, 0.2);
        border-top-color: #2f6e4e;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Upload progress bar */
      .upload-progress {
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
      }

      .upload-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #2f6e4e 0%, #3d8b64 100%);
        transition: width 0.3s ease;
      }

      /* Pagination dots - consistent across all screen sizes */
      #filePaginationDots button {
        flex-shrink: 0;
        display: inline-block;
        cursor: pointer;
        border: none;
        padding: 0;
        outline: none;
      }

      #filePaginationDots button:focus {
        outline: 2px solid rgba(47, 110, 78, 0.3);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body class="bg-gray-50 overflow-x-hidden">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[9999] focus:bg-white focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:text-[#2f6e4e] focus:font-medium">Skip to content</a>
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col" data-role="sk"></aside>
      <script src="js/components/sidebar.js"></script>

      <!-- Confirmation Modal -->
      <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
          <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <h3 id="confirmModalTitle" class="text-lg font-bold text-gray-900 text-center mb-2">Confirm Action</h3>
          <p id="confirmMessage" class="text-sm text-gray-600 text-center mb-6">Are you sure you want to proceed?</p>
          <div class="flex gap-3">
            <button id="confirmCancel" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Cancel</button>
            <button id="confirmOk" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium">Delete</button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="main-content" class="flex-1 overflow-auto">
        <!-- Top Bar -->
        <header class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-[#2f6e4e] font-semibold mb-1" id="currentDate">Sunday, December 14, 2025</p>
                <h1 class="text-2xl font-bold text-gray-800">Manage Files</h1>
                <p class="text-sm text-gray-600 mt-1">Upload, organize, and share documents with your team and volunteers</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="window.notificationModal.toggle()" class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Notifications">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse">5</span>
                  </button>
                </div>
                <button onclick="window.profileModal.open()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-[#2f6e4e] transition">Loading...</p>
                    <p class="text-xs text-gray-500">SK Official</p>
                  </div>
                  <div class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20 group-hover:ring-[#2f6e4e]/40 transition">
                    --
                  </div>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- File Management Section -->
        <div class="px-6 py-6">
          <div class="max-w-7xl mx-auto">
            <!-- ========================= -->
            <!-- MANAGE FILES (REPLACES ANNOUNCEMENTS) -->
            <!-- ========================= -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
              <div class="flex items-center justify-end mb-6">
                <!-- Upload button (admin) -->
                <div class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 rounded-xl px-3 py-2 transition-all duration-300 group" onclick="openProfileModal()">
                  <button
                    onclick="openUploadModal()"
                    class="cursor-pointer px-4 py-2 bg-[#2f6e4e] hover:bg-[#2f6e4e] text-white rounded-lg font-medium transition flex items-center space-x-2 min-w-[180px] justify-center"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"
                      ></path>
                    </svg>
                    <span>Upload File</span>
                  </button>

                  <button
                    id="bulkDeleteBtn"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition hidden"
                  >
                    Delete Selected
                  </button>
                </div>
              </div>

              <!-- Search Bar -->
              <div class="mb-6 grid grid-cols-1 md:grid-cols-[1fr_auto] gap-3">
                <input
                  id="fileSearch"
                  type="text"
                  placeholder="Search files by name or date..."
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
                />
                <select
                  id="filterCategory"
                  class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white md:min-w-[180px]"
                >
                  <option value="">All categories</option>
                  <option value="general">General Files</option>
                  <option value="project">Project Files</option>
                  <option value="published">Published Files</option>
                </select>
              </div>

              <!-- Loading Skeleton -->
              <div id="filesLoadingSkeleton" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="border border-gray-200 rounded-xl p-5 animate-pulse">
                  <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
                    <div class="ml-3 flex-1">
                      <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                      <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                  </div>
                  <div class="flex gap-2 mt-4">
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                  </div>
                </div>
                <div class="border border-gray-200 rounded-xl p-5 animate-pulse">
                  <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
                    <div class="ml-3 flex-1">
                      <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                      <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                  </div>
                  <div class="flex gap-2 mt-4">
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                  </div>
                </div>
                <div class="border border-gray-200 rounded-xl p-5 animate-pulse">
                  <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-gray-200 rounded-lg"></div>
                    <div class="ml-3 flex-1">
                      <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                      <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                  </div>
                  <div class="flex gap-2 mt-4">
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                    <div class="h-8 bg-gray-200 rounded flex-1"></div>
                  </div>
                </div>
              </div>

              <!-- File Grid -->
              <div
                id="filesGrid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"
              >
                <!-- File cards are injected by JS -->
              </div>

              <!-- Pagination Dots (Center) -->
              <div id="filePaginationDots" class="flex justify-center gap-2 mt-6 hidden">
                <!-- Dots will be inserted here -->
              </div>

              <!-- Pagination Controls (Bottom Right) -->
              <div class="mt-6 flex justify-end">
                <nav
                  id="filePaginationNav"
                  class="hidden inline-flex rounded-md shadow-sm"
                  role="navigation"
                  aria-label="Pagination"
                >
                  <button
                    id="prevPage"
                    onclick="navigateFiles(-1)"
                    class="px-3 py-2 border border-gray-200 rounded-l-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Prev
                  </button>
                  <button
                    id="nextPage"
                    onclick="navigateFiles(1)"
                    class="px-3 py-2 border-t border-b border-r border-gray-200 rounded-r-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Next
                  </button>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- View File Modal -->
    <div
      id="viewFileModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4"
      role="dialog" aria-modal="true" aria-labelledby="viewFileModalTitle"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div
          class="p-6 border-b border-gray-200 flex items-center justify-between"
        >
          <h3 id="viewFileModalTitle" class="text-2xl font-bold text-gray-800">
            View File
          </h3>
          <button
            onclick="closeFileModal()"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            ✕
          </button>
        </div>

        <div class="p-6 space-y-4">
          <!-- Loading State -->
          <div id="viewFileLoading" class="hidden h-80 bg-gray-100 rounded-lg flex items-center justify-center">
            <div class="text-center">
              <div class="spinner-lg mx-auto mb-3"></div>
              <p class="text-gray-500">Loading preview...</p>
            </div>
          </div>

          <div
            id="viewFilePreview"
            class="h-80 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden"
          >
            <!-- Image Preview -->
            <img
              id="viewFileImg"
              src=""
              alt="file"
              class="object-contain h-full w-full hidden"
            />
            <!-- PDF Preview Canvas -->
            <canvas id="pdfCanvas" class="hidden max-h-full max-w-full"></canvas>
            <!-- File Icon Fallback -->
            <div id="viewFileIcon" class="text-center hidden">
              <div id="fileIconBg" class="w-20 h-20 rounded-xl flex items-center justify-center mx-auto mb-3">
                <span id="fileTypeLabel" class="text-2xl font-bold"></span>
              </div>
              <p class="text-gray-500 text-sm">Preview not available for this file type</p>
            </div>
          </div>

          <div>
            <p class="text-sm text-gray-500">Filename</p>
            <p id="viewFilename" class="font-semibold text-gray-800">
              Budget_Report_Q4.pdf
            </p>
          </div>

          <div class="flex items-center justify-between">
            <p class="text-sm text-gray-500">Uploaded</p>
            <p id="viewFileDate" class="text-sm text-gray-600">Nov 19, 2025</p>
          </div>

          <div class="flex justify-end">
            <a
              id="downloadLink"
              href="#"
              download
              class="px-4 py-2 border border-gray-300 rounded-lg mr-3"
              >Download</a
            >
            <button
              onclick="closeFileModal()"
              class="px-4 py-2 bg-[#2f6e4e] text-white rounded-lg"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload File Modal -->
    <div
      id="uploadFileModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4"
      role="dialog" aria-modal="true" aria-labelledby="uploadFileModalTitle"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full">
        <div
          class="p-6 border-b border-gray-200 flex items-center justify-between"
        >
          <h3 id="uploadFileModalTitle" class="text-2xl font-bold text-gray-800">Upload File</h3>
          <button
            onclick="closeUploadModal()"
            class="text-gray-400 hover:text-gray-600 transition text-2xl"
          >
            ✕
          </button>
        </div>

        <div class="p-6 space-y-6">
          <!-- File Selection -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Select File</label
            >
            <div class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 rounded-xl px-3 py-2 transition-all duration-300 group" onclick="openProfileModal()">
              <label
                for="modalFileInput"
                class="cursor-pointer px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg border border-gray-300 transition font-medium"
              >
                Choose File
              </label>
              <input
                id="modalFileInput"
                type="file"
                class="hidden"
                accept=".pdf,.xlsx,.xls,.doc,.docx,.png,.jpg,.jpeg"
              />
              <span id="selectedFileName" class="text-gray-500"
                >No file chosen</span
              >
            </div>
            <p class="text-xs text-gray-500 mt-2">Maximum file size: 10MB</p>
          </div>

          <!-- File Name Input -->
          <div>
            <label
              for="uploadFileName"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >File Name</label
            >
            <input
              id="uploadFileName"
              type="text"
              placeholder="Enter file name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent"
            />
            <p class="text-xs text-gray-500 mt-1">
              Edit the file name if needed
            </p>
          </div>

          <!-- Category Selection -->
          <div>
            <label
              for="uploadFileCategory"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Category</label
            >
            <select
              id="uploadFileCategory"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent appearance-none bg-white"
            >
              <option value="">Select category</option>
              <option value="general">General Files</option>
              <option value="project">Project Files</option>
            </select>
          </div>

          <!-- Upload Progress (hidden by default) -->
          <div id="uploadProgressContainer" class="hidden">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Uploading...</span>
              <span id="uploadProgressPercent" class="text-sm text-gray-500">0%</span>
            </div>
            <div class="upload-progress">
              <div id="uploadProgressBar" class="upload-progress-bar" style="width: 0%"></div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div id="uploadActionButtons" class="flex justify-end space-x-3 pt-4">
            <button
              onclick="closeUploadModal()"
              class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
            >
              Cancel
            </button>
            <button
              id="confirmUploadBtn"
              class="px-6 py-3 bg-[#2f6e4e] hover:bg-[#2f6e4e]/90 text-white rounded-lg transition font-medium flex items-center justify-center min-w-[140px]"
            >
              <span id="uploadBtnText">Upload File</span>
              <div id="uploadBtnSpinner" class="spinner ml-2 hidden"></div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete File Confirmation Modal -->
    <div
      id="deleteFileModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4"
      role="dialog" aria-modal="true" aria-labelledby="deleteFileModalTitle"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6">
          <div
            class="flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mx-auto mb-4"
          >
            <svg
              class="w-6 h-6 text-red-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
          <h3 id="deleteFileModalTitle" class="text-xl font-bold text-gray-800 text-center mb-2">
            Delete File?
          </h3>
          <p id="deleteFileName" class="text-gray-600 text-center mb-6">
            This action cannot be undone. Are you sure?
          </p>
          <div class="flex space-x-3">
            <button
              onclick="closeDeleteFileModal()"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
            >
              Cancel
            </button>
            <button
              id="confirmDeleteFileBtn"
              class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Archive File Confirmation Modal -->
    <div
      id="archiveFileModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center p-4"
      role="dialog" aria-modal="true" aria-labelledby="archiveFileModalTitle"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6">
          <div
            class="flex items-center justify-center w-12 h-12 bg-yellow-100 rounded-full mx-auto mb-4"
          >
            <svg
              class="w-6 h-6 text-yellow-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
              ></path>
            </svg>
          </div>
          <h3 id="archiveFileModalTitle" class="text-xl font-bold text-gray-800 text-center mb-2">
            Archive File?
          </h3>
          <p id="archiveFileName" class="text-gray-600 text-center mb-6">
            You can restore it from the Archive page.
          </p>
          <div class="flex space-x-3">
            <button
              onclick="closeArchiveFileModal()"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
            >
              Cancel
            </button>
            <button
              id="confirmArchiveFileBtn"
              class="flex-1 px-4 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium"
            >
              Archive
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Publish File Info Modal -->
    <div
      id="publishInfoModal"
      class="hidden fixed inset-0 bg-black bg-opacity-40 z-[10000] flex items-center justify-center p-4"
      role="dialog" aria-modal="true" aria-labelledby="publishInfoModalTitle"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
        <div class="flex items-center justify-center w-12 h-12 mx-auto bg-yellow-100 rounded-full mb-4">
          <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
          </svg>
        </div>
        <h3 id="publishInfoModalTitle" class="text-xl font-bold text-gray-900 text-center mb-2">Publish to Homepage</h3>
        <p id="publishFileName" class="text-sm text-gray-600 text-center mb-4"></p>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex gap-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-blue-900 mb-1">This will make the file visible to the public</p>
              <p class="text-xs text-blue-700">The file will appear in the Transparency section on the homepage where all barangay residents can view and download it.</p>
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <button id="cancelPublish" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Cancel</button>
          <button id="confirmPublish" class="flex-1 px-4 py-2.5 bg-[#2f6e4e] hover:bg-[#2f6e4e]/90 text-white rounded-lg transition font-medium">Publish</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div
      id="fileToast"
      class="hidden fixed top-4 right-4 z-50 bg-[#2f6e4e] text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <span id="fileToastMessage">Action completed successfully!</span>
    </div>


    <script type="module">
      // Import components
      import { NotificationModal } from './js/components/NotificationModal.js';
      import { ProfileModal } from './js/components/ProfileModal.js';

      // =========================================
      // BIMS FILE MANAGEMENT - SUPABASE BACKEND
      // =========================================

      // Security: Sanitize file URL (only allow Supabase storage URLs)
      function sanitizeFileURL(url) {
        if (!url) return null;
        try {
          const parsed = new URL(url);
          const allowedHosts = ['supabase.co', 'supabase.com'];
          if (allowedHosts.some(host => parsed.hostname.endsWith(host))) {
            return url;
          }
        } catch (e) {
          // invalid URL - ignore
        }
        return null;
      }

      // Constants
      const ALLOWED_FILE_TYPES = ['pdf', 'xlsx', 'xls', 'doc', 'docx', 'png', 'jpg', 'jpeg'];
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const FILES_PER_PAGE = 6;

      // Dynamic bucket selection based on category
      const STORAGE_BUCKETS = {
        'GENERAL': 'general-files',
        'PROJECT': 'project-files'
      };

      // State
      let fileStore = [];
      let currentPage = 0;
      let currentUser = null;
      let isLoading = false;

      // DOM Elements
      const filesGrid = document.getElementById("filesGrid");
      const filesLoadingSkeleton = document.getElementById("filesLoadingSkeleton");
      const searchInput = document.getElementById("fileSearch");
      const filterCategory = document.getElementById("filterCategory");
      const modalFileInput = document.getElementById("modalFileInput");
      const uploadFileName = document.getElementById("uploadFileName");
      const uploadFileCategory = document.getElementById("uploadFileCategory");
      const selectedFileName = document.getElementById("selectedFileName");
      let selectedFile = null;

      // =========================================
      // SESSION & INITIALIZATION
      // =========================================
      async function initializePage() {
        try {
          // Initialize session for SK Officials only
          const sessionResult = await SessionManager.init(['SK_OFFICIAL', 'SUPERADMIN']);

          if (!sessionResult.success) {
            return; // SessionManager handles redirect
          }

          currentUser = sessionResult.user;

          // Update header with user info
          updateHeaderUserInfo(sessionResult);

          // Load profile modal data
          await profileModal.loadUserData(currentUser, sessionResult.userData);

          // Load files from Supabase
          await loadFiles();

          // Update current date
          updateCurrentDate();

        } catch (error) {
          console.error('Page initialization error:', error);
          showToast('Failed to initialize page. Please refresh.', 'error');
        }
      }

      function updateHeaderUserInfo(sessionResult) {
        const nameEl = document.querySelector('header .text-sm.font-medium');
        const roleEl = document.querySelector('header .text-xs.text-gray-500');
        const avatarEl = document.querySelector('header .w-10.h-10');

        if (nameEl && sessionResult.userData) {
          const firstName = sessionResult.userData.firstName || '';
          const lastName = sessionResult.userData.lastName || '';
          nameEl.textContent = `${firstName} ${lastName}`.trim() || 'SK Official';
        }

        if (roleEl) {
          const roleDisplay = {
            'SK_OFFICIAL': 'SK Official',
            'SUPERADMIN': 'Administrator'
          };
          roleEl.textContent = roleDisplay[sessionResult.role] || sessionResult.role;
        }

        // Update avatar with profile image
        if (avatarEl && sessionResult.userData) {
          const imageUrl = sessionResult.userData.imagePathURL;
          const firstName = sessionResult.userData.firstName || '';
          const lastName = sessionResult.userData.lastName || '';
          const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();

          if (imageUrl && typeof imageUrl === 'string' && imageUrl.startsWith('https://')) {
            avatarEl.innerHTML = `<img src="${escapeHTML(imageUrl)}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="handleAvatarError(this, '${escapeHTML(initials)}')" />`;
          } else {
            avatarEl.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Listen for profile updates from ProfileModal
      window.addEventListener('profileUpdated', (event) => {
        const profile = event.detail;
        const nameEl = document.querySelector('header .text-sm.font-medium');
        const avatarEl = document.querySelector('header .w-10.h-10');

        if (nameEl) {
          nameEl.textContent = `${profile.firstName} ${profile.lastName}`.trim();
        }

        if (avatarEl) {
          const initials = `${profile.firstName?.charAt(0) || ''}${profile.lastName?.charAt(0) || ''}`.toUpperCase();
          if (profile.profilePicture && profile.profilePicture.startsWith('https://')) {
            avatarEl.innerHTML = `<img src="${escapeHTML(profile.profilePicture)}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="handleAvatarError(this, '${escapeHTML(initials)}')" />`;
          } else {
            avatarEl.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      });

      // =========================================
      // FILE LOADING FROM SUPABASE
      // =========================================
      async function loadFiles() {
        showLoadingSkeleton(true);

        try {
          // Query File_Tbl for ACTIVE files (not archived)
          const { data, error } = await supabaseClient
            .from('File_Tbl')
            .select('fileID, fileName, fileType, dateUploaded, fileCategory, filePath, userID, isPublished')
            .eq('fileStatus', 'ACTIVE')
            .order('dateUploaded', { ascending: false });

          if (error) {
            console.error('Error loading files:', error);
            showToast('Failed to load files. Please try again.', 'error');
            fileStore = [];
          } else {
            // Transform data to match our frontend structure
            fileStore = (data || []).map(file => ({
              id: file.fileID,
              name: file.fileName,
              type: file.fileType?.toLowerCase() || 'file',
              uploaded: formatDate(file.dateUploaded),
              uploadedFull: formatDateLong(file.dateUploaded),
              uploadedDate: new Date(file.dateUploaded),
              category: file.fileCategory?.toLowerCase() || 'general',
              url: file.filePath,
              userID: file.userID,
              isPublished: file.isPublished || false
            }));
          }

          showLoadingSkeleton(false);
          renderFiles(fileStore);

        } catch (err) {
          console.error('Load files exception:', err);
          showToast('An error occurred while loading files.', 'error');
          showLoadingSkeleton(false);
          fileStore = [];
          renderFiles([]);
        }
      }

      function showLoadingSkeleton(show) {
        if (show) {
          filesLoadingSkeleton.classList.remove('hidden');
          filesGrid.classList.add('hidden');
        } else {
          filesLoadingSkeleton.classList.add('hidden');
          filesGrid.classList.remove('hidden');
        }
      }

      function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      }

      function formatDateLong(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        });
      }

      // =========================================
      // FILE RENDERING
      // =========================================
      function renderFiles(list) {
        filesGrid.innerHTML = "";

        if (!list.length) {
          filesGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p class="text-gray-500 font-medium">No files found</p>
              <p class="text-gray-400 text-sm mt-1">Upload a file to get started</p>
            </div>`;
          document.getElementById('filePaginationNav').classList.add('hidden');
          document.getElementById('filePaginationDots').classList.add('hidden');
          return;
        }

        // Calculate pagination
        const startIndex = currentPage * FILES_PER_PAGE;
        const endIndex = startIndex + FILES_PER_PAGE;
        const filesToShow = list.slice(startIndex, endIndex);

        updateFilePagination(list.length);

        filesToShow.forEach((file) => {
          const card = document.createElement("div");
          card.className = "border border-gray-200 rounded-xl p-5 hover:shadow-lg transition";

          const fileIconColor = {
            pdf: "bg-red-100 text-red-600",
            xlsx: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
            xls: "bg-[#2f6e4e]/20 text-[#2f6e4e]",
            doc: "bg-blue-100 text-blue-600",
            docx: "bg-blue-100 text-blue-600",
            png: "bg-purple-100 text-purple-600",
            jpg: "bg-purple-100 text-purple-600",
            jpeg: "bg-purple-100 text-purple-600",
          }[file.type] || "bg-gray-100 text-gray-700";

          const starFilled = file.isPublished;
          card.innerHTML = `
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 ${fileIconColor} rounded-lg flex items-center justify-center font-bold flex-shrink-0">
                ${escapeHTML(file.type?.toUpperCase() || 'FILE')}
              </div>
              <div class="ml-3 min-w-0 flex-1">
                <p class="font-semibold text-gray-800 truncate" title="${escapeHTML(file.name)}">${escapeHTML(file.name)}</p>
                <p class="text-xs text-gray-500">Uploaded: ${escapeHTML(file.uploaded)}</p>
              </div>
              <button class="ml-2 p-1.5 rounded-full hover:bg-yellow-50 transition flex-shrink-0" onclick="togglePublish('${file.id}')" title="${starFilled ? 'Unpublish from homepage' : 'Publish to homepage'}">
                <svg class="w-5 h-5 ${starFilled ? 'text-yellow-500' : 'text-gray-300'}" fill="${starFilled ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
              </button>
            </div>
            <div class="flex justify-between mt-4 gap-2">
              <button class="flex-1 px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium" onclick="viewFile('${file.id}')">View</button>
              <button class="flex-1 px-4 py-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition text-sm font-medium" onclick="archiveFile('${file.id}')">Archive</button>
            </div>
          `;
          filesGrid.appendChild(card);
        });
      }

      // =========================================
      // PAGINATION
      // =========================================
      function updateFilePagination(totalFiles) {
        const totalPages = Math.ceil(totalFiles / FILES_PER_PAGE);
        const dotsContainer = document.getElementById('filePaginationDots');
        const navContainer = document.getElementById('filePaginationNav');

        if (totalPages <= 1) {
          dotsContainer.classList.add('hidden');
          navContainer.classList.add('hidden');
          return;
        }

        dotsContainer.classList.remove('hidden');
        navContainer.classList.remove('hidden');

        dotsContainer.innerHTML = Array.from({ length: totalPages }, (_, i) => `
          <button
            onclick="goToFilePage(${i})"
            class="h-2 rounded-full transition-all duration-300 ${i === currentPage ? 'bg-[#2f6e4e] w-8' : 'bg-gray-300 hover:bg-gray-400 w-2'}"
            style="min-height: 8px;"
          ></button>
        `).join('');
      }

      function navigateFiles(direction) {
        const filtered = applyCurrentFilters();
        const totalPages = Math.ceil(filtered.length / FILES_PER_PAGE);
        currentPage += direction;

        if (currentPage < 0) currentPage = totalPages - 1;
        if (currentPage >= totalPages) currentPage = 0;

        renderFiles(filtered);
      }

      function goToFilePage(pageIndex) {
        currentPage = pageIndex;
        renderFiles(applyCurrentFilters());
      }

      // =========================================
      // SEARCH & FILTER
      // =========================================
      function applyFilters() {
        currentPage = 0;
        renderFiles(applyCurrentFilters());
      }

      function applyCurrentFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const c = filterCategory.value;

        return fileStore.filter((f) => {
          const matchesCategory = !c || (c === 'published' ? f.isPublished : f.category === c);
          const matchesQuery = !q ||
            f.name.toLowerCase().includes(q) ||
            (f.uploaded && f.uploaded.toLowerCase().includes(q)) ||
            (f.uploadedFull && f.uploadedFull.toLowerCase().includes(q));
          return matchesCategory && matchesQuery;
        });
      }

      searchInput.addEventListener("input", applyFilters);
      filterCategory.addEventListener("change", applyFilters);

      // =========================================
      // FILE UPLOAD (SUPABASE STORAGE + DATABASE)
      // =========================================
      function openUploadModal() {
        document.getElementById("uploadFileModal").classList.remove("hidden");
        resetUploadForm();
      }

      function closeUploadModal() {
        document.getElementById("uploadFileModal").classList.add("hidden");
        resetUploadForm();
      }

      function resetUploadForm() {
        modalFileInput.value = "";
        uploadFileName.value = "";
        uploadFileCategory.value = "";
        selectedFileName.textContent = "No file chosen";
        selectedFile = null;

        // Reset progress UI
        document.getElementById('uploadProgressContainer').classList.add('hidden');
        document.getElementById('uploadProgressBar').style.width = '0%';
        document.getElementById('uploadProgressPercent').textContent = '0%';
        document.getElementById('uploadBtnText').textContent = 'Upload File';
        document.getElementById('uploadBtnSpinner').classList.add('hidden');
        document.getElementById('confirmUploadBtn').disabled = false;
      }

      // Handle file selection
      modalFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
          showToast(`File size exceeds ${MAX_FILE_SIZE / (1024 * 1024)}MB limit!`, 'error');
          modalFileInput.value = "";
          selectedFileName.textContent = "No file chosen";
          return;
        }

        // Validate file type
        const ext = file.name.split('.').pop().toLowerCase();
        if (!ALLOWED_FILE_TYPES.includes(ext)) {
          showToast(`File type .${ext} is not allowed. Allowed: ${ALLOWED_FILE_TYPES.join(', ')}`, 'error');
          modalFileInput.value = "";
          selectedFileName.textContent = "No file chosen";
          return;
        }

        selectedFile = file;
        selectedFileName.textContent = file.name;
        uploadFileName.value = file.name;
      });

      // Handle upload confirmation
      document.getElementById("confirmUploadBtn").addEventListener("click", async () => {
        if (isLoading) return;

        // Validation
        if (!selectedFile) {
          showToast("Please select a file first!", 'warning');
          return;
        }

        const fileName = uploadFileName.value.trim();
        if (!fileName) {
          showToast("Please enter a file name!", 'warning');
          return;
        }

        const category = uploadFileCategory.value;
        if (!category) {
          showToast("Please select a category!", 'warning');
          return;
        }

        await uploadFile(selectedFile, fileName, category);
      });

      async function uploadFile(file, fileName, category) {
        isLoading = true;
        const uploadBtn = document.getElementById('confirmUploadBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const uploadBtnSpinner = document.getElementById('uploadBtnSpinner');
        const progressContainer = document.getElementById('uploadProgressContainer');
        const progressBar = document.getElementById('uploadProgressBar');
        const progressPercent = document.getElementById('uploadProgressPercent');

        try {
          // Show loading state
          uploadBtn.disabled = true;
          uploadBtnText.textContent = 'Uploading...';
          uploadBtnSpinner.classList.remove('hidden');
          progressContainer.classList.remove('hidden');

          // Simulate progress (Supabase doesn't provide upload progress)
          let progress = 0;
          const progressInterval = setInterval(() => {
            if (progress < 90) {
              progress += Math.random() * 10;
              progressBar.style.width = `${Math.min(progress, 90)}%`;
              progressPercent.textContent = `${Math.round(Math.min(progress, 90))}%`;
            }
          }, 200);

          // Generate unique file path
          const ext = file.name.split('.').pop().toLowerCase();
          const timestamp = Date.now();
          const uniqueFileName = `${timestamp}_${fileName.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
          const categoryUpper = category.toUpperCase();
          const filePath = `${uniqueFileName}`;

          // Select bucket based on category
          const storageBucket = STORAGE_BUCKETS[categoryUpper] || 'general-files';

          // 1. Upload to Supabase Storage
          const { data: storageData, error: storageError } = await supabaseClient.storage
            .from(storageBucket)
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (storageError) {
            clearInterval(progressInterval);
            throw new Error(`Storage upload failed: ${storageError.message}`);
          }

          // 2. Get public URL
          const { data: urlData } = supabaseClient.storage
            .from(storageBucket)
            .getPublicUrl(filePath);

          const publicUrl = urlData?.publicUrl || '';

          // 3. Insert metadata into File_Tbl
          const { data: dbData, error: dbError } = await supabaseClient
            .from('File_Tbl')
            .insert({
              userID: currentUser.id,
              fileName: fileName,
              fileType: ext.toUpperCase(),
              fileStatus: 'ACTIVE',
              filePath: publicUrl,
              fileCategory: categoryUpper,
              dateUploaded: new Date().toISOString()
            })
            .select()
            .single();

          if (dbError) {
            // If DB insert fails, try to clean up the uploaded file
            await supabaseClient.storage.from(storageBucket).remove([filePath]);
            clearInterval(progressInterval);
            throw new Error(`Database insert failed: ${dbError.message}`);
          }

          // Complete progress
          clearInterval(progressInterval);
          progressBar.style.width = '100%';
          progressPercent.textContent = '100%';

          // Success
          showToast('File uploaded successfully!', 'success');

          // Refresh file list
          await loadFiles();

          // Close modal after short delay
          setTimeout(() => {
            closeUploadModal();
          }, 500);

        } catch (error) {
          console.error('Upload error:', error);
          showToast(error.message || 'Failed to upload file. Please try again.', 'error');
        } finally {
          isLoading = false;
          uploadBtn.disabled = false;
          uploadBtnText.textContent = 'Upload File';
          uploadBtnSpinner.classList.add('hidden');
        }
      }

      // =========================================
      // VIEW FILE (WITH PDF/IMAGE PREVIEW)
      // =========================================
      async function viewFile(id) {
        const fileId = typeof id === 'string' ? parseInt(id, 10) : id;
        const file = fileStore.find((f) => f.id === fileId);
        if (!file) return;

        // Update modal content
        document.getElementById("viewFileModalTitle").textContent = escapeHTML(file.name);
        document.getElementById("viewFilename").textContent = escapeHTML(file.name);
        document.getElementById("viewFileDate").textContent = escapeHTML(file.uploaded);

        // Reset preview elements
        const img = document.getElementById("viewFileImg");
        const pdfCanvas = document.getElementById("pdfCanvas");
        const fileIcon = document.getElementById("viewFileIcon");
        const viewLoading = document.getElementById("viewFileLoading");
        const viewPreview = document.getElementById("viewFilePreview");

        img.classList.add("hidden");
        pdfCanvas.classList.add("hidden");
        fileIcon.classList.add("hidden");
        viewLoading.classList.remove("hidden");
        viewPreview.classList.add("hidden");

        // Set download link
        const sanitizedUrl = sanitizeFileURL(file.url);
        const dl = document.getElementById("downloadLink");
        dl.href = sanitizedUrl || "#";
        dl.style.pointerEvents = sanitizedUrl ? 'auto' : 'none';
        dl.style.opacity = sanitizedUrl ? '1' : '0.5';

        // Show modal
        document.getElementById("viewFileModal").classList.remove("hidden");

        // Handle preview based on file type
        const fileType = file.type?.toLowerCase();

        try {
          if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileType) && sanitizedUrl) {
            // Image preview
            img.src = sanitizedUrl;
            img.onload = () => {
              viewLoading.classList.add("hidden");
              viewPreview.classList.remove("hidden");
              img.classList.remove("hidden");
            };
            img.onerror = () => {
              showFileIconFallback(fileType);
            };
          } else if (fileType === 'pdf' && sanitizedUrl) {
            // PDF preview using PDF.js
            await renderPDFPreview(sanitizedUrl, pdfCanvas, viewLoading, viewPreview);
          } else {
            // Show file icon for unsupported types
            showFileIconFallback(fileType);
          }
        } catch (error) {
          console.error('Preview error:', error);
          showFileIconFallback(fileType);
        }
      }

      async function renderPDFPreview(url, canvas, loadingEl, previewEl) {
        try {
          // Set PDF.js worker
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

          const pdf = await pdfjsLib.getDocument(url).promise;
          const page = await pdf.getPage(1);

          const scale = 1.5;
          const viewport = page.getViewport({ scale });

          canvas.height = viewport.height;
          canvas.width = viewport.width;

          const ctx = canvas.getContext('2d');
          await page.render({ canvasContext: ctx, viewport }).promise;

          loadingEl.classList.add("hidden");
          previewEl.classList.remove("hidden");
          canvas.classList.remove("hidden");
        } catch (error) {
          console.error('PDF render error:', error);
          showFileIconFallback('pdf');
        }
      }

      function showFileIconFallback(fileType) {
        const fileIcon = document.getElementById("viewFileIcon");
        const fileIconBg = document.getElementById("fileIconBg");
        const fileTypeLabel = document.getElementById("fileTypeLabel");
        const viewLoading = document.getElementById("viewFileLoading");
        const viewPreview = document.getElementById("viewFilePreview");

        const iconColors = {
          pdf: "bg-red-100 text-red-600",
          xlsx: "bg-green-100 text-green-600",
          xls: "bg-green-100 text-green-600",
          doc: "bg-blue-100 text-blue-600",
          docx: "bg-blue-100 text-blue-600",
        };

        fileIconBg.className = `w-20 h-20 rounded-xl flex items-center justify-center mx-auto mb-3 ${iconColors[fileType] || 'bg-gray-100 text-gray-600'}`;
        fileTypeLabel.textContent = (fileType || 'FILE').toUpperCase();

        viewLoading.classList.add("hidden");
        viewPreview.classList.remove("hidden");
        fileIcon.classList.remove("hidden");
      }

      function closeFileModal() {
        document.getElementById("viewFileModal").classList.add("hidden");
        // Reset PDF canvas
        const canvas = document.getElementById("pdfCanvas");
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      // =========================================
      // ARCHIVE FILE (UPDATE STATUS IN DATABASE)
      // =========================================
      let archiveTargetId = null;

      function archiveFile(id) {
        const fileId = typeof id === 'string' ? parseInt(id, 10) : id;
        const file = fileStore.find((f) => f.id === fileId);
        if (!file) return;

        archiveTargetId = fileId;
        document.getElementById('archiveFileName').textContent = `Archive "${escapeHTML(file.name)}"? You can restore it from the Archive page.`;
        document.getElementById('archiveFileModal').classList.remove('hidden');
      }

      function closeArchiveFileModal() {
        archiveTargetId = null;
        document.getElementById('archiveFileModal').classList.add('hidden');
      }

      document.getElementById('confirmArchiveFileBtn').addEventListener('click', async () => {
        if (!archiveTargetId || isLoading) return;

        isLoading = true;
        const btn = document.getElementById('confirmArchiveFileBtn');
        btn.disabled = true;
        btn.textContent = 'Archiving...';

        try {
          // Update file status to ARCHIVED in database
          const { error } = await supabaseClient
            .from('File_Tbl')
            .update({
              fileStatus: 'ARCHIVED'
            })
            .eq('fileID', archiveTargetId);

          if (error) {
            throw new Error(error.message);
          }

          showToast('File archived successfully!', 'success');
          closeArchiveFileModal();
          await loadFiles();

        } catch (error) {
          console.error('Archive error:', error);
          showToast('Failed to archive file. Please try again.', 'error');
        } finally {
          isLoading = false;
          btn.disabled = false;
          btn.textContent = 'Archive';
        }
      });

      // =========================================
      // DELETE FILE (OPTIONAL - PERMANENT DELETE)
      // =========================================
      let deleteTargetId = null;

      function promptDeleteFile(id) {
        const fileId = typeof id === 'string' ? parseInt(id, 10) : id;
        const file = fileStore.find((f) => f.id === fileId);
        if (!file) return;
        deleteTargetId = fileId;
        document.getElementById("deleteFileName").textContent = `Delete "${escapeHTML(file.name)}"? This action cannot be undone.`;
        document.getElementById("deleteFileModal").classList.remove("hidden");
      }

      function closeDeleteFileModal() {
        deleteTargetId = null;
        document.getElementById("deleteFileModal").classList.add("hidden");
      }

      document.getElementById("confirmDeleteFileBtn").addEventListener("click", async () => {
        if (!deleteTargetId || isLoading) return;

        isLoading = true;
        const btn = document.getElementById('confirmDeleteFileBtn');
        btn.disabled = true;
        btn.textContent = 'Deleting...';

        const file = fileStore.find(f => f.id === deleteTargetId);

        try {
          // 1. Delete from storage (extract bucket and path from URL)
          if (file?.url) {
            // URL format: https://xxx.supabase.co/storage/v1/object/public/bucket-name/filename
            const urlMatch = file.url.match(/\/storage\/v1\/object\/public\/([^/]+)\/(.+)$/);
            if (urlMatch) {
              const bucketName = urlMatch[1];
              const filePath = urlMatch[2];
              await supabaseClient.storage.from(bucketName).remove([filePath]);
            }
          }

          // 2. Delete from database
          const { error } = await supabaseClient
            .from('File_Tbl')
            .delete()
            .eq('fileID', deleteTargetId);

          if (error) {
            throw new Error(error.message);
          }

          showToast('File deleted permanently.', 'success');
          closeDeleteFileModal();
          await loadFiles();

        } catch (error) {
          console.error('Delete error:', error);
          showToast('Failed to delete file. Please try again.', 'error');
        } finally {
          isLoading = false;
          btn.disabled = false;
          btn.textContent = 'Delete';
        }
      });

      // =========================================
      // PUBLISH / UNPUBLISH FILE (Star Feature)
      // =========================================
      let publishTargetId = null;

      function togglePublish(id) {
        const fileId = typeof id === 'string' ? parseInt(id, 10) : id;
        const file = fileStore.find((f) => f.id === fileId);
        if (!file) return;

        if (file.isPublished) {
          // Already published — unpublish directly without modal
          confirmUnpublish(fileId);
        } else {
          // Not published — show confirmation modal
          publishTargetId = fileId;
          document.getElementById('publishFileName').textContent = `"${file.name}" will be visible on the homepage for all residents to view and download.`;
          document.getElementById('publishInfoModal').classList.remove('hidden');
        }
      }

      function closePublishModal() {
        publishTargetId = null;
        document.getElementById('publishInfoModal').classList.add('hidden');
      }

      document.getElementById('cancelPublish').addEventListener('click', closePublishModal);

      document.getElementById('confirmPublish').addEventListener('click', async () => {
        if (!publishTargetId || isLoading) return;

        isLoading = true;
        const btn = document.getElementById('confirmPublish');
        btn.disabled = true;
        btn.textContent = 'Publishing...';

        try {
          const { error } = await supabaseClient
            .from('File_Tbl')
            .update({ isPublished: true })
            .eq('fileID', publishTargetId);

          if (error) throw new Error(error.message);

          showToast('File published to homepage!', 'success');
          closePublishModal();
          await loadFiles();
        } catch (error) {
          console.error('Publish error:', error);
          showToast('Failed to publish file. Please try again.', 'error');
        } finally {
          isLoading = false;
          btn.disabled = false;
          btn.textContent = 'Publish';
        }
      });

      async function confirmUnpublish(fileId) {
        if (isLoading) return;
        isLoading = true;

        try {
          const { error } = await supabaseClient
            .from('File_Tbl')
            .update({ isPublished: false })
            .eq('fileID', fileId);

          if (error) throw new Error(error.message);

          showToast('File removed from homepage.', 'info');
          await loadFiles();
        } catch (error) {
          console.error('Unpublish error:', error);
          showToast('Failed to unpublish file. Please try again.', 'error');
        } finally {
          isLoading = false;
        }
      }

      // Backward compatibility
      function showFileToast(msg) {
        showToast(msg, 'success');
      }

      // =========================================
      // UTILITY FUNCTIONS
      // =========================================
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const currentDate = new Date().toLocaleDateString('en-US', options);
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
          dateElement.textContent = currentDate;
        }
      }

      // =========================================
      // INITIALIZE COMPONENTS
      // =========================================
      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;

      // =========================================
      // LOGOUT HANDLER
      // =========================================
      async function handleLogout() {
        try {
          await SessionManager.logout();
          // SessionManager handles redirect to login page
        } catch (error) {
          console.error('Logout error:', error);
          showToast('Failed to logout. Please try again.', 'error');
        }
      }
      window.handleLogout = handleLogout;
      window.viewFile = viewFile;
      window.archiveFile = archiveFile;
      window.closeFileModal = closeFileModal;
      window.closeArchiveFileModal = closeArchiveFileModal;
      window.closeDeleteFileModal = closeDeleteFileModal;
      window.closeUploadModal = closeUploadModal;
      window.openUploadModal = openUploadModal;
      window.togglePublish = togglePublish;
      window.navigateFiles = navigateFiles;
      window.goToFilePage = goToFilePage;

      // =========================================
      // INITIALIZE ON PAGE LOAD
      // =========================================
      document.addEventListener('DOMContentLoaded', () => {
        initializePage();
      });
    </script>

    <!-- Notification Modal - Injected by NotificationModal.js component -->

    <!-- ProfileModal component will be dynamically rendered here -->
      <script src="js/mobile-nav.js"></script>
  </body>
</html>
