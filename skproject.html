<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BIMS - SK Project Monitoring</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#059669",
              secondary: "#10b981",
            },
          },
        },
      };
    </script>

    <style>
      /* Text truncation */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Card layout */
      .project-card {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
      }

      /* Tab styles */
      .tab-btn {
        position: relative;
        padding: 1rem 0.5rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
      }

      .tab-btn.active {
        color: #059669;
        border-bottom-color: #059669;
      }

      .tab-btn:hover {
        color: #047857;
      }

      /* Badge animations */
      @keyframes pulse-slow {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .badge-pulse {
        animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
      <!-- SIDEBAR -->
      <aside
        class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col"
      >
        <div class="p-6 flex-1 flex flex-col">
          <!-- Logo -->
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-14 h-14 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg"
            >
              <svg
                class="w-8 h-8 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                ></path>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-black text-gray-800">BIMS</h1>
              <p class="text-sm text-gray-600 font-medium">SK Malanday</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a
              href="dashb.html"
              class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                ></path>
              </svg>
              <span>Dashboard</span>
            </a>
            <a
              href="skfiles.html"
              class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              <span>Manage Files</span>
            </a>
            <a
              href="skproject.html"
              class="flex items-center space-x-3 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-lg font-medium"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                ></path>
              </svg>
              <span>Project Monitoring</span>
            </a>
            <a
              href="skcalendar.html"
              class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
              </svg>
              <span>Manage Calendar</span>
            </a>
            <a
              href="sk-testimonies.html"
              class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                ></path>
              </svg>
              <span>Testimonies</span>
            </a>
            <a
              href="sk-archive.html"
              class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                ></path>
              </svg>
              <span>Archive</span>
            </a>
          </nav>

          <div class="flex-1"></div>

          <!-- Logout -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <button
              class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition w-full"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7"
                ></path>
              </svg>
              <span class="font-medium">Logout</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="flex-1 overflow-auto">
        <!-- Header -->
        <header class="bg-gradient-to-r from-emerald-50 to-white border-b border-gray-200 sticky top-0 z-10">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-emerald-600 font-semibold mb-1" id="currentDate">Sunday, December 14, 2025</p>
                <h1 class="text-2xl font-bold text-gray-800">Project Monitoring</h1>
                <p class="text-sm text-gray-600 mt-1">Track and manage all SK projects</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="toggleNotificationModal()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Notifications">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">5</span>
                  </button>
                </div>
                <button onclick="openProfileModal()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700">Andrea Pelias</p>
                    <p class="text-xs text-gray-500">SK Chairman</p>
                  </div>
                  <div class="w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center text-white font-semibold">
                    AP
                  </div>
                </button>
              </div>
          </div>
        </header>

        <!-- Main Content Section -->
        <div class="px-6 py-6">
          <div class="max-w-7xl mx-auto">
            <!-- Action Bar -->
            <div class="flex justify-between items-center mb-6">
              <div class="flex items-center gap-4 flex-1">
                <input
                  id="projectSearch"
                  type="text"
                  placeholder="Search projects by name, category, or location..."
                  class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                />
                <select
                  id="categoryFilter"
                  class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white min-w-[150px]"
                >
                  <option value="">All types</option>
                  <option>Community</option>
                  <option>Sports</option>
                  <option>Education</option>
                  <option>Environment</option>
                  <option>Health</option>
                </select>
                <button
                  onclick="applyFilters()"
                  class="px-6 py-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium"
                >
                  Search
                </button>
              </div>
              <button
                id="createProjectBtn"
                class="ml-4 px-5 py-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium flex items-center gap-2"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Create Project
              </button>
            </div>

            <!-- Projects Carousel Container -->
            <div class="relative">
              <!-- Navigation Arrows -->
              <button
                id="prevBtn"
                onclick="navigateProjects(-1)"
                class="hidden absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 z-10 w-12 h-12 bg-white rounded-full shadow-lg hover:bg-gray-50 transition items-center justify-center"
              >
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>

              <!-- Projects Grid -->
              <div
                id="projectsGrid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
              >
                <!-- Project cards will be dynamically inserted here -->
              </div>

              <button
                id="nextBtn"
                onclick="navigateProjects(1)"
                class="hidden absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 z-10 w-12 h-12 bg-white rounded-full shadow-lg hover:bg-gray-50 transition items-center justify-center"
              >
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>

            <!-- Pagination Dots -->
            <div id="paginationDots" class="flex justify-center gap-2 mt-6 hidden">
              <!-- Dots will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT DETAILS VIEW MODAL -->
    <div
      id="projectViewModal"
      class="hidden fixed inset-0 z-50 overflow-y-auto"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 opacity-75"
          onclick="closeProjectView()"
        ></div>

        <div
          class="relative bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden"
        >
          <!-- Header with gradient -->
          <div
            class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-6"
          >
            <div class="flex justify-between items-start">
              <div>
                <h2 id="viewProjectTitle" class="text-2xl font-bold mb-2"></h2>
                <div class="flex items-center gap-4 text-emerald-100">
                  <span id="viewProjectHeadsCount" class="text-sm"></span>
                  <span>•</span>
                  <span id="viewProjectCategory" class="text-sm"></span>
                </div>
              </div>
              <button
                onclick="closeProjectView()"
                class="text-white/80 hover:text-white"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Tabs Navigation -->
          <div class="border-b border-gray-200 bg-white px-6">
            <nav class="flex space-x-8">
              <button
                onclick="switchTab('details')"
                id="tabDetails"
                class="tab-btn active"
              >
                Project Details
              </button>
              <button
                onclick="switchTab('applicants')"
                id="tabApplicants"
                class="tab-btn"
              >
                Applicants (<span id="applicantCount">0</span>)
              </button>
              <button
                onclick="switchTab('inquiries')"
                id="tabInquiries"
                class="tab-btn"
              >
                Inquiries (<span id="inquiryCount">0</span>)
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="overflow-y-auto max-h-[60vh] custom-scrollbar">
            <!-- Project Details Tab -->
            <div id="tabContentDetails" class="p-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Category
                  </h3>
                  <p id="detailsCategory" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Status
                  </h3>
                  <span
                    id="detailsStatus"
                    class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                  ></span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Project Duration
                  </h3>
                  <p id="detailsDuration" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Location
                  </h3>
                  <p id="detailsLocation" class="text-gray-900"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold text-gray-600 mb-1">
                    Project Heads
                  </h3>
                  <p id="detailsHeads" class="text-gray-900"></p>
                </div>
              </div>

              <div>
                <h3 class="text-sm font-semibold text-gray-600 mb-2">
                  Description
                </h3>
                <div
                  id="detailsDescription"
                  class="text-gray-900 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg"
                ></div>
              </div>

              <!-- Captain's Decision Section -->
              <div id="captainDecisionSection" class="hidden mt-6">
                <div class="border-t border-gray-200 pt-6">
                  <h3 class="text-sm font-semibold text-gray-600 mb-3">
                    Barangay Captain's Decision
                  </h3>
                  <div id="decisionContent" class="bg-gray-50 rounded-lg p-5 border-l-4">
                    <div class="flex items-center gap-3 mb-3">
                      <div id="decisionIcon" class="w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold"></div>
                      <div>
                        <p id="decisionStatus" class="font-bold text-lg"></p>
                        <p id="decisionDate" class="text-sm text-gray-600"></p>
                      </div>
                    </div>
                    <div class="mt-4">
                      <p class="text-xs font-semibold text-gray-600 mb-2">Comments:</p>
                      <p id="decisionComments" class="text-gray-800 whitespace-pre-wrap"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Applicants Tab -->
            <div id="tabContentApplicants" class="hidden p-6">
              <div class="mb-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <select
                    id="applicantStatusFilter"
                    onchange="filterApplicants()"
                    class="px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">All Status</option>
                    <option value="pending">Pending Review</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                  </select>
                </div>
                <div class="flex gap-2">
                  <span
                    class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium"
                  >
                    <span id="pendingCount">0</span> pending review
                  </span>
                  <span
                    class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium"
                  >
                    <span id="approvedCount">0</span> Approved
                  </span>
                </div>
              </div>

              <div id="applicantsList" class="space-y-3">
                <!-- Applicant cards will be inserted here -->
              </div>

              <!-- Attendance Generator Section -->
              <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">Generate Attendance Sheet</h3>
                    <p class="text-sm text-gray-600 mt-1">Download PDF attendance sheet for approved volunteers</p>
                  </div>
                  <button
                    onclick="generateAttendancePDF()"
                    class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition flex items-center gap-2"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Download PDF</span>
                  </button>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div class="flex gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                      <p class="font-semibold mb-1">Attendance Sheet Info:</p>
                      <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Only <strong>approved applicants</strong> will be included</li>
                        <li>Sheet includes columns for: Name, Role, Signature, Time In, Time Out</li>
                        <li>PDF will be formatted for easy printing</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Inquiries Tab -->
            <div id="tabContentInquiries" class="hidden p-6">
              <div id="inquiriesList" class="space-y-4">
                <!-- Inquiries will be inserted here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE/EDIT PROJECT MODAL -->
    <div id="projectModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 opacity-75"
          onclick="closeProjectModal()"
        ></div>

        <div
          class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
        >
          <div class="p-6 border-b">
            <div class="flex items-center justify-between">
              <h3
                id="projectModalTitle"
                class="text-2xl font-bold text-gray-800"
              >
                Create Project
              </h3>
              <button
                onclick="closeProjectModal()"
                class="text-gray-400 hover:text-gray-600"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Title</label
              >
              <input
                id="projTitle"
                type="text"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Category</label
                >
                <input
                  id="projCategory"
                  type="text"
                  placeholder="e.g., Community, Sports, Education"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Status</label
                >
                <select
                  id="projStatus"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  disabled
                >
                  <option>Pending Approval</option>
                  <option>Ongoing</option>
                  <option>Upcoming</option>
                  <option>Pending for Revision</option>
                  <option>Rejected</option>
                  <option>Completed</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-info-circle mr-1"></i>
                  Status will be "Pending Approval" until Barangay Captain approves
                </p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Proposed Budget (₱)</label
                >
                <input
                  id="projBudget"
                  type="number"
                  placeholder="e.g., 50000"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                  min="0"
                  step="100"
                  oninput="updateBudgetRemaining()"
                />
                <p class="text-xs text-gray-500 mt-1" id="budgetHelpText">
                  <i class="fas fa-info-circle mr-1"></i>
                  Enter the total budget needed for this project
                </p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Expected Volunteers</label
                >
                <input
                  id="projVolunteers"
                  type="number"
                  placeholder="e.g., 50"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                  min="1"
                />
              </div>
            </div>

            <!-- Budget Breakdown Section -->
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-bold text-gray-800">Budget Breakdown</h4>
                <div class="text-right">
                  <p class="text-xs text-gray-600">Remaining Budget</p>
                  <p id="remainingBudget" class="text-lg font-bold text-emerald-600">₱0.00</p>
                </div>
              </div>

              <div class="bg-white rounded-lg p-3 mb-3">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="border-b border-gray-300">
                        <th class="text-left py-2 px-2 font-semibold text-gray-700 w-12">#</th>
                        <th class="text-left py-2 px-2 font-semibold text-gray-700">Expense Item</th>
                        <th class="text-left py-2 px-2 font-semibold text-gray-700 w-32">Cost (₱)</th>
                        <th class="text-center py-2 px-2 font-semibold text-gray-700 w-16">Action</th>
                      </tr>
                    </thead>
                    <tbody id="budgetBreakdownTable">
                      <!-- Budget breakdown rows will be added here -->
                    </tbody>
                    <tfoot>
                      <tr class="border-t-2 border-gray-300">
                        <td colspan="2" class="py-2 px-2 text-right font-bold text-gray-800">Total:</td>
                        <td class="py-2 px-2 font-bold text-emerald-600" id="budgetTotal">₱0.00</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <button
                type="button"
                onclick="addBudgetRow()"
                class="w-full px-3 py-2 bg-white border border-emerald-300 text-emerald-700 rounded-lg hover:bg-emerald-50 flex items-center justify-center gap-2 text-sm font-medium"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Add Expense Item
              </button>

              <p class="text-xs text-gray-600 mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                List all planned expenses. Total must not exceed the proposed budget.
              </p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Start Date</label
                >
                <input
                  type="date"
                  id="projStartDate"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Start Time</label
                >
                <input
                  type="time"
                  id="projStartTime"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >End Date</label
                >
                <input
                  type="date"
                  id="projEndDate"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >End Time</label
                >
                <input
                  type="time"
                  id="projEndTime"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                  required
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Location</label
              >
              <input
                id="projLocation"
                type="text"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg"
                placeholder="Barangay Hall, Covered Court, etc."
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Project Heads</label
              >
              <div id="headsSelect" class="relative">
                <div
                  id="selectedPills"
                  class="flex items-center gap-2 flex-wrap p-2 border border-gray-300 rounded-lg min-h-[48px] cursor-text"
                  onclick="openHeadsDropdown()"
                >
                  <input
                    id="headsSearch"
                    placeholder="Search & add project heads..."
                    class="flex-1 min-w-[120px] px-2 py-1 outline-none"
                  />
                </div>
                <div
                  id="headsDropdown"
                  class="hidden absolute mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-20 max-h-48 overflow-auto"
                ></div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Banner image (optional)</label
              >
              <input
                id="projBanner"
                type="file"
                accept="image/*"
                class="w-full"
              />
              <p class="text-xs text-gray-500 mt-1">
                You can upload a banner image to display on the card.
              </p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Target Beneficiaries</label
              >
              <input
                id="projBeneficiaries"
                type="text"
                placeholder="e.g., 200 Youth ages 15-30, 150 Families"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
              />
              <p class="text-xs text-gray-500 mt-1">
                Who and how many people will benefit from this project? (Include count and description)
              </p>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >Project Description</label
              >
              <textarea
                id="projDesc"
                rows="6"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500"
                placeholder="Include:&#10;• Brief project overview&#10;• Objectives (What you aim to achieve)&#10;• Expected outcomes (What results you expect)&#10;&#10;Example: A community festival to celebrate New Year with cultural performances, games, and food stalls.&#10;&#10;Objectives:&#10;• Promote community unity&#10;• Showcase local talents&#10;• Provide entertainment for all ages&#10;&#10;Expected Outcomes:&#10;• 500+ attendees expected&#10;• 15+ performers lined up&#10;• Strengthen barangay relationships"
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                Please include project overview, objectives, and expected outcomes in your description for Barangay Captain review.
              </p>
            </div>
          </div>

          <div class="p-6 border-t flex justify-end gap-3">
            <button
              onclick="closeProjectModal()"
              class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"
            >
              Cancel
            </button>
            <button
              id="saveProjectBtn"
              class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
              Submit for Approval
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- APPLICANT DETAILS MODAL -->
    <div
      id="applicantModal"
      class="hidden fixed inset-0 z-[60] overflow-y-auto"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 opacity-75"
          onclick="closeApplicantModal()"
        ></div>

        <div
          class="relative bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto"
        >
          <!-- Header -->
          <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 p-6">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-xl font-bold text-white">
                  Volunteer Application Details
                </h2>
                <p
                  id="appProjectName"
                  class="text-emerald-100 text-sm mt-1"
                ></p>
              </div>
              <button
                onclick="closeApplicantModal()"
                class="text-white/80 hover:text-white"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  ></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <!-- Personal Information -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4">Personal Information</h3>
              <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                <div class="grid grid-cols-4 gap-4">
                  <div class="col-span-2">
                    <label class="text-xs text-gray-600">Last Name</label>
                    <p id="appLastName" class="font-medium"></p>
                  </div>
                  <div class="col-span-1">
                    <label class="text-xs text-gray-600">First Name</label>
                    <p id="appFirstName" class="font-medium"></p>
                  </div>
                  <div class="col-span-1">
                    <label class="text-xs text-gray-600">MI</label>
                    <p id="appMiddleName" class="font-medium"></p>
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <label class="text-xs text-gray-600">Birthday</label>
                    <p id="appBirthday" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Age</label>
                    <p id="appAge" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Contact</label>
                    <p id="appContact" class="font-medium"></p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-xs text-gray-600">Email</label>
                    <p id="appEmail" class="font-medium"></p>
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Address</label>
                    <p id="appAddress" class="font-medium"></p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Application Details -->
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4">Application Details</h3>
              <div class="space-y-3">
                <div>
                  <label class="text-xs text-gray-600">Preferred Role</label>
                  <p id="appRole" class="font-medium"></p>
                </div>
                <div id="appParentalConsentSection" class="hidden">
                  <label class="text-xs text-gray-600"
                    >Parental Consent (Minor Applicant)</label
                  >
                  <div class="p-3 bg-gray-50 rounded-lg text-sm">
                    <a
                      id="appParentalConsent"
                      href="#"
                      download
                      class="text-blue-600 hover:underline inline-flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        ></path>
                      </svg>
                      <span id="appParentalConsentText"></span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status Management -->
            <div class="border-t pt-4">
              <h3 class="text-lg font-semibold mb-4">Application Status</h3>
              <div class="flex items-center justify-between mb-4">
                <div>
                  <label class="text-xs text-gray-600">Current Status</label>
                  <p id="appCurrentStatus" class="font-medium"></p>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Applied Date</label>
                  <p id="appDate" class="font-medium"></p>
                </div>
              </div>

              <div class="flex gap-2">
                <button
                  onclick="updateStatus('approved')"
                  class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700"
                >
                  Approve
                </button>
                <button
                  onclick="updateStatus('rejected')"
                  class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                >
                  Reject
                </button>
                <button
                  onclick="updateStatus('pending')"
                  class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                >
                  Pending
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT EVALUATION MODAL (Mark as Complete) -->
    <div id="evaluationModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeEvaluationModal()"></div>

        <div class="relative bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <!-- Header -->
          <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">Project Evaluation</h2>
                <p id="evalProjectTitle" class="text-purple-100"></p>
              </div>
              <button onclick="closeEvaluationModal()" class="text-white/80 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Form Content -->
          <div class="p-6 space-y-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
              <p class="text-sm text-blue-800">
                <strong>Complete this evaluation to calculate the project's success rate.</strong><br>
                The success rate is based on 5 weighted metrics: Budget Efficiency (25%), Volunteer Participation (20%), Timeline Adherence (20%), Community Impact (20%), and Volunteer Feedback (15%).
              </p>
            </div>

            <!-- Budget Efficiency (25%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                1. Budget Efficiency (25%)
              </h3>
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Planned Budget (₱)</label>
                  <input type="number" id="budgetPlanned" placeholder="e.g. 50000"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Spent (₱)</label>
                  <input type="number" id="budgetActual" placeholder="e.g. 48000"
                         oninput="calculateSuccessRate(); updateActualTotalFromBreakdown()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-calculator mr-1"></i>
                    Auto-calculated from breakdown below
                  </p>
                </div>
              </div>

              <!-- Budget Breakdown with Receipts -->
              <div class="border-t pt-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-md font-bold text-gray-800">Budget Breakdown & Receipts</h4>
                  <button type="button" onclick="addActualBreakdownRow()" class="text-sm px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition">
                    <i class="fas fa-plus mr-1"></i> Add Item
                  </button>
                </div>

                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                      <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Description</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-32">Planned (₱)</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-32">Actual (₱)</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700 w-48">Receipt</th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-700 w-20">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="actualBudgetBreakdownTable">
                      <!-- Rows will be populated here -->
                    </tbody>
                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                      <tr class="font-bold">
                        <td class="px-3 py-3 text-gray-800">TOTAL</td>
                        <td class="px-3 py-3 text-gray-800" id="plannedBreakdownTotal">₱0</td>
                        <td class="px-3 py-3 text-emerald-700" id="actualBreakdownTotal">₱0</td>
                        <td colspan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>

            <!-- Volunteer Participation (20%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                2. Volunteer Participation (20%)
              </h3>

              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Target Volunteers</label>
                  <input type="number" id="volunteersTarget" placeholder="e.g. 50"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Volunteers</label>
                  <input type="number" id="volunteersActual" placeholder="e.g. 62"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                  <p class="text-xs text-gray-500 mt-1">
                    Enter the actual number of volunteers who participated
                  </p>
                </div>
              </div>

              <!-- Upload Attendance PDF -->
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  <i class="fas fa-file-pdf mr-1"></i>
                  Upload Attendance Sheet (PDF)
                </label>
                <div class="flex items-center gap-3">
                  <label class="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition text-sm font-medium flex items-center gap-2">
                    <i class="fas fa-upload"></i>
                    <span>Choose PDF</span>
                    <input type="file" id="attendancePdfUpload" accept=".pdf" onchange="uploadAttendancePDF(event)" class="hidden" />
                  </label>
                  <span id="attendancePdfName" class="text-sm text-gray-600 italic">No file selected</span>
                </div>
                <p class="text-xs text-gray-600 mt-2">
                  <i class="fas fa-info-circle mr-1"></i>
                  Upload the attendance PDF for documentation
                </p>
              </div>
            </div>

            <!-- Timeline Adherence (20%) -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                3. Timeline Adherence (20%)
              </h3>
              <select id="timelineStatus" onchange="calculateSuccessRate()"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="">Select timeline status</option>
                <option value="on-time">Completed On Time (100 points)</option>
                <option value="slightly-delayed">Slightly Delayed (70 points)</option>
                <option value="delayed">Delayed (40 points)</option>
                <option value="significantly-delayed">Significantly Delayed (10 points)</option>
              </select>
            </div>

            <!-- Community Impact (20%) - Beneficiaries Reached -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                4. Community Impact (20%) - Beneficiaries Reached
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Target Beneficiaries</label>
                  <input type="number" id="beneficiariesTarget" placeholder="e.g. 200"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed focus:ring-2 focus:ring-purple-500"
                         readonly />
                  <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lock mr-1"></i>
                    From approved project proposal
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Actual Beneficiaries</label>
                  <input type="number" id="beneficiariesActual" placeholder="e.g. 250"
                         oninput="calculateSuccessRate()"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                  <p class="text-xs text-gray-500 mt-1">Actual people reached</p>
                </div>
              </div>
            </div>

            <!-- Volunteer Feedback (15%) - Auto-calculated from surveys -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                5. Volunteer Feedback (15%)
              </h3>
              <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <div class="flex items-start gap-3">
                  <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm text-blue-800 font-semibold mb-1">Automatic Calculation</p>
                    <p class="text-sm text-blue-700 mb-3">
                      This metric is automatically calculated from volunteer satisfaction surveys. Volunteers must complete a satisfaction survey before receiving their Certificate of Participation.
                    </p>
                    <div class="p-3 bg-white rounded border border-blue-200">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-700">Average Satisfaction Score:</span>
                        <span id="autoFeedbackScore" class="text-2xl font-bold text-purple-600">-</span>
                      </div>
                      <p class="text-xs text-gray-500">
                        <span id="surveyCount">0</span> out of <span id="totalVolunteers">0</span> volunteers submitted feedback
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Project Achievements -->
            <div class="bg-white border border-gray-200 rounded-lg p-5">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                6. Project Achievements
              </h3>
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Achievement #<span id="achievementNumber">1</span>
                </label>
                <div class="relative">
                  <textarea id="achievementInput" rows="2"
                            placeholder="Type to see suggestions or enter your own achievement..."
                            oninput="showAchievementSuggestions(this.value)"
                            onfocus="showAchievementSuggestions(this.value)"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none"></textarea>

                  <!-- Auto-suggest dropdown -->
                  <div id="achievementSuggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                    <!-- Suggestions will be populated here -->
                  </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">Click suggestions below or type your own achievement</p>
              </div>

              <!-- Quick Suggestions -->
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Quick Suggestions:</label>
                <div class="flex flex-wrap gap-2">
                  <button type="button" onclick="addQuickAchievement('environmental')"
                          class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition">
                    🌱 Environmental
                  </button>
                  <button type="button" onclick="addQuickAchievement('community')"
                          class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition">
                    🤝 Community
                  </button>
                  <button type="button" onclick="addQuickAchievement('volunteer')"
                          class="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition">
                    👥 Volunteer
                  </button>
                  <button type="button" onclick="addQuickAchievement('educational')"
                          class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200 transition">
                    📚 Educational
                  </button>
                  <button type="button" onclick="addQuickAchievement('impact')"
                          class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-full hover:bg-red-200 transition">
                    ⭐ Impact
                  </button>
                </div>
              </div>

              <!-- Add Achievement Button -->
              <button type="button" onclick="addAchievement()"
                      class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Add Achievement
              </button>

              <!-- Achievements List -->
              <div id="achievementsList" class="mt-4 space-y-2">
                <!-- Added achievements will appear here -->
              </div>
            </div>

            <!-- Success Rate Preview -->
            <div class="bg-gradient-to-r from-emerald-50 to-emerald-100 border-2 border-emerald-300 rounded-lg p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-emerald-900">Calculated Success Rate</h3>
                <span id="successRateValue" class="text-4xl font-black text-emerald-600">0%</span>
              </div>
              <div class="h-4 bg-emerald-200 rounded-full overflow-hidden mb-4">
                <div id="successRateBar" class="h-full bg-emerald-600 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>

              <!-- Score Breakdown -->
              <div class="grid grid-cols-5 gap-2 text-center text-sm">
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-emerald-800" id="budgetScoreValue">0</div>
                  <div class="text-xs text-emerald-700">Budget</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-emerald-800" id="participationScoreValue">0</div>
                  <div class="text-xs text-emerald-700">Volunteers</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-emerald-800" id="timelineScoreValue">0</div>
                  <div class="text-xs text-emerald-700">Timeline</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-emerald-800" id="impactScoreValue">0</div>
                  <div class="text-xs text-emerald-700">Impact</div>
                </div>
                <div class="bg-white/50 rounded p-2">
                  <div class="font-bold text-emerald-800" id="feedbackScoreValue">0</div>
                  <div class="text-xs text-emerald-700">Feedback</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Actions -->
          <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
            <button onclick="closeEvaluationModal()"
                    class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
              Cancel
            </button>
            <button onclick="submitEvaluation()"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Mark as Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- DOWNLOAD REPORT MODAL -->
    <div id="downloadReportModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 opacity-75" onclick="closeDownloadReportModal()"></div>

        <div class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full">
          <!-- Header -->
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold mb-2">Download Project Report</h2>
                <p id="downloadProjectTitle" class="text-blue-100"></p>
              </div>
              <button onclick="closeDownloadReportModal()" class="text-white/80 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <p class="text-gray-600 mb-6">
              Choose a format to download the complete project report including success rate breakdown, volunteer list, and budget details.
            </p>

            <div class="grid grid-cols-2 gap-4">
              <!-- PDF Option -->
              <button onclick="downloadReport('pdf')"
                      class="group p-6 border-2 border-gray-300 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition">
                <div class="flex flex-col items-center">
                  <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-red-200 transition">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-gray-800 mb-2">PDF Report</h3>
                  <p class="text-sm text-gray-600 text-center">Formatted document with charts</p>
                </div>
              </button>

              <!-- Excel Option -->
              <button onclick="downloadReport('excel')"
                      class="group p-6 border-2 border-gray-300 rounded-xl hover:border-green-500 hover:bg-green-50 transition">
                <div class="flex flex-col items-center">
                  <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4 group-hover:bg-green-200 transition">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                  <h3 class="text-lg font-bold text-gray-800 mb-2">Excel Report</h3>
                  <p class="text-sm text-gray-600 text-center">Spreadsheet with detailed data</p>
                </div>
              </button>
            </div>

            <div class="mt-6 bg-gray-50 rounded-lg p-4">
              <h4 class="font-semibold text-gray-800 mb-2">Report Includes:</h4>
              <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Success rate breakdown with all 5 metrics
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Complete volunteer list
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Budget transparency (allocated vs spent)
                </li>
                <li class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Timeline summary and dates
                </li>
              </ul>
            </div>
          </div>

          <!-- Footer -->
          <div class="p-6 border-t border-gray-200 flex justify-end">
            <button onclick="closeDownloadReportModal()"
                    class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="hidden fixed top-6 right-6 z-[70] bg-emerald-600 text-white px-5 py-3 rounded-lg shadow-lg"
    >
      <span id="toastMessage"></span>
    </div>

    <!-- Notification Modal -->
    <div
      id="notificationModal"
      class="hidden fixed top-20 right-6 w-96 bg-white rounded-xl shadow-2xl z-40 border border-gray-200"
    >
      <div
        class="p-4 border-b border-gray-200 flex items-center justify-between"
      >
        <h3 class="font-bold text-gray-800">Notifications</h3>
        <button
          onclick="markAllAsRead()"
          class="text-xs text-emerald-600 hover:text-emerald-700 font-medium"
        >
          Mark all as read
        </button>
      </div>
      <div id="notificationList" class="max-h-96 overflow-y-auto">
        <!-- Notifications will be dynamically inserted here -->
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50">
      <div class="flex items-center justify-center min-h-screen px-4">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
          <!-- Header -->
          <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="relative group">
                  <div id="profilePicturePreview" class="w-16 h-16 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white font-bold text-2xl overflow-hidden">
                    <span id="profileInitials">AP</span>
                  </div>
                  <label for="profilePictureInput" class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                  </label>
                  <input type="file" id="profilePictureInput" accept="image/*" onchange="handleProfilePictureChange(event)" class="hidden" />
                </div>
                <div>
                  <h2 class="text-2xl font-bold">My Profile</h2>
                  <p class="text-emerald-100 text-sm">Manage your account information</p>
                </div>
              </div>
              <button onclick="closeProfileModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Body -->
          <div class="p-6 space-y-6">
            <!-- Account Info Section -->
            <div>
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Account Information
              </h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                  <input type="text" id="profileFirstName" value="Andrea"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Middle Name</label>
                  <input type="text" id="profileMiddleName" placeholder="Optional"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                  <input type="text" id="profileLastName" value="Pelias"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                <input type="email" id="profileEmail" value="andrea.pelias@malanday.gov.ph"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed"
                       readonly />
                <p class="text-xs text-gray-500 mt-1">Email cannot be changed. Contact admin if needed.</p>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Position</label>
                <input type="text" id="profilePosition" value="SK Chairman"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed"
                       readonly />
              </div>
            </div>

            <!-- Personal Info Section -->
            <div class="pt-6 border-t border-gray-200">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                Personal Information
              </h3>

              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Complete Address</label>
                  <textarea id="profileAddress" rows="3" placeholder="Enter your complete address"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"></textarea>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Contact Number</label>
                  <input type="tel" id="profileContact" placeholder="e.g., 09171234567"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Gender</label>
                  <select id="profileGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                    <option value="">Select gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="non-binary">Non-binary / Gender Neutral</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Birthday</label>
                  <input type="date" id="profileBirthday"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="sticky bottom-0 bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3 border-t">
            <button onclick="closeProfileModal()"
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition">
              Cancel
            </button>
            <button onclick="saveProfile()"
                    class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Update current date
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const currentDate = new Date().toLocaleDateString('en-US', options);
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
          dateElement.textContent = currentDate;
        }
      }
      updateCurrentDate();

      // Current user
      const currentUser = "Andrea Pelias";

      // User profile data (in production, this would be fetched from server)
      let userProfile = {
        firstName: "Andrea",
        middleName: "",
        lastName: "Pelias",
        email: "andrea.pelias@malanday.gov.ph",
        position: "SK Chairman",
        address: "",
        contact: "",
        gender: "",
        birthday: "",
        profilePicture: null // Stores base64 image data
      };

      // Profile Modal Functions
      function openProfileModal() {
        // Load profile data into form
        document.getElementById('profileFirstName').value = userProfile.firstName;
        document.getElementById('profileMiddleName').value = userProfile.middleName;
        document.getElementById('profileLastName').value = userProfile.lastName;
        document.getElementById('profileEmail').value = userProfile.email;
        document.getElementById('profilePosition').value = userProfile.position;
        document.getElementById('profileAddress').value = userProfile.address;
        document.getElementById('profileContact').value = userProfile.contact;
        document.getElementById('profileGender').value = userProfile.gender;
        document.getElementById('profileBirthday').value = userProfile.birthday;

        // Load profile picture if exists
        const previewDiv = document.getElementById('profilePicturePreview');
        if (userProfile.profilePicture) {
          previewDiv.innerHTML = `<img src="${userProfile.profilePicture}" alt="Profile Picture" class="w-full h-full object-cover rounded-full" />`;
        } else {
          const firstInitial = userProfile.firstName.charAt(0).toUpperCase();
          const lastInitial = userProfile.lastName.charAt(0).toUpperCase();
          previewDiv.innerHTML = `<span id="profileInitials" class="text-white font-bold text-2xl">${firstInitial}${lastInitial}</span>`;
        }

        document.getElementById('profileModal').classList.remove('hidden');
      }

      function closeProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
      }

      function handleProfilePictureChange(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file');
          return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image size should be less than 5MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const imageData = e.target.result;

          // Store in profile
          userProfile.profilePicture = imageData;

          // Update modal preview
          const previewDiv = document.getElementById('profilePicturePreview');
          previewDiv.innerHTML = `<img src="${imageData}" alt="Profile Picture" class="w-full h-full object-cover rounded-full" />`;

          // Update header avatar
          updateHeaderAvatar();

          showToast('Profile picture uploaded successfully!');
        };
        reader.readAsDataURL(file);
      }

      function updateHeaderAvatar() {
        const headerAvatar = document.querySelector('header .w-10.h-10.bg-emerald-600');
        if (!headerAvatar) return;

        if (userProfile.profilePicture) {
          headerAvatar.innerHTML = `<img src="${userProfile.profilePicture}" alt="Profile" class="w-full h-full object-cover rounded-full" />`;
        } else {
          const firstInitial = userProfile.firstName.charAt(0).toUpperCase();
          const lastInitial = userProfile.lastName.charAt(0).toUpperCase();
          headerAvatar.innerHTML = `<span class="text-white font-bold">${firstInitial}${lastInitial}</span>`;
        }
      }

      function saveProfile() {
        // Get form values
        userProfile.firstName = document.getElementById('profileFirstName').value;
        userProfile.middleName = document.getElementById('profileMiddleName').value;
        userProfile.lastName = document.getElementById('profileLastName').value;
        userProfile.address = document.getElementById('profileAddress').value;
        userProfile.contact = document.getElementById('profileContact').value;
        userProfile.gender = document.getElementById('profileGender').value;
        userProfile.birthday = document.getElementById('profileBirthday').value;

        // Validation
        if (!userProfile.firstName || !userProfile.lastName) {
          alert('First name and last name are required.');
          return;
        }

        // In production, this would save to the server
        console.log('Profile saved:', userProfile);

        // Update header display
        const middleInitial = userProfile.middleName ? ` ${userProfile.middleName.charAt(0)}.` : '';
        const fullName = `${userProfile.firstName}${middleInitial} ${userProfile.lastName}`;
        document.querySelector('header .text-sm.font-medium').textContent = fullName;

        // Update header avatar
        updateHeaderAvatar();

        showToast('Profile updated successfully!');
        closeProfileModal();
      }

      // Generate Attendance PDF
      function generateAttendancePDF() {
        if (!currentProjectId) {
          alert('No project selected');
          return;
        }

        // Get the current project
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) {
          alert('Project not found');
          return;
        }

        // Get approved applicants for the current project
        const approvedApplicants = applications.filter(app =>
          app.projectId === currentProjectId && app.status === 'approved'
        );

        if (approvedApplicants.length === 0) {
          alert('No approved applicants found for this project. Please approve applicants first.');
          return;
        }

        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Page settings
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let yPosition = margin;

        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('BARANGAY INFORMATION MANAGEMENT SYSTEM', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 7;

        doc.setFontSize(14);
        doc.text('SK Malanday - Volunteer Attendance Sheet', pageWidth / 2, yPosition, { align: 'center' });
        yPosition += 10;

        // Project Information
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Project: ${project.title}`, margin, yPosition);
        yPosition += 6;
        doc.text(`Date: ${project.startDate}`, margin, yPosition);
        yPosition += 10;

        // Table Header
        doc.setFillColor(5, 150, 105); // Emerald color
        doc.rect(margin, yPosition, pageWidth - 2 * margin, 8, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFont(undefined, 'bold');
        doc.setFontSize(9);

        const colWidths = {
          no: 15,
          name: 80,
          time: 40,
          signature: 45
        };

        let xPos = margin + 2;
        doc.text('No.', xPos, yPosition + 5);
        xPos += colWidths.no;
        doc.text('Name', xPos, yPosition + 5);
        xPos += colWidths.name;
        doc.text('Time', xPos, yPosition + 5);
        xPos += colWidths.time;
        doc.text('Signature', xPos, yPosition + 5);

        yPosition += 8;
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');

        // Table Rows
        approvedApplicants.forEach((applicant, index) => {
          // Check if we need a new page
          if (yPosition > pageHeight - 30) {
            doc.addPage();
            yPosition = margin;
          }

          // Alternating row colors
          if (index % 2 === 0) {
            doc.setFillColor(249, 250, 251);
            doc.rect(margin, yPosition, pageWidth - 2 * margin, 10, 'F');
          }

          xPos = margin + 2;

          // Number
          doc.text(String(index + 1), xPos, yPosition + 6);
          xPos += colWidths.no;

          // Name
          doc.text(applicant.fullName, xPos, yPosition + 6);
          xPos += colWidths.name;

          // Time line
          doc.setDrawColor(200, 200, 200);
          doc.line(xPos, yPosition + 7, xPos + colWidths.time - 5, yPosition + 7);
          xPos += colWidths.time;

          // Signature line
          doc.line(xPos, yPosition + 7, xPos + colWidths.signature - 5, yPosition + 7);

          yPosition += 10;
        });

        // Footer
        yPosition += 10;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Total Approved Volunteers: ${approvedApplicants.length}`, margin, yPosition);
        yPosition += 5;
        doc.text(`Generated on: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`, margin, yPosition);

        // Save the PDF
        const fileName = `Attendance_${project.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);

        showToast('Attendance sheet generated successfully!');
      }

      // SK Officials list
      const skOfficials = [
        "Andrea Pelias",
        "Kyleen Nicdao",
        "Gavin Adrian Santos",
        "Elijah Dela Vega",
        "Juliana Gabriella Sergio",
        "Jerome Ancheta",
        "Catherine Reyes",
        "Mark Santiago",
      ];

      // Sample volunteer applications
      const applications = [
        {
          id: 1,
          projectId: 1,
          firstName: "Juan",
          middleName: "R.",
          lastName: "Dela Cruz",
          fullName: "Dela Cruz, Juan R.",
          birthday: "2005-03-15",
          age: 20,
          contact: "09171234567",
          address: "123 Malanday Street, Marikina City",
          preferredRole: "Event Coordinator",
          status: "pending",
          appliedDate: "2025-01-20",
        },
        {
          id: 2,
          projectId: 1,
          firstName: "Maria",
          middleName: "C.",
          lastName: "Santos",
          fullName: "Santos, Maria C.",
          birthday: "2008-07-22",
          age: 17,
          contact: "09281234567",
          address: "456 Sampaguita St., Marikina City",
          preferredRole: "Documentation Team",
          parentalConsent: "parental_consent_maria_santos.pdf",
          status: "approved",
          attended: true,
          appliedDate: "2025-01-18",
        },
        {
          id: 3,
          projectId: 2,
          firstName: "Mark",
          middleName: "A.",
          lastName: "Rivera",
          fullName: "Rivera, Mark A.",
          birthday: "2004-11-30",
          age: 21,
          contact: "09331234567",
          address: "789 Rizal Ave., Marikina City",
          preferredRole: "Sports Coach",
          status: "approved",
          appliedDate: "2025-01-19",
        },
      ];

      // Sample projects with enhanced data
      let projects = [
        {
          id: 1,
          title: "Community Clean-Up Drive 2025: Malanday River Rehabilitation",
          category: "Environment",
          status: "Ongoing",
          heads: ["Andrea Pelias", "Kyleen Nicdao"],
          startDate: "2025-12-02",
          endDate: "2025-12-02",
          startTime: "08:00",
          endTime: "12:00",
          location: "Malanday River and surrounding areas",
          description:
            "A comprehensive environmental initiative focused on rehabilitating the Malanday River system through weekly clean-up activities, waste segregation education, and community involvement.\n\nObjectives:\n• Remove accumulated waste from river and riverbanks\n• Educate residents on proper waste disposal\n• Plant trees along riverbanks\n• Establish monitoring system for illegal dumping\n\nVolunteer Roles Needed:\n• Event Coordinators\n• Documentation Team\n• Logistics Support\n• Community Educators",
          banner: "",
          budget: 35000,
          expectedVolunteers: 40,
          beneficiaries: "250 Community residents, families near Malanday River",
          budgetBreakdown: [
            { id: 1, description: "Cleaning supplies and equipment", cost: 8000 },
            { id: 2, description: "Trash bags and waste bins", cost: 3500 },
            { id: 3, description: "Refreshments for volunteers", cost: 5000 },
            { id: 4, description: "Tree saplings and planting materials", cost: 7500 },
            { id: 5, description: "Signage and educational materials", cost: 4000 },
            { id: 6, description: "First aid supplies", cost: 2000 },
            { id: 7, description: "Transportation and logistics", cost: 3000 },
            { id: 8, description: "Documentation (photos/videos)", cost: 2000 }
          ],
          applications: applications.filter((a) => a.projectId === 1),
          approvalStatus: "approved",
          notes: "Great initiative! The project proposal is well-structured and the budget is reasonable. Approved for implementation. Please ensure all safety protocols are followed during the event.",
          approvedBy: "Hon. Barangay Captain",
          approvalDate: "Dec 10, 2025",
          inquiries: [
            {
              id: 101,
              from: "Juan Dela Cruz",
              message: "What time po magsisimula?",
              time: "2h",
              replies: [
                {
                  text: "Good day! The clean-up drive will start at 7:00 AM. Please arrive 15 minutes earlier for registration. Thank you!",
                  repliedBy: "Andrea Pelias",
                  repliedAt: "1h",
                },
              ],
            },
            {
              id: 102,
              from: "Maria Santos",
              message: "Pwede po bang sumama kahit late?",
              time: "5h",
              replies: [
                {
                  text: "Hello! Yes, you can join even if you arrive late. However, we encourage everyone to come on time so you won't miss the orientation and safety briefing. See you there!",
                  repliedBy: "Andrea Pelias",
                  repliedAt: "4h",
                },
              ],
            },
          ],
        },
        {
          id: 2,
          title: "Youth Sports Festival 2025",
          category: "Sports",
          status: "Completed",
          heads: ["Kyleen Nicdao"],
          startDate: "2025-11-25",
          endDate: "2025-11-25",
          startTime: "09:00",
          endTime: "17:00",
          location: "Covered Court",
          description:
            "A multi-sport festival for barangay youth including basketball and volleyball. Registration required for teams. Food and first aid on site.",
          banner: "",
          applications: applications.filter((a) => a.projectId === 2),
          inquiries: [
            {
              id: 201,
              from: "Mark Rivera",
              message: "Anong uniform ang suot?",
              time: "1d",
              replies: [],
            },
          ],
        },
        {
          id: 3,
          title: "Scholarship Program Deadline",
          category: "Education",
          status: "Pending for Revision",
          heads: ["Andrea Pelias"],
          startDate: "2025-12-15",
          endDate: "2025-12-15",
          startTime: "23:59",
          endTime: "23:59",
          location: "SK Office",
          description:
            "Support & scholarship application for deserving students. Deadline: December 15, 2025. Submit requirements to the office during office hours.",
          banner: "",
          applications: [],
          inquiries: [],
          approvalStatus: "revision-requested",
          notes: "The scholarship program needs more details:\n\n1. Provide specific eligibility criteria\n2. Include budget breakdown for scholarship amounts\n3. Add selection process timeline\n4. Specify number of scholarship slots available\n\nPlease revise and resubmit within 5 working days.",
          revisionRequestedBy: "Hon. Barangay Captain",
          revisionRequestDate: "Dec 12, 2025",
        },
        {
          id: 4,
          title: "International Youth Exchange Program",
          category: "Education",
          status: "Rejected",
          heads: ["Andrea Pelias"],
          startDate: "2026-03-01",
          endDate: "2026-03-15",
          startTime: "08:00",
          endTime: "18:00",
          location: "Various International Venues",
          description: "Youth exchange program with sister barangay in another country to promote cultural exchange and global exposure.",
          banner: "",
          applications: [],
          inquiries: [],
          approvalStatus: "rejected",
          notes: "After careful review, this project cannot be approved due to:\n\n1. Budget of ₱250,000 exceeds our Q1 allocation\n2. Not aligned with current barangay priorities\n3. Limited direct benefit to the community\n4. High costs for small participant pool\n\nWe suggest focusing on local programs that can benefit more residents. You may consider a local cultural exchange with nearby barangays instead, which would be more cost-effective and accessible.",
          rejectedBy: "Hon. Barangay Captain",
          rejectionDate: "Dec 11, 2025",
        },
      ];

      // Store current project ID for modal operations
      let currentProjectId = null;

      // Pagination variables
      let currentPage = 0;
      const projectsPerPage = 3;
      let currentFilteredProjects = [];

      // Navigate through project pages
      function navigateProjects(direction) {
        const totalPages = Math.ceil(currentFilteredProjects.length / projectsPerPage);
        currentPage += direction;

        // Wrap around
        if (currentPage < 0) currentPage = totalPages - 1;
        if (currentPage >= totalPages) currentPage = 0;

        renderProjects(currentFilteredProjects);
        updatePaginationDots();
      }

      // Update pagination dots
      function updatePaginationDots() {
        const totalPages = Math.ceil(currentFilteredProjects.length / projectsPerPage);
        const dotsContainer = document.getElementById('paginationDots');

        if (totalPages <= 1) {
          dotsContainer.classList.add('hidden');
          document.getElementById('prevBtn').classList.add('hidden');
          document.getElementById('nextBtn').classList.add('hidden');
          return;
        }

        dotsContainer.classList.remove('hidden');
        document.getElementById('prevBtn').classList.remove('hidden');
        document.getElementById('prevBtn').classList.add('flex');
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('nextBtn').classList.add('flex');

        dotsContainer.innerHTML = Array.from({ length: totalPages }, (_, i) => `
          <button
            onclick="goToPage(${i})"
            class="w-2 h-2 rounded-full transition ${i === currentPage ? 'bg-emerald-600 w-8' : 'bg-gray-300 hover:bg-gray-400'}"
          ></button>
        `).join('');
      }

      // Go to specific page
      function goToPage(pageIndex) {
        currentPage = pageIndex;
        renderProjects(currentFilteredProjects);
        updatePaginationDots();
      }

      // Render projects grid
      function renderProjects(list) {
        currentFilteredProjects = list;
        const grid = document.getElementById("projectsGrid");
        grid.innerHTML = "";

        if (list.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-12 text-gray-500">No projects found</div>';
          document.getElementById('paginationDots').classList.add('hidden');
          document.getElementById('prevBtn').classList.add('hidden');
          document.getElementById('nextBtn').classList.add('hidden');
          return;
        }

        // Calculate pagination
        const startIndex = currentPage * projectsPerPage;
        const endIndex = startIndex + projectsPerPage;
        const projectsToShow = list.slice(startIndex, endIndex);

        // Update navigation buttons
        updatePaginationDots();

        projectsToShow.forEach((project) => {
          const isHead = project.heads.includes(currentUser);
          const pendingCount = project.applications.filter(
            (a) => a.status === "pending"
          ).length;
          const totalApplicants = project.applications.length;

          const card = document.createElement("div");
          card.className =
            "bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-lg transition-all project-card";

          const statusColors = {
            "Pending Approval": "bg-orange-100 text-orange-700",
            Ongoing: "bg-emerald-100 text-emerald-700",
            Upcoming: "bg-blue-100 text-blue-700",
            "Pending for Revision": "bg-yellow-100 text-yellow-700",
            Rejected: "bg-red-100 text-red-700",
            Completed: "bg-emerald-100 text-emerald-700",
          };

          card.innerHTML = `
          <!-- Banner Image Area -->
          <div class="h-40 bg-gradient-to-br from-emerald-100 to-emerald-50"></div>

          <!-- Card Body -->
          <div class="p-5 flex flex-col h-full">
            <!-- Title -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 line-clamp-2 min-h-[56px]">${
              project.title
            }</h3>
            
            <!-- Status and Category badges -->
            <div class="flex items-center gap-2 mb-4">
              <span class="px-2.5 py-1 ${
                statusColors[project.status] || "bg-gray-100 text-gray-700"
              } text-xs rounded-md font-medium">
                ${project.status}
              </span>
              <span class="px-2.5 py-1 bg-gray-100 text-gray-700 text-xs rounded-md font-medium">
                ${project.category}
              </span>
            </div>

            <!-- Description -->
            <p class="text-sm text-gray-600 line-clamp-3 mb-4 flex-1">
              ${project.description}
            </p>

            <!-- Statistics Section -->
            <div class="space-y-3 mb-4">
              <!-- Applicants -->
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-2xl font-bold text-gray-800">${totalApplicants}</span>
                  <span class="ml-2 text-sm text-gray-600">Total Applicants</span>
                </div>
                ${
                  pendingCount > 0
                    ? `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-md font-medium">
                    ${pendingCount} pending review
                  </span>`
                    : ""
                }
              </div>

              <!-- Inquiries -->
              <div class="flex items-center text-sm text-gray-600">
                <span class="font-semibold text-gray-800">${
                  project.inquiries.length
                }</span>
                <span class="ml-2">Inquiries</span>
              </div>
            </div>

            <!-- Success Rate Badge (for completed projects) -->
            ${
              project.status === "Completed" && project.successRate !== undefined
                ? `
              <div class="mb-3 p-3 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-lg border border-emerald-200">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold text-emerald-800">Success Rate</span>
                  <span class="text-2xl font-bold text-emerald-600">${project.successRate}%</span>
                </div>
                <div class="mt-2 h-2 bg-emerald-200 rounded-full overflow-hidden">
                  <div class="h-full bg-emerald-600 rounded-full" style="width: ${project.successRate}%"></div>
                </div>
              </div>
            `
                : ""
            }

            <!-- Main Action Button -->
            <button onclick="viewProject(${project.id})"
                    class="w-full px-4 py-2.5 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium mb-3 transition">
              View Details & Applications
            </button>

            <!-- Archive Button (for completed, rejected, or revision-needed projects) -->
            ${
              project.status === "Completed" || project.status === "Rejected" || project.status === "Pending for Revision"
                ? `
              <button onclick="archiveProject(${project.id})"
                      class="w-full px-4 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-medium mb-3 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                </svg>
                Archive Project
              </button>
            `
                : ""
            }

            <!-- Mark as Complete Button (for active/ongoing projects) -->
            ${
              isHead && (project.status === "Ongoing" || project.status === "Upcoming")
                ? `
              <button onclick="openEvaluationModal(${project.id})"
                      class="w-full px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium mb-3 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Mark as Complete
              </button>
            `
                : ""
            }

            <!-- Edit Button -->
            ${
              isHead
                ? `
              <div class="flex gap-2">
                <button onclick="editProject(${project.id})"
                        class="w-full px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium">
                  Edit
                </button>
              </div>
            `
                : ""
            }
          </div>
        `;

          grid.appendChild(card);
        });
      }

      // View project details
      function viewProject(id) {
        currentProjectId = id;
        const project = projects.find((p) => p.id === id);
        if (!project) return;

        // Populate header
        document.getElementById("viewProjectTitle").textContent = project.title;
        document.getElementById(
          "viewProjectHeadsCount"
        ).textContent = `${project.heads.length} Project Head(s)`;
        document.getElementById("viewProjectCategory").textContent =
          project.category;

        // Populate details tab
        document.getElementById("detailsCategory").textContent =
          project.category;

        const statusEl = document.getElementById("detailsStatus");
        const statusColors = {
          "Pending Approval": "bg-orange-100 text-orange-700",
          Ongoing: "bg-emerald-100 text-emerald-700",
          Upcoming: "bg-blue-100 text-blue-700",
          "Pending for Revision": "bg-yellow-100 text-yellow-700",
          Rejected: "bg-red-100 text-red-700",
          Completed: "bg-emerald-100 text-emerald-700",
        };
        statusEl.textContent = project.status;
        statusEl.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${
          statusColors[project.status]
        }`;

        const startDateTime = project.startTime
          ? `${new Date(project.startDate).toLocaleDateString()} ${
              project.startTime
            }`
          : new Date(project.startDate).toLocaleDateString();
        const endDateTime = project.endTime
          ? `${new Date(project.endDate).toLocaleDateString()} ${
              project.endTime
            }`
          : new Date(project.endDate).toLocaleDateString();
        document.getElementById(
          "detailsDuration"
        ).textContent = `${startDateTime} - ${endDateTime}`;
        document.getElementById("detailsLocation").textContent =
          project.location;

        // Display captain's decision if available
        displayCaptainDecision(project);
        document.getElementById("detailsHeads").textContent =
          project.heads.join(", ");
        document.getElementById("detailsDescription").textContent =
          project.description;

        // Update counts
        document.getElementById("applicantCount").textContent =
          project.applications.length;
        document.getElementById("inquiryCount").textContent =
          project.inquiries.length;

        const pending = project.applications.filter(
          (a) => a.status === "pending"
        ).length;
        const approved = project.applications.filter(
          (a) => a.status === "approved"
        ).length;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;

        // Load applicants
        loadApplicants(project);

        // Load inquiries
        loadInquiries(project);

        // Show modal
        document.getElementById("projectViewModal").classList.remove("hidden");
        switchTab("details");
      }

      function closeProjectView() {
        document.getElementById("projectViewModal").classList.add("hidden");
        currentProjectId = null;
      }

      // Tab switching
      function switchTab(tab) {
        // Update tab buttons
        ["details", "applicants", "inquiries"].forEach((t) => {
          const tabBtn = document.getElementById(
            `tab${t.charAt(0).toUpperCase() + t.slice(1)}`
          );
          const tabContent = document.getElementById(
            `tabContent${t.charAt(0).toUpperCase() + t.slice(1)}`
          );

          if (t === tab) {
            tabBtn.classList.add("active");
            tabContent.classList.remove("hidden");
          } else {
            tabBtn.classList.remove("active");
            tabContent.classList.add("hidden");
          }
        });
      }

      // Load applicants
      function loadApplicants(project) {
        const container = document.getElementById("applicantsList");
        container.innerHTML = "";

        if (project.applications.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">No applications yet</p>';
          return;
        }

        const filteredApps = getFilteredApplicants(project);

        filteredApps.forEach((app) => {
          const statusColors = {
            pending: "bg-yellow-100 text-yellow-700",
            approved: "bg-emerald-100 text-emerald-700",
            rejected: "bg-red-100 text-red-700",
          };

          const card = document.createElement("div");
          card.className =
            "bg-white border rounded-lg p-4 hover:shadow-md cursor-pointer transition";
          card.onclick = () => viewApplicant(app, project);

          card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h4 class="font-semibold">${app.fullName}</h4>
              <p class="text-sm text-gray-600">${app.preferredRole} • Age ${app.age}</p>
            </div>
            <div class="flex items-center gap-3">
              ${project.status === 'Completed' && app.status === 'approved' ? `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded" onclick="event.stopPropagation()">
                  <input type="checkbox" ${app.attended ? 'checked' : ''}
                         onchange="toggleAttendance(${project.id}, ${app.id}, this.checked)"
                         class="w-4 h-4 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-500" />
                  <span class="text-sm font-medium ${app.attended ? 'text-emerald-700' : 'text-gray-600'}">
                    ${app.attended ? 'Attended' : 'Mark Attended'}
                  </span>
                </label>
              ` : ''}
              <span class="px-3 py-1 ${statusColors[app.status]} text-xs rounded-full font-medium">
                ${app.status}
              </span>
            </div>
          </div>
        `;

          container.appendChild(card);
        });
      }

      function getFilteredApplicants(project) {
        const filter = document.getElementById("applicantStatusFilter").value;
        return filter
          ? project.applications.filter((a) => a.status === filter)
          : project.applications;
      }

      function filterApplicants() {
        const project = projects.find((p) => p.id === currentProjectId);
        if (project) loadApplicants(project);
      }

      // Toggle attendance for approved volunteers
      function toggleAttendance(projectId, applicantId, attended) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        const applicant = project.applications.find(a => a.id === applicantId);
        if (!applicant) return;

        applicant.attended = attended;

        // Reload the applicants list to reflect the change
        loadApplicants(project);

        showToast(attended ?
          `${applicant.fullName} marked as attended` :
          `${applicant.fullName} attendance removed`
        );
      }

      // Load inquiries
      function loadInquiries(project) {
        const container = document.getElementById("inquiriesList");
        container.innerHTML = "";

        if (project.inquiries.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">No inquiries yet</p>';
          return;
        }

        project.inquiries.forEach((inquiry) => {
          const initials = inquiry.from
            .split(" ")
            .map((n) => n[0])
            .join("")
            .substring(0, 2);
          const hasReplies = inquiry.replies && inquiry.replies.length > 0;

          const card = document.createElement("div");
          card.className = "bg-white border border-gray-200 rounded-lg p-4";

          // Build all replies HTML
          let repliesSection = "";
          if (hasReplies) {
            inquiry.replies.forEach((reply) => {
              const replyInitials = reply.repliedBy
                .split(" ")
                .map((n) => n[0])
                .join("")
                .substring(0, 2);
              repliesSection += `
              <div class="mt-4 ml-16 pl-4 border-l-2 border-emerald-500">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center font-semibold text-white flex-shrink-0 text-sm">
                    ${replyInitials}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <h5 class="font-semibold text-gray-900 text-sm">${reply.repliedBy}</h5>
                      <span class="text-xs text-gray-500">${reply.repliedAt}</span>
                    </div>
                    <p class="text-sm text-gray-700">${reply.text}</p>
                  </div>
                </div>
              </div>
            `;
            });
          }

          card.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center font-semibold text-gray-700 flex-shrink-0">
              ${initials}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900">${inquiry.from}</h4>
                  <p class="text-sm text-gray-700 mt-1">${inquiry.message}</p>
                </div>
                <span class="text-xs text-gray-500 ml-4">${inquiry.time}</span>
              </div>
              
              <div class="mt-2">
                ${
                  hasReplies
                    ? `<span class="text-xs text-emerald-600 font-medium">✓ ${
                        inquiry.replies.length
                      } ${
                        inquiry.replies.length === 1 ? "Reply" : "Replies"
                      }</span>`
                    : '<span class="text-xs text-orange-600 font-medium">No replies yet</span>'
                }
              </div>
            </div>
          </div>
          
          ${repliesSection}
          
          <div class="mt-4 ml-16 pl-4 border-l-2 border-gray-200">
            <textarea id="replyText_${inquiry.id}" rows="2" 
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none" 
                      placeholder="Type your reply..."></textarea>
            <button onclick="sendInquiryReply(${inquiry.id})" 
                    class="mt-2 px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
              Send Reply
            </button>
          </div>
        `;

          container.appendChild(card);
        });
      }

      // View applicant details
      let currentApp = null;
      function viewApplicant(app, project) {
        currentApp = app;
        document.getElementById("appProjectName").textContent = project.title;
        document.getElementById("appFirstName").textContent =
          app.firstName || "";
        document.getElementById("appMiddleName").textContent =
          app.middleName || "";
        document.getElementById("appLastName").textContent = app.lastName || "";
        document.getElementById("appBirthday").textContent = new Date(
          app.birthday
        ).toLocaleDateString();
        document.getElementById("appAge").textContent = `${app.age} years old`;
        document.getElementById("appContact").textContent = app.contact;
        document.getElementById("appEmail").textContent = app.email || "";
        document.getElementById("appAddress").textContent = app.address;
        document.getElementById("appRole").textContent = app.preferredRole;

        // Show parental consent section if applicant is under 18
        const consentSection = document.getElementById(
          "appParentalConsentSection"
        );
        if (app.age < 18) {
          consentSection.classList.remove("hidden");
          const consentLink = document.getElementById("appParentalConsent");
          const consentText = document.getElementById("appParentalConsentText");

          if (app.parentalConsent) {
            consentLink.href = "#"; // In a real app, this would be the actual file URL
            consentLink.download = app.parentalConsent;
            consentText.textContent = app.parentalConsent;
          } else {
            consentText.textContent = "Not uploaded";
            consentLink.removeAttribute("href");
            consentLink.classList.remove("text-blue-600", "hover:underline");
            consentLink.classList.add("text-gray-500");
          }
        } else {
          consentSection.classList.add("hidden");
        }

        const statusColors = {
          pending: "text-yellow-600",
          approved: "text-emerald-600",
          rejected: "text-red-600",
        };

        document.getElementById("appCurrentStatus").innerHTML = `<span class="${
          statusColors[app.status]
        } font-semibold">${app.status.toUpperCase()}</span>`;
        document.getElementById("appDate").textContent = new Date(
          app.appliedDate
        ).toLocaleDateString();

        document.getElementById("applicantModal").classList.remove("hidden");
      }

      function closeApplicantModal() {
        document.getElementById("applicantModal").classList.add("hidden");
        currentApp = null;
      }

      function updateStatus(newStatus) {
        if (!currentApp) return;
        currentApp.status = newStatus;
        showToast(`Application status updated to ${newStatus}`);
        closeApplicantModal();

        // Refresh the view
        const project = projects.find((p) =>
          p.applications.some((a) => a.id === currentApp.id)
        );
        if (project) {
          loadApplicants(project);

          // Update counts
          const pending = project.applications.filter(
            (a) => a.status === "pending"
          ).length;
          const approved = project.applications.filter(
            (a) => a.status === "approved"
          ).length;
          document.getElementById("pendingCount").textContent = pending;
          document.getElementById("approvedCount").textContent = approved;
        }

        renderProjects(projects);
      }

      // Edit project
      let editingProjectId = null;
      let selectedHeads = [];

      function editProject(id) {
        const project = projects.find((p) => p.id === id);
        if (!project) return;

        if (!project.heads.includes(currentUser)) {
          alert("Only project heads can edit this project.");
          return;
        }

        editingProjectId = id;
        document.getElementById("projectModalTitle").textContent =
          "Edit Project";
        document.getElementById("projTitle").value = project.title;
        document.getElementById("projCategory").value = project.category;
        document.getElementById("projStatus").value = project.status;
        document.getElementById("projBudget").value = project.budget || 0;
        document.getElementById("projVolunteers").value = project.expectedVolunteers || 0;
        document.getElementById("projStartDate").value = project.startDate;
        document.getElementById("projStartTime").value =
          project.startTime || "08:00";
        document.getElementById("projEndDate").value = project.endDate;
        document.getElementById("projEndTime").value =
          project.endTime || "17:00";
        document.getElementById("projLocation").value = project.location;
        document.getElementById("projDesc").value = project.description;
        document.getElementById("projBeneficiaries").value = project.beneficiaries || "";

        selectedHeads = [...project.heads];
        renderHeadsPills();

        document.getElementById("projectModal").classList.remove("hidden");
      }

      // Create new project
      document
        .getElementById("createProjectBtn")
        .addEventListener("click", () => {
          editingProjectId = null;
          selectedHeads = [];
          document.getElementById("projectModalTitle").textContent =
            "Create Project";
          document.getElementById("projTitle").value = "";
          document.getElementById("projCategory").value = "";
          document.getElementById("projStatus").value = "Ongoing";
          document.getElementById("projBudget").value = "";
          document.getElementById("projVolunteers").value = "";
          document.getElementById("projStartDate").value = "";
          document.getElementById("projEndDate").value = "";
          document.getElementById("projLocation").value = "";
          document.getElementById("projDesc").value = "";
          document.getElementById("projBeneficiaries").value = "";
          document.getElementById("projBanner").value = "";

          clearBudgetBreakdown();
          renderHeadsPills();
          document.getElementById("projectModal").classList.remove("hidden");

          // Check if there's a budget in URL params (from captain approval)
          const urlParams = new URLSearchParams(window.location.search);
          const approvedBudget = urlParams.get('budget');
          if (approvedBudget) {
            autoFillBudgetFromCaptain(parseFloat(approvedBudget));
            // Clear the URL param after using it
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        });

      function closeProjectModal() {
        document.getElementById("projectModal").classList.add("hidden");
        editingProjectId = null;
        selectedHeads = [];
        clearBudgetBreakdown();
      }

      // Budget Breakdown Functions
      let budgetBreakdownItems = [];

      function addBudgetRow() {
        const item = {
          id: Date.now(),
          description: '',
          cost: 0
        };
        budgetBreakdownItems.push(item);
        renderBudgetBreakdown();
        // Focus on the newly added description input
        setTimeout(() => {
          const newRow = document.querySelector(`#budgetItem_${item.id}_desc`);
          if (newRow) newRow.focus();
        }, 100);
      }

      function removeBudgetRow(id) {
        budgetBreakdownItems = budgetBreakdownItems.filter(item => item.id !== id);
        renderBudgetBreakdown();
        updateBudgetTotal();
      }

      function updateBudgetItem(id, field, value) {
        const item = budgetBreakdownItems.find(item => item.id === id);
        if (item) {
          if (field === 'cost') {
            item[field] = parseFloat(value) || 0;
          } else {
            item[field] = value;
          }
          updateBudgetTotal();
        }
      }

      function renderBudgetBreakdown() {
        const tbody = document.getElementById('budgetBreakdownTable');
        tbody.innerHTML = budgetBreakdownItems.map((item, index) => `
          <tr class="border-b border-gray-200">
            <td class="py-2 px-2 text-gray-700">${index + 1}</td>
            <td class="py-2 px-2">
              <input
                type="text"
                id="budgetItem_${item.id}_desc"
                value="${item.description}"
                placeholder="e.g., Food and beverages"
                oninput="updateBudgetItem(${item.id}, 'description', this.value)"
                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-emerald-500 text-sm"
              />
            </td>
            <td class="py-2 px-2">
              <input
                type="number"
                id="budgetItem_${item.id}_cost"
                value="${item.cost || ''}"
                placeholder="0"
                min="0"
                step="0.01"
                oninput="updateBudgetItem(${item.id}, 'cost', this.value)"
                class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-emerald-500 text-sm"
              />
            </td>
            <td class="py-2 px-2 text-center">
              <button
                type="button"
                onclick="removeBudgetRow(${item.id})"
                class="text-red-600 hover:text-red-800"
                title="Remove item"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </td>
          </tr>
        `).join('');
      }

      function updateBudgetTotal() {
        const total = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
        document.getElementById('budgetTotal').textContent = `₱${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        updateBudgetRemaining();
      }

      function updateBudgetRemaining() {
        const proposedBudget = parseFloat(document.getElementById('projBudget').value) || 0;
        const total = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
        const remaining = proposedBudget - total;

        const remainingEl = document.getElementById('remainingBudget');
        remainingEl.textContent = `₱${remaining.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        // Change color based on remaining budget
        if (remaining < 0) {
          remainingEl.className = 'text-lg font-bold text-red-600';
        } else if (remaining === 0) {
          remainingEl.className = 'text-lg font-bold text-gray-600';
        } else {
          remainingEl.className = 'text-lg font-bold text-emerald-600';
        }
      }

      function clearBudgetBreakdown() {
        budgetBreakdownItems = [];
        renderBudgetBreakdown();
        updateBudgetTotal();
      }

      // Auto-fill budget from captain's approval
      function autoFillBudgetFromCaptain(approvedBudget) {
        if (approvedBudget) {
          document.getElementById('projBudget').value = approvedBudget;
          updateBudgetRemaining();
        }
      }

      // Initialize budget when opening create project modal
      // This will be called from captain-dashboard when creating project from approved proposal
      window.initializeProjectWithBudget = function(budget) {
        autoFillBudgetFromCaptain(budget);
      };

      // Project heads multi-select
      function renderHeadsPills() {
        const container = document.getElementById("selectedPills");
        container.querySelectorAll(".pill").forEach((el) => el.remove());

        selectedHeads.forEach((name) => {
          const pill = document.createElement("span");
          pill.className =
            "pill flex items-center gap-1 bg-emerald-50 text-emerald-700 px-2 py-1 rounded-full text-sm";
          pill.innerHTML = `
          ${name}
          <button onclick="removeHead('${name}')" class="ml-1">✕</button>
        `;
          container.insertBefore(pill, document.getElementById("headsSearch"));
        });
      }

      function removeHead(name) {
        selectedHeads = selectedHeads.filter((h) => h !== name);
        renderHeadsPills();
      }

      function openHeadsDropdown() {
        const dropdown = document.getElementById("headsDropdown");
        dropdown.classList.remove("hidden");
        renderHeadsDropdown();
      }

      document.getElementById("headsSearch").addEventListener("input", (e) => {
        renderHeadsDropdown(e.target.value);
      });

      function renderHeadsDropdown(filter = "") {
        const dropdown = document.getElementById("headsDropdown");
        dropdown.innerHTML = "";

        const available = skOfficials.filter(
          (name) =>
            name.toLowerCase().includes(filter.toLowerCase()) &&
            !selectedHeads.includes(name)
        );

        available.forEach((name) => {
          const option = document.createElement("div");
          option.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
          option.textContent = name;
          option.onclick = () => {
            selectedHeads.push(name);
            renderHeadsPills();
            document.getElementById("headsSearch").value = "";
            renderHeadsDropdown();
          };
          dropdown.appendChild(option);
        });
      }

      // Save project
      document
        .getElementById("saveProjectBtn")
        .addEventListener("click", () => {
          const title = document.getElementById("projTitle").value.trim();
          const category = document.getElementById("projCategory").value.trim();
          const status = document.getElementById("projStatus").value;
          const startDate = document.getElementById("projStartDate").value;
          const startTime = document.getElementById("projStartTime").value;
          const endDate = document.getElementById("projEndDate").value;
          const endTime = document.getElementById("projEndTime").value;
          const location = document.getElementById("projLocation").value.trim();
          const description = document.getElementById("projDesc").value.trim();
          const budget = parseFloat(document.getElementById("projBudget").value) || 0;
          const volunteers = parseInt(document.getElementById("projVolunteers").value) || 0;
          const beneficiaries = document.getElementById("projBeneficiaries").value.trim();

          if (
            !title ||
            !category ||
            selectedHeads.length === 0 ||
            !startDate ||
            !startTime ||
            !endDate ||
            !endTime
          ) {
            alert(
              "Please provide all required fields: title, category, start date/time, end date/time, and at least one project head."
            );
            return;
          }

          // Validate budget breakdown
          if (budgetBreakdownItems.length > 0) {
            const totalBudgetBreakdown = budgetBreakdownItems.reduce((sum, item) => sum + (item.cost || 0), 0);
            if (totalBudgetBreakdown > budget) {
              alert(`Budget breakdown total (₱${totalBudgetBreakdown.toLocaleString()}) exceeds the proposed budget (₱${budget.toLocaleString()}). Please adjust the breakdown.`);
              return;
            }
            // Check if all items have descriptions
            const hasEmptyDescriptions = budgetBreakdownItems.some(item => !item.description.trim());
            if (hasEmptyDescriptions) {
              alert("Please provide descriptions for all budget breakdown items.");
              return;
            }
          }

          if (editingProjectId) {
            const project = projects.find((p) => p.id === editingProjectId);
            Object.assign(project, {
              title,
              category,
              status,
              startDate,
              startTime,
              endDate,
              endTime,
              location,
              description,
              budget,
              expectedVolunteers: volunteers,
              beneficiaries,
              heads: [...selectedHeads],
              budgetBreakdown: budgetBreakdownItems.map(item => ({ ...item })),
            });
            showToast("Project updated successfully");
          } else {
            const newProject = {
              id: Date.now(),
              title,
              category,
              status: "Pending Approval",
              startDate,
              startTime,
              endDate,
              endTime,
              location,
              description,
              budget,
              expectedVolunteers: volunteers,
              beneficiaries,
              heads: [...selectedHeads],
              budgetBreakdown: budgetBreakdownItems.map(item => ({ ...item })),
              banner: "",
              submittedBy: "Andrea Pelias",
              submissionDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
              approvalStatus: "pending",
              applications: [],
              inquiries: [],
            };
            projects.unshift(newProject);
            showToast("Project submitted for Barangay Captain approval!");
          }

          closeProjectModal();
          renderProjects(projects);
        });

      // Send reply to inquiry
      function sendInquiryReply(inquiryId) {
        const replyText = document
          .getElementById(`replyText_${inquiryId}`)
          .value.trim();

        if (!replyText) {
          alert("Please type a reply message.");
          return;
        }

        // Find and update the inquiry
        const project = projects.find((p) => p.id === currentProjectId);
        if (project) {
          const inquiry = project.inquiries.find((i) => i.id === inquiryId);
          if (inquiry) {
            // Initialize replies array if it doesn't exist
            if (!inquiry.replies) {
              inquiry.replies = [];
            }

            // Add new reply to the thread
            inquiry.replies.push({
              text: replyText,
              repliedBy: currentUser,
              repliedAt: "Just now",
            });

            showToast("Reply sent successfully");
            loadInquiries(project);

            // Refresh main grid to update inquiry counts
            renderProjects(projects);
          }
        }
      }

      // Search and filter
      document
        .getElementById("projectSearch")
        .addEventListener("input", applyFilters);
      document
        .getElementById("categoryFilter")
        .addEventListener("change", applyFilters);

      function applyFilters() {
        const search = document
          .getElementById("projectSearch")
          .value.toLowerCase();
        const category = document.getElementById("categoryFilter").value;

        const filtered = projects.filter((p) => {
          const matchSearch =
            !search ||
            p.title.toLowerCase().includes(search) ||
            p.description.toLowerCase().includes(search) ||
            p.category.toLowerCase().includes(search) ||
            p.heads.join(" ").toLowerCase().includes(search);
          const matchCategory = !category || p.category === category;
          return matchSearch && matchCategory;
        });

        currentPage = 0; // Reset to first page when filters change
        renderProjects(filtered);
      }

      // Toast notification
      function showToast(message) {
        const toast = document.getElementById("toast");
        document.getElementById("toastMessage").textContent = message;
        toast.classList.remove("hidden");
        setTimeout(() => toast.classList.add("hidden"), 3000);
      }

      // Display captain's decision in project details
      function displayCaptainDecision(project) {
        const section = document.getElementById('captainDecisionSection');
        const content = document.getElementById('decisionContent');
        const icon = document.getElementById('decisionIcon');
        const statusEl = document.getElementById('decisionStatus');
        const dateEl = document.getElementById('decisionDate');
        const commentsEl = document.getElementById('decisionComments');

        // Check if project has approval status and notes from captain
        if (project.approvalStatus && project.notes) {
          section.classList.remove('hidden');

          let iconText = '';
          let iconBg = '';
          let borderColor = '';
          let statusText = '';
          let dateText = '';

          if (project.approvalStatus === 'approved') {
            iconText = '✓';
            iconBg = 'bg-green-100 text-green-600';
            borderColor = 'border-green-500';
            statusText = 'Project Approved';
            dateText = project.approvalDate ? `Approved on ${project.approvalDate}` : 'Recently approved';
          } else if (project.approvalStatus === 'rejected') {
            iconText = '✗';
            iconBg = 'bg-red-100 text-red-600';
            borderColor = 'border-red-500';
            statusText = 'Project Rejected';
            dateText = project.rejectionDate ? `Rejected on ${project.rejectionDate}` : 'Recently rejected';
          } else if (project.approvalStatus === 'revision-requested') {
            iconText = '✎';
            iconBg = 'bg-yellow-100 text-yellow-600';
            borderColor = 'border-yellow-500';
            statusText = 'Revision Requested';
            dateText = project.revisionRequestDate ? `Requested on ${project.revisionRequestDate}` : 'Recently requested';
          }

          icon.className = `w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold ${iconBg}`;
          icon.textContent = iconText;

          statusEl.textContent = statusText;
          dateEl.textContent = dateText;
          commentsEl.textContent = project.notes || 'No comments provided.';

          content.className = `bg-gray-50 rounded-lg p-5 border-l-4 ${borderColor}`;
        } else {
          section.classList.add('hidden');
        }
      }

      // Close dropdowns on outside click
      document.addEventListener("click", (e) => {
        if (!document.getElementById("headsSelect").contains(e.target)) {
          document.getElementById("headsDropdown").classList.add("hidden");
        }
      });

      // Initialize
      renderProjects(projects);

      // Make functions globally accessible
      window.viewProject = viewProject;
      window.closeProjectView = closeProjectView;
      window.switchTab = switchTab;
      window.editProject = editProject;
      window.closeProjectModal = closeProjectModal;
      window.closeApplicantModal = closeApplicantModal;
      window.viewApplicant = viewApplicant;
      window.updateStatus = updateStatus;
      window.removeHead = removeHead;
      window.openHeadsDropdown = openHeadsDropdown;
      window.filterApplicants = filterApplicants;
      window.applyFilters = applyFilters;
      window.sendInquiryReply = sendInquiryReply;
      window.openEvaluationModal = openEvaluationModal;
      window.closeEvaluationModal = closeEvaluationModal;
      window.submitEvaluation = submitEvaluation;
      window.calculateSuccessRate = calculateSuccessRate;
      window.openDownloadReportModal = openDownloadReportModal;
      window.closeDownloadReportModal = closeDownloadReportModal;
      window.downloadReport = downloadReport;
      window.archiveProject = archiveProject;

      // Notification System
      let notifications = [
        {
          id: 1,
          type: "new_inquiry",
          title: "New Inquiry: Community Clean-Up Drive 2025",
          message: "Juan Dela Cruz posted a new inquiry on your project",
          time: "5 minutes ago",
          read: false,
          projectId: 1,
        },
        {
          id: 2,
          type: "inquiry_reply",
          title: "Inquiry Reply: Youth Sports Festival",
          message: "Maria Santos replied to an inquiry thread",
          time: "1 hour ago",
          read: false,
          projectId: 2,
        },
        {
          id: 3,
          type: "new_announcement",
          title: "New Announcement Posted",
          message: "Kyleen Nicdao posted a new announcement",
          time: "2 hours ago",
          read: false,
          referenceId: 1,
        },
        {
          id: 4,
          type: "new_project",
          title: "New Project: Beach Clean-Up Initiative",
          message: "Andrea Pelias created a new project",
          time: "3 hours ago",
          read: false,
          referenceId: 3,
        },
        {
          id: 5,
          type: "project_application",
          title: "New Application: Community Clean-Up Drive 2025",
          message: "Juan Dela Cruz applied to your project",
          time: "30 minutes ago",
          read: false,
          projectId: 1,
          applicantId: 1,
        },
      ];

      function toggleNotificationModal() {
        const modal = document.getElementById("notificationModal");
        modal.classList.toggle("hidden");
        if (!modal.classList.contains("hidden")) {
          renderNotifications();
        }
      }

      function closeNotificationModal() {
        document.getElementById("notificationModal").classList.add("hidden");
      }

      function updateNotificationCount() {
        const unreadCount = notifications.filter((n) => !n.read).length;
        const badge = document.getElementById("notificationBadge");

        if (unreadCount > 0) {
          badge.textContent = unreadCount > 9 ? "9+" : unreadCount;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      }

      function getNotificationIcon(type) {
        switch (type) {
          case "new_inquiry":
            return `<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>`;
          case "inquiry_reply":
            return `<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>`;
          case "new_announcement":
            return `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
            </svg>`;
          case "new_project":
            return `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>`;
          case "project_application":
            return `<svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>`;
          default:
            return "";
        }
      }

      function getNotificationBgColor(type) {
        switch (type) {
          case "new_inquiry":
            return "bg-yellow-50";
          case "inquiry_reply":
            return "bg-yellow-50";
          case "new_announcement":
            return "bg-blue-50";
          case "new_project":
            return "bg-blue-50";
          case "project_application":
            return "bg-emerald-50";
          default:
            return "bg-gray-50";
        }
      }

      function renderNotifications() {
        const notificationList = document.getElementById("notificationList");

        if (notifications.length === 0) {
          notificationList.innerHTML = `
            <div class="p-8 text-center text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
              <p class="font-medium">No notifications</p>
              <p class="text-sm mt-1">You're all caught up!</p>
            </div>
          `;
          return;
        }

        notificationList.innerHTML = notifications
          .map(
            (notif) => `
          <div
            onclick="handleNotificationClick(${notif.id})"
            class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition ${
              !notif.read ? getNotificationBgColor(notif.type) : ""
            }"
          >
            <div class="flex items-start space-x-3">
              <div class="flex-shrink-0">
                ${getNotificationIcon(notif.type)}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between">
                  <p class="text-sm font-semibold text-gray-800 truncate ${
                    !notif.read ? "font-bold" : ""
                  }">
                    ${notif.title}
                  </p>
                  ${
                    !notif.read
                      ? '<span class="w-2 h-2 bg-emerald-600 rounded-full flex-shrink-0 ml-2 mt-1"></span>'
                      : ""
                  }
                </div>
                <p class="text-xs text-gray-600 mt-1">${notif.message}</p>
                <p class="text-xs text-gray-400 mt-2">${notif.time}</p>
              </div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function handleNotificationClick(notifId) {
        const notif = notifications.find((n) => n.id === notifId);
        if (!notif) return;

        notif.read = true;
        updateNotificationCount();
        closeNotificationModal();

        // Route to appropriate page based on notification type
        if (notif.type === "new_inquiry" || notif.type === "inquiry_reply") {
          window.location.href = `skproject.html?projectId=${notif.projectId}&tab=inquiries`;
        } else if (notif.type === "new_announcement") {
          window.location.href = `dashb.html`;
        } else if (notif.type === "new_project") {
          window.location.href = `skproject.html?projectId=${notif.referenceId}`;
        } else if (notif.type === "project_application") {
          window.location.href = `skproject.html?projectId=${notif.projectId}&tab=applications&applicantId=${notif.applicantId}`;
        }
      }

      function markAllAsRead() {
        notifications.forEach((n) => (n.read = true));
        updateNotificationCount();
        renderNotifications();
      }

      // Close notification modal when clicking outside
      document.addEventListener("click", function (event) {
        const modal = document.getElementById("notificationModal");
        const notificationButton = event.target.closest(
          'button[onclick="toggleNotificationModal()"]'
        );

        if (
          !modal.contains(event.target) &&
          !notificationButton &&
          !modal.classList.contains("hidden")
        ) {
          closeNotificationModal();
        }
      });

      // Handle URL parameters for deep linking to inquiries
      function handleURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get("projectId");
        const tab = urlParams.get("tab");
        const applicantId = urlParams.get("applicantId");

        if (projectId) {
          const id = parseInt(projectId);
          const project = projects.find((p) => p.id === id);

          if (project) {
            viewProject(id);

            if (tab === "inquiries") {
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  switchTab("inquiries");
                });
              });
            } else if (tab === "applications") {
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  switchTab("applicants");
                  // If applicantId is provided, open that applicant's details modal
                  if (applicantId) {
                    requestAnimationFrame(() => {
                      const applicant = applications.find(
                        (a) => a.id === parseInt(applicantId)
                      );
                      if (applicant) {
                        viewApplicant(applicant, project);
                      }
                    });
                  }
                });
              });
            }
          }
        }
      }

      // ========== SUCCESS RATE EVALUATION MODAL FUNCTIONS ==========

      function openEvaluationModal(projectId) {
        currentProjectId = projectId;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        document.getElementById('evalProjectTitle').textContent = project.title;
        document.getElementById('evaluationModal').classList.remove('hidden');

        // Auto-fill from project proposal data
        document.getElementById('budgetPlanned').value = project.budget || '';
        document.getElementById('volunteersTarget').value = project.expectedVolunteers || '';
        document.getElementById('beneficiariesTarget').value = project.targetBeneficiaries || '';

        // Load actual budget breakdown (auto-fills from planned, user can edit)
        loadActualBreakdownFromPlanned(projectId);

        // Reset actual values
        document.getElementById('budgetActual').value = '';
        document.getElementById('volunteersActual').value = '';
        document.getElementById('timelineStatus').value = '';
        document.getElementById('beneficiariesActual').value = '';

        // Load volunteer feedback data from project
        const approvedVolunteers = project.applications.filter(a => a.status === 'approved');
        const volunteersWithFeedback = approvedVolunteers.filter(v => v.satisfactionScore);
        const avgSatisfaction = volunteersWithFeedback.length > 0
          ? (volunteersWithFeedback.reduce((sum, v) => sum + v.satisfactionScore, 0) / volunteersWithFeedback.length).toFixed(1)
          : '-';

        document.getElementById('autoFeedbackScore').textContent = avgSatisfaction !== '-' ? `${avgSatisfaction}/4` : '-';
        document.getElementById('surveyCount').textContent = volunteersWithFeedback.length;
        document.getElementById('totalVolunteers').textContent = approvedVolunteers.length;

        calculateSuccessRate();
      }

      function closeEvaluationModal() {
        document.getElementById('evaluationModal').classList.add('hidden');
        currentProjectId = null;
        // Clear achievements
        projectAchievements = [];
        document.getElementById('achievementsList').innerHTML = '';
        document.getElementById('achievementInput').value = '';
        document.getElementById('achievementNumber').textContent = '1';
      }

      // ========== ACHIEVEMENTS FUNCTIONS ==========

      let projectAchievements = [];

      const achievementTemplates = {
        environmental: [
          "Successfully collected and properly disposed of {X} kg of waste materials from the community",
          "Planted {X} native trees across {Y} hectares of degraded land, contributing to reforestation efforts",
          "Reduced plastic waste by {X}% through community education and eco-friendly alternatives",
          "Established {X} community compost bins serving {Y} households in the barangay",
          "Cleaned and rehabilitated {X} meters of coastal/riverbank areas, removing debris and pollutants",
          "Organized {X} environmental awareness workshops reaching {Y} community members"
        ],
        community: [
          "Engaged {X} community members in active participation throughout the project duration",
          "Strengthened partnerships with {X} local organizations and {Y} barangay officials",
          "Distributed essential resources to {X} families in need within the community",
          "Facilitated {X} community dialogues fostering collaboration among {Y} stakeholders",
          "Established {X} sustainable community programs benefiting {Y} residents long-term",
          "Built strong relationships with {X} local leaders enhancing future project collaboration"
        ],
        volunteer: [
          "Mobilized {X} dedicated volunteers who contributed a total of {Y} service hours",
          "Achieved {X}% volunteer retention rate with {Y} volunteers participating in multiple activities",
          "Trained {X} volunteers in leadership and project management skills for future initiatives",
          "Developed teamwork and collaboration among {X} volunteers from diverse backgrounds",
          "Recognized {X} outstanding volunteers for exceptional dedication and community service",
          "Created a volunteer network of {X} individuals committed to ongoing community development"
        ],
        educational: [
          "Conducted {X} educational sessions on environmental conservation reaching {Y} participants",
          "Distributed {X} informational materials educating community members on sustainable practices",
          "Trained {X} community leaders as environmental advocates and change agents",
          "Organized {X} skills workshops equipping {Y} residents with practical knowledge",
          "Developed {X} learning modules adopted by {Y} barangays for community education",
          "Achieved {X}% increase in community awareness on environmental issues through targeted campaigns"
        ],
        impact: [
          "Exceeded target beneficiaries by {X}%, reaching {Y} individuals instead of the projected goal",
          "Achieved {X}% satisfaction rating from community members based on post-project surveys",
          "Generated {X}% cost savings by completing the project under budget while maintaining quality",
          "Completed all project milestones {X} days ahead of schedule demonstrating efficient execution",
          "Created lasting impact with {X}% of participants committing to continued environmental action",
          "Secured {X} commitments from local businesses and organizations for ongoing support of initiatives"
        ]
      };

      function showAchievementSuggestions(inputValue) {
        const suggestionsDiv = document.getElementById('achievementSuggestions');

        if (!inputValue || inputValue.trim().length < 2) {
          suggestionsDiv.classList.add('hidden');
          return;
        }

        const allTemplates = Object.values(achievementTemplates).flat();
        const matches = allTemplates.filter(template =>
          template.toLowerCase().includes(inputValue.toLowerCase())
        );

        if (matches.length === 0) {
          suggestionsDiv.classList.add('hidden');
          return;
        }

        suggestionsDiv.innerHTML = matches.slice(0, 8).map(template => `
          <div class="px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0"
               onclick="selectAchievementSuggestion('${template.replace(/'/g, "\\'")}')">
            <p class="text-sm text-gray-700">${template}</p>
          </div>
        `).join('');

        suggestionsDiv.classList.remove('hidden');
      }

      function selectAchievementSuggestion(template) {
        document.getElementById('achievementInput').value = template;
        document.getElementById('achievementSuggestions').classList.add('hidden');
      }

      function addQuickAchievement(category) {
        const templates = achievementTemplates[category];
        if (!templates || templates.length === 0) return;

        // Get a random template from the category
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
        document.getElementById('achievementInput').value = randomTemplate;
        document.getElementById('achievementSuggestions').classList.add('hidden');

        // Auto-focus on the input
        document.getElementById('achievementInput').focus();
      }

      function addAchievement() {
        const input = document.getElementById('achievementInput');
        const achievementText = input.value.trim();

        if (!achievementText) {
          alert('Please enter an achievement description');
          return;
        }

        projectAchievements.push(achievementText);
        renderAchievementsList();

        // Clear input and update number
        input.value = '';
        document.getElementById('achievementNumber').textContent = projectAchievements.length + 1;
        document.getElementById('achievementSuggestions').classList.add('hidden');
      }

      function removeAchievement(index) {
        projectAchievements.splice(index, 1);
        renderAchievementsList();
        document.getElementById('achievementNumber').textContent = projectAchievements.length + 1;
      }

      function renderAchievementsList() {
        const listDiv = document.getElementById('achievementsList');

        if (projectAchievements.length === 0) {
          listDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No achievements added yet</p>';
          return;
        }

        listDiv.innerHTML = projectAchievements.map((achievement, index) => `
          <div class="flex items-start gap-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
            <div class="flex-shrink-0 w-6 h-6 bg-purple-600 text-white rounded-full flex items-center justify-center text-xs font-bold">
              ${index + 1}
            </div>
            <p class="flex-1 text-sm text-gray-700 leading-relaxed">${achievement}</p>
            <button onclick="removeAchievement(${index})"
                    class="flex-shrink-0 text-red-600 hover:text-red-800 transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        `).join('');
      }

      // Close suggestions when clicking outside
      document.addEventListener('click', function(event) {
        const input = document.getElementById('achievementInput');
        const suggestions = document.getElementById('achievementSuggestions');

        if (input && suggestions && !input.contains(event.target) && !suggestions.contains(event.target)) {
          suggestions.classList.add('hidden');
        }
      });

      // ========== ACTUAL BUDGET BREAKDOWN WITH RECEIPTS ==========

      let actualBreakdownItems = [];

      function loadActualBreakdownFromPlanned(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project || !project.budgetBreakdown) {
          actualBreakdownItems = [];
          return;
        }

        // Auto-fill from planned budget breakdown
        actualBreakdownItems = project.budgetBreakdown.map(item => ({
          id: item.id,
          description: item.description,
          plannedCost: item.cost,
          actualCost: item.cost, // Pre-fill with planned cost (user can edit)
          receipt: null,
          receiptPreview: null
        }));

        // Load saved actual breakdown if exists
        if (project.actualBreakdown) {
          project.actualBreakdown.forEach(savedItem => {
            const item = actualBreakdownItems.find(i => i.id === savedItem.id);
            if (item) {
              item.actualCost = savedItem.actualCost;
              item.receipt = savedItem.receipt;
              item.receiptPreview = savedItem.receiptPreview;
            }
          });
        }

        renderActualBreakdownTable();
      }

      function renderActualBreakdownTable() {
        const tableBody = document.getElementById('actualBudgetBreakdownTable');
        tableBody.innerHTML = '';

        actualBreakdownItems.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-200 hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-3 py-3">
              <input type="text" value="${item.description}" onchange="updateActualBreakdownDescription(${index}, this.value)"
                     class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 text-sm" />
            </td>
            <td class="px-3 py-3 text-gray-600">₱${item.plannedCost.toLocaleString()}</td>
            <td class="px-3 py-3">
              <input type="number" value="${item.actualCost}" onchange="updateActualBreakdownCost(${index}, this.value)"
                     class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-emerald-500 text-sm" min="0" />
            </td>
            <td class="px-3 py-3">
              <div class="flex items-center gap-2">
                ${item.receiptPreview ? `
                  <img src="${item.receiptPreview}" class="w-10 h-10 object-cover rounded border cursor-pointer" onclick="viewReceiptImage(${index})" title="Click to view" />
                  <button onclick="removeReceipt(${index})" class="text-red-600 hover:text-red-800 text-xs">
                    <i class="fas fa-times"></i>
                  </button>
                ` : `
                  <label class="cursor-pointer text-emerald-600 hover:text-emerald-700 text-xs flex items-center gap-1">
                    <i class="fas fa-upload"></i>
                    <span>Upload</span>
                    <input type="file" accept="image/*" onchange="uploadReceipt(${index}, event)" class="hidden" />
                  </label>
                `}
              </div>
            </td>
            <td class="px-3 py-3 text-center">
              <button onclick="deleteActualBreakdownRow(${index})" class="text-red-600 hover:text-red-800" title="Remove item">
                <i class="fas fa-times text-sm"></i>
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });

        updateActualBreakdownTotals();
      }

      function addActualBreakdownRow() {
        const newItem = {
          id: Date.now(),
          description: '',
          plannedCost: 0,
          actualCost: 0,
          receipt: null,
          receiptPreview: null
        };
        actualBreakdownItems.push(newItem);
        renderActualBreakdownTable();
      }

      function updateActualBreakdownDescription(index, value) {
        actualBreakdownItems[index].description = value;
      }

      function updateActualBreakdownCost(index, value) {
        actualBreakdownItems[index].actualCost = parseFloat(value) || 0;
        updateActualBreakdownTotals();
      }

      function deleteActualBreakdownRow(index) {
        if (confirm('Remove this budget item?')) {
          actualBreakdownItems.splice(index, 1);
          renderActualBreakdownTable();
        }
      }

      function uploadReceipt(index, event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          actualBreakdownItems[index].receipt = file.name;
          actualBreakdownItems[index].receiptPreview = e.target.result;
          renderActualBreakdownTable();
        };
        reader.readAsDataURL(file);
      }

      function removeReceipt(index) {
        actualBreakdownItems[index].receipt = null;
        actualBreakdownItems[index].receiptPreview = null;
        renderActualBreakdownTable();
      }

      function viewReceiptImage(index) {
        const receipt = actualBreakdownItems[index];
        if (!receipt.receiptPreview) return;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
        modal.onclick = () => modal.remove();
        modal.innerHTML = `
          <div class="max-w-4xl max-h-[90vh] relative">
            <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-gray-100">
              <i class="fas fa-times"></i>
            </button>
            <img src="${receipt.receiptPreview}" class="max-w-full max-h-[90vh] rounded shadow-2xl" />
          </div>
        `;
        document.body.appendChild(modal);
      }

      function updateActualBreakdownTotals() {
        const plannedTotal = actualBreakdownItems.reduce((sum, item) => sum + item.plannedCost, 0);
        const actualTotal = actualBreakdownItems.reduce((sum, item) => sum + item.actualCost, 0);

        document.getElementById('plannedBreakdownTotal').textContent = '₱' + plannedTotal.toLocaleString();
        document.getElementById('actualBreakdownTotal').textContent = '₱' + actualTotal.toLocaleString();

        // Auto-update the main Actual Spent field
        document.getElementById('budgetActual').value = actualTotal;
        calculateSuccessRate();
      }

      function updateActualTotalFromBreakdown() {
        // This is called when manual edit is attempted - ignore it since we auto-calculate
        return;
      }

      // ========== SUCCESS RATE CALCULATION ==========

      function calculateSuccessRate() {
        const budgetPlanned = parseFloat(document.getElementById('budgetPlanned').value) || 0;
        const budgetActual = parseFloat(document.getElementById('budgetActual').value) || 0;
        const volunteersTarget = parseFloat(document.getElementById('volunteersTarget').value) || 0;
        const volunteersActual = parseFloat(document.getElementById('volunteersActual').value) || 0;
        const timelineStatus = document.getElementById('timelineStatus').value;
        const beneficiariesTarget = parseFloat(document.getElementById('beneficiariesTarget').value) || 0;
        const beneficiariesActual = parseFloat(document.getElementById('beneficiariesActual').value) || 0;

        // Calculate Budget Efficiency (25%) - closer to planned is better
        let budgetScore = 0;
        if (budgetPlanned > 0) {
          const budgetEfficiency = Math.min((budgetPlanned / budgetActual) * 100, 100);
          budgetScore = budgetEfficiency;
        }

        // Calculate Volunteer Participation (20%)
        let participationScore = 0;
        if (volunteersTarget > 0) {
          participationScore = Math.min((volunteersActual / volunteersTarget) * 100, 100);
        }

        // Calculate Timeline Adherence (20%)
        const timelineScores = {
          'on-time': 100,
          'slightly-delayed': 70,
          'delayed': 40,
          'significantly-delayed': 10
        };
        const timelineScore = timelineScores[timelineStatus] || 0;

        // Calculate Community Impact (20%) - Based on beneficiaries reached
        let impactScore = 0;
        if (beneficiariesTarget > 0) {
          impactScore = Math.min((beneficiariesActual / beneficiariesTarget) * 100, 100);
        }

        // Calculate Volunteer Feedback (15%) - Auto-calculated from volunteer surveys
        const feedbackText = document.getElementById('autoFeedbackScore').textContent;
        const feedbackRating = feedbackText !== '-' ? parseFloat(feedbackText.split('/')[0]) : 0;
        const feedbackScore = (feedbackRating / 4) * 100;

        // Weighted calculation
        const successRate = Math.round(
          (budgetScore * 0.25) +
          (participationScore * 0.20) +
          (timelineScore * 0.20) +
          (impactScore * 0.20) +
          (feedbackScore * 0.15)
        );

        // Update display
        document.getElementById('successRateValue').textContent = successRate + '%';
        document.getElementById('successRateBar').style.width = successRate + '%';

        // Update breakdown
        document.getElementById('budgetScoreValue').textContent = Math.round(budgetScore * 0.25);
        document.getElementById('participationScoreValue').textContent = Math.round(participationScore * 0.20);
        document.getElementById('timelineScoreValue').textContent = Math.round(timelineScore * 0.20);
        document.getElementById('impactScoreValue').textContent = Math.round(impactScore * 0.20);
        document.getElementById('feedbackScoreValue').textContent = Math.round(feedbackScore * 0.15);

        return successRate;
      }

      function submitEvaluation() {
        const budgetPlanned = parseFloat(document.getElementById('budgetPlanned').value);
        const budgetActual = parseFloat(document.getElementById('budgetActual').value);
        const volunteersTarget = parseFloat(document.getElementById('volunteersTarget').value);
        const volunteersActual = parseFloat(document.getElementById('volunteersActual').value);
        const timelineStatus = document.getElementById('timelineStatus').value;
        const beneficiariesTarget = parseFloat(document.getElementById('beneficiariesTarget').value);
        const beneficiariesActual = parseFloat(document.getElementById('beneficiariesActual').value);

        if (!budgetPlanned || !budgetActual || !volunteersTarget || !volunteersActual || !timelineStatus || !beneficiariesTarget || !beneficiariesActual) {
          alert('Please fill in all required fields');
          return;
        }

        const feedbackText = document.getElementById('autoFeedbackScore').textContent;
        const feedbackRating = feedbackText !== '-' ? parseFloat(feedbackText.split('/')[0]) : 0;

        const successRate = calculateSuccessRate();

        // Update project
        const project = projects.find(p => p.id === currentProjectId);
        if (project) {
          project.status = 'Completed';
          project.successRate = successRate;
          project.evaluation = {
            budgetPlanned,
            budgetActual,
            volunteersTarget,
            volunteersActual,
            timelineStatus,
            beneficiariesTarget,
            beneficiariesActual,
            feedbackRating,
            completedDate: new Date().toISOString()
          };
          project.achievements = [...projectAchievements];

          // Save actual budget breakdown with receipts
          project.actualBreakdown = actualBreakdownItems.map(item => ({
            id: item.id,
            description: item.description,
            plannedCost: item.plannedCost,
            actualCost: item.actualCost,
            receipt: item.receipt,
            receiptPreview: item.receiptPreview
          }));

          renderProjects(projects);
          showToast(`Project marked as complete with ${successRate}% success rate!`);
          closeEvaluationModal();
        }
      }

      // ========== ARCHIVE PROJECT FUNCTIONS ==========

      function archiveProject(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        const archivableStatuses = ['Completed', 'Rejected', 'Pending for Revision'];
        if (!archivableStatuses.includes(project.status)) {
          alert('Only completed, rejected, or projects pending revision can be archived.');
          return;
        }

        const confirmArchive = confirm(
          `Are you sure you want to archive "${project.title}"?\n\n` +
          `Status: ${project.status}\n` +
          `This will move the project to the Archive section.`
        );

        if (confirmArchive) {
          // Remove from active projects
          projects = projects.filter(p => p.id !== projectId);

          // In a real app, this would be sent to the archive database
          // For now, we just remove it from the active list

          showToast('Project archived successfully');
          renderProjects(projects);
        }
      }

      // Auto-archive completed projects after 3 months
      function checkAutoArchive() {
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

        projects.forEach(project => {
          if (project.status === 'Completed' && project.evaluation && project.evaluation.completedDate) {
            const completedDate = new Date(project.evaluation.completedDate);

            // If completed more than 3 months ago, auto-archive
            if (completedDate < threeMonthsAgo) {
              console.log(`Auto-archiving project: ${project.title}`);
              projects = projects.filter(p => p.id !== project.id);
              showToast(`"${project.title}" was automatically archived (completed >3 months ago)`);
            }
          }
        });

        renderProjects(projects);
      }

      // Run auto-archive check on page load and every hour
      checkAutoArchive();
      setInterval(checkAutoArchive, 3600000); // Check every hour

      // ========== DOWNLOAD REPORT MODAL FUNCTIONS ==========

      function openDownloadReportModal(projectId) {
        currentProjectId = projectId;
        const project = projects.find(p => p.id === projectId);
        if (!project) return;

        document.getElementById('downloadProjectTitle').textContent = project.title;
        document.getElementById('downloadReportModal').classList.remove('hidden');
      }

      function closeDownloadReportModal() {
        document.getElementById('downloadReportModal').classList.add('hidden');
        currentProjectId = null;
      }

      function downloadReport(format) {
        const project = projects.find(p => p.id === currentProjectId);
        if (!project) return;

        if (format === 'pdf') {
          showToast('Generating PDF report...');
          const reportWindow = window.open('', '_blank');
          const volunteers = project.applications.filter(a => a.status === 'approved');

          // Simple PDF - user clicks ctrl+P to print/save as PDF
          reportWindow.document.write('<html><head><title>' + project.title + ' Report</title></head>');
          reportWindow.document.write('<body style="font-family: Arial; padding: 20px;">');
          reportWindow.document.write('<h1>' + project.title + '</h1>');
          reportWindow.document.write('<p><strong>Success Rate:</strong> ' + (project.successRate || 'N/A') + '%</p>');
          reportWindow.document.write('<p><strong>Category:</strong> ' + project.category + '</p>');
          reportWindow.document.write('<p><strong>Status:</strong> ' + project.status + '</p>');
          if (project.evaluation) {
            reportWindow.document.write('<h2>Evaluation Metrics</h2>');
            reportWindow.document.write('<p><strong>Budget:</strong> ₱' + project.evaluation.budgetActual.toLocaleString() + ' / ₱' + project.evaluation.budgetPlanned.toLocaleString() + '</p>');
            reportWindow.document.write('<p><strong>Volunteers:</strong> ' + project.evaluation.volunteersActual + ' / ' + project.evaluation.volunteersTarget + '</p>');
            reportWindow.document.write('<p><strong>Beneficiaries:</strong> ' + project.evaluation.beneficiariesActual + ' / ' + project.evaluation.beneficiariesTarget + '</p>');
          }
          reportWindow.document.write('<h2>Volunteers (' + volunteers.length + ')</h2>');
          reportWindow.document.write('<table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Name</th><th>Age</th><th>Contact</th></tr>');
          volunteers.forEach(v => {
            reportWindow.document.write('<tr><td>' + (v.fullName || v.firstName + ' ' + v.lastName) + '</td><td>' + v.age + '</td><td>' + (v.contact || 'N/A') + '</td></tr>');
          });
          reportWindow.document.write('</table>');
          reportWindow.document.write('<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); };</' + 'script>');
          reportWindow.document.write('</body></html>');
          reportWindow.document.close();

          showToast('PDF report opened. Use Print to save as PDF.');
          closeDownloadReportModal();
        } else if (format === 'excel') {
          showToast('Generating Excel report...');
          setTimeout(() => {
            console.log('Excel Report Data:', {
              project: project.title,
              successRate: project.successRate,
              evaluation: project.evaluation,
              volunteers: project.applications.filter(a => a.status === 'approved')
            });
            showToast('Excel report downloaded successfully!');
            closeDownloadReportModal();
          }, 1000);
        }
      }

      // ========== ATTENDANCE PDF UPLOAD ==========

      let uploadedAttendancePDF = null;

      function uploadAttendancePDF(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.type !== 'application/pdf') {
          alert('Please upload a PDF file');
          return;
        }

        uploadedAttendancePDF = file;
        document.getElementById('attendancePdfName').textContent = file.name;
        document.getElementById('attendancePdfName').classList.remove('italic', 'text-gray-600');
        document.getElementById('attendancePdfName').classList.add('text-emerald-600', 'font-medium');
      }

      // Initialize notification count on page load
      updateNotificationCount();
      handleURLParameters();
    </script>
  </body>
</html>
