<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BIMS - SK Manage Calendar</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- BIMS Configuration -->
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#2f6e4e",
              secondary: "#3d8b64",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', sans-serif;
        background: #fafafa;
      }

      /* Calendar Container */
      .calendar-container {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      /* Calendar Header */
      .calendar-header {
        background: linear-gradient(135deg, #2f6e4e 0%, #3d8b64 100%);
        padding: 1.5rem;
        color: white;
      }

      .calendar-title {
        font-family: 'Inter', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 0.5rem;
      }

      /* View Toggle */
      .view-toggle {
        display: inline-flex;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 4px;
        backdrop-filter: blur(10px);
      }

      .view-toggle button {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
        font-size: 0.875rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .view-toggle button.active {
        background: white;
        color: #2f6e4e;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .view-toggle button:hover:not(.active) {
        background: rgba(255, 255, 255, 0.15);
        color: white;
      }

      /* Navigation */
      .nav-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1.5px solid rgba(255, 255, 255, 0.3);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .nav-btn-today {
        width: auto;
        padding: 0 1rem;
      }

      /* Calendar Grid */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-auto-rows: 90px;
        background: white;
      }

      /* Day Headers */
      .day-header {
        text-align: center;
        padding: 0.75rem 0.5rem;
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        background: linear-gradient(180deg, #fafafa 0%, #f3f4f6 100%);
        border-bottom: 2px solid #e5e7eb;
      }

      /* Calendar Cells */
      .calendar-cell {
        height: 90px;
        border: 1px solid #f0f0f0;
        padding: 0.625rem;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .calendar-cell:hover {
        background: #fafafa;
        box-shadow: inset 0 0 0 1px #2f6e4e20;
      }

      .calendar-cell.other-month {
        background: #fafafa;
        color: #9ca3af;
      }

      .calendar-cell.today {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-color: #2f6e4e;
      }

      .cell-date {
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .calendar-cell.today .cell-date {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: #2f6e4e;
        color: white;
        border-radius: 50%;
        font-weight: 700;
      }

      .calendar-cell.other-month .cell-date {
        color: #9ca3af;
      }

      /* Event Pills */
      .event-pill {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.25rem;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .event-pill:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .event-pill.project {
        background: linear-gradient(135deg, #2f6e4e 0%, #3d8b64 100%);
        color: white;
      }

      .event-pill.announcement {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
      }

      /* Week View */
      .week-view-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 0 0 12px 12px;
        position: relative;
      }

      /* Mobile scroll hint */
      @media (max-width: 640px) {
        .week-view-container::after {
          content: '';
          position: sticky;
          right: 0;
          top: 0;
          width: 40px;
          height: 100%;
          background: linear-gradient(to left, rgba(255, 255, 255, 0.9), transparent);
          pointer-events: none;
          float: right;
        }
      }

      .week-view-container::-webkit-scrollbar {
        height: 8px;
      }

      .week-view-container::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 4px;
      }

      .week-view-container::-webkit-scrollbar-thumb {
        background: #2f6e4e;
        border-radius: 4px;
      }

      .week-view-container::-webkit-scrollbar-thumb:hover {
        background: #3d8b64;
      }

      .week-view {
        display: grid;
        grid-template-columns: 80px repeat(7, minmax(100px, 1fr));
        gap: 1px;
        background: #e5e7eb;
        min-width: min-content;
      }

      .time-slot {
        background: white;
        padding: 0.75rem;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
        white-space: nowrap;
      }

      .week-cell {
        background: white;
        padding: 0.5rem;
        min-height: 60px;
        position: relative;
      }

      @media (max-width: 768px) {
        .week-view {
          grid-template-columns: 60px repeat(7, minmax(80px, 120px));
        }

        .time-slot {
          font-size: 0.625rem;
          padding: 0.5rem 0.375rem;
        }

        .week-cell {
          min-height: 50px;
          padding: 0.25rem;
        }
      }

      @media (max-width: 640px) {
        .week-view {
          grid-template-columns: 50px repeat(7, 90px);
        }

        .time-slot {
          font-size: 0.5625rem;
          padding: 0.375rem 0.25rem;
        }

        .week-cell {
          min-height: 45px;
        }

        .week-view-container::-webkit-scrollbar {
          height: 6px;
        }
      }

      /* Day View */
      .day-view-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
      }

      .day-view-header {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        padding: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
      }

      .day-view-date {
        font-family: 'Inter', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
      }

      .day-view-events {
        padding: 1.5rem;
      }

      /* Event Card */
      .event-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-left: 4px solid #2f6e4e;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        animation: slideUp 0.4s ease-out backwards;
      }

      .event-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(47, 110, 78, 0.12);
      }

      .event-card.announcement {
        border-left-color: #f59e0b;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .event-card:nth-child(1) { animation-delay: 0.05s; }
      .event-card:nth-child(2) { animation-delay: 0.1s; }
      .event-card:nth-child(3) { animation-delay: 0.15s; }
      .event-card:nth-child(4) { animation-delay: 0.2s; }

      .event-time {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .event-title {
        font-weight: 700;
        font-size: 1rem;
        color: #1f2937;
        margin-bottom: 0.25rem;
      }

      .event-description {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
      }

      .event-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
        color: #9ca3af;
      }

      /* Events Sidebar */
      .events-sidebar {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .events-sidebar-section {
        margin-bottom: 2rem;
      }

      .events-sidebar-title {
        font-family: 'Inter', sans-serif;
        font-size: 1.125rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .upcoming-event {
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left-width: 3px;
        border-left-style: solid;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upcoming-event.border-\[#2f6e4e\] {
        border-left-color: #2f6e4e;
      }

      .upcoming-event.border-amber-500 {
        border-left-color: #f59e0b;
      }

      .upcoming-event:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(47, 110, 78, 0.1);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .events-sidebar {
          margin-top: 1.5rem;
        }
      }

      @media (max-width: 768px) {
        .calendar-header {
          padding: 1.25rem;
        }

        .calendar-header > div {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .calendar-header > div > div:first-child {
          width: 100%;
          justify-content: center;
        }

        .calendar-title {
          font-size: 1.25rem;
          text-align: center;
          flex: 1;
        }

        .view-toggle {
          width: 100%;
          justify-content: center;
        }

        .view-toggle button {
          flex: 1;
          padding: 0.625rem 0.5rem;
          font-size: 0.8125rem;
        }

        .nav-btn {
          width: 36px;
          height: 36px;
        }

        .calendar-cell {
          height: 80px;
          padding: 0.5rem;
        }

        .cell-date {
          font-size: 0.75rem;
        }

        .event-pill {
          font-size: 0.625rem;
          padding: 0.125rem 0.375rem;
        }

        .day-header {
          padding: 0.875rem 0.5rem;
          font-size: 0.6875rem;
        }
      }

      /* Large phones (430px - 640px) */
      @media (min-width: 430px) and (max-width: 640px) {
        .calendar-header > div > div:first-child {
          gap: 0.625rem;
        }

        .calendar-title {
          font-size: 1.125rem;
        }

        .nav-btn {
          width: 34px;
          height: 34px;
        }

        .view-toggle button {
          padding: 0.5625rem 0.5rem;
          font-size: 0.8125rem;
        }

        .calendar-cell {
          height: 70px;
        }

        .day-header {
          padding: 0.8125rem 0.375rem;
          font-size: 0.6875rem;
        }
      }

      @media (max-width: 640px) {
        .calendar-header {
          padding: 1rem;
        }

        .calendar-header > div {
          flex-direction: column;
          gap: 0.875rem;
          align-items: stretch;
        }

        .calendar-header > div > div:first-child {
          width: 100%;
          justify-content: center;
          gap: 0.5rem;
        }

        .calendar-title {
          font-size: 1rem;
          margin: 0;
          min-width: 0;
          flex: 1;
          text-align: center;
        }

        .nav-btn {
          width: 32px;
          height: 32px;
          border-radius: 8px;
          flex-shrink: 0;
        }

        .nav-btn svg {
          width: 1rem;
          height: 1rem;
        }

        .nav-btn-today {
          display: none;
        }

        .view-toggle {
          width: 100%;
        }

        .view-toggle button {
          padding: 0.5rem 0.375rem;
          font-size: 0.75rem;
          flex: 1;
        }

        .calendar-cell {
          height: 60px;
          padding: 0.375rem;
        }

        .cell-date {
          font-size: 0.6875rem;
        }

        .day-header {
          padding: 0.75rem 0.25rem;
          font-size: 0.625rem;
          letter-spacing: 0.05em;
        }

        .event-pill {
          display: none;
        }

        .calendar-cell::after {
          content: '';
          position: absolute;
          bottom: 4px;
          left: 50%;
          transform: translateX(-50%);
          width: 6px;
          height: 6px;
          background: #2f6e4e;
          border-radius: 50%;
        }

        .calendar-cell.no-events::after {
          display: none;
        }

        .events-sidebar-title {
          font-size: 1rem;
        }

        .upcoming-event {
          padding: 0.875rem;
        }
      }

      /* Extra small phones */
      @media (max-width: 375px) {
        .calendar-header {
          padding: 0.875rem 0.75rem;
        }

        .calendar-header > div {
          gap: 0.75rem;
        }

        .calendar-header > div > div:first-child {
          gap: 0.375rem;
        }

        .calendar-title {
          font-size: 0.875rem;
        }

        .nav-btn {
          width: 28px;
          height: 28px;
        }

        .nav-btn svg {
          width: 0.875rem;
          height: 0.875rem;
        }

        .view-toggle {
          padding: 3px;
        }

        .view-toggle button {
          padding: 0.4375rem 0.25rem;
          font-size: 0.6875rem;
          border-radius: 6px;
        }

        .day-header {
          padding: 0.625rem 0.125rem;
          font-size: 0.5625rem;
        }

        .calendar-cell {
          height: 50px;
          padding: 0.25rem;
        }

        .cell-date {
          font-size: 0.625rem;
        }

        .calendar-cell.today .cell-date {
          width: 24px;
          height: 24px;
          font-size: 0.625rem;
        }
      }

      /* Landscape orientation */
      @media (max-width: 932px) and (orientation: landscape) {
        .calendar-header {
          padding: 0.875rem 1rem;
        }

        .calendar-header > div {
          flex-direction: row;
        }

        .view-toggle {
          width: auto;
        }

        .calendar-cell {
          height: 70px;
        }
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95);
        transition: transform 0.3s ease;
      }

      .modal.active .modal-content {
        transform: scale(1);
      }

      /* Icons */
      .icon-wrapper {
        transition: all 0.3s ease;
      }

      .icon-wrapper:hover {
        transform: translateY(-2px);
      }

      .nav-link svg {
        transition: all 0.3s ease;
      }

      .nav-link:hover svg {
        transform: scale(1.1);
      }

      .icon-badge {
        box-shadow: 0 2px 8px rgba(47, 110, 78, 0.15);
      }

      .notification-icon {
        position: relative;
      }

      .notification-icon:hover {
        transform: rotate(15deg) scale(1.1);
        transition: transform 0.3s ease;
      }

      /* Loading Animation */
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Toast Notification Animation */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slideIn {
        animation: slideIn 0.3s ease-out forwards;
      }

      /* Add to Calendar Buttons */
      .add-to-calendar-btn {
        transition: all 0.2s ease;
      }

      .add-to-calendar-btn:active {
        transform: scale(0.95);
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
      <!-- SIDEBAR -->
      <aside class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col">
        <div class="p-6 flex-1 flex flex-col">
          <!-- Logo -->
          <div class="flex items-center space-x-4 mb-8">
            <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg icon-badge overflow-hidden">
              <img src="asset/logo.svg" alt="BIMS Logo" class="w-full h-full object-contain p-1">
            </div>
            <div>
              <h1 class="text-xl font-black text-gray-800">BIMS</h1>
              <p class="text-sm text-gray-600 font-medium">SK Malanday</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a href="sk-dashboard.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group">
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-green-50 transition">
                <svg class="w-5 h-5 group-hover:text-green-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"></path>
                </svg>
              </div>
              <span>Dashboard</span>
            </a>
            <a href="sk-files.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group">
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-blue-50 transition">
                <svg class="w-5 h-5 group-hover:text-blue-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              <span>Manage Files</span>
            </a>
            <a href="sk-projects.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group">
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-purple-50 transition">
                <svg class="w-5 h-5 group-hover:text-purple-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
              </div>
              <span>Project Monitoring</span>
            </a>
            <a href="sk-calendar.html" class="nav-link flex items-center space-x-3 px-4 py-3 bg-[#2f6e4e]/10 text-[#2f6e4e] rounded-lg font-medium group">
              <div class="w-9 h-9 bg-[#2f6e4e]/20 rounded-lg flex items-center justify-center group-hover:bg-[#2f6e4e]/30 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>
              <span>Calendar</span>
            </a>
            <a href="sk-testimonies.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group">
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-50 transition">
                <svg class="w-5 h-5 group-hover:text-indigo-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <span>Testimonies</span>
            </a>
            <a href="sk-archive.html" class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group">
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition">
                <svg class="w-5 h-5 group-hover:text-gray-700 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                </svg>
              </div>
              <span>Archives</span>
            </a>
          </nav>

          <div class="flex-1"></div>

          <!-- Logout -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <button onclick="handleLogout()" class="nav-link flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition w-full group">
              <div class="w-9 h-9 bg-red-50 rounded-lg flex items-center justify-center group-hover:bg-red-100 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
              </div>
              <span class="font-medium">Logout</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <div class="flex-1 overflow-auto">
        <!-- Top Bar -->
        <header class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-[#2f6e4e] font-semibold mb-1" id="currentDate">Sunday, January 04, 2026</p>
                <h1 class="text-2xl font-bold text-gray-800">Projects & Announcements</h1>
                <p class="text-sm text-gray-600 mt-1">Manage SK Malanday projects and announcements calendar</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="toggleNotificationModal()" class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse">5</span>
                  </button>
                </div>
                <button onclick="openProfileModal()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700" id="headerUserName">Loading...</p>
                    <p class="text-xs text-gray-500" id="headerUserRole">SK Official</p>
                  </div>
                  <div id="headerUserAvatar" class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20">
                    <span class="text-white font-semibold">--</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Calendar Content -->
        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Calendar -->
            <div class="lg:col-span-3">
              <div class="calendar-container">
                <!-- Calendar Header with Controls -->
                <div class="calendar-header">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <button onclick="previousMonth()" class="nav-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                        </svg>
                      </button>
                      <h2 class="calendar-title" id="monthYear">January 2026</h2>
                      <button onclick="nextMonth()" class="nav-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </button>
                      <button onclick="goToToday()" class="nav-btn nav-btn-today">
                        <span class="text-sm font-semibold">Today</span>
                      </button>
                    </div>
                    <div class="view-toggle">
                      <button onclick="setView('month')" class="active" id="monthViewBtn">Month</button>
                      <button onclick="setView('week')" id="weekViewBtn">Week</button>
                      <button onclick="setView('day')" id="dayViewBtn">Day</button>
                    </div>
                  </div>
                </div>

                <!-- Calendar Body -->
                <div id="calendarBody">
                  <!-- Month View (Default) -->
                  <div id="monthView">
                    <div class="calendar-grid">
                      <div class="day-header">SUN</div>
                      <div class="day-header">MON</div>
                      <div class="day-header">TUE</div>
                      <div class="day-header">WED</div>
                      <div class="day-header">THU</div>
                      <div class="day-header">FRI</div>
                      <div class="day-header">SAT</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays">
                      <!-- Days will be generated by JavaScript -->
                    </div>
                  </div>

                  <!-- Week View -->
                  <div id="weekView" style="display: none;">
                    <div class="week-view-container">
                      <div class="week-view" id="weekGrid">
                        <!-- Week grid will be generated by JavaScript -->
                      </div>
                    </div>
                  </div>

                  <!-- Day View -->
                  <div id="dayView" style="display: none;">
                    <div class="day-view-container">
                      <div class="day-view-header">
                        <div class="day-view-date" id="dayViewDate">Sunday, January 4, 2026</div>
                      </div>
                      <div class="day-view-events" id="dayViewEvents">
                        <!-- Events will be generated by JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
              <div class="events-sidebar">
                <!-- Upcoming Projects -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-[#2f6e4e]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Projects
                  </div>
                  <div id="upcomingProjects">
                    <!-- Upcoming projects will be generated by JavaScript -->
                  </div>
                </div>

                <!-- Recent Announcements -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                    </svg>
                    Recent Announcements
                  </div>
                  <div id="recentAnnouncements">
                    <!-- Recent announcements will be generated by JavaScript -->
                  </div>
                </div>

                <!-- Quick Actions -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-[#2f6e4e]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Quick Actions
                  </div>
                  <button onclick="exportCalendar()" class="w-full px-4 py-3 bg-gradient-to-r from-[#2f6e4e] to-[#3d8b64] text-white rounded-xl hover:shadow-lg transition-all duration-300 font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Export Calendar</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Modal - Injected by NotificationModal.js component -->
    <div id="notificationModalContainer"></div>

    <!-- ProfileModal component will be dynamically rendered here -->
    <div id="profileModalContainer"></div>

    <!-- Project/Announcement Detail Modal -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-gray-800" id="modalEventTitle">Project Title</h3>
          <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="modalEventContent">
          <!-- Project/Announcement details will be inserted here -->
        </div>
      </div>
    </div>

    <script type="module">
      // Import components
      import { NotificationModal } from "./js/components/NotificationModal.js";
      import { ProfileModal } from "./js/components/ProfileModal.js";

      console.log("[SK CALENDAR] Script loaded - starting execution");
      console.log("[SK CALENDAR] SessionManager available:", typeof SessionManager !== "undefined");

      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;
      console.log("[SK CALENDAR] NotificationModal component initialized");

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;
      console.log("[SK CALENDAR] ProfileModal component initialized");

      // Global variables
      let currentUser = null;
      let currentUserData = null;
      let events = []; // Will be loaded from database

      // Calendar State
      let currentDate = new Date();
      let currentView = 'month';
      let selectedDate = null;

      // ============================================
      // SECURITY: XSS Prevention Helpers
      // ============================================
      /**
       * Escape HTML to prevent XSS attacks
       * @param {string} unsafe - Unsafe string from user input or database
       * @returns {string} - Safe HTML string
       */
      function escapeHTML(unsafe) {
        if (typeof unsafe !== "string") return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      /**
       * SECURITY: Validate and sanitize image URLs
       * Only allows https URLs and Supabase storage URLs
       * @param {string} url - URL to validate
       * @returns {string} - Safe URL or empty string
       */
      function sanitizeImageURL(url) {
        if (!url || typeof url !== "string") return "";
        const trimmedUrl = url.trim();
        if (!trimmedUrl) return "";

        // Only allow https:// URLs (block javascript:, data:, etc.)
        if (!trimmedUrl.startsWith("https://")) {
          console.warn("⚠️ Blocked non-HTTPS image URL:", trimmedUrl.substring(0, 50));
          return "";
        }

        // Validate URL format
        try {
          const parsedUrl = new URL(trimmedUrl);
          const allowedDomains = ["supabase.co", "supabase.com"];
          const isAllowedDomain = allowedDomains.some(domain =>
            parsedUrl.hostname.endsWith(domain)
          );
          if (!isAllowedDomain) {
            console.warn("⚠️ Image URL from untrusted domain:", parsedUrl.hostname);
          }
          return trimmedUrl;
        } catch (e) {
          console.warn("⚠️ Invalid image URL format:", trimmedUrl.substring(0, 50));
          return "";
        }
      }

      // ============================================
      // Authentication & Initialization
      // ============================================
      /**
       * Initialize session and authentication
       * Load all calendar data from database
       */
      async function initializeCalendar() {
        console.log("[SK CALENDAR] initializeCalendar() function called");
        try {
          // Require authentication - only SK_OFFICIAL allowed
          console.log("[SK CALENDAR] Checking authentication...");
          const sessionResult = await SessionManager.requireAuth(["SK_OFFICIAL"]);

          console.log("[SK CALENDAR] Session result:", sessionResult);

          if (!sessionResult.success) {
            console.error("[SK CALENDAR ERROR] Authentication failed:", sessionResult.error);
            return; // Session manager handles redirect
          }

          console.log("[SK CALENDAR] Authentication successful!");
          console.log("[SK CALENDAR] User role:", sessionResult.role);

          currentUser = sessionResult.user;
          currentUserData = sessionResult.userData;

          // Update user profile in header
          updateUserProfile();

          // Load user profile data into ProfileModal component
          await profileModal.loadUserData(currentUser, currentUserData);

          // Load calendar events from database
          await loadEventsFromDatabase();

          // Render calendar and sidebar sections
          updateCurrentDate();
          renderCalendar();
          renderUpcomingProjects();
          renderRecentAnnouncements();

          // Refresh sidebar every minute
          setInterval(() => {
            renderUpcomingProjects();
          }, 60000);

          console.log("[SK CALENDAR] Initialized successfully!");
        } catch (error) {
          console.error("[SK CALENDAR ERROR] Initialization error:", error);
          SessionManager.redirectToLogin("Failed to initialize calendar");
        }
      }

      /**
       * Update user profile in header
       */
      function updateUserProfile() {
        if (!currentUserData) return;

        const nameElement = document.getElementById("headerUserName");
        const roleElement = document.getElementById("headerUserRole");
        const avatarElement = document.getElementById("headerUserAvatar");

        if (nameElement) {
          const fullName = `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim();
          nameElement.textContent = fullName || 'SK Official';
        }

        if (roleElement) {
          roleElement.textContent = "SK Official";
        }

        if (avatarElement) {
          const safeProfileUrl = sanitizeImageURL(currentUserData.imagePathURL);
          const initials = `${currentUserData.firstName?.charAt(0) || ''}${currentUserData.lastName?.charAt(0) || ''}`.toUpperCase();

          if (safeProfileUrl) {
            avatarElement.innerHTML = `<img src="${safeProfileUrl}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='<span class=\\'text-white font-semibold\\'>${escapeHTML(initials)}</span>';" />`;
          } else {
            avatarElement.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Listen for profile updates from ProfileModal
      document.addEventListener("profileUpdated", async (e) => {
        console.log("[SK CALENDAR] Profile updated event received:", e.detail);
        if (e.detail && e.detail.userData) {
          currentUserData = e.detail.userData;
          updateUserProfile();
        }
      });

      /**
       * Load events from database (projects and announcements)
       */
      async function loadEventsFromDatabase() {
        console.log("[SK CALENDAR] Loading events from database...");
        try {
          // Load APPROVED projects from Pre_Project_Tbl
          const { data: projects, error: projectsError } = await supabaseClient
            .from("Pre_Project_Tbl")
            .select(`
              preProjectID,
              title,
              description,
              startDateTime,
              endDateTime,
              volunteers,
              location,
              skID,
              SK_Tbl (
                User_Tbl (
                  firstName,
                  lastName
                )
              )
            `)
            .eq("approvalStatus", "APPROVED")
            .order("startDateTime", { ascending: true });

          if (projectsError) {
            console.error("[SK CALENDAR] Error loading projects:", projectsError);
          }

          // Load announcements from Announcement_Tbl
          const { data: announcements, error: announcementsError } = await supabaseClient
            .from("Announcement_Tbl")
            .select(`
              announcementID,
              title,
              description,
              publishedDate,
              category,
              User_Tbl (
                firstName,
                lastName
              )
            `)
            .order("publishedDate", { ascending: true });

          if (announcementsError) {
            console.error("[SK CALENDAR] Error loading announcements:", announcementsError);
          }

          // Transform projects to calendar events
          const projectEvents = (projects || []).map(project => {
            const headName = project.SK_Tbl?.User_Tbl
              ? `${project.SK_Tbl.User_Tbl.firstName} ${project.SK_Tbl.User_Tbl.lastName}`
              : "SK Official";

            return {
              id: `project-${project.preProjectID}`,
              dbId: project.preProjectID,
              title: project.title,
              type: "project",
              start: project.startDateTime,
              end: project.endDateTime,
              description: project.description,
              head: headName,
              volunteers: project.volunteers,
              location: project.location
            };
          });

          // Transform announcements to calendar events
          const announcementEvents = (announcements || []).map(announcement => {
            const authorName = announcement.User_Tbl
              ? `${announcement.User_Tbl.firstName} ${announcement.User_Tbl.lastName}`
              : "SK Official";

            return {
              id: `announcement-${announcement.announcementID}`,
              dbId: announcement.announcementID,
              title: announcement.title,
              type: "announcement",
              start: announcement.publishedDate,
              end: announcement.publishedDate,
              description: announcement.description,
              head: authorName
            };
          });

          // Combine all events
          events = [...projectEvents, ...announcementEvents];
          console.log("[SK CALENDAR] Loaded", events.length, "events from database");

        } catch (error) {
          console.error("[SK CALENDAR] Error loading events:", error);
          events = [];
        }
      }

      // Initialize on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        initializeCalendar();
      });

      // Update current date display
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
      }

      // Render Calendar
      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Update month/year display
        const monthNames = ["January", "February", "March", "April", "May", "June",
                           "July", "August", "September", "October", "November", "December"];
        document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

        // Clear calendar
        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const today = new Date();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const cell = createDayCell(day, true, year, month - 1);
          calendarDays.appendChild(cell);
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
          const isToday = isCurrentMonth && day === today.getDate();
          const cell = createDayCell(day, false, year, month, isToday);
          calendarDays.appendChild(cell);
        }

        // Next month days
        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells; // 6 rows * 7 days
        for (let day = 1; day <= remainingCells; day++) {
          const cell = createDayCell(day, true, year, month + 1);
          calendarDays.appendChild(cell);
        }
      }

      // Create day cell
      function createDayCell(day, isOtherMonth, year, month, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        if (isOtherMonth) cell.classList.add('other-month');
        if (isToday) cell.classList.add('today');

        const cellDate = new Date(year, month, day);
        const dayEvents = getEventsForDate(cellDate);

        if (dayEvents.length === 0) {
          cell.classList.add('no-events');
        }

        // SECURITY: Use escapeHTML to prevent XSS attacks
        cell.innerHTML = `
          <div class="cell-date">${day}</div>
          ${dayEvents.slice(0, 3).map(event => `
            <div class="event-pill ${event.type}" onclick="openEventModal('${event.id}', event)">
              ${escapeHTML(event.title)}
            </div>
          `).join('')}
          ${dayEvents.length > 3 ? `<div class="text-xs text-gray-500 mt-1">+${dayEvents.length - 3} more</div>` : ''}
        `;

        cell.onclick = () => {
          if (!isOtherMonth) {
            selectedDate = cellDate;
            setView('day');
          }
        };

        return cell;
      }

      // Get events for specific date
      function getEventsForDate(date) {
        return events.filter(event => {
          const eventDate = new Date(event.start);
          return eventDate.getFullYear() === date.getFullYear() &&
                 eventDate.getMonth() === date.getMonth() &&
                 eventDate.getDate() === date.getDate();
        });
      }

      // Navigation
      function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      }

      function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      }

      function goToToday() {
        currentDate = new Date();
        renderCalendar();
      }

      // View switching
      function setView(view) {
        currentView = view;

        // Update buttons
        document.getElementById('monthViewBtn').classList.remove('active');
        document.getElementById('weekViewBtn').classList.remove('active');
        document.getElementById('dayViewBtn').classList.remove('active');
        document.getElementById(view + 'ViewBtn').classList.add('active');

        // Hide all views
        document.getElementById('monthView').style.display = 'none';
        document.getElementById('weekView').style.display = 'none';
        document.getElementById('dayView').style.display = 'none';

        // Show selected view
        if (view === 'month') {
          document.getElementById('monthView').style.display = 'block';
        } else if (view === 'week') {
          document.getElementById('weekView').style.display = 'block';
          renderWeekView();
        } else if (view === 'day') {
          document.getElementById('dayView').style.display = 'block';
          renderDayView();
        }
      }

      // Render Week View
      function renderWeekView() {
        const weekGrid = document.getElementById('weekGrid');
        weekGrid.innerHTML = '<div class="time-slot"></div>';

        // Get week dates
        const weekStart = new Date(currentDate);
        weekStart.setDate(currentDate.getDate() - currentDate.getDay());

        // Detect mobile
        const isMobile = window.innerWidth <= 640;

        // Add day headers
        for (let i = 0; i < 7; i++) {
          const date = new Date(weekStart);
          date.setDate(weekStart.getDate() + i);
          const header = document.createElement('div');
          header.className = 'time-slot';
          header.style.fontWeight = '700';
          header.style.fontSize = isMobile ? '0.625rem' : '0.875rem';
          header.style.textAlign = 'center';
          header.style.padding = isMobile ? '0.5rem 0.25rem' : '0.75rem';

          if (isMobile) {
            // Mobile: Show compact format like "Sun, Jan 5"
            const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const day = date.getDate();
            header.innerHTML = `${weekday},<br>${month} ${day}`;
          } else {
            // Desktop: Show full format
            header.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          }

          weekGrid.appendChild(header);
        }

        // Add time slots
        for (let hour = 8; hour <= 18; hour++) {
          const timeSlot = document.createElement('div');
          timeSlot.className = 'time-slot';
          timeSlot.textContent = `${hour}:00`;
          weekGrid.appendChild(timeSlot);

          for (let i = 0; i < 7; i++) {
            const cell = document.createElement('div');
            cell.className = 'week-cell';
            weekGrid.appendChild(cell);
          }
        }
      }

      // Render Day View
      function renderDayView() {
        const dateToShow = selectedDate || currentDate;
        const dayEvents = getEventsForDate(dateToShow);

        document.getElementById('dayViewDate').textContent =
          dateToShow.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        const dayViewEvents = document.getElementById('dayViewEvents');

        if (dayEvents.length === 0) {
          dayViewEvents.innerHTML = `
            <div class="text-center py-12">
              <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p class="text-gray-500 font-medium">No projects or announcements</p>
              <p class="text-sm text-gray-400 mt-1">Nothing scheduled for this day</p>
            </div>
          `;
        } else {
          // SECURITY: Use escapeHTML to prevent XSS attacks
          dayViewEvents.innerHTML = dayEvents.map(event => {
            const startTime = new Date(event.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const endTime = new Date(event.end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="event-card ${event.type}" onclick="openEventModal('${event.id}')">
                <div class="event-time">${startTime} - ${endTime}</div>
                <div class="event-title">${escapeHTML(event.title)}</div>
                <div class="event-description">${escapeHTML(event.description)}</div>
                <div class="event-meta">
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>${escapeHTML(event.head)}</span>
                  </div>
                  ${event.volunteers ? `
                    <div class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                      </svg>
                      <span>${event.volunteers} volunteers</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Render Projects (all projects sorted by start date descending)
      function renderUpcomingProjects() {
        const now = new Date();
        const allProjects = events
          .filter(event => event.type === 'project')
          .sort((a, b) => new Date(b.start) - new Date(a.start))
          .slice(0, 3);

        const container = document.getElementById('upcomingProjects');

        if (allProjects.length === 0) {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No projects found</p>';
        } else {
          // SECURITY: Use escapeHTML to prevent XSS attacks
          container.innerHTML = allProjects.map(event => {
            const eventDate = new Date(event.start);
            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="upcoming-event border-[#2f6e4e]" onclick="openEventModal('${event.id}')">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 text-center">
                    <div class="text-xs font-semibold text-gray-500 uppercase">${dateStr.split(' ')[0]}</div>
                    <div class="text-2xl font-bold text-[#2f6e4e]">${dateStr.split(' ')[1]}</div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded text-[#2f6e4e] bg-[#2f6e4e]/10">Project</span>
                    </div>
                    <div class="font-semibold text-sm text-gray-800 truncate">${escapeHTML(event.title)}</div>
                    <div class="text-xs text-gray-500 mt-1">${timeStr} • ${escapeHTML(event.head)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Render Recent Announcements (most recent first)
      function renderRecentAnnouncements() {
        const recentAnnouncements = events
          .filter(event => event.type === 'announcement')
          .sort((a, b) => new Date(b.start) - new Date(a.start))
          .slice(0, 3);

        const container = document.getElementById('recentAnnouncements');

        if (recentAnnouncements.length === 0) {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No recent announcements</p>';
        } else {
          // SECURITY: Use escapeHTML to prevent XSS attacks
          container.innerHTML = recentAnnouncements.map(event => {
            const eventDate = new Date(event.start);
            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="upcoming-event border-amber-500" onclick="openEventModal('${event.id}')">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 text-center">
                    <div class="text-xs font-semibold text-gray-500 uppercase">${dateStr.split(' ')[0]}</div>
                    <div class="text-2xl font-bold text-amber-500">${dateStr.split(' ')[1]}</div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded text-amber-600 bg-amber-50">Announcement</span>
                    </div>
                    <div class="font-semibold text-sm text-gray-800 truncate">${escapeHTML(event.title)}</div>
                    <div class="text-xs text-gray-500 mt-1">${timeStr} • ${escapeHTML(event.head)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Event Modal
      function openEventModal(eventId, e) {
        if (e) e.stopPropagation();

        const event = events.find(ev => ev.id === eventId);
        if (!event) return;

        const startDate = new Date(event.start);
        const endDate = new Date(event.end);
        const startTime = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const dateStr = startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        // Determine view details link based on event type
        const viewDetailsLink = event.type === 'project'
          ? `sk-projects.html?id=${event.dbId}`
          : `sk-dashboard.html`; // Announcements are on dashboard

        // SECURITY: Use escapeHTML to prevent XSS attacks
        document.getElementById('modalEventTitle').textContent = event.title;
        document.getElementById('modalEventContent').innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span>${dateStr}</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>${startTime} - ${endTime}</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span>${escapeHTML(event.head)}</span>
            </div>
            ${event.volunteers ? `
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <span>${event.volunteers} volunteers needed</span>
              </div>
            ` : ''}
            ${event.location ? `
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>${escapeHTML(event.location)}</span>
              </div>
            ` : ''}
            <div class="pt-4 border-t border-gray-200">
              <h4 class="font-semibold text-gray-800 mb-2">Description</h4>
              <p class="text-gray-600">${escapeHTML(event.description)}</p>
            </div>
            <div class="pt-4 space-y-3">
              <!-- Add to Calendar Section -->
              <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200">
                <h5 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Add to Your Calendar
                </h5>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                  <a href="${getAddToCalendarLinks(event).google}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-blue-200 text-blue-600 rounded-lg text-xs font-semibold hover:bg-blue-50 hover:border-blue-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                  </a>
                  <a href="${getAddToCalendarLinks(event).outlook}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-indigo-200 text-indigo-600 rounded-lg text-xs font-semibold hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M23 12.5v7.18a1.32 1.32 0 0 1-1.32 1.32H14.5v-9h8.5zm0-2.09h-8.5V1.32A1.32 1.32 0 0 1 15.82 0h6.68A1.5 1.5 0 0 1 23 1.32v9.09zM12 0v24l-10.5-4.82V4.82L12 0z"/>
                    </svg>
                    Outlook
                  </a>
                  <a href="${getAddToCalendarLinks(event).office365}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-red-200 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 hover:border-red-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21.53 4.306v15.363q0 .807-.472 1.433-.472.627-1.253.85l-6.888 1.974q-.136.037-.29.055-.156.019-.293.019-.396 0-.72-.105-.321-.106-.656-.292l-4.505-2.544q-.248-.137-.391-.366-.143-.23-.143-.515 0-.434.304-.738.303-.303.738-.303.26 0 .498.118l4.244 2.39q.205.113.446.17.242.056.498.056.34 0 .498-.074l6.447-1.848q.16-.037.279-.186.12-.15.12-.335V4.964q0-.186-.12-.336-.12-.149-.279-.186l-6.447-1.848q-.158-.074-.498-.074-.26 0-.5.056-.243.056-.447.17L7.035 6.13q-.248.136-.498.117-.396 0-.738-.303-.341-.304-.341-.738 0-.285.143-.515.143-.23.391-.366L10.497.78q.335-.186.656-.292.324-.105.72-.105.137 0 .293.019.154.018.29.055l6.888 1.974q.781.223 1.253.85.472.626.472 1.433z"/>
                    </svg>
                    Office365
                  </a>
                  <button onclick="exportSingleEvent('${event.id}')" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-[#2f6e4e]/30 text-[#2f6e4e] rounded-lg text-xs font-semibold hover:bg-[#2f6e4e]/5 hover:border-[#2f6e4e] transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    iCal File
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 flex items-start gap-1">
                  <svg class="w-3 h-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>Click a platform to add this event to your calendar. The iCal file works with Apple Calendar, Yahoo, and most calendar apps.</span>
                </p>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="window.location.href='${viewDetailsLink}'" class="flex-1 px-4 py-3 bg-gradient-to-r from-[#2f6e4e] to-[#3d8b64] text-white rounded-lg font-semibold hover:shadow-lg transition-all duration-300">
                  View Details
                </button>
                <button onclick="closeEventModal()" class="px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-700 hover:border-[#2f6e4e] hover:text-[#2f6e4e] transition-all duration-300">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;

        document.getElementById('eventModal').classList.add('active');
      }

      function closeEventModal() {
        document.getElementById('eventModal').classList.remove('active');
      }

      // iCalendar (.ics) Generation Helper Functions
      function generateICS(events) {
        const lines = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//BIMS SK Malanday//Calendar//EN',
          'CALSCALE:GREGORIAN',
          'METHOD:PUBLISH',
          'X-WR-CALNAME:SK Malanday Projects & Announcements',
          'X-WR-TIMEZONE:Asia/Manila',
          'X-WR-CALDESC:SK Malanday Barangay Information Management System Calendar'
        ];

        events.forEach(event => {
          lines.push(...generateEventICS(event));
        });

        lines.push('END:VCALENDAR');
        return lines.join('\r\n');
      }

      function generateEventICS(event) {
        const start = new Date(event.start);
        const end = new Date(event.end);

        const formatDate = (date) => {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        };

        const escapeText = (text) => {
          return text.replace(/\\/g, '\\\\')
                     .replace(/;/g, '\\;')
                     .replace(/,/g, '\\,')
                     .replace(/\n/g, '\\n');
        };

        const now = new Date();
        const timestamp = formatDate(now);

        let description = escapeText(event.description);
        if (event.head) {
          description += `\\n\\nOrganizer: ${escapeText(event.head)}`;
        }
        if (event.volunteers) {
          description += `\\n\\nVolunteers Needed: ${event.volunteers}`;
        }

        return [
          'BEGIN:VEVENT',
          `UID:${event.id}@bims-sk-malanday`,
          `DTSTAMP:${timestamp}`,
          `DTSTART:${formatDate(start)}`,
          `DTEND:${formatDate(end)}`,
          `SUMMARY:${escapeText(event.title)}`,
          `DESCRIPTION:${description}`,
          `LOCATION:SK Malanday, Marikina City`,
          `STATUS:CONFIRMED`,
          `CATEGORIES:${event.type === 'project' ? 'PROJECT' : 'ANNOUNCEMENT'}`,
          event.type === 'project' ? 'CLASS:PUBLIC' : 'CLASS:PUBLIC',
          'END:VEVENT'
        ];
      }

      function downloadICS(icsContent, filename) {
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }

      // Export All Calendar Events
      function exportCalendar() {
        const icsContent = generateICS(events);
        const filename = `SK_Malanday_Calendar_${new Date().getFullYear()}.ics`;
        downloadICS(icsContent, filename);

        showToast('Calendar exported successfully! Open the .ics file with your preferred calendar app.');
      }

      // Export Single Event
      function exportSingleEvent(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;

        const icsContent = generateICS([event]);
        const safeTitle = event.title.replace(/[^a-z0-9]/gi, '_');
        const filename = `${safeTitle}_Event.ics`;
        downloadICS(icsContent, filename);

        showToast('Event exported successfully!');
      }

      // Add to Calendar Links
      function getAddToCalendarLinks(event) {
        const start = new Date(event.start);
        const end = new Date(event.end);

        const formatGoogleDate = (date) => {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        };

        const formatOutlookDate = (date) => {
          return date.toISOString();
        };

        const title = encodeURIComponent(event.title);
        const description = encodeURIComponent(event.description);
        const location = encodeURIComponent('SK Malanday, Marikina City');

        return {
          google: `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${formatGoogleDate(start)}/${formatGoogleDate(end)}&details=${description}&location=${location}`,
          outlook: `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&startdt=${formatOutlookDate(start)}&enddt=${formatOutlookDate(end)}&body=${description}&location=${location}`,
          office365: `https://outlook.office.com/calendar/0/deeplink/compose?subject=${title}&startdt=${formatOutlookDate(start)}&enddt=${formatOutlookDate(end)}&body=${description}&location=${location}`,
          yahoo: `https://calendar.yahoo.com/?v=60&title=${title}&st=${formatGoogleDate(start)}&et=${formatGoogleDate(end)}&desc=${description}&in_loc=${location}`
        };
      }

      // Toast Notification
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-6 right-6 bg-gradient-to-r from-[#2f6e4e] to-[#3d8b64] text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 z-50 animate-slideIn';
        toast.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span class="font-medium">${message}</span>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      // ============================================
      // Notification & Profile Functions
      // ============================================
      // These are handled by NotificationModal.js and ProfileModal.js components

      /**
       * Toggle notification modal
       * Uses the NotificationModal component
       */
      function toggleNotificationModal() {
        if (window.notificationModal) {
          window.notificationModal.toggle();
        }
      }

      /**
       * Open profile modal
       * Uses the ProfileModal component
       */
      function openProfileModal() {
        if (window.profileModal) {
          window.profileModal.open();
        }
      }

      // ============================================
      // Logout Function
      // ============================================
      /**
       * Handle user logout
       * Uses SessionManager to properly end the session
       */
      async function handleLogout() {
        try {
          await SessionManager.logout();
        } catch (error) {
          console.error("[SK CALENDAR] Logout error:", error);
          // Force logout even if there's an error
          window.location.href = "login.html";
        }
      }

      // ============================================
      // Expose functions to global scope for onclick handlers
      // ============================================
      // Calendar navigation
      window.previousMonth = previousMonth;
      window.nextMonth = nextMonth;
      window.goToToday = goToToday;
      window.setView = setView;

      // Event modal
      window.openEventModal = openEventModal;
      window.closeEventModal = closeEventModal;

      // Export functions
      window.exportCalendar = exportCalendar;
      window.exportSingleEvent = exportSingleEvent;

      // Notification & Profile functions
      window.toggleNotificationModal = toggleNotificationModal;
      window.openProfileModal = openProfileModal;

      // Logout function
      window.handleLogout = handleLogout;
    </script>
    <script src="js/mobile-nav.js"></script>
  </body>
</html>
