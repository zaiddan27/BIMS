<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Youth Calendar - View upcoming events and schedules">
    <title>BIMS - Youth Browse Calendar</title>

    <!-- Tailwind CSS -->
    <link href="css/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link href="css/toast.css" rel="stylesheet">
    <link href="css/calendar.css" rel="stylesheet">

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.97.0" integrity="sha384-1+ItoWbWcmVSm+Y+dJaUt4SEWNA21/jxef+Z0TSHHVy/dEUxEUEnZ1bHn6GT5hj+" crossorigin="anonymous"></script>

    <!-- BIMS Configuration -->
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>
    <script src="js/utils/sanitize.js"></script>
    <script src="js/utils/toast.js"></script>
    <script src="js/utils/focus-trap.js"></script>

    <style>
      /* Youth-specific announcement colors (blue theme) */
      .event-pill.announcement {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
      }

      .event-card.announcement {
        border-left-color: #3b82f6;
      }

      .upcoming-event.border-blue-500 {
        border-left-color: #3b82f6;
      }

      /* Toast Notification Animation */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-slideIn {
        animation: slideIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[9999] focus:bg-white focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:text-[#2f6e4e] focus:font-medium">Skip to content</a>
    <div class="flex h-screen overflow-hidden">
      <!-- SIDEBAR -->
      <aside class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col" data-role="youth"></aside>
      <script src="js/components/sidebar.js"></script>

      <!-- MAIN CONTENT -->
      <div id="main-content" class="flex-1 overflow-auto">
        <!-- Top Bar -->
        <header class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-[#2f6e4e] font-semibold mb-1" id="currentDate">Sunday, January 04, 2026</p>
                <h1 class="text-2xl font-bold text-gray-800">Calendar</h1>
                <p class="text-sm text-gray-600 mt-1">View project deadlines and schedules</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="toggleNotificationModal()" class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse">5</span>
                  </button>
                </div>
                <button onclick="openProfileModal()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700" id="headerUserName">Loading...</p>
                    <p class="text-xs text-gray-500" id="headerUserRole">Youth Volunteer</p>
                  </div>
                  <div id="headerUserAvatar" class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20">
                    <span class="text-white font-semibold">--</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Calendar Content -->
        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Calendar -->
            <div class="lg:col-span-3">
              <div class="calendar-container">
                <!-- Calendar Header with Controls -->
                <div class="calendar-header">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <button onclick="previousMonth()" class="nav-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                        </svg>
                      </button>
                      <h2 class="calendar-title" id="monthYear">January 2026</h2>
                      <button onclick="nextMonth()" class="nav-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </button>
                      <button onclick="goToToday()" class="nav-btn nav-btn-today">
                        <span class="text-sm font-semibold">Today</span>
                      </button>
                    </div>
                    <div class="view-toggle">
                      <button onclick="setView('month')" class="active" id="monthViewBtn">Month</button>
                      <button onclick="setView('week')" id="weekViewBtn">Week</button>
                      <button onclick="setView('day')" id="dayViewBtn">Day</button>
                    </div>
                  </div>
                </div>

                <!-- Calendar Body -->
                <div id="calendarBody">
                  <!-- Month View (Default) -->
                  <div id="monthView">
                    <div class="calendar-grid">
                      <div class="day-header">SUN</div>
                      <div class="day-header">MON</div>
                      <div class="day-header">TUE</div>
                      <div class="day-header">WED</div>
                      <div class="day-header">THU</div>
                      <div class="day-header">FRI</div>
                      <div class="day-header">SAT</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays">
                      <!-- Days will be generated by JavaScript -->
                    </div>
                  </div>

                  <!-- Week View -->
                  <div id="weekView" style="display: none;">
                    <div class="week-view-container">
                      <div class="week-view" id="weekGrid">
                        <!-- Week grid will be generated by JavaScript -->
                      </div>
                    </div>
                  </div>

                  <!-- Day View -->
                  <div id="dayView" style="display: none;">
                    <div class="day-view-container">
                      <div class="day-view-header">
                        <div class="day-view-date" id="dayViewDate">Sunday, January 4, 2026</div>
                      </div>
                      <div class="day-view-events" id="dayViewEvents">
                        <!-- Events will be generated by JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
              <div class="events-sidebar">
                <!-- Upcoming Projects -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-[#2f6e4e]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Projects
                  </div>
                  <div id="upcomingProjects">
                    <!-- Upcoming projects will be generated by JavaScript -->
                  </div>
                </div>

                <!-- Recent Announcements -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                    </svg>
                    Recent Announcements
                  </div>
                  <div id="recentAnnouncements">
                    <!-- Recent announcements will be generated by JavaScript -->
                  </div>
                </div>

                <!-- Quick Actions -->
                <div class="events-sidebar-section">
                  <div class="events-sidebar-title">
                    <svg class="w-5 h-5 text-[#2f6e4e]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Quick Actions
                  </div>
                  <button onclick="exportCalendar()" class="w-full px-4 py-3 bg-gradient-to-r from-[#2f6e4e] to-[#3d8b64] text-white rounded-xl hover:shadow-lg transition-all duration-300 font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Export Calendar</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Modal - Injected by NotificationModal.js component -->
    <div id="notificationModalContainer"></div>

    <!-- ProfileModal component will be dynamically rendered here -->
    <div id="profileModalContainer"></div>

    <!-- Project/Announcement Detail Modal -->
    <div id="eventModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalEventTitle">
      <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-bold text-gray-800" id="modalEventTitle">Project Title</h3>
          <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="modalEventContent">
          <!-- Project/Announcement details will be inserted here -->
        </div>
      </div>
    </div>

    <script type="module">
      // Import components
      import { NotificationModal } from "./js/components/NotificationModal.js";
      import { ProfileModal } from "./js/components/ProfileModal.js";

      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;

      // Global variables
      let currentUser = null;
      let currentUserData = null;
      let events = []; // Will be loaded from database

      // Calendar State
      let currentDate = new Date();
      let currentView = 'month';
      let selectedDate = null;

      function sanitizeImageURL(url) {
        if (!url || typeof url !== "string") return "";
        const trimmedUrl = url.trim();
        if (!trimmedUrl) return "";

        if (!trimmedUrl.startsWith("https://")) {
          return "";
        }

        try {
          const parsedUrl = new URL(trimmedUrl);
          const allowedDomains = ["supabase.co", "supabase.com"];
          const isAllowedDomain = allowedDomains.some(domain =>
            parsedUrl.hostname.endsWith(domain)
          );
          return trimmedUrl;
        } catch (e) {
          return "";
        }
      }

      // ============================================
      // Authentication & Initialization
      // ============================================
      async function initializeCalendar() {
        try {
          const sessionResult = await SessionManager.requireAuth(["YOUTH_VOLUNTEER"]);

          if (!sessionResult.success) {
            return;
          }

          currentUser = sessionResult.user;
          currentUserData = sessionResult.userData;

          // Update user profile in header
          updateUserProfile();

          // Load user profile data into ProfileModal component
          await profileModal.loadUserData(currentUser, currentUserData);

          // Load calendar events from database
          await loadEventsFromDatabase();

          // Render calendar and sidebar sections
          updateCurrentDate();
          renderCalendar();
          renderUpcomingProjects();
          renderRecentAnnouncements();

          // Refresh sidebar every minute
          const sidebarRefreshInterval = setInterval(() => {
            renderUpcomingProjects();
          }, 60000);
          window.addEventListener('beforeunload', () => clearInterval(sidebarRefreshInterval));

        } catch (error) {
          SessionManager.redirectToLogin("Failed to initialize calendar");
        }
      }

      function updateUserProfile() {
        if (!currentUserData) return;

        const nameElement = document.getElementById("headerUserName");
        const roleElement = document.getElementById("headerUserRole");
        const avatarElement = document.getElementById("headerUserAvatar");

        if (nameElement) {
          const fullName = `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim();
          nameElement.textContent = fullName || 'Youth Volunteer';
        }

        if (roleElement) {
          roleElement.textContent = "Youth Volunteer";
        }

        if (avatarElement) {
          const safeProfileUrl = sanitizeImageURL(currentUserData.imagePathURL);
          const initials = `${currentUserData.firstName?.charAt(0) || ''}${currentUserData.lastName?.charAt(0) || ''}`.toUpperCase();

          if (safeProfileUrl) {
            avatarElement.innerHTML = `<img src="${safeProfileUrl}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="handleAvatarError(this, '${escapeHTML(initials)}')" />`;
          } else {
            avatarElement.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Listen for profile updates from ProfileModal
      document.addEventListener("profileUpdated", async (e) => {
        if (e.detail && e.detail.userData) {
          currentUserData = e.detail.userData;
          updateUserProfile();
        }
      });

      async function loadEventsFromDatabase() {
        try {
          // Load APPROVED projects from Pre_Project_Tbl
          const { data: projects, error: projectsError } = await supabaseClient
            .from("Pre_Project_Tbl")
            .select(`
              preProjectID,
              title,
              description,
              startDateTime,
              endDateTime,
              volunteers,
              location,
              skID,
              SK_Tbl (
                User_Tbl (
                  firstName,
                  lastName
                )
              )
            `)
            .eq("approvalStatus", "APPROVED")
            .order("startDateTime", { ascending: true });

          // Load announcements from Announcement_Tbl
          const { data: announcements, error: announcementsError } = await supabaseClient
            .from("Announcement_Tbl")
            .select(`
              announcementID,
              title,
              description,
              publishedDate,
              category,
              User_Tbl (
                firstName,
                lastName
              )
            `)
            .order("publishedDate", { ascending: true });

          // Transform projects to calendar events
          const projectEvents = (projects || []).map(project => {
            const headName = project.SK_Tbl?.User_Tbl
              ? `${project.SK_Tbl.User_Tbl.firstName} ${project.SK_Tbl.User_Tbl.lastName}`
              : "SK Official";

            return {
              id: `project-${project.preProjectID}`,
              dbId: project.preProjectID,
              title: project.title,
              type: "project",
              start: project.startDateTime,
              end: project.endDateTime,
              description: project.description,
              head: headName,
              volunteers: project.volunteers,
              location: project.location
            };
          });

          // Transform announcements to calendar events
          const announcementEvents = (announcements || []).map(announcement => {
            const authorName = announcement.User_Tbl
              ? `${announcement.User_Tbl.firstName} ${announcement.User_Tbl.lastName}`
              : "SK Official";

            return {
              id: `announcement-${announcement.announcementID}`,
              dbId: announcement.announcementID,
              title: announcement.title,
              type: "announcement",
              start: announcement.publishedDate,
              end: announcement.publishedDate,
              description: announcement.description,
              head: authorName
            };
          });

          // Combine all events
          events = [...projectEvents, ...announcementEvents];

        } catch (error) {
          console.error("[YOUTH CALENDAR] Error loading events:", error);
          events = [];
        }
      }

      // Initialize on DOMContentLoaded
      document.addEventListener('DOMContentLoaded', function() {
        initializeCalendar();
      });

      // Update current date display
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
      }

      // Render Calendar
      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = ["January", "February", "March", "April", "May", "June",
                           "July", "August", "September", "October", "November", "December"];
        document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const today = new Date();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const cell = createDayCell(day, true, year, month - 1);
          calendarDays.appendChild(cell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const isToday = isCurrentMonth && day === today.getDate();
          const cell = createDayCell(day, false, year, month, isToday);
          calendarDays.appendChild(cell);
        }

        const totalCells = calendarDays.children.length;
        const remainingCells = 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
          const cell = createDayCell(day, true, year, month + 1);
          calendarDays.appendChild(cell);
        }
      }

      // Create day cell
      function createDayCell(day, isOtherMonth, year, month, isToday = false) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        if (isOtherMonth) cell.classList.add('other-month');
        if (isToday) cell.classList.add('today');

        const cellDate = new Date(year, month, day);
        const dayEvents = getEventsForDate(cellDate);

        if (dayEvents.length === 0) {
          cell.classList.add('no-events');
        }

        cell.innerHTML = `
          <div class="cell-date">${day}</div>
          ${dayEvents.slice(0, 3).map(event => `
            <div class="event-pill ${event.type}" onclick="openEventModal('${event.id}', event)">
              ${escapeHTML(event.title)}
            </div>
          `).join('')}
          ${dayEvents.length > 3 ? `<div class="text-xs text-gray-500 mt-1">+${dayEvents.length - 3} more</div>` : ''}
        `;

        cell.onclick = () => {
          if (!isOtherMonth) {
            selectedDate = cellDate;
            setView('day');
          }
        };

        return cell;
      }

      // Get events for specific date
      function getEventsForDate(date) {
        return events.filter(event => {
          const eventDate = new Date(event.start);
          return eventDate.getFullYear() === date.getFullYear() &&
                 eventDate.getMonth() === date.getMonth() &&
                 eventDate.getDate() === date.getDate();
        });
      }

      // Navigation
      function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      }

      function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      }

      function goToToday() {
        currentDate = new Date();
        renderCalendar();
      }

      // View switching
      function setView(view) {
        currentView = view;

        document.getElementById('monthViewBtn').classList.remove('active');
        document.getElementById('weekViewBtn').classList.remove('active');
        document.getElementById('dayViewBtn').classList.remove('active');
        document.getElementById(view + 'ViewBtn').classList.add('active');

        document.getElementById('monthView').style.display = 'none';
        document.getElementById('weekView').style.display = 'none';
        document.getElementById('dayView').style.display = 'none';

        if (view === 'month') {
          document.getElementById('monthView').style.display = 'block';
        } else if (view === 'week') {
          document.getElementById('weekView').style.display = 'block';
          renderWeekView();
        } else if (view === 'day') {
          document.getElementById('dayView').style.display = 'block';
          renderDayView();
        }
      }

      // Render Week View
      function renderWeekView() {
        const weekGrid = document.getElementById('weekGrid');
        weekGrid.innerHTML = '<div class="time-slot"></div>';

        const weekStart = new Date(currentDate);
        weekStart.setDate(currentDate.getDate() - currentDate.getDay());

        const isMobile = window.innerWidth <= 640;

        for (let i = 0; i < 7; i++) {
          const date = new Date(weekStart);
          date.setDate(weekStart.getDate() + i);
          const header = document.createElement('div');
          header.className = 'time-slot';
          header.style.fontWeight = '700';
          header.style.fontSize = isMobile ? '0.625rem' : '0.875rem';
          header.style.textAlign = 'center';
          header.style.padding = isMobile ? '0.5rem 0.25rem' : '0.75rem';

          if (isMobile) {
            const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const day = date.getDate();
            header.innerHTML = `${weekday},<br>${month} ${day}`;
          } else {
            header.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          }

          weekGrid.appendChild(header);
        }

        for (let hour = 8; hour <= 18; hour++) {
          const timeSlot = document.createElement('div');
          timeSlot.className = 'time-slot';
          timeSlot.textContent = `${hour}:00`;
          weekGrid.appendChild(timeSlot);

          for (let i = 0; i < 7; i++) {
            const cell = document.createElement('div');
            cell.className = 'week-cell';
            weekGrid.appendChild(cell);
          }
        }
      }

      // Render Day View
      function renderDayView() {
        const dateToShow = selectedDate || currentDate;
        const dayEvents = getEventsForDate(dateToShow);

        document.getElementById('dayViewDate').textContent =
          dateToShow.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        const dayViewEvents = document.getElementById('dayViewEvents');

        if (dayEvents.length === 0) {
          dayViewEvents.innerHTML = `
            <div class="text-center py-12">
              <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p class="text-gray-500 font-medium">No projects or announcements</p>
              <p class="text-sm text-gray-400 mt-1">Nothing scheduled for this day</p>
            </div>
          `;
        } else {
          dayViewEvents.innerHTML = dayEvents.map(event => {
            const startTime = new Date(event.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const endTime = new Date(event.end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="event-card ${event.type}" onclick="openEventModal('${event.id}')">
                <div class="event-time">${startTime} - ${endTime}</div>
                <div class="event-title">${escapeHTML(event.title)}</div>
                <div class="event-description">${escapeHTML(event.description)}</div>
                <div class="event-meta">
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>${escapeHTML(event.head)}</span>
                  </div>
                  ${event.volunteers ? `
                    <div class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                      </svg>
                      <span>${event.volunteers} volunteers</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Render Projects (sorted by start date descending)
      function renderUpcomingProjects() {
        const allProjects = events
          .filter(event => event.type === 'project')
          .sort((a, b) => new Date(b.start) - new Date(a.start))
          .slice(0, 3);

        const container = document.getElementById('upcomingProjects');

        if (allProjects.length === 0) {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No projects found</p>';
        } else {
          container.innerHTML = allProjects.map(event => {
            const eventDate = new Date(event.start);
            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="upcoming-event border-[#2f6e4e]" onclick="openEventModal('${event.id}')">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 text-center">
                    <div class="text-xs font-semibold text-gray-500 uppercase">${dateStr.split(' ')[0]}</div>
                    <div class="text-2xl font-bold text-[#2f6e4e]">${dateStr.split(' ')[1]}</div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded text-[#2f6e4e] bg-[#2f6e4e]/10">Project</span>
                    </div>
                    <div class="font-semibold text-sm text-gray-800 truncate">${escapeHTML(event.title)}</div>
                    <div class="text-xs text-gray-500 mt-1">${timeStr} • ${escapeHTML(event.head)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Render Recent Announcements (most recent first)
      function renderRecentAnnouncements() {
        const recentAnnouncements = events
          .filter(event => event.type === 'announcement')
          .sort((a, b) => new Date(b.start) - new Date(a.start))
          .slice(0, 3);

        const container = document.getElementById('recentAnnouncements');

        if (recentAnnouncements.length === 0) {
          container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No recent announcements</p>';
        } else {
          container.innerHTML = recentAnnouncements.map(event => {
            const eventDate = new Date(event.start);
            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            return `
              <div class="upcoming-event border-blue-500" onclick="openEventModal('${event.id}')">
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 text-center">
                    <div class="text-xs font-semibold text-gray-500 uppercase">${dateStr.split(' ')[0]}</div>
                    <div class="text-2xl font-bold text-blue-500">${dateStr.split(' ')[1]}</div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded text-blue-600 bg-blue-50">Announcement</span>
                    </div>
                    <div class="font-semibold text-sm text-gray-800 truncate">${escapeHTML(event.title)}</div>
                    <div class="text-xs text-gray-500 mt-1">${timeStr} • ${escapeHTML(event.head)}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // Event Modal
      function openEventModal(eventId, e) {
        if (e) e.stopPropagation();

        const event = events.find(ev => ev.id === eventId);
        if (!event) return;

        const startDate = new Date(event.start);
        const endDate = new Date(event.end);
        const startTime = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const dateStr = startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        const viewDetailsLink = event.type === 'project'
          ? `youth-projects.html?projectId=${event.dbId}`
          : `youth-dashboard.html`;

        document.getElementById('modalEventTitle').textContent = event.title;
        document.getElementById('modalEventContent').innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span>${dateStr}</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>${startTime} - ${endTime}</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span>${escapeHTML(event.head)}</span>
            </div>
            ${event.volunteers ? `
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                <span>${event.volunteers} volunteers needed</span>
              </div>
            ` : ''}
            ${event.location ? `
              <div class="flex items-center gap-3 text-sm text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>${escapeHTML(event.location)}</span>
              </div>
            ` : ''}
            <div class="pt-4 border-t border-gray-200">
              <h4 class="font-semibold text-gray-800 mb-2">Description</h4>
              <p class="text-gray-600">${escapeHTML(event.description)}</p>
            </div>
            <div class="pt-4 space-y-3">
              <!-- Add to Calendar Section -->
              <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200">
                <h5 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  Add to Your Calendar
                </h5>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                  <a href="${getAddToCalendarLinks(event).google}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-blue-200 text-blue-600 rounded-lg text-xs font-semibold hover:bg-blue-50 hover:border-blue-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                  </a>
                  <a href="${getAddToCalendarLinks(event).outlook}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-indigo-200 text-indigo-600 rounded-lg text-xs font-semibold hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M23 12.5v7.18a1.32 1.32 0 0 1-1.32 1.32H14.5v-9h8.5zm0-2.09h-8.5V1.32A1.32 1.32 0 0 1 15.82 0h6.68A1.5 1.5 0 0 1 23 1.32v9.09zM12 0v24l-10.5-4.82V4.82L12 0z"/>
                    </svg>
                    Outlook
                  </a>
                  <a href="${getAddToCalendarLinks(event).office365}" target="_blank" rel="noopener" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-red-200 text-red-600 rounded-lg text-xs font-semibold hover:bg-red-50 hover:border-red-400 transition-all duration-200">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21.53 4.306v15.363q0 .807-.472 1.433-.472.627-1.253.85l-6.888 1.974q-.136.037-.29.055-.156.019-.293.019-.396 0-.72-.105-.321-.106-.656-.292l-4.505-2.544q-.248-.137-.391-.366-.143-.23-.143-.515 0-.434.304-.738.303-.303.738-.303.26 0 .498.118l4.244 2.39q.205.113.446.17.242.056.498.056.34 0 .498-.074l6.447-1.848q.16-.037.279-.186.12-.15.12-.335V4.964q0-.186-.12-.336-.12-.149-.279-.186l-6.447-1.848q-.158-.074-.498-.074-.26 0-.5.056-.243.056-.447.17L7.035 6.13q-.248.136-.498.117-.396 0-.738-.303-.341-.304-.341-.738 0-.285.143-.515.143-.23.391-.366L10.497.78q.335-.186.656-.292.324-.105.72-.105.137 0 .293.019.154.018.29.055l6.888 1.974q.781.223 1.253.85.472.626.472 1.433z"/>
                    </svg>
                    Office365
                  </a>
                  <button onclick="exportSingleEvent('${event.id}')" class="flex items-center justify-center gap-2 px-3 py-2 bg-white border-2 border-[#2f6e4e]/30 text-[#2f6e4e] rounded-lg text-xs font-semibold hover:bg-[#2f6e4e]/5 hover:border-[#2f6e4e] transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    iCal File
                  </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 flex items-start gap-1">
                  <svg class="w-3 h-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>Click a platform to add this event to your calendar. The iCal file works with Apple Calendar, Yahoo, and most calendar apps.</span>
                </p>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="window.location.href='${viewDetailsLink}'" class="flex-1 px-4 py-3 bg-gradient-to-r from-[#2f6e4e] to-[#3d8b64] text-white rounded-lg font-semibold hover:shadow-lg transition-all duration-300">
                  View Details
                </button>
                <button onclick="closeEventModal()" class="px-4 py-3 border-2 border-gray-200 rounded-lg font-medium text-gray-700 hover:border-[#2f6e4e] hover:text-[#2f6e4e] transition-all duration-300">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;

        document.getElementById('eventModal').classList.add('active');
      }

      function closeEventModal() {
        document.getElementById('eventModal').classList.remove('active');
      }

      // iCalendar (.ics) Generation Helper Functions
      function generateICS(events) {
        const lines = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//BIMS SK Malanday//Calendar//EN',
          'CALSCALE:GREGORIAN',
          'METHOD:PUBLISH',
          'X-WR-CALNAME:SK Malanday Projects & Announcements',
          'X-WR-TIMEZONE:Asia/Manila',
          'X-WR-CALDESC:SK Malanday Barangay Information Management System Calendar'
        ];

        events.forEach(event => {
          lines.push(...generateEventICS(event));
        });

        lines.push('END:VCALENDAR');
        return lines.join('\r\n');
      }

      function generateEventICS(event) {
        const start = new Date(event.start);
        const end = new Date(event.end);

        const formatDate = (date) => {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        };

        const escapeText = (text) => {
          return text.replace(/\\/g, '\\\\')
                     .replace(/;/g, '\\;')
                     .replace(/,/g, '\\,')
                     .replace(/\n/g, '\\n');
        };

        const now = new Date();
        const timestamp = formatDate(now);

        let description = escapeText(event.description);
        if (event.head) {
          description += `\\n\\nOrganizer: ${escapeText(event.head)}`;
        }
        if (event.volunteers) {
          description += `\\n\\nVolunteers Needed: ${event.volunteers}`;
        }

        return [
          'BEGIN:VEVENT',
          `UID:${event.id}@bims-sk-malanday`,
          `DTSTAMP:${timestamp}`,
          `DTSTART:${formatDate(start)}`,
          `DTEND:${formatDate(end)}`,
          `SUMMARY:${escapeText(event.title)}`,
          `DESCRIPTION:${description}`,
          `LOCATION:SK Malanday, Marikina City`,
          `STATUS:CONFIRMED`,
          `CATEGORIES:${event.type === 'project' ? 'PROJECT' : 'ANNOUNCEMENT'}`,
          event.type === 'project' ? 'CLASS:PUBLIC' : 'CLASS:PUBLIC',
          'END:VEVENT'
        ];
      }

      function downloadICS(icsContent, filename) {
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }

      // Export All Calendar Events
      function exportCalendar() {
        const icsContent = generateICS(events);
        const filename = `SK_Malanday_Calendar_${new Date().getFullYear()}.ics`;
        downloadICS(icsContent, filename);

        showToast('Calendar exported successfully! Open the .ics file with your preferred calendar app.');
      }

      // Export Single Event
      function exportSingleEvent(eventId) {
        const event = events.find(e => e.id === eventId);
        if (!event) return;

        const icsContent = generateICS([event]);
        const safeTitle = event.title.replace(/[^a-z0-9]/gi, '_');
        const filename = `${safeTitle}_Event.ics`;
        downloadICS(icsContent, filename);

        showToast('Event exported successfully!');
      }

      // Add to Calendar Links
      function getAddToCalendarLinks(event) {
        const start = new Date(event.start);
        const end = new Date(event.end);

        const formatGoogleDate = (date) => {
          return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        };

        const formatOutlookDate = (date) => {
          return date.toISOString();
        };

        const title = encodeURIComponent(event.title);
        const description = encodeURIComponent(event.description);
        const location = encodeURIComponent('SK Malanday, Marikina City');

        return {
          google: `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${formatGoogleDate(start)}/${formatGoogleDate(end)}&details=${description}&location=${location}`,
          outlook: `https://outlook.live.com/calendar/0/deeplink/compose?subject=${title}&startdt=${formatOutlookDate(start)}&enddt=${formatOutlookDate(end)}&body=${description}&location=${location}`,
          office365: `https://outlook.office.com/calendar/0/deeplink/compose?subject=${title}&startdt=${formatOutlookDate(start)}&enddt=${formatOutlookDate(end)}&body=${description}&location=${location}`,
          yahoo: `https://calendar.yahoo.com/?v=60&title=${title}&st=${formatGoogleDate(start)}&et=${formatGoogleDate(end)}&desc=${description}&in_loc=${location}`
        };
      }

      // ============================================
      // Notification & Profile Functions
      // ============================================
      function toggleNotificationModal() {
        if (window.notificationModal) {
          window.notificationModal.toggle();
        }
      }

      function openProfileModal() {
        if (window.profileModal) {
          window.profileModal.open();
        }
      }

      // ============================================
      // Logout Function
      // ============================================
      async function handleLogout() {
        try {
          await SessionManager.logout();
        } catch (error) {
          console.error("[YOUTH CALENDAR] Logout error:", error);
          window.location.href = "login.html";
        }
      }

      // ============================================
      // Expose functions to global scope for onclick handlers
      // ============================================
      window.previousMonth = previousMonth;
      window.nextMonth = nextMonth;
      window.goToToday = goToToday;
      window.setView = setView;

      window.openEventModal = openEventModal;
      window.closeEventModal = closeEventModal;

      window.exportCalendar = exportCalendar;
      window.exportSingleEvent = exportSingleEvent;

      window.toggleNotificationModal = toggleNotificationModal;
      window.openProfileModal = openProfileModal;

      window.handleLogout = handleLogout;
    </script>
    <script src="js/mobile-nav.js"></script>
  </body>
</html>
