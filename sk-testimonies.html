<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BIMS - Manage Testimonies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- BIMS Configuration -->
    <script src="js/config/env.js"></script>
    <script src="js/config/supabase.js"></script>
    <script src="js/auth/auth.js"></script>
    <script src="js/auth/session.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#2f6e4e",
              secondary: "#3d8b64",
            },
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      .icon-wrapper { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      .icon-wrapper:hover { transform: translateY(-2px); }
      .nav-link svg { transition: all 0.3s ease; }
      .nav-link:hover svg { transform: scale(1.1); }
      .icon-badge { box-shadow: 0 2px 8px rgba(47, 110, 78, 0.15); }
      .notification-icon { position: relative; }
      .notification-icon:hover { transform: rotate(15deg) scale(1.1); transition: transform 0.3s ease; }
      .status-icon-pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
      .status-icon-approved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
      .status-icon-rejected { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
      .icon-primary { filter: drop-shadow(0 2px 4px rgba(47, 110, 78, 0.1)); }
      .icon-glow { filter: drop-shadow(0 0 8px rgba(47, 110, 78, 0.3)); }

      /* Desktop modal footer styling */
      @media (min-width: 768px) {
        .testimony-modal-footer {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          gap: 0.75rem;
        }
      }

      /* Toast Notification Styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 300px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast.success {
        border-left: 4px solid #10b981;
      }

      .toast.error {
        border-left: 4px solid #ef4444;
      }

      .toast.warning {
        border-left: 4px solid #f59e0b;
      }

      .toast.info {
        border-left: 4px solid #3b82f6;
      }

      /* Pagination dots - consistent across all screen sizes */
      #paginationDots button {
        flex-shrink: 0;
        display: inline-block;
        cursor: pointer;
        border: none;
        padding: 0;
        outline: none;
      }

      #paginationDots button:focus {
        outline: 2px solid rgba(47, 110, 78, 0.3);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body class="bg-gray-50 overflow-x-hidden">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside
        class="w-64 bg-white shadow-lg flex-shrink-0 h-screen flex flex-col"
      >
        <div class="p-6 flex-1 flex flex-col">
          <!-- Logo -->
          <div class="flex items-center space-x-4 mb-8">
            <div
              class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg icon-badge overflow-hidden"
            >
              <img src="asset/logo.svg" alt="BIMS Logo" class="w-full h-full object-contain p-1">
            </div>
            <div>
              <h1 class="text-xl font-black text-gray-800">BIMS</h1>
              <p class="text-sm text-gray-600 font-medium">SK Malanday</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a
              href="sk-dashboard.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-green-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-green-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                  ></path>
                </svg>
              </div>
              <span>Dashboard</span>
            </a>
            <a
              href="sk-files.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-blue-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-blue-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
              </div>
              <span>Manage Files</span>
            </a>
            <a
              href="sk-projects.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-purple-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-purple-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  ></path>
                </svg>
              </div>
              <span>Project Monitoring</span>
            </a>
            <a
              href="sk-calendar.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-orange-50 transition">
                <svg
                  class="w-5 h-5 group-hover:text-orange-600 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <span>Calendar</span>
            </a>
            <a
              href="sk-testimonies.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 bg-[#2f6e4e]/10 text-[#2f6e4e] rounded-lg font-medium group"
            >
              <div class="w-9 h-9 bg-[#2f6e4e]/20 rounded-lg flex items-center justify-center group-hover:bg-[#2f6e4e]/30 transition">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                  ></path>
                </svg>
              </div>
              <span>Testimonies</span>
            </a>
            <a
              href="sk-archive.html"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 rounded-lg transition group"
            >
              <div class="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 transition">
                <svg
                  class="w-5 h-5 group-hover:text-gray-700 transition"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                  ></path>
                </svg>
              </div>
              <span>Archives</span>
            </a>
          </nav>

          <div class="flex-1"></div>

          <!-- Logout -->
          <div class="mt-8 pt-8 border-t border-gray-200">
            <button
              onclick="handleLogout()"
              class="nav-link flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition w-full group"
            >
              <div class="w-9 h-9 bg-red-50 rounded-lg flex items-center justify-center group-hover:bg-red-100 transition">
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
              </div>
              <span class="font-medium">Logout</span>
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="flex-1 overflow-auto">
        <!-- Top Bar -->
        <header class="bg-gradient-to-r from-[#2f6e4e]/10 to-white border-b border-gray-200">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-[#2f6e4e] font-semibold mb-1" id="currentDate">Sunday, December 14, 2025</p>
                <h1 class="text-2xl font-bold text-gray-800">Volunteer Testimonies</h1>
                <p class="text-sm text-gray-600 mt-1">Manage and feature testimonials from youth volunteers</p>
              </div>
              <div class="flex items-center space-x-4">
                <div class="relative">
                  <button onclick="window.notificationModal.toggle()" class="notification-icon p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="Notifications">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg shadow-red-500/50 animate-pulse">5</span>
                  </button>
                </div>
                <button onclick="window.profileModal.open()" class="flex items-center space-x-3 hover:bg-gray-100 rounded-lg px-3 py-2 transition-colors">
                  <div class="text-right">
                    <p class="text-sm font-medium text-gray-700 group-hover:text-[#2f6e4e] transition">Loading...</p>
                    <p class="text-xs text-gray-500">SK Official</p>
                  </div>
                  <div class="w-10 h-10 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-full flex items-center justify-center text-white font-semibold shadow-lg ring-2 ring-[#2f6e4e]/20 group-hover:ring-[#2f6e4e]/40 transition">
                    --
                  </div>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Filter and Stats -->
        <div class="px-6 py-6">
          <div class="max-w-7xl mx-auto">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <div class="bg-white rounded-2xl p-6 shadow-lg border-l-4 border-[#2f6e4e] hover:shadow-xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <p class="text-sm font-semibold text-gray-600 mb-1">Total Testimonies</p>
                    <p class="text-4xl font-black text-gray-800" id="totalTestimonies">12</p>
                  </div>
                  <div class="w-16 h-16 bg-gradient-to-br from-[#2f6e4e] to-[#3d8b64] rounded-2xl flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                  </div>
                </div>
                <div class="flex items-center text-sm">
                  <span class="text-gray-600 font-medium">All volunteer feedback</span>
                </div>
              </div>

              <div class="bg-white rounded-2xl p-6 shadow-lg border-l-4 border-yellow-500 hover:shadow-xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <p class="text-sm font-semibold text-gray-600 mb-1">Featured</p>
                    <p class="text-4xl font-black text-gray-800" id="featuredCount">5</p>
                  </div>
                  <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                  </div>
                </div>
                <div class="flex items-center text-sm">
                  <span class="text-gray-600 font-medium">Highlighted testimonials</span>
                </div>
              </div>

            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <!-- Tabs with Icons and Underline -->
                <div class="flex items-center gap-6 border-b border-gray-200 pb-0 -mb-px">
                  <button
                    onclick="filterTestimonies('all')"
                    id="filterAll"
                    class="flex items-center gap-3 pb-3 border-b-2 border-[#2f6e4e] text-gray-800 font-medium transition-all duration-200 relative"
                  >
                    <div class="w-10 h-10 bg-[#2f6e4e] rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                      </svg>
                    </div>
                    <span class="tab-label-full">All Testimonies</span>
                    <span class="tab-label-short hidden">All</span>
                    <span id="allCountBadge" class="px-2.5 py-0.5 bg-[#2f6e4e]/10 text-[#2f6e4e] text-sm font-semibold rounded-full">12</span>
                  </button>
                  <button
                    onclick="filterTestimonies('featured')"
                    id="filterFeatured"
                    class="flex items-center gap-3 pb-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium transition-all duration-200 relative"
                  >
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                      </svg>
                    </div>
                    <span class="tab-label-full">Featured</span>
                    <span class="tab-label-short hidden">Featured</span>
                    <span id="featuredCountBadge" class="px-2.5 py-0.5 bg-gray-100 text-gray-600 text-sm font-semibold rounded-full">5</span>
                  </button>
                </div>

                <div class="w-full md:w-auto">
                  <input
                    type="text"
                    id="searchInput"
                    placeholder="Search testimonies..."
                    class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3d8b64] focus:border-transparent transition-all"
                    oninput="searchTestimonies()"
                  />
                </div>
              </div>

              <!-- Testimonies Grid -->
              <div id="testimoniesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Testimony cards will be inserted here by JavaScript -->
              </div>

              <!-- Pagination Dots (Center) -->
              <div id="paginationDots" class="flex justify-center gap-2 mt-6 hidden">
                <!-- Dots will be inserted here -->
              </div>

              <!-- Pagination Controls (Bottom Right) -->
              <div class="mt-6 flex justify-end">
                <nav
                  id="paginationNav"
                  class="hidden inline-flex rounded-md shadow-sm"
                  role="navigation"
                  aria-label="Pagination"
                >
                  <button
                    id="prevBtn"
                    onclick="navigateTestimonies(-1)"
                    class="px-3 py-2 border border-gray-200 rounded-l-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Prev
                  </button>
                  <button
                    id="nextBtn"
                    onclick="navigateTestimonies(1)"
                    class="px-3 py-2 border-t border-b border-r border-gray-200 rounded-r-md hover:bg-gray-50 transition text-gray-700 font-medium"
                  >
                    Next
                  </button>
                </nav>
              </div>

              <!-- Empty State -->
              <div id="emptyState" class="hidden text-center py-12">
                <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-gray-500 font-medium">No testimonies found</p>
                <p class="text-sm text-gray-400 mt-1">Try adjusting your filters</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- View Testimony Modal -->
    <div
      id="viewModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-gray-800">Testimony Details</h3>
            <button
              onclick="closeViewModal()"
              class="text-gray-400 hover:text-gray-600 transition"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="p-6 space-y-4">
          <!-- Volunteer Info Section -->
          <div class="flex items-start space-x-4">
            <div id="viewAvatar" class="w-16 h-16 bg-[#2f6e4e] rounded-full flex items-center justify-center text-white font-bold text-xl flex-shrink-0">
              JD
            </div>
            <div class="flex-1 min-w-0">
              <h4 id="viewVolunteerName" class="text-lg font-bold text-gray-800">Juan Dela Cruz</h4>
              <p id="viewProject" class="text-sm text-gray-600">Community Clean-Up Drive 2025</p>
              <p id="viewDate" class="text-xs text-gray-400 mt-1">Submitted: Nov 20, 2025</p>
            </div>
          </div>

          <!-- Featured Badge - Separate Line -->
          <div id="viewStatusBadge" class="flex justify-start"></div>

          <div class="border-t border-gray-200 pt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Testimony</label>
            <p id="viewTestimony" class="text-gray-700 leading-relaxed"></p>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Satisfaction Rating</label>
            <div class="flex items-center space-x-2">
              <div id="viewRating" class="flex space-x-1"></div>
              <span id="viewRatingText" class="text-sm text-gray-600"></span>
            </div>
          </div>
        </div>

        <div class="p-6 border-t border-gray-200 testimony-modal-footer">
          <button
            id="featureBtn"
            onclick="toggleFeature()"
            class="testimony-modal-feature-btn px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium flex items-center justify-center space-x-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
            </svg>
            <span id="featureBtnText">Feature</span>
          </button>
          <button
            id="deleteBtn"
            onclick="deleteTestimony()"
            class="testimony-modal-delete-btn px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium flex items-center justify-center space-x-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span>Delete</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
        <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <h3 id="confirmTitle" class="text-lg font-bold text-gray-900 text-center mb-2">Confirm Action</h3>
        <p id="confirmMessage" class="text-sm text-gray-600 text-center mb-6">Are you sure you want to proceed?</p>
        <div class="flex gap-3">
          <button id="confirmCancel" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Cancel</button>
          <button id="confirmOk" class="flex-1 px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition font-medium">Delete</button>
        </div>
      </div>
    </div>

    <!-- Feature Info Modal -->
    <div id="featureInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
        <div class="flex items-center justify-center w-12 h-12 mx-auto bg-yellow-100 rounded-full mb-4">
          <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
          </svg>
        </div>
        <h3 id="featureInfoTitle" class="text-lg font-bold text-gray-900 text-center mb-2">Feature Testimony</h3>
        <p id="featureInfoMessage" class="text-sm text-gray-600 text-center mb-6">This testimony will be displayed on the homepage for public viewing. Featured testimonies help showcase the positive impact of our SK programs to the community.</p>
        <div class="flex gap-3">
          <button id="featureInfoCancel" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium text-gray-700">Cancel</button>
          <button id="featureInfoOk" class="flex-1 px-4 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition font-medium flex items-center justify-center space-x-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
            </svg>
            <span id="featureInfoBtnText">Feature</span>
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      // Import components
      import { NotificationModal } from "./js/components/NotificationModal.js";
      import { ProfileModal } from "./js/components/ProfileModal.js";

      // Initialize NotificationModal component
      const notificationModal = new NotificationModal();
      notificationModal.render();
      window.notificationModal = notificationModal;

      // Initialize ProfileModal component
      const profileModal = new ProfileModal();
      profileModal.render();
      window.profileModal = profileModal;

      // Global variables
      let testimonies = [];
      let currentFilter = 'all';
      let currentTestimonyId = null;
      let currentUser = null;
      let currentUserData = null;

      // Pagination variables
      let currentPage = 0;
      const testimoniesPerPage = 6;

      // SECURITY: Escape HTML to prevent XSS
      function escapeHTML(unsafe) {
        if (typeof unsafe !== "string") return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // SECURITY: Validate and sanitize image URLs
      function sanitizeImageURL(url) {
        if (!url || typeof url !== "string") return "";
        const trimmedUrl = url.trim();
        if (!trimmedUrl) return "";
        if (!trimmedUrl.startsWith("https://")) return "";
        try {
          const parsedUrl = new URL(trimmedUrl);
          const allowedDomains = ["supabase.co", "supabase.com"];
          const isAllowedDomain = allowedDomains.some(domain =>
            parsedUrl.hostname.endsWith(domain)
          );
          if (!isAllowedDomain) return "";
          return trimmedUrl;
        } catch (e) {
          return "";
        }
      }

      // Format date helper
      function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      // Initialize session and load data
      async function initializeTestimonies() {
        try {
          // Require authentication - only SK_OFFICIAL allowed
          const sessionResult = await SessionManager.requireAuth(["SK_OFFICIAL"]);

          if (!sessionResult.success) {
            console.error("[SK TESTIMONIES] Authentication failed:", sessionResult.error);
            return;
          }

          currentUser = sessionResult.user;
          currentUserData = sessionResult.userData;

          // Update user profile in header
          updateUserProfile();

          // Load user profile data into ProfileModal component
          await profileModal.loadUserData(currentUser, currentUserData);

          // Load testimonies from database
          await loadTestimonies();

        } catch (error) {
          console.error("[SK TESTIMONIES] Initialization error:", error);
          SessionManager.redirectToLogin("Failed to initialize testimonies page");
        }
      }

      // Update user profile in header
      function updateUserProfile() {
        if (!currentUserData) return;

        const nameElement = document.querySelector("header p.text-sm.font-medium");
        const roleElement = document.querySelector("header p.text-xs.text-gray-500");
        const avatarElement = document.querySelector("header .w-10.h-10");

        if (nameElement) {
          const fullName = `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim();
          nameElement.textContent = fullName || 'SK Official';
        }

        if (roleElement) {
          roleElement.textContent = "SK Official";
        }

        if (avatarElement) {
          const safeProfileUrl = sanitizeImageURL(currentUserData.imagePathURL);
          if (safeProfileUrl) {
            avatarElement.innerHTML = `<img src="${safeProfileUrl}" alt="Profile" class="w-full h-full object-cover rounded-full" onerror="this.parentElement.innerHTML='<span class=\\'text-white font-semibold\\'>${escapeHTML((currentUserData.firstName?.charAt(0) || '') + (currentUserData.lastName?.charAt(0) || '')).toUpperCase()}</span>';" />`;
          } else {
            const initials = `${(currentUserData.firstName || 'S').charAt(0)}${(currentUserData.lastName || 'K').charAt(0)}`.toUpperCase();
            avatarElement.innerHTML = `<span class="text-white font-semibold">${escapeHTML(initials)}</span>`;
          }
        }
      }

      // Load testimonies from Supabase
      async function loadTestimonies() {
        try {
          const { data, error } = await supabaseClient
            .from("Testimonies_Tbl")
            .select(`
              testimonyID, message, rating, isFiltered, timeStamp, createdAt,
              User_Tbl (
                userID, firstName, lastName, imagePathURL
              )
            `)
            .order("createdAt", { ascending: false });

          if (error) {
            console.error("[SK TESTIMONIES] Error loading testimonies:", error);
            showToast("Failed to load testimonies", "error");
            return;
          }

          // Map database records to local format
          testimonies = (data || []).map(t => ({
            id: t.testimonyID,
            volunteerId: t.User_Tbl?.userID || null,
            volunteerName: `${t.User_Tbl?.firstName || 'Unknown'} ${t.User_Tbl?.lastName || ''}`.trim(),
            volunteerInitials: `${(t.User_Tbl?.firstName || 'U').charAt(0)}${(t.User_Tbl?.lastName || '').charAt(0)}`.toUpperCase(),
            volunteerImage: t.User_Tbl?.imagePathURL || null,
            testimony: t.message || '',
            rating: t.rating || 0,
            featured: t.isFiltered || false,
            dateSubmitted: formatDate(t.createdAt || t.timeStamp)
          }));

          updateStats();
          renderTestimonies();
        } catch (err) {
          console.error("[SK TESTIMONIES] Unexpected error:", err);
          showToast("Failed to load testimonies", "error");
        }
      }

      // Navigate through testimony pages
      function navigateTestimonies(direction) {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        let filtered = testimonies.filter(t => {
          let matchesFilter = true;
          if (currentFilter === 'featured') matchesFilter = t.featured;

          const matchesSearch = searchTerm === '' ||
            t.volunteerName.toLowerCase().includes(searchTerm) ||
            t.project.toLowerCase().includes(searchTerm) ||
            t.testimony.toLowerCase().includes(searchTerm);

          return matchesFilter && matchesSearch;
        });

        const totalPages = Math.ceil(filtered.length / testimoniesPerPage);
        currentPage += direction;

        // Wrap around
        if (currentPage < 0) currentPage = totalPages - 1;
        if (currentPage >= totalPages) currentPage = 0;

        renderTestimonies();
        updatePaginationControls();
      }

      // Update pagination controls
      function updatePaginationControls() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        let filtered = testimonies.filter(t => {
          let matchesFilter = true;
          if (currentFilter === 'featured') matchesFilter = t.featured;

          const matchesSearch = searchTerm === '' ||
            t.volunteerName.toLowerCase().includes(searchTerm) ||
            t.project.toLowerCase().includes(searchTerm) ||
            t.testimony.toLowerCase().includes(searchTerm);

          return matchesFilter && matchesSearch;
        });

        const totalPages = Math.ceil(filtered.length / testimoniesPerPage);
        const paginationNav = document.getElementById('paginationNav');
        const dotsContainer = document.getElementById('paginationDots');

        if (totalPages <= 1) {
          paginationNav.classList.add('hidden');
          dotsContainer.classList.add('hidden');
          return;
        }

        // Show Prev/Next buttons
        paginationNav.classList.remove('hidden');
        paginationNav.classList.add('inline-flex');

        // Show and render pagination dots
        dotsContainer.classList.remove('hidden');
        dotsContainer.innerHTML = Array.from({ length: totalPages }, (_, i) => `
          <button
            onclick="goToPage(${i})"
            class="h-2 rounded-full transition-all duration-300 ${i === currentPage ? 'bg-[#2f6e4e] w-8' : 'bg-gray-300 hover:bg-gray-400 w-2'}"
            style="min-height: 8px;"
          ></button>
        `).join('');
      }

      // Go to specific page
      function goToPage(pageIndex) {
        currentPage = pageIndex;
        renderTestimonies();
        updatePaginationControls();
      }

      // Update statistics
      function updateStats() {
        const total = testimonies.length;
        const featured = testimonies.filter(t => t.featured).length;

        document.getElementById('totalTestimonies').textContent = total;
        document.getElementById('featuredCount').textContent = featured;

        // Update filter button counts in badges
        document.getElementById('allCountBadge').textContent = total;
        document.getElementById('featuredCountBadge').textContent = featured;
      }

      // Filter testimonies
      function filterTestimonies(filter) {
        currentFilter = filter;

        const allBtn = document.getElementById('filterAll');
        const featuredBtn = document.getElementById('filterFeatured');

        // Reset both buttons to inactive state
        // All button
        allBtn.classList.remove('border-[#2f6e4e]', 'text-gray-800');
        allBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
        const allIcon = allBtn.querySelector('div');
        const allIconSvg = allBtn.querySelector('svg');
        const allBadge = document.getElementById('allCountBadge');
        allIcon.classList.remove('bg-[#2f6e4e]');
        allIcon.classList.add('bg-gray-100');
        allIconSvg.classList.remove('text-white');
        allIconSvg.classList.add('text-gray-500');
        allBadge.classList.remove('bg-[#2f6e4e]/10', 'text-[#2f6e4e]');
        allBadge.classList.add('bg-gray-100', 'text-gray-600');

        // Featured button
        featuredBtn.classList.remove('border-[#2f6e4e]', 'text-gray-800');
        featuredBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
        const featuredIcon = featuredBtn.querySelector('div');
        const featuredIconSvg = featuredBtn.querySelector('svg');
        const featuredBadge = document.getElementById('featuredCountBadge');
        featuredIcon.classList.remove('bg-[#2f6e4e]');
        featuredIcon.classList.add('bg-gray-100');
        featuredIconSvg.classList.remove('text-white');
        featuredIconSvg.classList.add('text-gray-500');
        featuredBadge.classList.remove('bg-[#2f6e4e]/10', 'text-[#2f6e4e]');
        featuredBadge.classList.add('bg-gray-100', 'text-gray-600');

        // Activate selected button
        if (filter === 'all') {
          allBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
          allBtn.classList.add('border-[#2f6e4e]', 'text-gray-800');
          allIcon.classList.remove('bg-gray-100');
          allIcon.classList.add('bg-[#2f6e4e]');
          allIconSvg.classList.remove('text-gray-500');
          allIconSvg.classList.add('text-white');
          allBadge.classList.remove('bg-gray-100', 'text-gray-600');
          allBadge.classList.add('bg-[#2f6e4e]/10', 'text-[#2f6e4e]');
        } else if (filter === 'featured') {
          featuredBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
          featuredBtn.classList.add('border-[#2f6e4e]', 'text-gray-800');
          featuredIcon.classList.remove('bg-gray-100');
          featuredIcon.classList.add('bg-[#2f6e4e]');
          featuredIconSvg.classList.remove('text-gray-500');
          featuredIconSvg.classList.add('text-white');
          featuredBadge.classList.remove('bg-gray-100', 'text-gray-600');
          featuredBadge.classList.add('bg-[#2f6e4e]/10', 'text-[#2f6e4e]');
        }

        currentPage = 0; // Reset to first page when filter changes
        renderTestimonies();
      }

      // Search testimonies
      function searchTestimonies() {
        currentPage = 0; // Reset to first page when searching
        renderTestimonies();
      }

      // Render testimonies grid
      function renderTestimonies() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filtered = testimonies.filter(t => {
          // Apply filter
          let matchesFilter = true;
          if (currentFilter === 'featured') matchesFilter = t.featured;

          // Apply search
          const matchesSearch = searchTerm === '' ||
            t.volunteerName.toLowerCase().includes(searchTerm) ||
            t.project.toLowerCase().includes(searchTerm) ||
            t.testimony.toLowerCase().includes(searchTerm);

          return matchesFilter && matchesSearch;
        });

        const grid = document.getElementById('testimoniesGrid');
        const emptyState = document.getElementById('emptyState');

        if (filtered.length === 0) {
          grid.classList.add('hidden');
          emptyState.classList.remove('hidden');
          document.getElementById('paginationNav').classList.add('hidden');
          document.getElementById('paginationDots').classList.add('hidden');
          return;
        }

        grid.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Calculate pagination
        const startIndex = currentPage * testimoniesPerPage;
        const endIndex = startIndex + testimoniesPerPage;
        const testimoniesToShow = filtered.slice(startIndex, endIndex);

        // Update navigation buttons
        updatePaginationControls();

        grid.innerHTML = testimoniesToShow.map(t => {
          const featuredBadge = t.featured
            ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full flex items-center space-x-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg><span>Featured</span></span>'
            : '';

          const stars = '★'.repeat(t.rating) + '☆'.repeat(5 - t.rating);

          // Build avatar HTML - show profile image if available
          const safeImageUrl = sanitizeImageURL(t.volunteerImage);
          const avatarHTML = safeImageUrl
            ? `<img src="${safeImageUrl}" alt="${escapeHTML(t.volunteerName)}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" onerror="this.outerHTML='<div class=\\'w-12 h-12 bg-[#2f6e4e] rounded-full flex items-center justify-center text-white font-bold flex-shrink-0\\'>${escapeHTML(t.volunteerInitials)}</div>'" />`
            : `<div class="w-12 h-12 bg-[#2f6e4e] rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">${escapeHTML(t.volunteerInitials)}</div>`;

          return `
            <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition cursor-pointer" onclick="viewTestimony(${t.id})">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-start space-x-3">
                  ${avatarHTML}
                  <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-gray-800 truncate">${escapeHTML(t.volunteerName)}</h4>
                    <div class="flex items-center space-x-1 mt-1">
                      <span class="text-yellow-500 text-sm">${stars}</span>
                      <span class="text-xs text-gray-500">(${t.rating}/5)</span>
                    </div>
                  </div>
                </div>
              </div>

              <p class="text-sm text-gray-700 line-clamp-3 mb-3">${escapeHTML(t.testimony)}</p>

              <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                <span class="text-xs text-gray-400">${escapeHTML(t.dateSubmitted)}</span>
                ${featuredBadge}
              </div>
            </div>
          `;
        }).join('');
      }

      // View testimony details
      function viewTestimony(id) {
        const testimony = testimonies.find(t => t.id === id);
        if (!testimony) return;

        currentTestimonyId = id;

        document.getElementById('viewAvatar').textContent = testimony.volunteerInitials;
        document.getElementById('viewVolunteerName').textContent = testimony.volunteerName;
        document.getElementById('viewProject').textContent = testimony.project;
        document.getElementById('viewDate').textContent = `Submitted: ${testimony.dateSubmitted}`;
        document.getElementById('viewTestimony').textContent = testimony.testimony;

        // Featured badge
        const featuredBadge = testimony.featured
          ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-full flex items-center space-x-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg><span>Featured on Homepage</span></span>'
          : '';
        document.getElementById('viewStatusBadge').innerHTML = featuredBadge;

        // Rating stars
        const stars = '★'.repeat(testimony.rating) + '☆'.repeat(5 - testimony.rating);
        document.getElementById('viewRating').innerHTML = `<span class="text-yellow-500 text-2xl">${stars}</span>`;
        document.getElementById('viewRatingText').textContent = `${testimony.rating} out of 5`;

        // Update buttons
        const featureBtnText = document.getElementById('featureBtnText');
        featureBtnText.textContent = testimony.featured ? 'Unfeature' : 'Feature';

        document.getElementById('viewModal').classList.remove('hidden');
      }

      function closeViewModal() {
        document.getElementById('viewModal').classList.add('hidden');
        currentTestimonyId = null;
      }

      // Delete testimony
      function deleteTestimony() {
        const testimony = testimonies.find(t => t.id === currentTestimonyId);
        if (!testimony) return;

        showConfirm(
          'Delete Testimony',
          `Are you sure you want to permanently delete this testimony from ${testimony.volunteerName}? This action cannot be undone.`,
          async () => {
            try {
              const { error } = await supabaseClient
                .from('Testimonies_Tbl')
                .delete()
                .eq('testimonyID', currentTestimonyId);
              if (error) throw error;
              testimonies = testimonies.filter(t => t.id !== currentTestimonyId);
              updateStats();
              renderTestimonies();
              closeViewModal();
              showToast('Testimony has been permanently deleted.', 'success');
            } catch (err) {
              console.error('[SK TESTIMONIES] Delete error:', err);
              showToast('Failed to delete testimony', 'error');
            }
          },
          'Delete',
          'red'
        );
      }

      // Toggle featured status
      async function toggleFeature() {
        const testimony = testimonies.find(t => t.id === currentTestimonyId);
        if (!testimony) return;

        // If already featured, unfeature directly without modal
        if (testimony.featured) {
          try {
            const { error } = await supabaseClient
              .from('Testimonies_Tbl')
              .update({ isFiltered: false })
              .eq('testimonyID', currentTestimonyId);
            if (error) throw error;
            testimony.featured = false;
            updateStats();
            renderTestimonies();
            showToast('Testimony has been removed from homepage!');
            document.getElementById('featureBtnText').textContent = 'Feature';
            document.getElementById('viewStatusBadge').innerHTML = '';
          } catch (err) {
            console.error('[SK TESTIMONIES] Unfeature error:', err);
            showToast('Failed to update testimony', 'error');
          }
          return;
        }

        // If not featured, show info modal before featuring
        showFeatureInfoModal(testimony);
      }

      // Show feature info modal
      function showFeatureInfoModal(testimony) {
        const modal = document.getElementById('featureInfoModal');
        const titleEl = document.getElementById('featureInfoTitle');
        const messageEl = document.getElementById('featureInfoMessage');
        const confirmBtn = document.getElementById('featureInfoOk');
        const cancelBtn = document.getElementById('featureInfoCancel');
        const btnText = document.getElementById('featureInfoBtnText');

        titleEl.textContent = 'Feature Testimony';
        messageEl.textContent = 'This testimony will be displayed on the homepage for public viewing. Featured testimonies help showcase the positive impact of our SK programs to the community.';
        btnText.textContent = 'Feature';

        modal.classList.remove('hidden');

        const handleConfirm = async () => {
          modal.classList.add('hidden');
          try {
            const { error } = await supabaseClient
              .from('Testimonies_Tbl')
              .update({ isFiltered: true })
              .eq('testimonyID', testimony.id);
            if (error) throw error;
            testimony.featured = true;
            updateStats();
            renderTestimonies();
            showToast('Testimony has been featured on homepage!');
            document.getElementById('featureBtnText').textContent = 'Unfeature';
            // Update badge in modal
            const featuredBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 text-sm font-medium rounded-full flex items-center space-x-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg><span>Featured on Homepage</span></span>';
            document.getElementById('viewStatusBadge').innerHTML = featuredBadge;
          } catch (err) {
            console.error('[SK TESTIMONIES] Feature error:', err);
            showToast('Failed to feature testimony', 'error');
          }
          cleanup();
        };

        const handleCancel = () => {
          modal.classList.add('hidden');
          cleanup();
        };

        const cleanup = () => {
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        });
      }

      // Toast Notification System
      function showToast(message, type = 'success') {
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        let icon = '';
        if (type === 'success') {
          icon = '<svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        } else if (type === 'error') {
          icon = '<svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        } else if (type === 'warning') {
          icon = '<svg class="w-6 h-6 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
        } else {
          icon = '<svg class="w-6 h-6 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        toast.innerHTML = `
          ${icon}
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-800">${message}</p>
          </div>
          <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        `;

        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Confirmation Modal
      function showConfirm(title, message, onConfirm, confirmButtonText = 'Delete', confirmButtonColor = 'red') {
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmOk');
        const cancelBtn = document.getElementById('confirmCancel');

        titleEl.textContent = title;
        messageEl.textContent = message;
        confirmBtn.textContent = confirmButtonText;

        // Update button colors
        confirmBtn.className = `flex-1 px-4 py-2.5 ${confirmButtonColor === 'red' ? 'bg-red-600 hover:bg-red-700' : 'bg-[#2f6e4e] hover:bg-[#3d8b64]'} text-white rounded-lg transition font-medium`;

        modal.classList.remove('hidden');

        const handleConfirm = () => {
          modal.classList.add('hidden');
          onConfirm();
          cleanup();
        };

        const handleCancel = () => {
          modal.classList.add('hidden');
          cleanup();
        };

        const cleanup = () => {
          confirmBtn.removeEventListener('click', handleConfirm);
          cancelBtn.removeEventListener('click', handleCancel);
        };

        confirmBtn.addEventListener('click', handleConfirm);
        cancelBtn.addEventListener('click', handleCancel);

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        });
      }

      // Update current date display
      function updateCurrentDate() {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const currentDate = new Date().toLocaleDateString('en-US', options);
        const dateElement = document.getElementById('currentDate');
        if (dateElement) {
          dateElement.textContent = currentDate;
        }
      }
      updateCurrentDate();

      // Listen for profile updates from ProfileModal
      window.addEventListener('profileUpdated', (event) => {
        const profile = event.detail;

        // Update currentUserData with new values
        if (currentUserData) {
          currentUserData.firstName = profile.firstName;
          currentUserData.middleName = profile.middleName || '';
          currentUserData.lastName = profile.lastName;
          currentUserData.address = profile.address;
          currentUserData.contactNumber = profile.contact;
          currentUserData.birthday = profile.birthday;
          currentUserData.gender = profile.gender;
          if (profile.profilePicture) {
            currentUserData.imagePathURL = profile.profilePicture;
          }
        }

        // Update header UI
        updateUserProfile();
      });

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', initializeTestimonies);

      // Expose functions to window for onclick handlers
      window.filterTestimonies = filterTestimonies;
      window.searchTestimonies = searchTestimonies;
      window.navigateTestimonies = navigateTestimonies;
      window.goToPage = goToPage;
      window.viewTestimony = viewTestimony;
      window.closeViewModal = closeViewModal;
      window.toggleFeature = toggleFeature;
      window.deleteTestimony = deleteTestimony;
      window.showToast = showToast;
      window.showConfirm = showConfirm;
    </script>
      <script src="js/mobile-nav.js"></script>
  </body>
</html>
